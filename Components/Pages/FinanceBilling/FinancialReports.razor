@page "/finance/financial-reports"
@layout MainLayout
@using HestiaLink.Data
@using HestiaLink.Models
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext _context
@inject IJSRuntime JSRuntime

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Financial Reports</h1>
        <span class="page-topbar-subtitle">Revenue, Expenses & Tax Analytics</span>
    </header>

    <section class="page-content">
        <!-- Report Period Selector -->
        <div style="background: var(--color-white); padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-weight: 700; color: var(--color-dark-teal); margin-bottom: 8px; display: block;">Report Period</label>
                    <select class="form-select" @bind="SelectedPeriod">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-weight: 700; color: var(--color-dark-teal); margin-bottom: 8px; display: block;">From Date</label>
                    <input type="date" class="form-input" @bind="StartDate" />
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-weight: 700; color: var(--color-dark-teal); margin-bottom: 8px; display: block;">To Date</label>
                    <input type="date" class="form-input" @bind="EndDate" />
                </div>
                <div style="align-self: flex-end;">
                    <button class="btn-create" @onclick="GenerateReport">Generate Report</button>
                </div>
            </div>
        </div>

        <!-- Key Financial Metrics -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-title">Total Revenue</div>
                <div class="stat-value">₱@TotalRevenue.ToString("N2")</div>
                <div style="font-size: 0.85rem; color: #047857; margin-top: 4px;">Based on Paid Bills</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total Expenses</div>
                <div class="stat-value" style="color: #991b1b;">₱@TotalExpenses.ToString("N2")</div>
                <div style="font-size: 0.85rem; color: #991b1b; margin-top: 4px;">Operational Expenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Net Profit</div>
                <div class="stat-value" style="color: @(NetProfit >= 0 ? "var(--color-teal)" : "#991b1b")">₱@NetProfit.ToString("N2")</div>
                <div style="font-size: 0.85rem; color: var(--color-dark-teal); margin-top: 4px;">@ProfitMargin.ToString("F1")% margin</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Tax Liabilities</div>
                <div class="stat-value">₱@TotalTaxLiabilities.ToString("N2")</div>
                <div style="font-size: 0.85rem; color: var(--color-dark-teal); margin-top: 4px;">VAT + Income Tax</div>
            </div>
        </div>

        <!-- Report Tabs -->
        <div style="display: flex; gap: 12px; margin-bottom: 24px;">
            <button class="@(ActiveTab == "revenue" ? "btn-create" : "btn-outlined")" @onclick='() => ChangeTab("revenue")'>
                Revenue Breakdown
            </button>
            <button class="@(ActiveTab == "expenses" ? "btn-create" : "btn-outlined")" @onclick='() => ChangeTab("expenses")'>
                Expense Analysis
            </button>
            <button class="@(ActiveTab == "tax" ? "btn-create" : "btn-outlined")" @onclick='() => ChangeTab("tax")'>
                Tax Summary
            </button>
            <button class="@(ActiveTab == "profit" ? "btn-create" : "btn-outlined")" @onclick='() => ChangeTab("profit")'>
                Profit & Loss
            </button>
        </div>

        <!-- Revenue Breakdown Tab -->
        @if (ActiveTab == "revenue")
        {
            <div class="panel-card">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Revenue Source Distribution
                </div>
                <div class="panel-body" style="height: 400px; padding: 20px;">
                    @if (RevenueBreakdown.Any())
                    {
                        <canvas id="revenueChart"></canvas>
                    }
                    else
                    {
                        <div style="display:flex; justify-content:center; align-items:center; height:100%; color: #666;">No revenue data to display.</div>
                    }
                </div>
            </div>
        }

        <!-- Expense Analysis Tab -->
        @if (ActiveTab == "expenses")
        {
            <div class="panel-card">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Top Expense Categories
                </div>
                <div class="panel-body" style="height: 400px; padding: 20px;">
                    @if (ExpenseBreakdown.Any())
                    {
                        <canvas id="expenseChart"></canvas>
                    }
                    else
                    {
                         <div style="display:flex; justify-content:center; align-items:center; height:100%; color: #666;">No expense data to display.</div>
                    }
                </div>
            </div>
        }

        <!-- Tax Summary Tab (Keep as text/tables for clarity) -->
        @if (ActiveTab == "tax")
        {
            <div class="panel-card">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Tax Collections & Liabilities Summary
                </div>
                <div class="panel-body">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 30px;">
                        <div style="background: var(--color-cream); padding: 24px; border-radius: 12px;">
                            <h3 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900;">Guest Taxes Collected</h3>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--color-light-gray);">
                                <span style="font-weight: 600;">VAT (12%):</span>
                                <span style="font-weight: 900; color: var(--color-teal);">₱@VATCollected.ToString("N2")</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--color-light-gray);">
                                <span style="font-weight: 600;">Service Charge (10%):</span>
                                <span style="font-weight: 900; color: var(--color-teal);">₱@ServiceChargeCollected.ToString("N2")</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 1.1rem;">
                                <span style="font-weight: 900; color: var(--color-dark-teal);">Total Collected:</span>
                                <span style="font-weight: 900; color: var(--color-teal);">₱@(VATCollected + ServiceChargeCollected).ToString("N2")</span>
                            </div>
                        </div>

                        <div style="background: var(--color-cream); padding: 24px; border-radius: 12px;">
                            <h3 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900;">Employee Income Tax Withheld</h3>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--color-light-gray);">
                                <span style="font-weight: 600;">Rank & File:</span>
                                <span style="font-weight: 900; color: var(--color-dark-teal);">₱@RankAndFileTax.ToString("N2")</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--color-light-gray);">
                                <span style="font-weight: 600;">Managerial:</span>
                                <span style="font-weight: 900; color: var(--color-dark-teal);">₱@ManagerialTax.ToString("N2")</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 1.1rem;">
                                <span style="font-weight: 900; color: var(--color-dark-teal);">Total Withheld:</span>
                                <span style="font-weight: 900; color: #991b1b;">₱@(RankAndFileTax + ManagerialTax).ToString("N2")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Profit & Loss Tab -->
        @if (ActiveTab == "profit")
        {
            <div class="panel-card">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Profit & Loss Overview
                </div>
                 <div class="panel-body" style="height: 400px; padding: 20px;">
                    @if (TotalRevenue > 0 || TotalExpenses > 0)
                    {
                        <canvas id="profitChart"></canvas>
                    }
                    else
                    {
                        <div style="display:flex; justify-content:center; align-items:center; height:100%; color: #666;">No P&L data to display.</div>
                    }
                </div>
            </div>
        }

        <!-- Export Options -->
        <div style="display: flex; gap: 12px; margin-top: 30px; justify-content: center;">
            <button class="btn-outlined" @onclick="ExportPDF">📄 Export to PDF</button>
            <button class="btn-outlined" @onclick="ExportExcel">📊 Export to Excel</button>
            <button class="btn-outlined" @onclick="PrintReport">🖨 Print Report</button>
        </div>
    </section>
</div>

<style>
    .stat-card {
        background: var(--color-white);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        gap: 8px;
        height: auto;
        min-height: 120px;
    }
</style>

@code {
    private string SelectedPeriod = "month";
    private DateTime StartDate = DateTime.Now.AddMonths(-1);
    private DateTime EndDate = DateTime.Now;
    private string ActiveTab = "revenue";

    private List<RevenueSource> RevenueBreakdown = new List<RevenueSource>();
    private List<ExpenseCategory> ExpenseBreakdown = new List<ExpenseCategory>();

    private decimal TotalRevenue => RevenueBreakdown.Sum(r => r.Amount);
    private decimal TotalExpenses => ExpenseBreakdown.Sum(e => e.Amount);
    private decimal NetProfit => TotalRevenue - TotalExpenses;
    private decimal ProfitMargin => TotalRevenue > 0 ? (NetProfit / TotalRevenue) * 100 : 0;

    private decimal VATCollected = 0;
    private decimal ServiceChargeCollected = 0;
    private decimal RankAndFileTax = 0;
    private decimal ManagerialTax = 0;
    private decimal TotalTaxLiabilities => VATCollected + RankAndFileTax + ManagerialTax;

    protected override async Task OnInitializedAsync()
    {
        await LoadReportData();
    }

    private async Task ChangeTab(string tab)
    {
        ActiveTab = tab;
        // Give UI a moment to render the canvas before calling JS
        await Task.Delay(100); 
        await RenderCharts();
    }

    private async Task GenerateReport()
    {
        await LoadReportData();
        await RenderCharts();
    }

    private async Task LoadReportData()
    {
        try
        {
            // 1. Load Revenue
            var paidBills = await _context.Bills
                .Where(b => b.BillStatus == "Paid" && 
                            b.BillDate >= StartDate && 
                            b.BillDate <= EndDate)
                .ToListAsync();

            RevenueBreakdown.Clear();
            var totalBillAmount = paidBills.Sum(b => b.SubtotalAmount ?? 0);
            
            if (totalBillAmount > 0)
            {
                RevenueBreakdown.Add(new RevenueSource 
                { 
                    Source = "Room & Guest Services", 
                    Amount = totalBillAmount, 
                    TransactionCount = paidBills.Count 
                });
            }

            foreach (var source in RevenueBreakdown)
            {
                source.Percentage = TotalRevenue > 0 ? (source.Amount / TotalRevenue) * 100 : 0;
            }

            // 2. Load Expenses
            var expenses = await _context.OperationalExpenses
                .Where(e => e.ExpenseDate >= StartDate && 
                            e.ExpenseDate <= EndDate)
                .ToListAsync();
            
            ExpenseBreakdown.Clear();
            var groupedExpenses = expenses.GroupBy(e => e.Category);

            foreach (var group in groupedExpenses)
            {
                ExpenseBreakdown.Add(new ExpenseCategory
                {
                    Category = group.Key,
                    Amount = group.Sum(e => e.Amount),
                    TransactionCount = group.Count()
                });
            }

            foreach (var expense in ExpenseBreakdown)
            {
                expense.Percentage = TotalExpenses > 0 ? (expense.Amount / TotalExpenses) * 100 : 0;
                expense.AvgPerTransaction = expense.TransactionCount > 0 ? expense.Amount / expense.TransactionCount : 0;
            }

            // 3. Load Tax Data
            VATCollected = paidBills.Sum(b => (b.SubtotalAmount ?? 0) * 0.12m);
            ServiceChargeCollected = paidBills.Sum(b => (b.SubtotalAmount ?? 0) * 0.10m);

            var payrolls = await _context.Payrolls
                .Where(p => p.PeriodEnd >= DateOnly.FromDateTime(StartDate) && 
                            p.PeriodEnd <= DateOnly.FromDateTime(EndDate))
                .ToListAsync();

            RankAndFileTax = payrolls.Sum(p => p.TaxAmount ?? 0); 
            ManagerialTax = 0; 
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading financial data: {ex.Message}");
        }
    }

    private async Task RenderCharts()
    {
        if (ActiveTab == "revenue" && RevenueBreakdown.Any())
        {
            var labels = RevenueBreakdown.Select(r => r.Source).ToArray();
            var data = RevenueBreakdown.Select(r => r.Amount).ToArray();
            var colors = new[] { "#0d9488", "#0f766e", "#115e59", "#134e4a", "#14b8a6" }; // Teal palette

            await JSRuntime.InvokeVoidAsync("chartHelper.renderDoughnutChart", "revenueChart", labels, data, colors);
        }
        else if (ActiveTab == "expenses" && ExpenseBreakdown.Any())
        {
            var sortedExpenses = ExpenseBreakdown.OrderByDescending(e => e.Amount).Take(10).ToList();
            var labels = sortedExpenses.Select(e => e.Category).ToArray();
            var data = sortedExpenses.Select(e => e.Amount).ToArray();
            var colors = new[] { "#991b1b", "#b91c1c", "#dc2626", "#ef4444", "#f87171" }; // Red palette

            await JSRuntime.InvokeVoidAsync("chartHelper.renderHorizontalBarChart", "expenseChart", labels, data, colors);
        }
        else if (ActiveTab == "profit")
        {
            var labels = new[] { "Total Revenue", "Total Expenses", "Net Profit" };
            var data = new[] { TotalRevenue, TotalExpenses, NetProfit };
            var colors = new[] { "#0d9488", "#991b1b", NetProfit >= 0 ? "#047857" : "#7f1d1d" };

            await JSRuntime.InvokeVoidAsync("chartHelper.renderBarChart", "profitChart", labels, data, colors, "Financial Overview");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RenderCharts();
        }
    }

    private void ExportPDF() { }
    private void ExportExcel() { }
    private void PrintReport() { }

    public class RevenueSource
    {
        public string Source { get; set; } = "";
        public decimal Amount { get; set; }
        public decimal Percentage { get; set; }
        public int TransactionCount { get; set; }
    }

    public class ExpenseCategory
    {
        public string Category { get; set; } = "";
        public decimal Amount { get; set; }
        public decimal Percentage { get; set; }
        public int TransactionCount { get; set; }
        public decimal AvgPerTransaction { get; set; }
    }
}
