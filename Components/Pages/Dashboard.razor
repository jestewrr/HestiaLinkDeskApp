@page "/dashboard"
@using HestiaLink.Data
@using HestiaLink.Models
@using HestiaLink.Services
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext DbContext
@inject NavigationManager Navigation
@inject UserSession UserSession
@inject IJSRuntime JSRuntime
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>📊 Dashboard</h1>
        <span class="page-topbar-subtitle">@DateTime.Now.ToString("dddd, MMMM dd, yyyy") · Welcome, @(UserSession?.Username ?? "User")</span>
    </header>

    <section class="page-content">
        @if (!IsLoaded)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading dashboard data...</p>
            </div>
        }
        else if (HasError)
        {
            <div style="padding:12px; border-radius:8px; background:#fff4f8; color:#7f1d1d; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                <span>⚠️ @ErrorMessage</span>
                <button class="btn-create" @onclick="LoadDashboardData">🔄 Retry</button>
            </div>
        }
        else
        {
            <!-- Main Stats Row - Same style as CheckInCheckOut -->
            <div class="top-cards" style="display:flex; gap:14px; margin-bottom:18px; align-items:center; flex-wrap:wrap;">
                <div class="stat-card" style="flex:1; min-width:160px; padding:16px; border-radius:12px; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.06); border:1px solid #e5e7eb; border-left:4px solid #10b981;">
                    <div style="font-weight:600; color:#6b7280; font-size:0.85rem;">🏨 Available Rooms</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#10b981; margin-top:4px;">@AvailableRooms</div>
                    <div style="font-size:0.75rem; color:#9ca3af; margin-top:2px;">of @TotalRooms total</div>
                </div>
                <div class="stat-card" style="flex:1; min-width:160px; padding:16px; border-radius:12px; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.06); border:1px solid #e5e7eb; border-left:4px solid #3b82f6;">
                    <div style="font-weight:600; color:#6b7280; font-size:0.85rem;">👥 Active Guests</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#3b82f6; margin-top:4px;">@ActiveGuests</div>
                    <div style="font-size:0.75rem; color:#9ca3af; margin-top:2px;">checked in now</div>
                </div>
                <div class="stat-card" style="flex:1; min-width:160px; padding:16px; border-radius:12px; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.06); border:1px solid #e5e7eb; border-left:4px solid #f59e0b;">
                    <div style="font-weight:600; color:#6b7280; font-size:0.85rem;">🧹 Pending Tasks</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#f59e0b; margin-top:4px;">@PendingHousekeepingTasks</div>
                    <div style="font-size:0.75rem; color:#9ca3af; margin-top:2px;">housekeeping</div>
                </div>
                <div class="stat-card" style="flex:1; min-width:160px; padding:16px; border-radius:12px; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.06); border:1px solid #e5e7eb; border-left:4px solid #ef4444;">
                    <div style="font-weight:600; color:#6b7280; font-size:0.85rem;">⚠️ Low Stock</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#ef4444; margin-top:4px;">@LowStockItems</div>
                    <div style="font-size:0.75rem; color:#9ca3af; margin-top:2px;">inventory alerts</div>
                </div>
                <div class="stat-card" style="flex:1; min-width:160px; padding:16px; border-radius:12px; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.06); border:1px solid #e5e7eb; border-left:4px solid #8b5cf6;">
                    <div style="font-weight:600; color:#6b7280; font-size:0.85rem;">👨‍💼 Active Staff</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#8b5cf6; margin-top:4px;">@TotalStaff</div>
                    <div style="font-size:0.75rem; color:#9ca3af; margin-top:2px;">system users</div>
                </div>
            </div>

            <!-- Quick Actions - Card Style -->
            <div class="quick-actions" style="display:flex; gap:12px; margin-bottom:24px; flex-wrap:wrap;">
                <a href="/reservations/check-in-check-out" class="action-btn">
                    <span>🔑</span> Check In/Out
                </a>
                <a href="/reservations" class="action-btn">
                    <span>📅</span> Reservations
                </a>
                <a href="/housekeeping/cleaning-schedule" class="action-btn">
                    <span>🧹</span> Housekeeping
                </a>
                <a href="/inventory/dashboard" class="action-btn">
                    <span>📦</span> Inventory
                </a>
                <a href="/finance/financial-reports" class="action-btn">
                    <span>📊</span> Reports
                </a>
            </div>

            <!-- Dashboard Cards Grid -->
            <div class="cards-grid">
                <!-- Room Status Card -->
                <div class="user-card" style="grid-column: span 2;">
                    <div class="card-top">
                        <div class="avatar" style="background: linear-gradient(135deg, #10b981, #059669);">🏨</div>
                        <div class="card-title">Room Status Overview</div>
                        <a href="/reservations/check-in-check-out" class="view-link">View All →</a>
                    </div>
                    <div class="card-body">
                        <div class="room-status-grid">
                            <div class="room-status-item available">
                                <span class="status-icon">✅</span>
                                <div class="status-info">
                                    <span class="status-count">@AvailableRooms</span>
                                    <span class="status-label">Available</span>
                                </div>
                            </div>
                            <div class="room-status-item occupied">
                                <span class="status-icon">🔒</span>
                                <div class="status-info">
                                    <span class="status-count">@OccupiedRooms</span>
                                    <span class="status-label">Occupied</span>
                                </div>
                            </div>
                            <div class="room-status-item cleaning">
                                <span class="status-icon">🧹</span>
                                <div class="status-info">
                                    <span class="status-count">@RoomsForCleaning</span>
                                    <span class="status-label">For Cleaning</span>
                                </div>
                            </div>
                            <div class="room-status-item maintenance">
                                <span class="status-icon">🔧</span>
                                <div class="status-info">
                                    <span class="status-count">@MaintenanceRooms</span>
                                    <span class="status-label">Maintenance</span>
                                </div>
                            </div>
                        </div>
                        <div class="occupancy-section">
                            <div class="occupancy-header">
                                <span>Occupancy Rate</span>
                                <span class="occupancy-percent">@OccupancyRate%</span>
                            </div>
                            <div class="occupancy-bar">
                                <div class="occupancy-fill" style="width: @OccupancyRate%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Activity Card -->
                <div class="user-card">
                    <div class="card-top">
                        <div class="avatar" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">📅</div>
                        <div class="card-title">Today's Activity</div>
                    </div>
                    <div class="card-body">
                        <div class="activity-grid">
                            <div class="activity-item">
                                <span class="activity-icon" style="background:#d1fae5;">↘️</span>
                                <div class="activity-info">
                                    <span class="activity-count">@TodayCheckIns</span>
                                    <span class="activity-label">Check-ins</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <span class="activity-icon" style="background:#dbeafe;">↗️</span>
                                <div class="activity-info">
                                    <span class="activity-count">@TodayCheckOuts</span>
                                    <span class="activity-label">Check-outs</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <span class="activity-icon" style="background:#fef3c7;">📋</span>
                                <div class="activity-info">
                                    <span class="activity-count">@PendingReservations</span>
                                    <span class="activity-label">Pending</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <span class="activity-icon" style="background:#ede9fe;">💰</span>
                                <div class="activity-info">
                                    <span class="activity-count">₱@TodayRevenue.ToString("N0")</span>
                                    <span class="activity-label">Revenue</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Revenue Card -->
                <div class="user-card">
                    <div class="card-top">
                        <div class="avatar" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">💰</div>
                        <div class="card-title">Revenue Overview</div>
                        <a href="/finance/financial-reports" class="view-link">Reports →</a>
                    </div>
                    <div class="card-body">
                        <div class="revenue-grid">
                            <div class="revenue-item">
                                <span class="revenue-label">Today</span>
                                <span class="revenue-value">₱@TodayRevenue.ToString("N0")</span>
                            </div>
                            <div class="revenue-item">
                                <span class="revenue-label">This Week</span>
                                <span class="revenue-value">₱@WeeklyRevenue.ToString("N0")</span>
                            </div>
                            <div class="revenue-item highlight">
                                <span class="revenue-label">This Month</span>
                                <span class="revenue-value">₱@MonthlyRevenue.ToString("N0")</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">Weekly Trend</div>
                            <div class="bar-chart">
                                @foreach (var day in WeeklyRevenueData)
                                {
                                    var maxRevenue = WeeklyRevenueData.Any(d => d.Amount > 0) ? WeeklyRevenueData.Max(d => d.Amount) : 1;
                                    var height = maxRevenue > 0 ? (day.Amount / maxRevenue * 100) : 0;
                                    <div class="bar-item">
                                        <div class="bar" style="height: @height%"></div>
                                        <span class="bar-label">@day.DayName</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Reservations Card -->
                <div class="user-card">
                    <div class="card-top">
                        <div class="avatar" style="background: linear-gradient(135deg, #f59e0b, #d97706);">📋</div>
                        <div class="card-title">Recent Reservations</div>
                        <a href="/reservations" class="view-link">View All →</a>
                    </div>
                    <div class="card-body">
                        @if (RecentReservations.Any())
                        {
                            <div class="reservation-list">
                                @foreach (var res in RecentReservations.Take(4))
                                {
                                    <div class="reservation-item">
                                        <div class="res-info">
                                            <span class="res-guest">@res.GuestName</span>
                                            <span class="res-details">Room @res.RoomNumber · @res.CheckInDate.ToString("MMM dd")</span>
                                        </div>
                                        <span class="status-badge @GetStatusClass(res.Status)">@res.Status</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="no-data">No recent reservations</div>
                        }
                    </div>
                </div>

                <!-- Housekeeping Card -->
                <div class="user-card">
                    <div class="card-top">
                        <div class="avatar" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">🧹</div>
                        <div class="card-title">Housekeeping Tasks</div>
                        <a href="/housekeeping/cleaning-schedule" class="view-link">View All →</a>
                    </div>
                    <div class="card-body">
                        @if (HousekeepingTasks.Any())
                        {
                            <div class="task-list">
                                @foreach (var task in HousekeepingTasks.Take(4))
                                {
                                    <div class="task-item">
                                        <div class="task-info">
                                            <span class="task-room">Room @task.RoomNumber</span>
                                            <span class="task-assignee">@task.AssignedTo</span>
                                        </div>
                                        <span class="status-badge @GetTaskStatusClass(task.Status)">@task.Status</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="no-data" style="color:#10b981;">✨ All rooms are clean!</div>
                        }
                        <div class="task-summary">
                            <div class="task-stat">
                                <span class="task-stat-value">@HousekeepingTasks.Count(t => t.Status == "Assigned")</span>
                                <span class="task-stat-label">Assigned</span>
                            </div>
                            <div class="task-stat">
                                <span class="task-stat-value">@HousekeepingTasks.Count(t => t.Status == "In Progress")</span>
                                <span class="task-stat-label">In Progress</span>
                            </div>
                            <div class="task-stat">
                                <span class="task-stat-value">@CompletedTasksToday</span>
                                <span class="task-stat-label">Completed</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Alerts Card -->
                <div class="user-card">
                    <div class="card-top">
                        <div class="avatar" style="background: linear-gradient(135deg, #ef4444, #dc2626);">📦</div>
                        <div class="card-title">Inventory Alerts</div>
                        <a href="/inventory/alerts" class="view-link">View All →</a>
                    </div>
                    <div class="card-body">
                        @if (LowStockInventory.Any())
                        {
                            <div class="inventory-list">
                                @foreach (var item in LowStockInventory.Take(4))
                                {
                                    <div class="inventory-item">
                                        <div class="inv-info">
                                            <span class="inv-name">@item.ItemName</span>
                                            <span class="inv-stock">@item.CurrentStock @item.Unit</span>
                                        </div>
                                        @if (item.CurrentStock == 0)
                                        {
                                            <span class="status-badge status-danger">Out</span>
                                        }
                                        else
                                        {
                                            <span class="status-badge status-warning">Low</span>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="no-data" style="color:#10b981;">✅ All items well stocked!</div>
                        }
                        <div class="inventory-summary">
                            <div class="inv-stat">
                                <span class="inv-stat-value">@TotalInventoryItems</span>
                                <span class="inv-stat-label">Total Items</span>
                            </div>
                            <div class="inv-stat">
                                <span class="inv-stat-value">@LowStockItems</span>
                                <span class="inv-stat-label">Low Stock</span>
                            </div>
                            <div class="inv-stat">
                                <span class="inv-stat-value">₱@TotalInventoryValue.ToString("N0")</span>
                                <span class="inv-stat-label">Value</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </section>
</div>

<style>
    /* Page Layout */
    .page-wrapper {
        min-height: 100vh;
        background: #f3f5f7;
    }

    .page-topbar {
        padding: 20px 24px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 20px;
    }

    .page-topbar h1 {
        margin: 0 0 4px 0;
        font-size: 1.5rem;
        color: #0f766e;
        font-weight: 800;
    }

    .page-topbar-subtitle {
        color: #6b7280;
        font-size: 0.9rem;
    }

    .page-content {
        padding: 0 24px 24px;
    }

    /* Cards Grid - Same as CheckInCheckOut */
    .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 20px;
    }

    /* User Card - Same style as CheckInCheckOut */
    .user-card {
        background: white;
        border-radius: 14px;
        padding: 18px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        display: flex;
        flex-direction: column;
        transition: all 0.2s ease;
    }

    .user-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        transform: translateY(-2px);
    }

    .card-top {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 16px;
    }

    .card-title {
        font-weight: 800;
        font-size: 1.1rem;
        color: #1f2937;
        flex: 1;
    }

    .view-link {
        font-size: 0.8rem;
        color: #0f766e;
        text-decoration: none;
        font-weight: 600;
    }

    .view-link:hover {
        color: #059669;
        text-decoration: underline;
    }

    .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* Avatar */
    .avatar {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        background: linear-gradient(135deg, #06b6d4, #0f766e);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        flex-shrink: 0;
    }

    /* Quick Actions */
    .action-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: white;
        padding: 12px 20px;
        border-radius: 10px;
        text-decoration: none;
        color: #0f766e;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }

    .action-btn:hover {
        background: #0f766e;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(15,118,110,0.2);
    }

    /* Room Status Grid */
    .room-status-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }

    .room-status-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 14px 10px;
        border-radius: 10px;
        background: #f8fafc;
        text-align: center;
    }

    .room-status-item.available { border-bottom: 3px solid #10b981; }
    .room-status-item.occupied { border-bottom: 3px solid #3b82f6; }
    .room-status-item.cleaning { border-bottom: 3px solid #f59e0b; }
    .room-status-item.maintenance { border-bottom: 3px solid #ef4444; }

    .status-icon { font-size: 1.5rem; margin-bottom: 6px; }

    .status-info { display: flex; flex-direction: column; }

    .status-count {
        font-size: 1.4rem;
        font-weight: 800;
        color: #1f2937;
    }

    .status-label {
        font-size: 0.7rem;
        color: #6b7280;
        font-weight: 600;
    }

    /* Occupancy Bar */
    .occupancy-section {
        margin-top: 12px;
        padding-top: 14px;
        border-top: 1px solid #e5e7eb;
    }

    .occupancy-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.85rem;
        color: #6b7280;
    }

    .occupancy-percent {
        font-weight: 700;
        color: #0f766e;
    }

    .occupancy-bar {
        height: 10px;
        background: #e5e7eb;
        border-radius: 5px;
        overflow: hidden;
    }

    .occupancy-fill {
        height: 100%;
        background: linear-gradient(90deg, #0f766e, #14b8a6);
        border-radius: 5px;
        transition: width 0.5s ease;
    }

    /* Activity Grid */
    .activity-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .activity-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 10px;
    }

    .activity-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }

    .activity-info { display: flex; flex-direction: column; }

    .activity-count {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1f2937;
    }

    .activity-label {
        font-size: 0.7rem;
        color: #6b7280;
    }

    /* Revenue Grid */
    .revenue-grid {
        display: flex;
        justify-content: space-around;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
    }

    .revenue-item {
        text-align: center;
        padding: 8px;
    }

    .revenue-item.highlight {
        background: #f0fdf4;
        border-radius: 8px;
        padding: 10px 16px;
    }

    .revenue-label {
        display: block;
        font-size: 0.7rem;
        color: #6b7280;
        margin-bottom: 4px;
    }

    .revenue-value {
        font-size: 1rem;
        font-weight: 700;
        color: #1f2937;
    }

    .revenue-item.highlight .revenue-value {
        color: #0f766e;
        font-size: 1.2rem;
    }

    /* Bar Chart */
    .chart-container { margin-top: 12px; }

    .chart-title {
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 10px;
        text-align: center;
    }

    .bar-chart {
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        height: 80px;
    }

    .bar-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
    }

    .bar {
        width: 20px;
        background: linear-gradient(180deg, #0f766e, #14b8a6);
        border-radius: 3px 3px 0 0;
        min-height: 4px;
    }

    .bar-label {
        font-size: 0.6rem;
        color: #6b7280;
        margin-top: 4px;
    }

    /* Reservation List */
    .reservation-list, .task-list, .inventory-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .reservation-item, .task-item, .inventory-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: #f8fafc;
        border-radius: 8px;
    }

    .res-info, .task-info, .inv-info {
        display: flex;
        flex-direction: column;
    }

    .res-guest, .task-room, .inv-name {
        font-weight: 700;
        color: #1f2937;
        font-size: 0.9rem;
    }

    .res-details, .task-assignee, .inv-stock {
        font-size: 0.75rem;
        color: #6b7280;
    }

    /* Status Badges */
    .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .status-confirmed { background: #d1fae5; color: #065f46; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-checkedin { background: #dbeafe; color: #1e40af; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
    .status-warning { background: #fef3c7; color: #92400e; }
    .status-danger { background: #fee2e2; color: #991b1b; }
    .status-assigned { background: #fef3c7; color: #92400e; }
    .status-inprogress { background: #dbeafe; color: #1e40af; }

    /* Task & Inventory Summary */
    .task-summary, .inventory-summary {
        display: flex;
        justify-content: space-around;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
        margin-top: auto;
    }

    .task-stat, .inv-stat { text-align: center; }

    .task-stat-value, .inv-stat-value {
        display: block;
        font-size: 1.2rem;
        font-weight: 700;
        color: #0f766e;
    }

    .task-stat-label, .inv-stat-label {
        font-size: 0.65rem;
        color: #6b7280;
    }

    /* No Data */
    .no-data {
        padding: 20px;
        text-align: center;
        color: #6b7280;
        font-size: 0.9rem;
    }

    /* Loading */
    .loading-state {
        text-align: center;
        padding: 80px 20px;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #e5e7eb;
        border-top-color: #0f766e;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    .btn-create {
        background: #0ea5a4;
        color: white;
        padding: 8px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive */
    @@media (max-width: 1200px) {
        .cards-grid {
            grid-template-columns: 1fr;
        }
        
        .user-card {
            grid-column: span 1 !important;
        }

        .room-status-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 768px) {
        .top-cards {
            flex-direction: column;
        }

        .quick-actions {
            flex-direction: column;
        }

        .activity-grid {
            grid-template-columns: 1fr;
        }

        .room-status-grid {
            grid-template-columns: 1fr 1fr;
        }

        .revenue-grid {
            flex-direction: column;
            gap: 8px;
        }
    }
</style>

@code {
    private bool IsLoaded = false;
    private bool HasError = false;
    private string ErrorMessage = string.Empty;

    // Room Statistics
    private int TotalRooms = 0;
    private int AvailableRooms = 0;
    private int OccupiedRooms = 0;
    private int RoomsForCleaning = 0;
    private int MaintenanceRooms = 0;
    private int OccupancyRate = 0;

    // Guest & Reservation Statistics
    private int ActiveGuests = 0;
    private int TodayCheckIns = 0;
    private int TodayCheckOuts = 0;
    private int PendingReservations = 0;

    // Revenue Statistics
    private decimal TodayRevenue = 0;
    private decimal WeeklyRevenue = 0;
    private decimal MonthlyRevenue = 0;

    // Staff Statistics
    private int TotalStaff = 0;

    // Housekeeping Statistics
    private int PendingHousekeepingTasks = 0;
    private int CompletedTasksToday = 0;

    // Inventory Statistics
    private int LowStockItems = 0;
    private int TotalInventoryItems = 0;
    private decimal TotalInventoryValue = 0;

    // Data Lists
    private List<ReservationSummary> RecentReservations = new();
    private List<TaskSummary> HousekeepingTasks = new();
    private List<InventorySummary> LowStockInventory = new();
    private List<DailyRevenue> WeeklyRevenueData = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            HasError = false;
            IsLoaded = false;
            StateHasChanged();

            // Load Room Statistics
            var rooms = await DbContext.Rooms.AsNoTracking().ToListAsync();
            TotalRooms = rooms.Count;
            AvailableRooms = rooms.Count(r => r.Status == "Available");
            OccupiedRooms = rooms.Count(r => r.Status == "Occupied");
            RoomsForCleaning = rooms.Count(r => r.Status == "For Cleaning" || r.Status == "Dirty" || r.Status == "Cleaning");
            MaintenanceRooms = rooms.Count(r => r.Status == "Maintenance");
            OccupancyRate = TotalRooms > 0 ? (int)Math.Round((double)OccupiedRooms / TotalRooms * 100) : 0;

            // Load Reservation Statistics
            var today = DateTime.Today;
            var reservations = await DbContext.Reservations
                .AsNoTracking()
                .Include(r => r.Guest)
                .ToListAsync();

            ActiveGuests = reservations.Count(r => r.Status == "Checked In");
            TodayCheckIns = reservations.Count(r => r.CheckInDate.Date == today && r.Status == "Checked In");
            TodayCheckOuts = reservations.Count(r => r.CheckOutDate.Date == today && r.Status == "Checked Out");
            PendingReservations = reservations.Count(r => r.Status == "Confirmed" || r.Status == "Pending");

            // Recent Reservations with Room info
            var reservedRooms = await DbContext.ReservedRooms
                .AsNoTracking()
                .Include(rr => rr.Room)
                .ToListAsync();

            RecentReservations = reservations
                .OrderByDescending(r => r.CreatedDate)
                .Take(10)
                .Select(r => new ReservationSummary
                {
                    GuestName = r.Guest != null ? $"{r.Guest.FirstName} {r.Guest.LastName}" : "Unknown",
                    RoomNumber = reservedRooms.FirstOrDefault(rr => rr.ReservationID == r.ReservationID)?.Room?.RoomNumber ?? "N/A",
                    CheckInDate = r.CheckInDate,
                    Status = r.Status ?? "Unknown"
                })
                .ToList();

            // Load Revenue Statistics
            var payments = await DbContext.Payments.AsNoTracking().ToListAsync();
            var startOfWeek = today.AddDays(-(int)today.DayOfWeek);
            var startOfMonth = new DateTime(today.Year, today.Month, 1);

            TodayRevenue = payments.Where(p => p.PaymentDate.Date == today).Sum(p => p.Amount);
            WeeklyRevenue = payments.Where(p => p.PaymentDate.Date >= startOfWeek).Sum(p => p.Amount);
            MonthlyRevenue = payments.Where(p => p.PaymentDate.Date >= startOfMonth).Sum(p => p.Amount);

            // Weekly Revenue Data for Chart
            WeeklyRevenueData = Enumerable.Range(0, 7)
                .Select(i =>
                {
                    var date = startOfWeek.AddDays(i);
                    return new DailyRevenue
                    {
                        DayName = date.ToString("ddd"),
                        Amount = payments.Where(p => p.PaymentDate.Date == date).Sum(p => p.Amount)
                    };
                })
                .ToList();

            // Load Staff Statistics - Fixed query to avoid IsAvailable column
            try
            {
                TotalStaff = await DbContext.SystemUsers
                    .AsNoTracking()
                    .Where(u => u.Status == "Active")
                    .CountAsync();
            }
            catch
            {
                TotalStaff = 0;
            }

            // Load Housekeeping Statistics - Fixed query to avoid CompletionStatus column
            try
            {
                var tasks = await DbContext.CleaningTasks
                    .AsNoTracking()
                    .Include(t => t.Room)
                    .Include(t => t.AssignedUser)
                    .ToListAsync();

                var activeTasks = tasks.Where(t => t.Status == "Assigned" || t.Status == "In Progress").ToList();
                PendingHousekeepingTasks = activeTasks.Count;
                
                // Use Status instead of CompletionStatus for completed tasks
                CompletedTasksToday = tasks.Count(t => t.Status == "Completed" && t.CompletedDate?.Date == today);

                HousekeepingTasks = activeTasks
                    .OrderByDescending(t => t.AssignedDate)
                    .Select(t => new TaskSummary
                    {
                        RoomNumber = t.Room?.RoomNumber ?? "N/A",
                        AssignedTo = t.AssignedUser?.Username ?? "Unassigned",
                        Status = t.Status ?? "Unknown"
                    })
                    .ToList();
            }
            catch
            {
                HousekeepingTasks = new List<TaskSummary>();
                PendingHousekeepingTasks = 0;
                CompletedTasksToday = 0;
            }

            // Load Inventory Statistics
            try
            {
                var inventoryItems = await DbContext.InventoryItems
                    .AsNoTracking()
                    .Where(i => i.IsActive == true)
                    .ToListAsync();

                TotalInventoryItems = inventoryItems.Count;
                TotalInventoryValue = inventoryItems.Sum(i => (i.CurrentStock ?? 0) * i.UnitCost);

                var lowStock = inventoryItems
                    .Where(i => (i.CurrentStock ?? 0) <= (i.ReorderPoint ?? 0))
                    .OrderBy(i => i.CurrentStock)
                    .ToList();

                LowStockItems = lowStock.Count;
                LowStockInventory = lowStock
                    .Select(i => new InventorySummary
                    {
                        ItemName = i.ItemName,
                        CurrentStock = i.CurrentStock ?? 0,
                        Unit = i.UnitOfMeasure ?? ""
                    })
                    .ToList();
            }
            catch
            {
                TotalInventoryItems = 0;
                TotalInventoryValue = 0;
                LowStockItems = 0;
                LowStockInventory = new List<InventorySummary>();
            }

            IsLoaded = true;
        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = ex.InnerException?.Message ?? ex.Message;
            IsLoaded = true;
        }

        StateHasChanged();
    }

    private string GetStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "confirmed" => "status-confirmed",
            "pending" => "status-pending",
            "checked in" => "status-checkedin",
            "checked out" => "status-confirmed",
            "cancelled" => "status-cancelled",
            _ => "status-pending"
        };
    }

    private string GetTaskStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "assigned" => "status-assigned",
            "in progress" => "status-inprogress",
            "completed" => "status-confirmed",
            _ => "status-pending"
        };
    }

    // Helper Classes
    private class ReservationSummary
    {
        public string GuestName { get; set; } = string.Empty;
        public string RoomNumber { get; set; } = string.Empty;
        public DateTime CheckInDate { get; set; }
        public string Status { get; set; } = string.Empty;
    }

    private class TaskSummary
    {
        public string RoomNumber { get; set; } = string.Empty;
        public string AssignedTo { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
    }

    private class InventorySummary
    {
        public string ItemName { get; set; } = string.Empty;
        public int CurrentStock { get; set; }
        public string Unit { get; set; } = string.Empty;
    }

    private class DailyRevenue
    {
        public string DayName { get; set; } = string.Empty;
        public decimal Amount { get; set; }
    }
}