@page "/reservations/check-in-check-out"
@using System.Linq
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext DbContext
@inject IJSRuntime JSRuntime
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Check In / Check Out</h1>
        <span class="page-topbar-subtitle">Manage room occupancy</span>
    </header>

    <section class="page-content">
        <div class="top-cards" style="display:flex; gap:14px; margin-bottom:18px; align-items:center;">
            <div class="stat-card" style="flex:1; padding:12px; border-radius:10px; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.04); border:1px solid #e5e7eb;">
                <div style="font-weight:600; color:#6b7280;">Occupied</div>
                <div style="font-size:1.4rem; font-weight:700; color:#374151;">@Rooms.Count(r => r.Status == "Occupied")</div>
            </div>
            <div class="stat-card" style="flex:1; padding:12px; border-radius:10px; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.04); border:1px solid #e5e7eb;">
                <div style="font-weight:600; color:#6b7280;">Under Maintenance</div>
                <div style="font-size:1.4rem; font-weight:700; color:#374151;">@Rooms.Count(r => r.Status == "Maintenance")</div>
            </div>
            <div class="stat-card" style="flex:1; padding:12px; border-radius:10px; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.04); border:1px solid #e5e7eb;">
                <div style="font-weight:600; color:#6b7280;">Available</div>
                <div style="font-size:1.4rem; font-weight:700; color:#374151;">@Rooms.Count(r => r.Status == "Available")</div>
            </div>
            <div class="stat-card" style="flex:1; padding:12px; border-radius:10px; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.04); border:1px solid #e5e7eb;">
                <div style="font-weight:600; color:#6b7280;">Occupancy Rate</div>
                <div style="font-size:1.4rem; font-weight:700; color:#374151; margin-top:6px;">@GetOccupancyRate()%</div>
            </div>
        </div>

        <div class="toolbar" style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px;">
            <div style="display:flex; gap:12px; align-items:center;">
                <input class="search-input" placeholder="Search by room or guest..." @bind="SearchText" @bind:event="oninput" />
                <select class="filter-select" @bind="FilterStatus">
                    <option value="All">All</option>
                    <option value="Available">Available</option>
                    <option value="Occupied">Occupied</option>
                    <option value="Maintenance">Maintenance</option>
                </select>

                <select class="filter-select" @bind="FilterFloor">
                    <option value="All">All Floors</option>
                    @foreach(var f in Floors)
                    {
                        <option value="@f">Floor @f</option>
                    }
                </select>
            </div>
            <div>
                <button class="btn-create" @onclick="RefreshList">Refresh</button>
            </div>
        </div>

        <div class="cards-grid">
            @foreach (var room in FilteredRooms)
            {
                <div class="user-card" @onclick="() => OnRoomClicked(room)">
                    <div class="card-top">
                        <div class="avatar">@GetAvatarInitials(room.RoomNumber)</div>
                        <div class="card-title">Room @room.RoomNumber <span style="font-weight:600; font-size:0.9rem; color:#64748b; margin-left:8px;">(Floor @room.Floor)</span></div>
                        <div class="status-badge @(room.Status == "Occupied" ? "badge-occupied" : room.Status == "Maintenance" ? "badge-maintenance" : "badge-available")">@room.Status</div>
                    </div>
                    <div class="card-body">
                        <div><strong>Guest:</strong> @(string.IsNullOrEmpty(room.GuestName) ? "-" : room.GuestName)</div>
                        <div><strong>Check-in:</strong> @(room.CheckInDate?.ToString("MMM dd, yyyy") ?? "-")</div>
                        <div><strong>Check-out:</strong> @(room.CheckOutDate?.ToString("MMM dd, yyyy") ?? "-")</div>
                    </div>
                </div>
            }
        </div>
    </section>
</div>

@if (ShowGuestModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width:720px;">
            <div class="modal-header-teal">
                <h2 style="margin:0;">Guest Information</h2>
                <div style="font-size:0.9rem; color:#f8fafc;">@(SelectedRoom != null ? $"Room {SelectedRoom.RoomNumber}" : "New Guest")</div>
            </div>

            <div class="form-grid" style="padding:18px;">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input class="form-input" @bind="GuestFirstName" />
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input class="form-input" @bind="GuestLastName" />
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Email Address</label>
                    <input class="form-input" @bind="GuestEmail" />
                </div>

                <div class="form-group">
                    <label class="form-label">Contact Number</label>
                    <input class="form-input" @bind="GuestContact" />
                </div>
                <div class="form-group">
                    <label class="form-label">Date of Birth</label>
                    <input type="date" class="form-input" @bind="GuestDOB" />
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Address</label>
                    <input class="form-input" @bind="GuestAddress" />
                </div>

                <div class="form-group">
                    <label class="form-label">Check In Date</label>
                    <input type="date" class="form-input" @bind="GuestCheckIn" />
                </div>
                <div class="form-group">
                    <label class="form-label">Check Out Date</label>
                    <input type="date" class="form-input" @bind="GuestCheckOut" />
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Services</label>
                    <div class="multi-dropdown">
                        <button class="dropdown-toggle" @onclick="ToggleServicesDropdown">@GetSelectedServicesLabel()</button>
                        @if (ShowServicesDropdown)
                        {
                            <div class="dropdown-panel">
                                @if (AvailableServices.Any())
                                {
                                    @foreach (var svc in AvailableServices)
                                    {
                                        <label class="dropdown-item"><input type="checkbox" checked="@SelectedServiceIds.Contains(svc.ServiceID)" @onchange="(e) => ToggleServiceSelection(svc.ServiceID, (bool?)e.Value == true)" /> @svc.ServiceName</label>
                                    }
                                }
                                else
                                {
                                    <div style="padding:8px;color:#64748b;">No services available</div>
                                }
                            </div>
                        }
                    </div>
                </div>

            </div>

            <div class="action-footer" style="border:none; padding:16px; display:flex; gap:12px; justify-content:flex-start;">
                <button class="btn-primary" @onclick="SaveGuest">Check - IN</button>
                <button class="btn-secondary" @onclick="CloseGuestModal">Cancel</button>
            </div>
        </div>
    </div>
}

@if (ShowAddServiceModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width:560px;">
            <div class="modal-header-teal">
                <h2 style="margin:0;">Add Services</h2>
                <div style="font-size:0.9rem; color:#f8fafc;">@(SelectedRoom != null ? $"Room {SelectedRoom.RoomNumber}" : "")</div>
            </div>

            <div style="padding:12px;">
                @if (AvailableServices.Any())
                {
                    @foreach (var svc in AvailableServices)
                    {
                        <label style="display:flex; align-items:center; gap:8px; padding:8px 0;"><input type="checkbox" checked="@AddServiceSelection.Contains(svc.ServiceID)" @onchange="(e) => ToggleAddServiceSelection(svc.ServiceID, (bool?)e.Value == true)" /> @svc.ServiceName <span style="margin-left:auto; color:#64748b;">@svc.StandardPrice.ToString("C")</span></label>
                    }
                }
                else
                {
                    <div style="padding:8px;color:#64748b;">No services available</div>
                }
            </div>

            <div class="action-footer" style="border:none; padding:16px; display:flex; gap:12px; justify-content:flex-start;">
                <button class="btn-primary" @onclick="SaveAddedServices">Add Services</button>
                <button class="btn-secondary" @onclick="CloseAddServiceModal">Cancel</button>
            </div>
        </div>
    </div>
}

@if (ShowCheckOutModal)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Billing & Payment</h2>
            </div>

            @if (SelectedRoom != null)
            {
                <div style="padding:16px;">
                    <div class="bill-row"><strong>Room:</strong> @SelectedRoom.RoomNumber</div>
                    <div class="bill-row"><strong>Guest:</strong> @SelectedRoom.GuestName</div>
                    <div class="bill-row"><strong>Check-in:</strong> @SelectedRoom.CheckInDate?.ToString("MMM dd, yyyy")</div>
                    <div class="bill-row"><strong>Check-out:</strong> @SelectedRoom.CheckOutDate?.ToString("MMM dd, yyyy")</div>

                    <div style="height:12px"></div>
                    <div class="bill-summary">
                        <div class="bill-row"><span>Room Charges:</span><span>@(SelectedRoom.RoomCharge.ToString("C"))</span></div>
                        <div class="bill-row"><span>Services:</span><span>@(SelectedRoom.ServiceCharge.ToString("C"))</span></div>
                        <div class="bill-row"><span>Tax (12%):</span><span>@(SelectedRoom.TaxAmount.ToString("C"))</span></div>
                        <div class="bill-row total"><span>REMAINING BALANCE:</span><span>@(SelectedRoom.TotalDue.ToString("C"))</span></div>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:18px;">
                        <button class="btn-checkout" @onclick="ProcessCheckOut">Process Check Out</button>
                        <button class="btn-add-service" @onclick="() => OpenAddServiceModal(SelectedRoom)">Add Service</button>
                        <button class="btn-cancel" @onclick="CloseCheckOutModal">Cancel</button>
                    </div>
                </div>
            }
        </div>
    </div>
}

<style>
    .cards-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:18px; }
    .user-card { background:white; border-radius:12px; padding:14px; border:1px solid #e5e7eb; box-shadow:0 2px 4px rgba(0,0,0,0.04); cursor:pointer; display:flex; flex-direction:column; justify-content:space-between; }
    .card-top { display:flex; align-items:center; gap:12px; }
    .avatar { display:none; }
    .card-title { font-weight:800; font-size:1.05rem; }
    .status-badge { margin-left:auto; padding:6px 10px; border-radius:12px; font-size:0.8rem; }
    .badge-occupied { background:#f3f4f6; color:#374151; border: 1px solid #d1d5db; }
    .badge-available { background:#e0f2f1; color:#00535b; border: 1px solid #b2dfdb; }
    .badge-maintenance { background:#fef2f2; color:#991b1b; border: 1px solid #fecaca; }
    .card-body { margin-top:12px; color:#334155; display:flex; flex-direction:column; gap:6px; }
    .card-actions { margin-top:12px; display:flex; gap:8px; }

    .modal-overlay { position:fixed; inset:0; background:rgba(16,47,51,0.45); display:flex; align-items:center; justify-content:center; z-index:40; }
    .modal-content { background:white; border-radius:10px; width:90%; max-width:900px; box-shadow:0 10px 30px rgba(2,6,23,0.4); }
    .modal-header-teal { background:#00535b; color:white; padding:14px 18px; border-top-left-radius:10px; border-top-right-radius:10px; display:flex; align-items:center; justify-content:space-between; }
    .modal-header { background:#00535b; color:white; padding:12px 16px; border-top-left-radius:10px; border-top-right-radius:10px; }
    .modal-header h2 { color: #ffffff; margin:0; font-weight:700; }
    .form-grid { display:grid; grid-template-columns: repeat(2,1fr); gap:12px; }
    .form-group { display:flex; flex-direction:column; gap:6px; }
    .form-group.full-width { grid-column:1 / -1; }
    .form-label { font-weight:600; color:#334155; }
    .form-input { padding:10px 12px; border-radius:8px; border:1px solid #e6eef0; }
    .action-footer { padding:12px 16px; }
    .btn-primary { background:#00535b; color:white; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; transition: background 0.2s ease; }
    .btn-primary:hover, .btn-primary:active { background:#0093a0; }
    .btn-secondary { background:#64748b; color:white; padding:10px 14px; border-radius:8px; border:none; }
    .btn-create { background:#0ea5a4; color:white; padding:8px 12px; border-radius:8px; border:none; }
    
    /* Billing Modal Buttons */
    .btn-checkout { background:#00535b; color:white; padding:12px 24px; border-radius:8px; border:none; cursor:pointer; font-weight:600; transition: all 0.2s ease; flex:1; }
    .btn-checkout:hover { background:#0093a0; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,83,91,0.2); }
    .btn-add-service { background:#0ea5a4; color:white; padding:12px 24px; border-radius:8px; border:none; cursor:pointer; font-weight:600; transition: all 0.2s ease; }
    .btn-add-service:hover { background:#0093a0; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(14,165,164,0.2); }
    .btn-cancel { background:#ef4444; color:white; padding:12px 24px; border-radius:8px; border:none; cursor:pointer; font-weight:600; transition: all 0.2s ease; }
    .btn-cancel:hover { background:#dc2626; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(239,68,68,0.2); }

    .search-input { padding:10px 12px; border-radius:12px; border:1px solid #e6eef0; width:360px; }
    .filter-select { padding:10px 12px; border-radius:12px; border:1px solid #e6eef0; background:white; cursor:pointer; min-width:140px; }

    .multi-dropdown { position:relative; }
    .dropdown-toggle { padding:10px 12px; border-radius:8px; border:1px solid #e6eef0; background:white; }
    .dropdown-panel { position:absolute; background:white; box-shadow:0 4px 12px rgba(2,6,23,0.12); border-radius:8px; padding:8px; margin-top:6px; z-index:50; max-height:200px; overflow:auto; width:320px; }
    .dropdown-item { display:block; padding:6px 8px; }

    .bill-summary { border-top:1px dashed #e6eef0; padding-top:10px; display:flex; flex-direction:column; gap:8px; }
    .bill-row { display:flex; justify-content:space-between; }
    .bill-row.total { font-weight:800; color:#064e3b; }
</style>

@code {
    private string SearchText = "";
    private string FilterStatus = "All";
    private string FilterFloor = "All";

    private bool ShowGuestModal = false;
    private bool ShowCheckOutModal = false;
    private bool ShowAddServiceModal = false;
    private bool ShowServicesDropdown = false;

    private List<RoomCard> Rooms = new();
    private List<Service> AvailableServices = new();
    private HashSet<int> SelectedServiceIds = new();
    private HashSet<int> AddServiceSelection = new();

    private RoomCard? SelectedRoom = null;

    private IEnumerable<int> Floors => Rooms.Select(r => r.Floor).Distinct().OrderBy(f => f);

    protected override async Task OnInitializedAsync()
    {
        await LoadRoomsFromDb();

        try
        {
            AvailableServices = await DbContext.Services.Where(s => s.Status == "Active").ToListAsync();
        }
        catch
        {
            AvailableServices = new List<Service>();
        }
    }

    private async Task LoadRoomsFromDb()
    {
        Rooms.Clear();
        try
        {
            var rooms = await DbContext.Rooms.Include(r => r.RoomType).AsNoTracking().ToListAsync();
            // load latest active reservation per room where status indicates checked in
            var reservations = await DbContext.Reservations.Where(r => r.Status == "Checked In").ToListAsync();
            var guests = await DbContext.Guests.ToListAsync();

            foreach (var rm in rooms)
            {
                var card = new RoomCard
                {
                    RoomNumber = rm.RoomNumber,
                    Floor = rm.Floor,
                    Status = rm.Status ?? "Available",
                    RoomCharge = rm.RoomType?.BasePrice ?? 0m
                };

                // find reservation for this room
                var reserved = await DbContext.ReservedRooms.FirstOrDefaultAsync(rr => rr.RoomID == rm.RoomID && reservations.Any(res => res.ReservationID == rr.ReservationID && res.Status == "Checked In"));
                if (reserved != null)
                {
                    var res = reservations.FirstOrDefault(r => r.ReservationID == reserved.ReservationID);
                    if (res != null)
                    {
                        var g = guests.FirstOrDefault(gg => gg.GuestID == res.GuestID);
                        card.GuestName = g?.FullName ?? "";
                        card.CheckInDate = res.CheckInDate;
                        card.CheckOutDate = res.CheckOutDate;
                        card.Status = res.Status == "Checked In" ? "Occupied" : card.Status;

                        // compute charges if needed
                        card.ServiceCharge = await DbContext.ServiceTransactions.Where(st => st.ReservationID == res.ReservationID).SumAsync(st => (decimal?)st.TotalAmount) ?? 0m;
                        card.TaxAmount = Math.Round((card.RoomCharge + card.ServiceCharge) * 0.12m, 2);
                        card.TotalDue = card.RoomCharge + card.ServiceCharge + card.TaxAmount;
                    }
                }

                Rooms.Add(card);
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", ex.Message);
            // fallback sample with proper guest data for occupied rooms
            Rooms = Enumerable.Range(101, 12).Select(i => 
            {
                var isOccupied = (i % 3 == 0 || i == 101);
                return new RoomCard 
                { 
                    RoomNumber = i.ToString(), 
                    Floor = i / 100, 
                    Status = isOccupied ? "Occupied" : "Available", 
                    RoomCharge = 2000m,
                    GuestName = isOccupied ? $"Guest {i}" : null,
                    CheckInDate = isOccupied ? DateTime.Today.AddDays(-1) : null,
                    CheckOutDate = isOccupied ? DateTime.Today.AddDays(2) : null,
                    ServiceCharge = 0m,
                    TaxAmount = isOccupied ? Math.Round(2000m * 0.12m, 2) : 0m,
                    TotalDue = isOccupied ? 2000m + Math.Round(2000m * 0.12m, 2) : 0m
                };
            }).ToList();
        }
    }

    private IEnumerable<RoomCard> FilteredRooms => Rooms.Where(r => (
        string.IsNullOrWhiteSpace(SearchText) || r.RoomNumber.Contains(SearchText, StringComparison.OrdinalIgnoreCase) || (r.GuestName ?? "").Contains(SearchText, StringComparison.OrdinalIgnoreCase))
        && (FilterStatus == "All" || r.Status == FilterStatus)
        && (FilterFloor == "All" || r.Floor.ToString() == FilterFloor));

    private void RefreshList()
    {
        _ = LoadRoomsFromDb();
    }

    private void OnRoomClicked(RoomCard room)
    {
        if (room.Status == "Occupied")
            OpenCheckOutModal(room);
        else if (room.Status == "Available")
            OpenGuestModal(room);
    }

    private void OpenGuestModal(RoomCard room)
    {
        SelectedRoom = room;
        // reset guest form
        GuestFirstName = ""; GuestLastName = ""; GuestEmail = ""; GuestContact = ""; GuestAddress = ""; GuestDOB = null;
        GuestCheckIn = DateTime.Today;
        GuestCheckOut = DateTime.Today.AddDays(1);
        SelectedServiceIds.Clear();
        ShowGuestModal = true;
    }

    private void CloseGuestModal()
    {
        ShowGuestModal = false;
        ShowServicesDropdown = false;
    }

    private void ToggleServicesDropdown()
    {
        ShowServicesDropdown = !ShowServicesDropdown;
    }

    private void ToggleServiceSelection(int id, bool select)
    {
        if (select) SelectedServiceIds.Add(id); else SelectedServiceIds.Remove(id);
    }

    private string GetSelectedServicesLabel()
    {
        if (!SelectedServiceIds.Any()) return "Select services...";
        var names = AvailableServices.Where(s => SelectedServiceIds.Contains(s.ServiceID)).Select(s => s.ServiceName).ToArray();
        return string.Join(", ", names);
    }

    // Guest form fields
    private string GuestFirstName = "";
    private string GuestLastName = "";
    private string GuestEmail = "";
    private string GuestContact = "";
    private DateTime? GuestDOB;
    private string GuestAddress = "";
    private DateTime GuestCheckIn = DateTime.Today;
    private DateTime GuestCheckOut = DateTime.Today.AddDays(1);

    private async Task SaveGuest()
    {
        if (SelectedRoom == null)
        {
            await JSRuntime.InvokeVoidAsync("alert", "No room selected");
            return;
        }

        // validations
        if (string.IsNullOrWhiteSpace(GuestFirstName) || string.IsNullOrWhiteSpace(GuestLastName) || string.IsNullOrWhiteSpace(GuestContact))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please fill required fields: First name, Last name, Contact number");
            return;
        }

        if (GuestCheckOut <= GuestCheckIn)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Check-out date must be after check-in date");
            return;
        }

        // find room entity
        var roomEntity = await DbContext.Rooms.FirstOrDefaultAsync(r => r.RoomNumber == SelectedRoom.RoomNumber);
        if (roomEntity == null)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Selected room not found in database");
            return;
        }

        if (roomEntity.Status != "Available")
        {
            await JSRuntime.InvokeVoidAsync("alert", "Room is not available");
            return;
        }

        // check overlapping reservations
        var overlap = await DbContext.Reservations
            .Join(DbContext.ReservedRooms, res => res.ReservationID, rr => rr.ReservationID, (res, rr) => new { res, rr })
            .Where(x => x.rr.RoomID == roomEntity.RoomID && x.res.Status == "Checked In")
            .AnyAsync();

        if (overlap)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Room is currently booked for the selected dates");
            return;
        }

        using var tx = await DbContext.Database.BeginTransactionAsync();
        try
        {
            // duplicate email check
            if (!string.IsNullOrWhiteSpace(GuestEmail))
            {
                var existing = await DbContext.Guests.FirstOrDefaultAsync(g => g.Email == GuestEmail);
                if (existing != null)
                {
                    // quick warning but continue - attach to existing guest
                    var proceed = await JSRuntime.InvokeAsync<bool>("confirm", "Email already exists for another guest. Continue and associate with existing record?");
                    if (!proceed) return;
                }
            }

            // create guest
            var guest = new Guest
            {
                FirstName = GuestFirstName,
                LastName = GuestLastName,
                Email = string.IsNullOrWhiteSpace(GuestEmail) ? null : GuestEmail,
                ContactNumber = GuestContact,
                Address = GuestAddress,
                DateOfBirth = GuestDOB,
                CreatedDate = DateTime.Now
            };
            DbContext.Guests.Add(guest);
            await DbContext.SaveChangesAsync();

            // calculate charges
            var nights = (GuestCheckOut - GuestCheckIn).Days;
            if (nights <= 0) nights = 1;
            var roomCharge = await CalculateRoomCharge(roomEntity.RoomID, GuestCheckIn, GuestCheckOut);
            var serviceTotal = AvailableServices.Where(s => SelectedServiceIds.Contains(s.ServiceID)).Sum(s => s.StandardPrice);
            var tax = Math.Round((roomCharge + serviceTotal) * 0.12m, 2);
            var grandTotal = roomCharge + serviceTotal + tax;

            // create reservation
            var reservation = new Reservation
            {
                GuestID = guest.GuestID,
                CheckInDate = GuestCheckIn,
                CheckOutDate = GuestCheckOut,
                Status = "Checked In",
                PaymentStatus = "Pending",
                TotalPayment = grandTotal,
                CreatedDate = DateTime.Now
            };

            DbContext.Reservations.Add(reservation);
            await DbContext.SaveChangesAsync();

            // reserved room
            var rr = new ReservedRoom { ReservationID = reservation.ReservationID, RoomID = roomEntity.RoomID };
            DbContext.ReservedRooms.Add(rr);
            await DbContext.SaveChangesAsync();

            // update room status
            roomEntity.Status = "Occupied";
            DbContext.Rooms.Update(roomEntity);
            await DbContext.SaveChangesAsync();

            // service transactions
            foreach (var svcId in SelectedServiceIds)
            {
                var svc = AvailableServices.FirstOrDefault(s => s.ServiceID == svcId);
                if (svc == null) continue;
                var st = new ServiceTransaction
                {
                    ReservationID = reservation.ReservationID,
                    ServiceID = svc.ServiceID,
                    Quantity = 1,
                    UnitPrice = svc.StandardPrice,
                    TotalAmount = svc.StandardPrice,
                    ServiceStatus = "Pending"
                };
                DbContext.ServiceTransactions.Add(st);
            }
            await DbContext.SaveChangesAsync();

            // bill detail
            var bill = new BillDetail
            {
                Description = $"Room {roomEntity.RoomNumber} charge",
                Quantity = nights,
                UnitPrice = roomCharge / nights,
                TotalAmount = roomCharge + serviceTotal + tax,
                TransactionDate = DateTime.Now
            };
            DbContext.BillDetails.Add(bill);
            await DbContext.SaveChangesAsync();

            // optional payment - none by default (Pending)

            await tx.CommitAsync();

            await JSRuntime.InvokeVoidAsync("alert", "Check-in successful");
            ShowGuestModal = false;
            await LoadRoomsFromDb();
        }
        catch (Exception ex)
        {
            await tx.RollbackAsync();
            await JSRuntime.InvokeVoidAsync("alert", $"Error during check-in: {ex.Message}");
        }
    }

    private void OpenAddServiceModal(RoomCard? room)
    {
        SelectedRoom = room;
        AddServiceSelection.Clear();
        ShowAddServiceModal = true;
    }

    private void CloseAddServiceModal()
    {
        ShowAddServiceModal = false;
    }

    private void ToggleAddServiceSelection(int id, bool select)
    {
        if (select) AddServiceSelection.Add(id); else AddServiceSelection.Remove(id);
    }

    private async Task SaveAddedServices()
    {
        if (SelectedRoom == null) return;
        var addedAmount = AvailableServices.Where(s => AddServiceSelection.Contains(s.ServiceID)).Sum(s => s.StandardPrice);
        SelectedRoom.ServiceCharge += addedAmount;
        SelectedRoom.TaxAmount = Math.Round((SelectedRoom.RoomCharge + SelectedRoom.ServiceCharge) * 0.12m, 2);
        SelectedRoom.TotalDue = SelectedRoom.RoomCharge + SelectedRoom.ServiceCharge + SelectedRoom.TaxAmount;
        ShowAddServiceModal = false;
        await JSRuntime.InvokeVoidAsync("alert", "Services added to room");
    }

    private void OpenCheckOutModal(RoomCard room)
    {
        SelectedRoom = room;
        // compute totals
        SelectedRoom.TaxAmount = Math.Round((SelectedRoom.RoomCharge + SelectedRoom.ServiceCharge) * 0.12m, 2);
        SelectedRoom.TotalDue = SelectedRoom.RoomCharge + SelectedRoom.ServiceCharge + SelectedRoom.TaxAmount;
        ShowCheckOutModal = true;
    }

    private void CloseCheckOutModal()
    {
        ShowCheckOutModal = false;
    }

    private async Task ProcessCheckOut()
    {
        if (SelectedRoom == null) return;
        // mark room available
        var roomEntity = await DbContext.Rooms.FirstOrDefaultAsync(r => r.RoomNumber == SelectedRoom.RoomNumber);
        if (roomEntity != null)
        {
            roomEntity.Status = "Available";
            DbContext.Rooms.Update(roomEntity);
            await DbContext.SaveChangesAsync();
        }

        SelectedRoom.Status = "Available";
        SelectedRoom.GuestName = null;
        SelectedRoom.CheckInDate = null;
        SelectedRoom.CheckOutDate = null;
        SelectedRoom.ServiceCharge = 0;
        SelectedRoom.TaxAmount = 0;
        SelectedRoom.TotalDue = 0;
        ShowCheckOutModal = false;
        await JSRuntime.InvokeVoidAsync("alert", "Check-out processed");
    }

    private string GetAvatarInitials(string roomNumber)
    {
        return new string(roomNumber.Take(2).ToArray());
    }

    private async Task<decimal> CalculateRoomCharge(int roomId, DateTime checkIn, DateTime checkOut)
    {
        var room = await DbContext.Rooms.Include(r => r.RoomType).FirstOrDefaultAsync(r => r.RoomID == roomId);
        if (room == null) return 0m;
        var nights = (checkOut - checkIn).Days;
        if (nights <= 0) nights = 1;
        var basePrice = room.RoomType?.BasePrice ?? 0m;
        return basePrice * nights;
    }

    private string GetOccupancyRate()
    {
        if (!Rooms.Any()) return "0";
        var occ = Rooms.Count(r => r.Status == "Occupied");
        return ((int)Math.Round(occ * 100.0 / Rooms.Count)).ToString();
    }

    public class RoomCard
    {
        public string RoomNumber { get; set; } = string.Empty;
        public int Floor { get; set; } = 1;
        public string Status { get; set; } = "Available";
        public string? GuestName { get; set; }
        public DateTime? CheckInDate { get; set; }
        public DateTime? CheckOutDate { get; set; }
        public decimal RoomCharge { get; set; }
        public decimal ServiceCharge { get; set; }
        public decimal TaxAmount { get; set; }
        public decimal TotalDue { get; set; }
    }
}