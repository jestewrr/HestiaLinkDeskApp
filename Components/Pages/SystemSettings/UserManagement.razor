@page "/settings/user-management"
@using Microsoft.EntityFrameworkCore
@using System.Data
@inject HestiaLinkContext Context
@inject IJSRuntime JSRuntime
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>User Management</h1>
        <span class="page-topbar-subtitle">System Administrator</span>
    </header>

    <!-- Error Alert Banner -->
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="error-banner">
            <span class="error-icon">‚ö†Ô∏è</span>
            <span class="error-message">@ErrorMessage</span>
            <button class="error-close" @onclick="ClearError">√ó</button>
        </div>
    }

    <!-- Loading Indicator -->
    @if (!IsLoaded)
    {
        <div class="loading-overlay">
            <div class="loading-spinner"></div>
            <p>Loading user data...</p>
        </div>
    }

    <section class="page-content">
        <div class="user-toolbar">
            <div class="toolbar-left">
                <div class="toolbar-search">
                    <input type="text" placeholder="Search users by name, ID, role, or employee ID..."
                           @bind="SearchText"
                           @oninput="OnSearchChanged"
                           @onkeydown="HandleKeyDown" />
                    <span class="search-icon">üîç</span>
                    @if (!string.IsNullOrEmpty(SearchText))
                    {
                        <button class="clear-search" @onclick="ClearSearch" title="Clear search">
                            √ó
                        </button>
                    }
                </div>
                <select class="filter-select" @bind="FilterRole">
                    <option value="All">All Roles</option>
                    <option value="Administrator">Administrator</option>
                    <option value="Manager">Manager</option>
                    <option value="FrontDesk">FrontDesk</option>
                    <option value="Housekeeping">Housekeeping</option>
                    <option value="Inventory">Inventory</option>
                    <option value="HR">HR</option>
                </select>
                <select class="filter-select" @bind="SortBy">
                    <option value="Username">Sort by Name</option>
                    <option value="Role">Sort by Role</option>
                    <option value="EmployeeId">Sort by Employee ID</option>
                    <option value="UserId">Sort by User ID</option>
                </select>
            </div>
            <div>
                <button class="btn-secondary" @onclick="OpenArchivedModal" disabled="@(!IsLoaded || IsProcessing)">
                     View Archived (@ArchivedUsersCount)
                </button>
                <button class="btn-create" @onclick="OpenCreateModal" disabled="@(!IsLoaded || IsProcessing)">
                    New User
                </button>
            </div>
        </div>

        <!-- Search Results Info -->
        @if (IsLoaded && !string.IsNullOrEmpty(SearchText))
        {
            <div class="search-results-info">
                <span>
                    Found @FilteredUsers.Count users matching "<strong>@SearchText</strong>"
                    @if (FilterRole != "All")
                    {
                        <text> in role <strong>@FilterRole</strong></text>
                    }
                </span>
                <button class="btn-link" @onclick="ClearSearch">Clear search</button>
            </div>
        }

        <!-- Enhanced Card Layout -->
        <div class="user-grid-container">
            @if (FilteredUsers.Any())
            {
                <div class="user-grid">
                    @foreach (var user in FilteredUsers)
                    {
                        <div class="user-card @(SelectedUser?.UserId == user.UserId ? "selected-card" : "")">
                            <div class="user-card-header">
                                <div class="user-avatar">
                                    @GetInitials(user.Username)
                                </div>
                                <div class="user-info">
                                    <h3 class="username">@user.Username</h3>
                                    <span class="user-id">ID: @user.UserId</span>
                                </div>
                                <div class="user-status">
                                    <span class="@(user.Status == "Active" ? "badge-active" : "badge-inactive")">
                                        @(user.Status == "Active" ? "Active" : "Archived")
                                    </span>
                                </div>
                            </div>

                            <div class="user-details">
                                <div class="detail-item">
                                    <span class="detail-label">Employee ID:</span>
                                    <span class="detail-value">@(user.EmployeeID?.ToString() ?? "N/A")</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Role:</span>
                                    <span class="user-role @(user.Role?.ToLower() ?? "")">@user.Role</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Created:</span>
                                    <span class="detail-value">@(user.CreatedAt.HasValue ? user.CreatedAt.Value.ToString("MMM dd, yyyy") : "--")</span>
                                </div>
                            </div>

                            @if (user.Status == "Active")
                            {
                                <div class="user-actions">
                                    <button class="btn-icon-action edit" @onclick="() => SelectAndEdit(user)" title="Edit User" disabled="@IsProcessing">
                                        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                    </button>
                                    <button class="btn-icon-action archive" @onclick="() => PromptArchive(user)" title="Archive User" disabled="@IsProcessing">
                                        <svg viewBox="0 0 24 24"><path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM6.24 5h11.52l.81.97H5.44l.8-.97zM5 19V8h14v11H5zm8.45-9h-2.9v3H8l4 4 4-4h-2.55z"/></svg>
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else if (IsLoaded)
            {
                <div class="no-users-message">
                    <div class="no-users-icon">üë§</div>
                    <h3>No users found</h3>
                    <p>
                        @if (!string.IsNullOrEmpty(SearchText))
                        {
                            <text>No users found matching "<strong>@SearchText</strong>". Try adjusting your search terms.</text>
                        }
                        else if (FilterRole != "All")
                        {
                            <text>No active users found with role <strong>@FilterRole</strong>.</text>
                        }
                        else
                        {
                            <text>Create your first user to get started.</text>
                        }
                    </p>
                    @if (string.IsNullOrEmpty(SearchText) && FilterRole == "All")
                    {
                        <button class="btn-create" @onclick="OpenCreateModal" disabled="@IsProcessing">
                            + Create New User
                        </button>
                    }
                    else
                    {
                        <button class="btn-secondary" @onclick="ClearFilters">
                            Clear Filters
                        </button>
                    }
                </div>
            }
        </div>
    </section>
</div>

<!-- Create/Edit User Modal -->
@if (ShowCreateModal || ShowEditModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">@(ShowCreateModal ? "Create New User" : "Edit User")</h2>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Employee</label>
                    <select class="form-select" @bind="CurrentUser.EmployeeId" disabled="@IsProcessing">
                        <option value="">-- Select Employee --</option>
                        @foreach (var emp in AvailableEmployees)
                        {
                            <option value="@emp.EmployeeId">@emp.EmployeeId - @emp.FirstName @emp.LastName</option>
                        }
                        @if (ShowEditModal && SelectedUser != null && SelectedUser.EmployeeId != null && !AvailableEmployees.Any(e => e.EmployeeId == SelectedUser.EmployeeId))
                        {
                            var selEmp = Employees.FirstOrDefault(e => e.EmployeeId == SelectedUser.EmployeeId);
                            if (selEmp != null)
                            {
                                <option value="@selEmp.EmployeeId" selected>@selEmp.EmployeeId - @selEmp.FirstName @selEmp.LastName</option>
                            }
                        }
                    </select>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" @bind="CurrentUser.Username" disabled="@IsProcessing" />
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" @bind="CurrentUser.Password" 
                           placeholder="@(ShowEditModal ? "Leave blank to keep current password" : "")" 
                           disabled="@IsProcessing" />
                </div>

                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-select" @bind="CurrentUser.Role" disabled="@IsProcessing">
                        <option value="Administrator">Administrator</option>
                        <option value="Manager">Manager</option>
                        <option value="FrontDesk">FrontDesk</option>
                        <option value="Housekeeping">Housekeeping</option>
                        <option value="Inventory">Inventory</option>
                        <option value="HR">HR</option>
                    </select>
                </div>
            </div>

            <div class="action-footer" style="border:none; padding-bottom:0; margin-top:10px;">
                <button class="btn-primary" @onclick="SaveUser" disabled="@IsProcessing">
                    @if (IsProcessing)
                    {
                        <span class="loading-spinner-small"></span>
                    }
                    @(ShowCreateModal ? "Create User" : "Save Changes")
                </button>
                <button class="btn-secondary" @onclick="CloseModals" disabled="@IsProcessing">Cancel</button>
            </div>
        </div>
    </div>
}

<!-- Archived Users Modal -->
@if (ShowArchivedModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">üì¶ Archived Users</h2>
                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8); margin-top: 4px;">@ArchivedUsers.Count archived users</div>
            </div>

            <div class="panel-body" style="max-height:60vh; overflow-y:auto;">
                @if (ArchivedUsers.Any())
                {
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Employee</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th style="text-align:center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in ArchivedUsers)
                            {
                                <tr>
                                    <td>@user.UserID</td>
                                    <td>@(user.EmployeeID?.ToString() ?? "N/A")</td>
                                    <td style="font-weight:700;">@user.Username</td>
                                    <td>@user.Role</td>
                                    <td style="text-align:center;">
                                        <button class="btn-secondary" style="background:#10b981; color: white;" 
                                                @onclick="() => RestoreUser(user)" disabled="@IsProcessing">
                                            ‚úÖ Restore
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="no-data" style="padding:40px; text-align: center; color: #64748b;">No archived users</div>
                }
            </div>

            <div class="action-footer" style="border:none; padding-bottom:0; margin-top:10px;">
                <button class="btn-secondary" @onclick="CloseArchivedModal" disabled="@IsProcessing">Close</button>
            </div>
        </div>
    </div>
}

<!-- Archive Confirmation Modal -->
@if (ShowArchiveConfirm)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width:420px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.2rem;">‚ö†Ô∏è Confirm Archive</h2>
            </div>
            <div style="padding:20px;">
                <p>Are you sure you want to archive user <strong>@(ArchiveTarget?.Username)</strong>?</p>
                <p style="color:#f59e0b; font-size:0.9rem;">Archived users will not appear in active lists but can be restored later.</p>
            </div>
            <div class="action-footer" style="border:none; padding-bottom:0;">
                <button class="btn-secondary" style="background:#f59e0b; color: white;" @onclick="ConfirmArchive" disabled="@IsProcessing">
                    @if (IsProcessing)
                    {
                        <span class="loading-spinner-small"></span>
                    }
                    Archive
                </button>
                <button class="btn-secondary" @onclick="CancelArchive" disabled="@IsProcessing">Cancel</button>
            </div>
        </div>
    </div>
}

@code {
    private string SearchText { get; set; } = "";
    private string FilterRole { get; set; } = "All";
    private string SortBy { get; set; } = "Username";
    private bool ShowCreateModal = false;
    private bool ShowEditModal = false;
    private bool ShowArchivedModal = false;
    private bool IsLoaded = false;
    private bool IsProcessing = false;
    private string ErrorMessage = string.Empty;

    private SystemUser? SelectedUser;
    private SystemUser CurrentUser = new();

    private List<SystemUser> Users = new();
    private List<Employee> Employees = new();
    private List<Employee> AvailableEmployees = new();

    // Search debouncing
    private System.Threading.Timer? SearchTimer;
    private const int SearchDelay = 300; // milliseconds

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        IsLoaded = true;
    }

    private async Task LoadData()
    {
        try
        {
            IsProcessing = true;
            StateHasChanged();

            // Try to load users - fall back to raw SQL if EF fails due to missing columns
            Users = await LoadUsersAsync();
            Employees = await Context.Employees.AsNoTracking().OrderBy(e => e.LastName).ToListAsync();
            await LoadAvailableEmployeesAsync();
            
            ClearError();
        }
        catch (Exception ex)
        {
            HandleError($"Failed to load user data: {ex.Message}", ex);
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Loads users with fallback to raw SQL if EF query fails (e.g., missing IsAvailable column)
    /// </summary>
    private async Task<List<SystemUser>> LoadUsersAsync()
    {
        try
        {
            // Try EF Core first
            return await Context.SystemUsers.AsNoTracking().OrderBy(u => u.Username).ToListAsync();
        }
        catch (Exception efEx)
        {
            Console.WriteLine($"EF query failed for SystemUsers: {efEx.Message}. Falling back to raw SQL.");
            return await LoadUsersRawAsync();
        }
    }

    /// <summary>
    /// Fallback method to load users using raw SQL (avoids missing column issues)
    /// </summary>
    private async Task<List<SystemUser>> LoadUsersRawAsync()
    {
        var users = new List<SystemUser>();
        try
        {
            var conn = Context.Database.GetDbConnection();
            if (conn.State != ConnectionState.Open)
                await conn.OpenAsync();

            // Check which columns exist
            using var checkCmd = conn.CreateCommand();
            checkCmd.CommandText = @"
                SELECT COLUMN_NAME 
                FROM INFORMATION_SCHEMA.COLUMNS 
                WHERE TABLE_NAME = 'SystemUser'";
            
            var existingColumns = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            using (var reader = await checkCmd.ExecuteReaderAsync())
            {
                while (await reader.ReadAsync())
                {
                    existingColumns.Add(reader.GetString(0));
                }
            }

            // Build SELECT with only existing columns
            var selectColumns = new List<string> { "UserID", "Username", "Password", "Role", "Status" };
            if (existingColumns.Contains("EmployeeID")) selectColumns.Add("EmployeeID");
            if (existingColumns.Contains("CreatedAt")) selectColumns.Add("CreatedAt");
            if (existingColumns.Contains("UpdatedAt")) selectColumns.Add("UpdatedAt");
            if (existingColumns.Contains("IsAvailable")) selectColumns.Add("IsAvailable");

            using var cmd = conn.CreateCommand();
            cmd.CommandText = $"SELECT {string.Join(", ", selectColumns)} FROM SystemUser ORDER BY Username";

            using var dataReader = await cmd.ExecuteReaderAsync();
            while (await dataReader.ReadAsync())
            {
                var user = new SystemUser
                {
                    UserID = dataReader.GetInt32(dataReader.GetOrdinal("UserID")),
                    Username = dataReader.GetString(dataReader.GetOrdinal("Username")),
                    Password = dataReader.GetString(dataReader.GetOrdinal("Password")),
                    Role = dataReader.GetString(dataReader.GetOrdinal("Role")),
                    Status = dataReader.GetString(dataReader.GetOrdinal("Status")),
                    IsAvailable = true // Default value
                };

                if (existingColumns.Contains("EmployeeID") && !dataReader.IsDBNull(dataReader.GetOrdinal("EmployeeID")))
                    user.EmployeeID = dataReader.GetInt32(dataReader.GetOrdinal("EmployeeID"));

                if (existingColumns.Contains("CreatedAt") && !dataReader.IsDBNull(dataReader.GetOrdinal("CreatedAt")))
                    user.CreatedAt = dataReader.GetDateTime(dataReader.GetOrdinal("CreatedAt"));

                if (existingColumns.Contains("UpdatedAt") && !dataReader.IsDBNull(dataReader.GetOrdinal("UpdatedAt")))
                    user.UpdatedAt = dataReader.GetDateTime(dataReader.GetOrdinal("UpdatedAt"));

                if (existingColumns.Contains("IsAvailable") && !dataReader.IsDBNull(dataReader.GetOrdinal("IsAvailable")))
                    user.IsAvailable = dataReader.GetBoolean(dataReader.GetOrdinal("IsAvailable"));

                users.Add(user);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Raw SQL query also failed: {ex.Message}");
            throw;
        }
        return users;
    }

    private async Task LoadAvailableEmployeesAsync()
    {
        try
        {
            // Use in-memory filtering to avoid complex EF queries that might fail
            var activeEmployeeIds = Users
                .Where(u => u.Status == "Active" && u.EmployeeID != null)
                .Select(u => u.EmployeeID)
                .ToHashSet();

            AvailableEmployees = Employees
                .Where(emp => emp.Status == "Active" && !activeEmployeeIds.Contains(emp.EmployeeID))
                .OrderBy(e => e.LastName)
                .ToList();
        }
        catch (Exception ex)
        {
            LogWarning("Error loading available employees", ex);
            AvailableEmployees = new List<Employee>();
        }
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        try
        {
            SearchTimer?.Dispose();
            SearchTimer = new System.Threading.Timer(async _ =>
            {
                await InvokeAsync(() => StateHasChanged());
                SearchTimer?.Dispose();
            }, null, SearchDelay, System.Threading.Timeout.Infinite);
        }
        catch (Exception ex)
        {
            HandleError("Error processing search input", ex);
        }
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        try
        {
            if (e.Key == "Escape")
            {
                ClearSearch();
            }
            else if (e.Key == "Enter")
            {
                SearchTimer?.Dispose();
                SearchTimer = null;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            HandleError("Error handling keyboard input", ex);
        }
    }

    private void ClearSearch()
    {
        try
        {
            SearchText = string.Empty;
            SearchTimer?.Dispose();
            SearchTimer = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            HandleError("Error clearing search", ex);
        }
    }

    private void ClearFilters()
    {
        try
        {
            SearchText = string.Empty;
            FilterRole = "All";
            SortBy = "Username";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            HandleError("Error clearing filters", ex);
        }
    }

    private List<SystemUser> FilteredUsers
    {
        get
        {
            try
            {
                var query = Users.Where(u => u.Status == "Active");

                if (!string.IsNullOrEmpty(SearchText))
                {
                    var searchTerm = SearchText.Trim().ToLower();
                    query = query.Where(u => 
                        (u.Username?.ToLower().Contains(searchTerm) ?? false) ||
                        (u.Role?.ToLower().Contains(searchTerm) ?? false) ||
                        (u.EmployeeID != null && u.EmployeeID.ToString()!.ToLower().Contains(searchTerm)) ||
                        u.UserID.ToString().ToLower().Contains(searchTerm)
                    );
                }

                if (FilterRole != "All")
                {
                    query = query.Where(u => u.Role == FilterRole);
                }

                query = SortBy switch
                {
                    "Role" => query.OrderBy(u => u.Role).ThenBy(u => u.Username),
                    "EmployeeID" => query.OrderBy(u => u.EmployeeID),
                    "UserID" => query.OrderBy(u => u.UserID),
                    _ => query.OrderBy(u => u.Username)
                };

                return query.ToList();
            }
            catch (Exception ex)
            {
                HandleError("Error filtering users", ex);
                return new List<SystemUser>();
            }
        }
    }

    private List<SystemUser> ArchivedUsers 
    {
        get
        {
            try
            {
                return Users.Where(u => u.Status == "Archived").OrderBy(u => u.Username).ToList();
            }
            catch (Exception ex)
            {
                HandleError("Error loading archived users", ex);
                return new List<SystemUser>();
            }
        }
    }
    
    private int ArchivedUsersCount => ArchivedUsers.Count;

    private string GetInitials(string username)
    {
        try
        {
            if (string.IsNullOrEmpty(username)) return "??";
            var parts = username.Split(' ', '.', '_');
            if (parts.Length >= 2)
                return $"{parts[0][0]}{parts[1][0]}".ToUpper();
            return username.Length >= 2 ? username.Substring(0, 2).ToUpper() : username.ToUpper();
        }
        catch
        {
            return "??";
        }
    }

    private void SelectAndEdit(SystemUser user)
    {
        try
        {
            SelectedUser = user;
            CurrentUser = new SystemUser
            {
                UserId = user.UserId,
                EmployeeId = user.EmployeeId,
                Username = user.Username,
                Password = "",
                Role = user.Role,
                CreatedAt = user.CreatedAt,
                UpdatedAt = user.UpdatedAt,
                Status = user.Status
            };
            ShowEditModal = true;
            ShowCreateModal = false;
        }
        catch (Exception ex)
        {
            HandleError("Error preparing user for editing", ex);
        }
    }

    private async Task OpenCreateModal()
    {
        try
        {
            CurrentUser = new SystemUser { Status = "Active", CreatedAt = DateTime.Now, Role = "FrontDesk" };
            await LoadAvailableEmployeesAsync();
            ShowCreateModal = true;
            ShowEditModal = false;
        }
        catch (Exception ex)
        {
            HandleError("Error opening create user modal", ex);
        }
    }

    private void CloseModals()
    {
        ShowCreateModal = false;
        ShowEditModal = false;
        ClearError();
    }

    private async Task SaveUser()
    {
        try
        {
            IsProcessing = true;
            StateHasChanged();

            var validationError = ValidateUser(CurrentUser, ShowCreateModal);
            if (!string.IsNullOrEmpty(validationError))
            {
                await ShowAlert(validationError);
                return;
            }

            var duplicateError = await CheckForDuplicates(CurrentUser);
            if (!string.IsNullOrEmpty(duplicateError))
            {
                await ShowAlert(duplicateError);
                return;
            }

            if (ShowCreateModal)
            {
                await CreateUserAsync();
            }
            else if (ShowEditModal)
            {
                await UpdateUserAsync();
            }

            CloseModals();
        }
        catch (Exception ex)
        {
            HandleError($"Error saving user: {ex.Message}", ex);
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    private string ValidateUser(SystemUser user, bool isCreate)
    {
        if (user.EmployeeId == null)
            return "Please select an Employee before saving.";
            
        if (string.IsNullOrWhiteSpace(user.Username))
            return "Username is required.";
            
        if (user.Username.Length < 3)
            return "Username must be at least 3 characters long.";
            
        if (isCreate && string.IsNullOrWhiteSpace(user.Password))
            return "Password is required for new users.";
            
        if (!string.IsNullOrWhiteSpace(user.Password) && user.Password.Length < 6)
            return "Password must be at least 6 characters long.";

        return string.Empty;
    }

    private async Task<string> CheckForDuplicates(SystemUser user)
    {
        try
        {
            // Check in memory to avoid EF query issues
            var usernameTaken = Users.Any(u => 
                u.Username.Equals(user.Username, StringComparison.OrdinalIgnoreCase) && 
                u.UserID != user.UserID);
            if (usernameTaken)
                return "Username already exists. Choose a different username.";

            var employeeAssigned = Users.Any(u => 
                u.EmployeeID == user.EmployeeID && 
                u.UserID != user.UserID && 
                u.Status == "Active");
            if (employeeAssigned)
                return "Selected employee already has an active user account.";

            return string.Empty;
        }
        catch (Exception ex)
        {
            LogWarning("Error checking for duplicates", ex);
            return string.Empty;
        }
    }

    private async Task CreateUserAsync()
    {
        try
        {
            // Use raw SQL to insert to avoid column issues
            var conn = Context.Database.GetDbConnection();
            if (conn.State != ConnectionState.Open)
                await conn.OpenAsync();

            // Check if IsAvailable column exists
            using var checkCmd = conn.CreateCommand();
            checkCmd.CommandText = @"
                SELECT COLUMN_NAME 
                FROM INFORMATION_SCHEMA.COLUMNS 
                WHERE TABLE_NAME = 'SystemUser' AND COLUMN_NAME = 'IsAvailable'";
            var hasIsAvailable = await checkCmd.ExecuteScalarAsync() != null;

            using var cmd = conn.CreateCommand();
            if (hasIsAvailable)
            {
                cmd.CommandText = @"
                    INSERT INTO SystemUser (EmployeeID, Username, Password, Role, CreatedAt, Status, IsAvailable)
                    VALUES (@EmployeeID, @Username, @Password, @Role, @CreatedAt, @Status, @IsAvailable)";
            }
            else
            {
                cmd.CommandText = @"
                    INSERT INTO SystemUser (EmployeeID, Username, Password, Role, CreatedAt, Status)
                    VALUES (@EmployeeID, @Username, @Password, @Role, @CreatedAt, @Status)";
            }

            var empParam = cmd.CreateParameter();
            empParam.ParameterName = "@EmployeeID";
            empParam.Value = CurrentUser.EmployeeID ?? (object)DBNull.Value;
            cmd.Parameters.Add(empParam);

            var userParam = cmd.CreateParameter();
            userParam.ParameterName = "@Username";
            userParam.Value = CurrentUser.Username;
            cmd.Parameters.Add(userParam);

            var passParam = cmd.CreateParameter();
            passParam.ParameterName = "@Password";
            passParam.Value = CurrentUser.Password;
            cmd.Parameters.Add(passParam);

            var roleParam = cmd.CreateParameter();
            roleParam.ParameterName = "@Role";
            roleParam.Value = CurrentUser.Role;
            cmd.Parameters.Add(roleParam);

            var createdParam = cmd.CreateParameter();
            createdParam.ParameterName = "@CreatedAt";
            createdParam.Value = DateTime.Now;
            cmd.Parameters.Add(createdParam);

            var statusParam = cmd.CreateParameter();
            statusParam.ParameterName = "@Status";
            statusParam.Value = "Active";
            cmd.Parameters.Add(statusParam);

            if (hasIsAvailable)
            {
                var availParam = cmd.CreateParameter();
                availParam.ParameterName = "@IsAvailable";
                availParam.Value = true;
                cmd.Parameters.Add(availParam);
            }

            await cmd.ExecuteNonQueryAsync();
            await LoadData();
            await ShowAlert("User created successfully!");
        }
        catch (Exception ex)
        {
            throw new Exception($"Failed to create user: {ex.Message}", ex);
        }
    }

    private async Task UpdateUserAsync()
    {
        try
        {
            var conn = Context.Database.GetDbConnection();
            if (conn.State != ConnectionState.Open)
                await conn.OpenAsync();

            using var cmd = conn.CreateCommand();
            
            // Build UPDATE dynamically - don't update password if blank
            var setClauses = new List<string>
            {
                "EmployeeID = @EmployeeID",
                "Username = @Username",
                "Role = @Role",
                "UpdatedAt = @UpdatedAt"
            };

            if (!string.IsNullOrWhiteSpace(CurrentUser.Password))
            {
                setClauses.Add("Password = @Password");
            }

            cmd.CommandText = $"UPDATE SystemUser SET {string.Join(", ", setClauses)} WHERE UserID = @UserID";

            var userIdParam = cmd.CreateParameter();
            userIdParam.ParameterName = "@UserID";
            userIdParam.Value = CurrentUser.UserID;
            cmd.Parameters.Add(userIdParam);

            var empParam = cmd.CreateParameter();
            empParam.ParameterName = "@EmployeeID";
            empParam.Value = CurrentUser.EmployeeID ?? (object)DBNull.Value;
            cmd.Parameters.Add(empParam);

            var userParam = cmd.CreateParameter();
            userParam.ParameterName = "@Username";
            userParam.Value = CurrentUser.Username;
            cmd.Parameters.Add(userParam);

            var roleParam = cmd.CreateParameter();
            roleParam.ParameterName = "@Role";
            roleParam.Value = CurrentUser.Role;
            cmd.Parameters.Add(roleParam);

            var updatedParam = cmd.CreateParameter();
            updatedParam.ParameterName = "@UpdatedAt";
            updatedParam.Value = DateTime.Now;
            cmd.Parameters.Add(updatedParam);

            if (!string.IsNullOrWhiteSpace(CurrentUser.Password))
            {
                var passParam = cmd.CreateParameter();
                passParam.ParameterName = "@Password";
                passParam.Value = CurrentUser.Password;
                cmd.Parameters.Add(passParam);
            }

            await cmd.ExecuteNonQueryAsync();
            await LoadData();
            await ShowAlert("User updated successfully!");
        }
        catch (Exception ex)
        {
            throw new Exception($"Failed to update user: {ex.Message}", ex);
        }
    }

    // Archive flow
    private SystemUser? ArchiveTarget;
    private bool ShowArchiveConfirm = false;

    private void PromptArchive(SystemUser user)
    {
        ArchiveTarget = user;
        ShowArchiveConfirm = true;
    }

    private void CancelArchive()
    {
        ShowArchiveConfirm = false;
        ArchiveTarget = null;
    }

    private async Task ConfirmArchive()
    {
        try
        {
            IsProcessing = true;
            StateHasChanged();

            if (ArchiveTarget != null)
            {
                var conn = Context.Database.GetDbConnection();
                if (conn.State != ConnectionState.Open)
                    await conn.OpenAsync();

                using var cmd = conn.CreateCommand();
                cmd.CommandText = "UPDATE SystemUser SET Status = 'Archived', UpdatedAt = @UpdatedAt WHERE UserID = @UserID";
                
                var userIdParam = cmd.CreateParameter();
                userIdParam.ParameterName = "@UserID";
                userIdParam.Value = ArchiveTarget.UserID;
                cmd.Parameters.Add(userIdParam);

                var updatedParam = cmd.CreateParameter();
                updatedParam.ParameterName = "@UpdatedAt";
                updatedParam.Value = DateTime.Now;
                cmd.Parameters.Add(updatedParam);

                await cmd.ExecuteNonQueryAsync();
                await LoadData();
                await ShowAlert("User archived successfully!");
            }
        }
        catch (Exception ex)
        {
            HandleError($"Error archiving user: {ex.Message}", ex);
        }
        finally
        {
            IsProcessing = false;
            ShowArchiveConfirm = false;
            ArchiveTarget = null;
            StateHasChanged();
        }
    }

    private void OpenArchivedModal()
    {
        ShowArchivedModal = true;
    }

    private void CloseArchivedModal()
    {
        ShowArchivedModal = false;
    }

    private async Task RestoreUser(SystemUser user)
    {
        try
        {
            IsProcessing = true;
            StateHasChanged();

            // Check if employee is still available
            var employee = Employees.FirstOrDefault(e => e.EmployeeID == user.EmployeeID);
            if (employee == null || employee.Status != "Active")
            {
                await ShowAlert("Cannot restore user: Associated employee is no longer active.");
                return;
            }

            var conn = Context.Database.GetDbConnection();
            if (conn.State != ConnectionState.Open)
                await conn.OpenAsync();

            using var cmd = conn.CreateCommand();
            cmd.CommandText = "UPDATE SystemUser SET Status = 'Active', UpdatedAt = @UpdatedAt WHERE UserID = @UserID";
            
            var userIdParam = cmd.CreateParameter();
            userIdParam.ParameterName = "@UserID";
            userIdParam.Value = user.UserID;
            cmd.Parameters.Add(userIdParam);

            var updatedParam = cmd.CreateParameter();
            updatedParam.ParameterName = "@UpdatedAt";
            updatedParam.Value = DateTime.Now;
            cmd.Parameters.Add(updatedParam);

            await cmd.ExecuteNonQueryAsync();
            await LoadData();
            await ShowAlert("User restored successfully!");
        }
        catch (Exception ex)
        {
            HandleError($"Error restoring user: {ex.Message}", ex);
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    private void HandleError(string userMessage, Exception? ex = null)
    {
        ErrorMessage = userMessage;
        if (ex != null)
        {
            Console.WriteLine($"User Management Error: {ex.Message}");
            Console.WriteLine($"Stack Trace: {ex.StackTrace}");
        }
        StateHasChanged();
    }

    private void ClearError()
    {
        ErrorMessage = string.Empty;
    }

    private void LogWarning(string message, Exception? ex = null)
    {
        Console.WriteLine($"User Management Warning: {message}");
        if (ex != null)
        {
            Console.WriteLine($"Warning Details: {ex.Message}");
        }
    }

    private async Task ShowAlert(string message)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("alert", message);
        }
        catch
        {
            ErrorMessage = message;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        SearchTimer?.Dispose();
    }
}

<style>
    /* ... existing styles ... */
    .page-wrapper {
        padding: 20px;
        background: #f8fafc;
        min-height: 100vh;
    }

    .page-topbar {
        margin-bottom: 24px;
    }

    .page-topbar h1 {
        margin: 0;
        color: #0f766e;
        font-size: 1.8rem;
    }

    .page-topbar-subtitle {
        color: #64748b;
        font-size: 0.9rem;
    }

    .error-banner {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 12px 16px;
        border-radius: 6px;
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .error-icon { font-size: 1.2em; }
    .error-message { flex: 1; }
    .error-close {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: #dc2626;
        padding: 0;
        width: 24px;
        height: 24px;
    }

    .loading-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #0f766e;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    .loading-spinner-small {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top: 2px solid #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
    }

    .user-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .toolbar-left {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    .toolbar-search {
        position: relative;
        display: flex;
        align-items: center;
    }

    .toolbar-search input {
        padding: 10px 40px 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        width: 320px;
        font-size: 0.9rem;
    }

    .search-icon {
        position: absolute;
        right: 12px;
        color: #64748b;
    }

    .clear-search {
        position: absolute;
        right: 35px;
        background: none;
        border: none;
        font-size: 1.2em;
        cursor: pointer;
        color: #64748b;
        padding: 4px;
        border-radius: 50%;
        width: 24px;
        height: 24px;
    }

    .filter-select {
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9rem;
        background: white;
    }

    .btn-create {
        background: #0f766e;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-create:hover:not(:disabled) {
        background: #0d9488;
    }

    .btn-secondary {
        background: white;
        color: #475569;
        border: 1px solid #e5e7eb;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-primary {
        background: #0f766e;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    .search-results-info {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 12px 16px;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9em;
        color: #475569;
    }

    .btn-link {
        background: none;
        border: none;
        color: #0f766e;
        cursor: pointer;
        text-decoration: underline;
        font-size: 0.9em;
    }

    .user-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
    }

    .user-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: all 0.2s ease;
    }

    .user-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .user-card.selected-card {
        border-color: #0f766e;
        box-shadow: 0 0 0 2px rgba(15, 118, 110, 0.2);
    }

    .user-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .user-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #0f766e, #06b6d4);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .user-info {
        flex: 1;
    }

    .username {
        margin: 0;
        font-size: 1.1rem;
        color: #1e293b;
    }

    .user-id {
        font-size: 0.8rem;
        color: #64748b;
    }

    .badge-active {
        background: #d1fae5;
        color: #065f46;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge-inactive {
        background: #fee2e2;
        color: #991b1b;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .user-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
    }

    .detail-label {
        color: #64748b;
    }

    .detail-value {
        color: #1e293b;
        font-weight: 500;
    }

    .user-role {
        font-weight: 600;
    }

    .user-role.administrator { color: #dc2626; }
    .user-role.manager { color: #ea580c; }
    .user-role.frontdesk { color: #16a34a; }
    .user-role.housekeeping { color: #9333ea; }
    .user-role.inventory { color: #0ea5e9; }
    .user-role.hr { color: #f59e0b; }

    .user-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    .btn-icon-action {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .btn-icon-action svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
    }

    .btn-icon-action.edit {
        background: #dbeafe;
        color: #2563eb;
    }

    .btn-icon-action.edit:hover:not(:disabled) {
        background: #bfdbfe;
    }

    .btn-icon-action.archive {
        background: #fef3c7;
        color: #d97706;
    }

    .btn-icon-action.archive:hover:not(:disabled) {
        background: #fde68a;
    }

    .no-users-message {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
    }

    .no-users-icon {
        font-size: 4rem;
        margin-bottom: 16px;
    }

    .no-users-message h3 {
        color: #1e293b;
        margin: 0 0 8px 0;
    }

    .no-users-message p {
        color: #64748b;
        margin: 0 0 20px 0;
    }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header-teal {
        background: linear-gradient(135deg, #0f766e, #064e3b);
        color: white;
        padding: 20px 24px;
        border-radius: 12px 12px 0 0;
    }

    .form-grid {
        padding: 24px;
        display: grid;
        gap: 16px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-label {
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
    }

    .form-input, .form-select {
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.95rem;
    }

    .action-footer {
        padding: 16px 24px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        border-top: 1px solid #e5e7eb;
    }

    .user-table {
        width: 100%;
        border-collapse: collapse;
    }

    .user-table th, .user-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }

    .user-table th {
        background: #f8fafc;
        font-weight: 600;
        color: #475569;
    }

    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @@media (max-width: 768px) {
        .toolbar-search input {
            width: 100%;
        }
        
        .user-toolbar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .toolbar-left {
            flex-direction: column;
        }
        
        .user-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
