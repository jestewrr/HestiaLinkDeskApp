@page "/finance/financial-reports"
@using HestiaLink.Components.Layout
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Financial Reports</h1>
        <span class="page-topbar-subtitle">Revenue, Expenses & Tax Analytics</span>
    </header>

    <section class="page-content">
        <!-- Report Period Selector -->
        <div style="background: var(--color-white); padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-weight: 700; color: var(--color-dark-teal); margin-bottom: 8px; display: block;">Report Period</label>
                    <select class="form-select" @bind="SelectedPeriod">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-weight: 700; color: var(--color-dark-teal); margin-bottom: 8px; display: block;">From Date</label>
                    <input type="date" class="form-input" @bind="StartDate" />
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-weight: 700; color: var(--color-dark-teal); margin-bottom: 8px; display: block;">To Date</label>
                    <input type="date" class="form-input" @bind="EndDate" />
                </div>
                <div style="align-self: flex-end;">
                    <button class="btn-create" @onclick="GenerateReport">Generate Report</button>
                </div>
            </div>
        </div>

        <!-- Key Financial Metrics -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-title">Total Revenue</div>
                <div class="stat-value">â‚±@TotalRevenue.ToString("N2")</div>
                <div style="font-size: 0.85rem; color: #047857; margin-top: 4px;">â†‘ 12.5% vs last period</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total Expenses</div>
                <div class="stat-value" style="color: #991b1b;">â‚±@TotalExpenses.ToString("N2")</div>
                <div style="font-size: 0.85rem; color: #991b1b; margin-top: 4px;">â†‘ 8.3% vs last period</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Net Profit</div>
                <div class="stat-value" style="color: @(NetProfit >= 0 ? "var(--color-teal)" : "#991b1b")">â‚±@NetProfit.ToString("N2")</div>
                <div style="font-size: 0.85rem; color: var(--color-dark-teal); margin-top: 4px;">@ProfitMargin.ToString("F1")% margin</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Tax Liabilities</div>
                <div class="stat-value">â‚±@TotalTaxLiabilities.ToString("N2")</div>
                <div style="font-size: 0.85rem; color: var(--color-dark-teal); margin-top: 4px;">VAT + Income Tax</div>
            </div>
        </div>

        <!-- Report Tabs -->
        <div style="display: flex; gap: 12px; margin-bottom: 24px;">
            <button class="@(ActiveTab == "revenue" ? "btn-create" : "btn-outlined")" @onclick='() => ActiveTab = "revenue"'>
                Revenue Breakdown
            </button>
            <button class="@(ActiveTab == "expenses" ? "btn-create" : "btn-outlined")" @onclick='() => ActiveTab = "expenses"'>
                Expense Analysis
            </button>
            <button class="@(ActiveTab == "tax" ? "btn-create" : "btn-outlined")" @onclick='() => ActiveTab = "tax"'>
                Tax Summary
            </button>
            <button class="@(ActiveTab == "profit" ? "btn-create" : "btn-outlined")" @onclick='() => ActiveTab = "profit"'>
                Profit & Loss
            </button>
        </div>

        <!-- Revenue Breakdown Tab -->
        @if (ActiveTab == "revenue")
        {
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                <div class="panel-card">
                    <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                        Revenue by Source
                    </div>
                    <div class="panel-body">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>Revenue Source</th>
                                    <th>Amount</th>
                                    <th>% of Total</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var source in RevenueBreakdown)
                                {
                                    <tr>
                                        <td style="font-weight: 700;">@source.Source</td>
                                        <td style="font-weight: 900; color: var(--color-teal);">â‚±@source.Amount.ToString("N2")</td>
                                        <td style="font-weight: 700;">@source.Percentage.ToString("F1")%</td>
                                        <td>@source.TransactionCount</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="panel-card">
                    <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                        Revenue Distribution
                    </div>
                    <div class="panel-body" style="padding: 30px;">
                        @foreach (var source in RevenueBreakdown)
                        {
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 700; color: var(--color-dark-teal);">@source.Source</span>
                                    <span style="font-weight: 900; color: var(--color-teal);">@source.Percentage.ToString("F1")%</span>
                                </div>
                                <div style="background: var(--color-light-gray); height: 12px; border-radius: 6px; overflow: hidden;">
                                    <div style="background: var(--color-teal); height: 100%; width: @(source.Percentage)%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Expense Analysis Tab -->
        @if (ActiveTab == "expenses")
        {
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                <div class="panel-card">
                    <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                        Expenses by Category
                    </div>
                    <div class="panel-body">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>% of Total</th>
                                    <th>Transactions</th>
                                    <th>Avg per Transaction</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var expense in ExpenseBreakdown)
                                {
                                    <tr>
                                        <td style="font-weight: 700;">@expense.Category</td>
                                        <td style="font-weight: 900; color: #991b1b;">â‚±@expense.Amount.ToString("N2")</td>
                                        <td style="font-weight: 700;">@expense.Percentage.ToString("F1")%</td>
                                        <td>@expense.TransactionCount</td>
                                        <td>â‚±@expense.AvgPerTransaction.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="panel-card">
                    <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                        Top Expense Categories
                    </div>
                    <div class="panel-body" style="padding: 30px;">
                        @foreach (var expense in ExpenseBreakdown.OrderByDescending(e => e.Amount).Take(5))
                        {
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 700; color: var(--color-dark-teal);">@expense.Category</span>
                                    <span style="font-weight: 900; color: #991b1b;">â‚±@expense.Amount.ToString("N0")</span>
                                </div>
                                <div style="background: var(--color-light-gray); height: 12px; border-radius: 6px; overflow: hidden;">
                                    <div style="background: #991b1b; height: 100%; width: @(expense.Percentage)%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Tax Summary Tab -->
        @if (ActiveTab == "tax")
        {
            <div class="panel-card">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Tax Collections & Liabilities Summary
                </div>
                <div class="panel-body">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 30px;">
                        <div style="background: var(--color-cream); padding: 24px; border-radius: 12px;">
                            <h3 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900;">Guest Taxes Collected</h3>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--color-light-gray);">
                                <span style="font-weight: 600;">VAT (12%):</span>
                                <span style="font-weight: 900; color: var(--color-teal);">â‚±@VATCollected.ToString("N2")</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--color-light-gray);">
                                <span style="font-weight: 600;">Service Charge (10%):</span>
                                <span style="font-weight: 900; color: var(--color-teal);">â‚±@ServiceChargeCollected.ToString("N2")</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 1.1rem;">
                                <span style="font-weight: 900; color: var(--color-dark-teal);">Total Collected:</span>
                                <span style="font-weight: 900; color: var(--color-teal);">â‚±@(VATCollected + ServiceChargeCollected).ToString("N2")</span>
                            </div>
                        </div>

                        <div style="background: var(--color-cream); padding: 24px; border-radius: 12px;">
                            <h3 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900;">Employee Income Tax Withheld</h3>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--color-light-gray);">
                                <span style="font-weight: 600;">Rank & File:</span>
                                <span style="font-weight: 900; color: var(--color-dark-teal);">â‚±@RankAndFileTax.ToString("N2")</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--color-light-gray);">
                                <span style="font-weight: 600;">Managerial:</span>
                                <span style="font-weight: 900; color: var(--color-dark-teal);">â‚±@ManagerialTax.ToString("N2")</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 1.1rem;">
                                <span style="font-weight: 900; color: var(--color-dark-teal);">Total Withheld:</span>
                                <span style="font-weight: 900; color: #991b1b;">â‚±@(RankAndFileTax + ManagerialTax).ToString("N2")</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: var(--color-white); padding: 20px; border-radius: 8px; border: 2px solid var(--color-teal);">
                        <h4 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900;">BIR Remittance Summary</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--color-light-gray);">
                                    <th style="padding: 12px; text-align: left; font-weight: 900;">Tax Type</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 900;">Amount to Remit</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 900;">Due Date</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 900;">BIR Form</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--color-light-gray); font-weight: 700;">VAT (Output Tax)</td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--color-light-gray); text-align: right; font-weight: 900; color: var(--color-teal);">â‚±@VATCollected.ToString("N2")</td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--color-light-gray);">20th of following month</td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--color-light-gray); font-family: monospace;">2550M</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--color-light-gray); font-weight: 700;">Withholding Tax (Income)</td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--color-light-gray); text-align: right; font-weight: 900; color: #991b1b;">â‚±@(RankAndFileTax + ManagerialTax).ToString("N2")</td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--color-light-gray);">10th of following month</td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--color-light-gray); font-family: monospace;">1601C</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Profit & Loss Tab -->
        @if (ActiveTab == "profit")
        {
            <div class="panel-card">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Profit & Loss Statement
                </div>
                <div class="panel-body">
                    <div style="max-width: 800px; margin: 0 auto;">
                        <!-- Revenue Section -->
                        <div style="background: var(--color-cream); padding: 24px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900;">Revenue</h3>
                            @foreach (var source in RevenueBreakdown)
                            {
                                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                    <span style="font-weight: 600;">@source.Source</span>
                                    <span style="font-weight: 900; color: var(--color-teal);">â‚±@source.Amount.ToString("N2")</span>
                                </div>
                            }
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; margin-top: 12px; border-top: 2px solid var(--color-dark-teal);">
                                <span style="font-weight: 900; font-size: 1.1rem; color: var(--color-dark-teal);">Total Revenue</span>
                                <span style="font-weight: 900; font-size: 1.1rem; color: var(--color-teal);">â‚±@TotalRevenue.ToString("N2")</span>
                            </div>
                        </div>

                        <!-- Expenses Section -->
                        <div style="background: var(--color-cream); padding: 24px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900;">Expenses</h3>
                            @foreach (var expense in ExpenseBreakdown)
                            {
                                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                    <span style="font-weight: 600;">@expense.Category</span>
                                    <span style="font-weight: 900; color: #991b1b;">â‚±@expense.Amount.ToString("N2")</span>
                                </div>
                            }
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; margin-top: 12px; border-top: 2px solid var(--color-dark-teal);">
                                <span style="font-weight: 900; font-size: 1.1rem; color: var(--color-dark-teal);">Total Expenses</span>
                                <span style="font-weight: 900; font-size: 1.1rem; color: #991b1b;">â‚±@TotalExpenses.ToString("N2")</span>
                            </div>
                        </div>

                        <!-- Net Profit -->
                        <div style="background: @(NetProfit >= 0 ? "var(--color-teal)" : "#991b1b"); color: var(--color-white); padding: 30px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 8px;">@(NetProfit >= 0 ? "NET PROFIT" : "NET LOSS")</div>
                            <div style="font-size: 2.5rem; font-weight: 900;">â‚±@Math.Abs(NetProfit).ToString("N2")</div>
                            <div style="font-size: 1rem; margin-top: 8px; opacity: 0.9;">Profit Margin: @ProfitMargin.ToString("F1")%</div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Export Options -->
        <div style="display: flex; gap: 12px; margin-top: 30px; justify-content: center;">
            <button class="btn-outlined" @onclick="ExportPDF">ðŸ“„ Export to PDF</button>
            <button class="btn-outlined" @onclick="ExportExcel">ðŸ“Š Export to Excel</button>
            <button class="btn-outlined" @onclick="PrintReport">ðŸ–¨ Print Report</button>
        </div>
    </section>
</div>

@code {
    private string SelectedPeriod = "month";
    private DateTime StartDate = DateTime.Now.AddMonths(-1);
    private DateTime EndDate = DateTime.Now;
    private string ActiveTab = "revenue";

    private List<RevenueSource> RevenueBreakdown = new List<RevenueSource>();
    private List<ExpenseCategory> ExpenseBreakdown = new List<ExpenseCategory>();

    private decimal TotalRevenue => RevenueBreakdown.Sum(r => r.Amount);
    private decimal TotalExpenses => ExpenseBreakdown.Sum(e => e.Amount);
    private decimal NetProfit => TotalRevenue - TotalExpenses;
    private decimal ProfitMargin => TotalRevenue > 0 ? (NetProfit / TotalRevenue) * 100 : 0;

    private decimal VATCollected = 28500;
    private decimal ServiceChargeCollected = 23750;
    private decimal RankAndFileTax = 5400;
    private decimal ManagerialTax = 18900;
    private decimal TotalTaxLiabilities => VATCollected + RankAndFileTax + ManagerialTax;

    protected override void OnInitialized()
    {
        LoadRevenueData();
        LoadExpenseData();
    }

    private void LoadRevenueData()
    {
        RevenueBreakdown.Add(new RevenueSource { Source = "Room Bookings", Amount = 185000, TransactionCount = 45 });
        RevenueBreakdown.Add(new RevenueSource { Source = "Food & Beverage", Amount = 42000, TransactionCount = 120 });
        RevenueBreakdown.Add(new RevenueSource { Source = "Additional Services", Amount = 18500, TransactionCount = 35 });
        RevenueBreakdown.Add(new RevenueSource { Source = "Event Bookings", Amount = 65000, TransactionCount = 8 });

        foreach (var source in RevenueBreakdown)
        {
            source.Percentage = TotalRevenue > 0 ? (source.Amount / TotalRevenue) * 100 : 0;
        }
    }

    private void LoadExpenseData()
    {
        ExpenseBreakdown.Add(new ExpenseCategory { Category = "Payroll", Amount = 95000, TransactionCount = 25 });
        ExpenseBreakdown.Add(new ExpenseCategory { Category = "Utilities", Amount = 35000, TransactionCount = 8 });
        ExpenseBreakdown.Add(new ExpenseCategory { Category = "Supplies", Amount = 28000, TransactionCount = 42 });
        ExpenseBreakdown.Add(new ExpenseCategory { Category = "Maintenance", Amount = 22000, TransactionCount = 15 });
        ExpenseBreakdown.Add(new ExpenseCategory { Category = "Marketing", Amount = 18000, TransactionCount = 6 });

        foreach (var expense in ExpenseBreakdown)
        {
            expense.Percentage = TotalExpenses > 0 ? (expense.Amount / TotalExpenses) * 100 : 0;
            expense.AvgPerTransaction = expense.TransactionCount > 0 ? expense.Amount / expense.TransactionCount : 0;
        }
    }

    private void GenerateReport()
    {
        // Generate report logic
    }

    private void ExportPDF()
    {
        // Export to PDF logic
    }

    private void ExportExcel()
    {
        // Export to Excel logic
    }

    private void PrintReport()
    {
        // Print report logic
    }

    public class RevenueSource
    {
        public string Source { get; set; } = "";
        public decimal Amount { get; set; }
        public decimal Percentage { get; set; }
        public int TransactionCount { get; set; }
    }

    public class ExpenseCategory
    {
        public string Category { get; set; } = "";
        public decimal Amount { get; set; }
        public decimal Percentage { get; set; }
        public int TransactionCount { get; set; }
        public decimal AvgPerTransaction { get; set; }
    }
}
