@page "/hr/attendance"
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Attendance</h1>
        <span class="page-topbar-subtitle">@DateTime.Now.ToString("dddd, MMMM dd, yyyy")</span>
    </header>

    <section class="page-content">
        <!-- Quick Stats -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-title">Present Today</div>
                <div class="stat-value" style="color: #047857;">@PresentCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Absent Today</div>
                <div class="stat-value" style="color: #991b1b;">@AbsentCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">On Leave</div>
                <div class="stat-value" style="color: #d97706;">@OnLeaveCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Late Check-ins</div>
                <div class="stat-value" style="color: #b91c1c;">@LateCount</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="user-toolbar">
            <div class="toolbar-left">
                <div class="toolbar-search">
                    <input type="text" placeholder="Search employee..." @bind="SearchText" />
                    <span class="search-icon">🔍</span>
                </div>
                <input type="date" class="filter-select" @bind="SelectedDate" style="padding: 10px 16px;" />
                <select class="filter-select" @bind="DepartmentFilter">
                    <option value="">All Departments</option>
                    <option value="Front Office">Front Office</option>
                    <option value="Housekeeping">Housekeeping</option>
                    <option value="Food & Beverage">Food & Beverage</option>
                    <option value="Maintenance">Maintenance</option>
                </select>
            </div>
            <button class="btn-create" @onclick="OpenRecordAttendanceModal">Record Attendance</button>
        </div>

        <!-- Attendance Table -->
        <div class="panel-card">
            <div class="panel-body user-list-container">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Employee ID</th>
                            <th>Employee Name</th>
                            <th>Department</th>
                            <th>Position</th>
                            <th>Shift</th>
                            <th>Check In</th>
                            <th>Check Out</th>
                            <th>Hours Worked</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var record in FilteredAttendance)
                        {
                            <tr>
                                <td style="font-family: monospace; font-weight: 700;">@record.EmployeeId</td>
                                <td style="font-weight: 700;">@record.EmployeeName</td>
                                <td>@record.Department</td>
                                <td>@record.Position</td>
                                <td>
                                    <span class="status-badge" style="background: var(--color-light-gray); color: var(--color-dark-teal);">
                                        @record.Shift
                                    </span>
                                </td>
                                <td style="font-weight: 700; color: @(record.IsLate ? "#b91c1b" : "var(--color-teal)");">
                                    @(record.CheckInTime?.ToString("HH:mm") ?? "--:--")
                                    @if (record.IsLate)
                                    {
                                        <span style="font-size: 0.75rem; color: #b91c1b;"> (Late)</span>
                                    }
                                </td>
                                <td style="font-weight: 700;">@(record.CheckOutTime?.ToString("HH:mm") ?? "--:--")</td>
                                <td style="font-weight: 900; color: var(--color-teal);">@record.HoursWorked.ToString("F1")h</td>
                                <td>
                                    <span class="status-badge status-@record.Status.ToLower()">@record.Status</span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 8px; justify-content: center;">
                                        <button class="btn-icon-action edit" title="Edit" @onclick="() => OpenEditModal(record)">
                                            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                        </button>
                                        <button class="btn-icon-action archive" title="View Details" @onclick="() => ViewDetails(record)">
                                            <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Leave Requests Section -->
        <div class="panel-card" style="margin-top: 30px;">
            <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                Pending Leave Requests
            </div>
            <div class="panel-body">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Leave Type</th>
                            <th>From Date</th>
                            <th>To Date</th>
                            <th>Days</th>
                            <th>Reason</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var leave in PendingLeaves)
                        {
                            <tr>
                                <td style="font-weight: 700;">@leave.EmployeeName</td>
                                <td>
                                    <span class="status-badge" style="background: var(--color-cream); color: var(--color-dark-teal);">
                                        @leave.LeaveType
                                    </span>
                                </td>
                                <td>@leave.FromDate.ToString("MMM dd, yyyy")</td>
                                <td>@leave.ToDate.ToString("MMM dd, yyyy")</td>
                                <td style="font-weight: 900; color: var(--color-teal);">@leave.Days</td>
                                <td>@leave.Reason</td>
                                <td>
                                    <div style="display: flex; gap: 8px; justify-content: center;">
                                        <button class="btn-icon" style="background: #047857; color: white;" title="Approve" @onclick="() => ApproveLeave(leave)">✓</button>
                                        <button class="btn-icon" style="background: #b91c1c; color: white;" title="Reject" @onclick="() => RejectLeave(leave)">✕</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<!-- Record Attendance Modal -->
@if (ShowRecordModal)
{
    <div class="modal-overlay" @onclick="CloseModals">
        <div class="modal-content" style="max-width: 600px;" @onclick:stopPropagation="true">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">Record Attendance</h2>
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
                <label class="form-label">Employee</label>
                <select class="form-select" @bind="NewRecord.EmployeeId">
                    <option value="">Select Employee</option>
                    <option value="EMP001">EMP001 - Juan Dela Cruz</option>
                    <option value="EMP002">EMP002 - Maria Santos</option>
                    <option value="EMP003">EMP003 - Pedro Reyes</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" @bind="NewRecord.Date" />
                </div>
                <div class="form-group">
                    <label class="form-label">Shift</label>
                    <select class="form-select" @bind="NewRecord.Shift">
                        <option>Morning (6AM-2PM)</option>
                        <option>Afternoon (2PM-10PM)</option>
                        <option>Night (10PM-6AM)</option>
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group">
                    <label class="form-label">Check In Time</label>
                    <input type="time" class="form-input" @bind="NewRecord.CheckInTime" />
                </div>
                <div class="form-group">
                    <label class="form-label">Check Out Time</label>
                    <input type="time" class="form-input" @bind="NewRecord.CheckOutTime" />
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Notes (Optional)</label>
                <textarea class="form-input" rows="3" @bind="NewRecord.Notes" placeholder="Any remarks or notes..."></textarea>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn-primary" style="flex: 1;" @onclick="SaveAttendance">Save Attendance</button>
                <button class="btn-secondary" style="flex: 1;" @onclick="CloseModals">Cancel</button>
            </div>
        </div>
    </div>
}

<style>
    .status-present { background-color: #d1fae5; color: #065f46; }
    .status-absent { background-color: #fee2e2; color: #991b1b; }
    .status-leave { background-color: #fef3c7; color: #92400e; }
    .status-halfday { background-color: #dbeafe; color: #1e40af; }
</style>

@code {
    private List<AttendanceRecord> AttendanceRecords = new List<AttendanceRecord>();
    private List<LeaveRequest> PendingLeaves = new List<LeaveRequest>();
    private AttendanceRecord NewRecord = new AttendanceRecord();
    private string SearchText = "";
    private string DepartmentFilter = "";
    private DateTime SelectedDate = DateTime.Now;
    private bool ShowRecordModal = false;

    private int PresentCount => AttendanceRecords.Count(a => a.Date.Date == DateTime.Now.Date && a.Status == "Present");
    private int AbsentCount => AttendanceRecords.Count(a => a.Date.Date == DateTime.Now.Date && a.Status == "Absent");
    private int OnLeaveCount => AttendanceRecords.Count(a => a.Date.Date == DateTime.Now.Date && a.Status == "Leave");
    private int LateCount => AttendanceRecords.Count(a => a.Date.Date == DateTime.Now.Date && a.IsLate);

    private List<AttendanceRecord> FilteredAttendance => AttendanceRecords
        .Where(a => a.Date.Date == SelectedDate.Date &&
                    (string.IsNullOrEmpty(SearchText) || 
                     a.EmployeeName.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                     a.EmployeeId.Contains(SearchText, StringComparison.OrdinalIgnoreCase)) &&
                    (string.IsNullOrEmpty(DepartmentFilter) || a.Department == DepartmentFilter))
        .OrderBy(a => a.EmployeeName)
        .ToList();

    protected override void OnInitialized()
    {
        AttendanceRecords.Add(new AttendanceRecord
        {
            EmployeeId = "EMP001",
            EmployeeName = "Juan Dela Cruz",
            Department = "Front Office",
            Position = "Receptionist",
            Date = DateTime.Now,
            Shift = "Morning (6AM-2PM)",
            CheckInTime = DateTime.Now.Date.AddHours(6).AddMinutes(5),
            CheckOutTime = DateTime.Now.Date.AddHours(14).AddMinutes(10),
            HoursWorked = 8.08m,
            Status = "Present",
            IsLate = true
        });

        AttendanceRecords.Add(new AttendanceRecord
        {
            EmployeeId = "EMP002",
            EmployeeName = "Maria Santos",
            Department = "Housekeeping",
            Position = "Supervisor",
            Date = DateTime.Now,
            Shift = "Morning (6AM-2PM)",
            CheckInTime = DateTime.Now.Date.AddHours(5).AddMinutes(55),
            CheckOutTime = DateTime.Now.Date.AddHours(14),
            HoursWorked = 8.08m,
            Status = "Present",
            IsLate = false
        });

        AttendanceRecords.Add(new AttendanceRecord
        {
            EmployeeId = "EMP003",
            EmployeeName = "Pedro Reyes",
            Department = "Food & Beverage",
            Position = "Chef",
            Date = DateTime.Now,
            Shift = "Afternoon (2PM-10PM)",
            Status = "Absent",
            IsLate = false
        });

        PendingLeaves.Add(new LeaveRequest
        {
            EmployeeName = "Ana Garcia",
            LeaveType = "Sick Leave",
            FromDate = DateTime.Now.AddDays(2),
            ToDate = DateTime.Now.AddDays(3),
            Days = 2,
            Reason = "Medical appointment"
        });

        PendingLeaves.Add(new LeaveRequest
        {
            EmployeeName = "Carlos Mendoza",
            LeaveType = "Vacation Leave",
            FromDate = DateTime.Now.AddDays(7),
            ToDate = DateTime.Now.AddDays(11),
            Days = 5,
            Reason = "Family vacation"
        });
    }

    private void OpenRecordAttendanceModal()
    {
        NewRecord = new AttendanceRecord { Date = DateTime.Now, Shift = "Morning (6AM-2PM)" };
        ShowRecordModal = true;
    }

    private void SaveAttendance()
    {
        if (NewRecord.CheckInTime.HasValue && NewRecord.CheckOutTime.HasValue)
        {
            NewRecord.HoursWorked = (decimal)(NewRecord.CheckOutTime.Value - NewRecord.CheckInTime.Value).TotalHours;
            var shiftStart = NewRecord.Shift switch
            {
                "Morning (6AM-2PM)" => 6,
                "Afternoon (2PM-10PM)" => 14,
                "Night (10PM-6AM)" => 22,
                _ => 6
            };
            NewRecord.IsLate = NewRecord.CheckInTime.Value.Hour > shiftStart || 
                              (NewRecord.CheckInTime.Value.Hour == shiftStart && NewRecord.CheckInTime.Value.Minute > 0);
            NewRecord.Status = "Present";
        }
        else
        {
            NewRecord.Status = "Absent";
        }

        AttendanceRecords.Add(NewRecord);
        CloseModals();
    }

    private void OpenEditModal(AttendanceRecord record)
    {
        // Edit logic
    }

    private void ViewDetails(AttendanceRecord record)
    {
        // View details logic
    }

    private void ApproveLeave(LeaveRequest leave)
    {
        // Approve leave logic
        PendingLeaves.Remove(leave);
    }

    private void RejectLeave(LeaveRequest leave)
    {
        // Reject leave logic
        PendingLeaves.Remove(leave);
    }

    private void CloseModals()
    {
        ShowRecordModal = false;
    }

    public class AttendanceRecord
    {
        public string EmployeeId { get; set; } = "";
        public string EmployeeName { get; set; } = "";
        public string Department { get; set; } = "";
        public string Position { get; set; } = "";
        public DateTime Date { get; set; }
        public string Shift { get; set; } = "";
        public DateTime? CheckInTime { get; set; }
        public DateTime? CheckOutTime { get; set; }
        public decimal HoursWorked { get; set; }
        public string Status { get; set; } = "Absent";
        public bool IsLate { get; set; }
        public string Notes { get; set; } = "";
    }

    public class LeaveRequest
    {
        public string EmployeeName { get; set; } = "";
        public string LeaveType { get; set; } = "";
        public DateTime FromDate { get; set; }
        public DateTime ToDate { get; set; }
        public int Days { get; set; }
        public string Reason { get; set; } = "";
    }
}
