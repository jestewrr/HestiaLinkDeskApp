@page "/hr/attendance"
@using HestiaLink.Services
@using HestiaLink.Data
@using System.Globalization
@using Microsoft.EntityFrameworkCore
@inject AttendanceService AttendanceService
@inject HestiaLinkContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Attendance Management</h1>
        <span class="page-topbar-subtitle">@SelectedDate.ToString("dddd, MMMM dd, yyyy")</span>
    </header>

    <section class="page-content">
        <!-- Attendance Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-title">Present Today</div>
                <div class="stat-value" style="color: #047857;">@AttendanceSummary.PresentCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Absent Today</div>
                <div class="stat-value" style="color: #991b1b;">@AttendanceSummary.AbsentCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">On Leave</div>
                <div class="stat-value" style="color: #d97706;">@AttendanceSummary.OnLeaveCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Late Check-Ins</div>
                <div class="stat-value" style="color: #b91c1c;">@AttendanceSummary.LateCount</div>
            </div>
        </div>

        <!-- Filters Toolbar -->
        <div class="user-toolbar">
            <div class="toolbar-left">
                <div class="toolbar-search">
                    <input type="text" placeholder="Search by name, ID, or department..." @bind="SearchText" @bind:event="oninput" />
                    <span class="search-icon"></span>
                </div>
                <input type="date" class="filter-select" value="@SelectedDate.ToString("yyyy-MM-dd")" style="padding: 10px 16px;" @onchange="OnDateChanged" />
                <select class="filter-select" @bind="SelectedDepartment" @bind:event="onchange">
                    <option value="">All Departments</option>
                    @foreach (var dept in Departments)
                    {
                        <option value="@dept">@dept</option>
                    }
                </select>
                <select class="filter-select" @bind="SelectedStatus">
                    <option value="">All Status</option>
                    <option value="Present">Present</option>
                    <option value="Pending">Pending (Not Checked In)</option>
                    <option value="On Leave">On Leave</option>
                    <option value="Absent">Absent</option>
                    <option value="Half Day">Half Day</option>
                    <option value="Holiday">Holiday</option>
                </select>
            </div>
        </div>

        <!-- Employee Attendance Table -->
        <div class="panel-card">
            <div class="panel-body user-list-container">
                @if (IsLoading)
                {
                    <div style="padding: 40px; text-align: center;">
                        <p>Loading attendance records...</p>
                    </div>
                }
                else if (!FilteredAttendance.Any())
                {
                    <div style="padding: 40px; text-align: center; color: #64748b;">
                        <p>No employees found for the selected filters.</p>
                    </div>
                }
                else
                {
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Shift</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Hours</th>
                                <th>Status</th>
                                <th style="text-align: center; width: 160px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var record in FilteredAttendance)
                            {
                                <tr>
                                    <td style="font-weight: 700;">@record.FirstName @record.LastName</td>
                                    <td>@record.Department</td>
                                    <td>
                                        @if (record.ScheduleStart.HasValue)
                                        {
                                            <span class="shift-badge @(GetShiftType(record.ScheduleStart) == "Night Shift" ? "shift-night" : "shift-day")">
                                                @GetShiftType(record.ScheduleStart)
                                            </span>
                                        }
                                        else
                                        {
                                            <span style="color: #94a3b8; font-style: italic;">Not Assigned</span>
                                        }
                                    </td>
                                    <td style="@(record.IsLate ? "color: #b91c1c; font-weight: 700;" : "color: var(--color-teal); font-weight: 700;")">
                                        @if (record.ActualCheckIn.HasValue)
                                        {
                                            @record.ActualCheckIn.Value.ToString("hh:mm tt")
                                            @if (record.IsLate)
                                            {
                                                <span style="font-size: 0.7rem; margin-left: 4px;">(Late)</span>
                                            }
                                        }
                                        else
                                        {
                                            <span style="color: #94a3b8;">--:--</span>
                                        }
                                    </td>
                                    <td style="font-weight: 700;">
                                        @if (record.ActualCheckOut.HasValue)
                                        {
                                            @record.ActualCheckOut.Value.ToString("hh:mm tt")
                                        }
                                        else
                                        {
                                            <span style="color: #94a3b8;">--:--</span>
                                        }
                                    </td>
                                    <td style="font-weight: 900; color: var(--color-teal);">
                                        @((record.RegularHours + record.OvertimeHours).ToString("F1"))h
                                        @if (record.OvertimeHours > 0)
                                        {
                                            <span style="font-size: 0.7rem; color: #7c3aed; margin-left: 4px;">(+@record.OvertimeHours.ToString("F1") OT)</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="status-badge status-@(record.AttendanceStatus.ToLower().Replace(" ", "-"))">@record.AttendanceStatus</span>
                                    </td>
                                    <td style="text-align: center;">
                                        <div style="display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: nowrap;">
                                            @if (!record.ScheduleStart.HasValue)
                                            {
                                                <button class="btn-icon btn-shift" title="Assign Shift" @onclick="() => OpenAssignShiftModal(record)">
                                                    🕐
                                                </button>
                                            }
                                            @if (record.ScheduleStart.HasValue)
                                            {
                                                <button class="btn-icon btn-edit" title="Edit Shift" @onclick="() => OpenEditShiftModal(record)">
                                                    ✏️
                                                </button>
                                            }
                                            @if (!record.ActualCheckIn.HasValue)
                                            {
                                                <button class="btn-icon btn-checkin" title="Check In" @onclick="() => RecordCheckIn(record)">
                                                    ✔️
                                                </button>
                                            }
                                            @if (record.ActualCheckIn.HasValue && !record.ActualCheckOut.HasValue)
                                            {
                                                <button class="btn-icon btn-checkout" title="Check Out" @onclick="() => RecordCheckOut(record)">
                                                    ✖️
                                                </button>
                                            }
                                            <button class="btn-icon btn-history" title="View History" @onclick="() => ViewAttendanceHistory(record.EmployeeID)">
                                                📋
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </section>
</div>

@* Attendance History Modal *@
@if (ShowHistoryModal && SelectedEmployeeForHistory != null)
{
    <div class="modal-overlay" @onclick="CloseHistoryModal">
        <div class="modal-content" style="max-width: 1100px;" @onclick:stopPropagation="true">
            <div class="modal-header-teal">
                <div>
                    <h2 style="margin:0; font-size:1.4rem;">Attendance History</h2>
                    <p style="margin: 4px 0 0 0; font-size: 0.9rem; opacity: 0.9;">@SelectedEmployeeForHistory.FirstName @SelectedEmployeeForHistory.LastName (ID: @SelectedEmployeeForHistory.EmployeeID)</p>
                </div>
                <button style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;" @onclick="CloseHistoryModal">×</button>
            </div>

            <div style="padding: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; margin-bottom: 20px; align-items: end;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">From Date</label>
                        <input type="date" class="form-input" @bind="HistoryFromDate" />
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">To Date</label>
                        <input type="date" class="form-input" @bind="HistoryToDate" />
                    </div>
                    <button class="btn-primary" @onclick="LoadAttendanceHistory">Load</button>
                </div>

                @if (AttendanceHistory.Any())
                {
                    <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                        <table class="user-table" style="font-size: 0.9rem;">
                            <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                                <tr>
                                    <th>Date</th>
                                    <th>Shift</th>
                                    <th>Schedule</th>
                                    <th>Check In</th>
                                    <th>Check Out</th>
                                    <th>Hours</th>
                                    <th>Status</th>
                                    <th>Late</th>
                                    <th style="text-align: center; width: 80px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var history in AttendanceHistory)
                                {
                                    <tr>
                                        <td style="font-weight: 700;">@history.AttendanceDate.ToString("MMM dd, yyyy")</td>
                                        <td>
                                            @if (history.ScheduleStart.HasValue)
                                            {
                                                <span class="shift-badge @(GetShiftType(history.ScheduleStart) == "Night Shift" ? "shift-night" : "shift-day")">
                                                    @GetShiftType(history.ScheduleStart)
                                                </span>
                                            }
                                            else
                                            {
                                                <span style="color: #94a3b8;">N/A</span>
                                            }
                                        </td>
                                        <td>@FormatSchedule(history.ScheduleStart, history.ScheduleEnd)</td>
                                        <td style="@(history.IsLate ? "color: #b91c1c; font-weight: 700;" : "")">
                                            @(history.ActualCheckIn?.ToString("hh:mm tt") ?? "--:--")
                                        </td>
                                        <td>@(history.ActualCheckOut?.ToString("hh:mm tt") ?? "--:--")</td>
                                        <td style="font-weight: 700; color: var(--color-teal);">
                                            @((history.RegularHours + history.OvertimeHours).ToString("F1"))h
                                            @if (history.OvertimeHours > 0)
                                            {
                                                <span style="font-size: 0.7rem; color: #7c3aed;">(+@history.OvertimeHours.ToString("F1"))</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="status-badge status-@(history.AttendanceStatus.ToLower().Replace(" ", "-"))">
                                                @history.AttendanceStatus
                                            </span>
                                        </td>
                                        <td>
                                            @if (history.IsLate)
                                            {
                                                <span style="color: #b91c1c; font-weight: 700;">Yes</span>
                                            }
                                            else
                                            {
                                                <span style="color: #64748b;">No</span>
                                            }
                                        </td>
                                        <td style="text-align: center;">
                                            <button class="btn-icon btn-edit" title="Edit" @onclick="() => OpenEditScheduleModal(history)">✏️</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div style="padding: 40px; text-align: center; color: #64748b; background: #f8fafc; border-radius: 8px;">
                        <p style="margin: 0;">No attendance history found for the selected date range.</p>
                    </div>
                }
            </div>

            <div class="action-footer" style="border-top: 1px solid #e5e7eb;">
                <button class="btn-secondary" @onclick="CloseHistoryModal">Close</button>
            </div>
        </div>
    </div>
}

@* Edit/Assign Shift Modal *@
@if (ShowEditScheduleModal)
{
    <div class="modal-overlay" @onclick="CloseEditScheduleModal">
        <div class="modal-content" style="max-width: 500px;" @onclick:stopPropagation="true">
            <div class="modal-header-teal">
                <div>
                    <h2 style="margin:0; font-size:1.2rem;">@(IsNewAttendance ? "Assign Shift" : "Edit Attendance")</h2>
                    <p style="margin: 4px 0 0 0; font-size: 0.85rem; opacity: 0.9;">
                        @EditEmployeeName - @EditAttendanceDate.ToString("MMM dd, yyyy")
                    </p>
                </div>
                <button style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;" @onclick="CloseEditScheduleModal">×</button>
            </div>

            <div style="padding: 24px;">
                @* Error/Success Message *@
                @if (!string.IsNullOrEmpty(SaveMessage))
                {
                    <div style="padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; background: @(SaveSuccess ? "#d1fae5" : "#fee2e2"); color: @(SaveSuccess ? "#065f46" : "#991b1b"); font-weight: 500;">
                        @SaveMessage
                    </div>
                }

                @* Employee Info Card *@
                <div style="background: #f0fdfa; border: 1px solid #99f6e4; border-radius: 8px; padding: 12px 16px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; color: #0f766e;">@EditEmployeeName</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #0f766e;">@EditAttendanceDate.ToString("ddd, MMM dd")</div>
                        </div>
                    </div>
                </div>

                @* Shift Selection *@
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="font-weight: 600;">Shift Type <span style="color: #ef4444;">*</span></label>
                    <select class="form-input" style="font-size: 1rem; padding: 12px;" @bind="SelectedShiftType" @bind:after="OnShiftTypeChanged">
                        <option value="">-- Select Shift --</option>
                        <option value="Day">🌅 Day Shift (5:00 AM - 5:00 PM)</option>
                        <option value="Night">🌙 Night Shift (5:00 PM - 5:00 AM)</option>
                        <option value="Custom">⚙️ Custom Schedule</option>
                    </select>
                </div>

                @* Schedule Times *@
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Schedule Start</label>
                        <input type="time" class="form-input @(SelectedShiftType != "Custom" && !string.IsNullOrEmpty(SelectedShiftType) ? "input-disabled" : "")"
                               @bind="EditScheduleStartTime"
                               disabled="@(SelectedShiftType != "Custom" && !string.IsNullOrEmpty(SelectedShiftType))" />
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Schedule End</label>
                        <input type="time" class="form-input @(SelectedShiftType != "Custom" && !string.IsNullOrEmpty(SelectedShiftType) ? "input-disabled" : "")"
                               @bind="EditScheduleEndTime"
                               disabled="@(SelectedShiftType != "Custom" && !string.IsNullOrEmpty(SelectedShiftType))" />
                    </div>
                </div>

                @if (!IsNewAttendance)
                {
                    @* Actual Check In/Out Times *@
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Actual Check In</label>
                            <input type="time" class="form-input" @bind="EditActualCheckInTime" />
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Actual Check Out</label>
                            <input type="time" class="form-input" @bind="EditActualCheckOutTime" />
                        </div>
                    </div>

                    @* Status Selection *@
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">Attendance Status</label>
                        <select class="form-input" @bind="EditAttendanceStatus">
                            <option value="Pending">⏳ Pending (Not Checked In)</option>
                            <option value="Present">✅ Present</option>
                            <option value="Absent">❌ Absent</option>
                            <option value="On Leave">🏖️ On Leave</option>
                            <option value="Half Day">⏰ Half Day</option>
                            <option value="Holiday">🎉 Holiday</option>
                        </select>
                    </div>

                    @* Late Checkbox *@
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: @(EditIsLate ? "#fef2f2" : "#f8fafc"); border-radius: 6px; border: 1px solid @(EditIsLate ? "#fecaca" : "#e2e8f0");">
                            <input type="checkbox" @bind="EditIsLate" style="width: 18px; height: 18px; accent-color: #ef4444;" />
                            <span style="font-weight: 500; color: @(EditIsLate ? "#b91c1c" : "#475569");">Mark as Late Arrival</span>
                        </label>
                    </div>
                }

                @* Notes *@
                <div class="form-group" style="margin-bottom: 24px;">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" rows="3" placeholder="Add any notes about this attendance record..." @bind="EditNotes" style="resize: vertical;"></textarea>
                </div>

                @* Action Buttons *@
                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn-primary" style="flex: 1; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;"
                            @onclick="HandleSaveClick"
                            @onclick:preventDefault="true"
                            @onclick:stopPropagation="true"
                            disabled="@(string.IsNullOrEmpty(SelectedShiftType) || IsSaving)">
                        @if (IsSaving)
                        {
                            <span class="spinner"></span>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>💾 Save Changes</span>
                        }
                    </button>
                    <button type="button" class="btn-secondary" style="flex: 1; padding: 12px;" @onclick="CloseEditScheduleModal" @onclick:stopPropagation="true" disabled="@IsSaving">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .status-present {
        background-color: #d1fae5;
        color: #065f46;
    }

    .status-absent {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .status-on-leave {
        background-color: #fef3c7;
        color: #92400e;
    }

    .status-half-day {
        background-color: #dbeafe;
        color: #1e40af;
    }

    .status-pending {
        background-color: #f1f5f9;
        color: #64748b;
    }

    .status-holiday {
        background-color: #fce7f3;
        color: #9d174d;
    }

    .shift-badge {
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .shift-day {
        background-color: #fef3c7;
        color: #92400e;
    }

    .shift-night {
        background-color: #e0e7ff;
        color: #3730a3;
    }

    .input-disabled {
        background-color: #f1f5f9 !important;
        cursor: not-allowed;
        color: #64748b;
    }

    .btn-icon {
        padding: 6px 8px;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }

        .btn-icon:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-icon:active {
            transform: translateY(0);
        }

    .btn-checkin {
        background: #10b981;
        color: white;
    }

    .btn-checkout {
        background: #f59e0b;
        color: white;
    }

    .btn-edit {
        background: #6366f1;
        color: white;
    }

    .btn-shift {
        background: #7c3aed;
        color: white;
    }

    .btn-history {
        background: #64748b;
        color: white;
    }

    .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 0.95rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

        .form-input:focus {
            outline: none;
            border-color: #14b8a6;
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }

    .form-label {
        display: block;
        margin-bottom: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        color: #475569;
    }

    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .btn-primary:disabled, .btn-secondary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>

@code {
    private List<AttendanceRecordDto> AttendanceRecords = new();
    private List<AttendanceRecordDto> AttendanceHistory = new();
    private AttendanceSummaryDto AttendanceSummary = new();

    private string SearchText = "";
    private string SelectedDepartment = "";
    private string SelectedStatus = "";
    private DateTime SelectedDate = DateTime.Now;
    private DateTime HistoryFromDate = DateTime.Now.AddDays(-30);
    private DateTime HistoryToDate = DateTime.Now;

    private List<string> Departments = new();

    private bool IsLoading = false;
    private bool ShowHistoryModal = false;
    private bool ShowEditScheduleModal = false;
    private bool IsNewAttendance = false;
    private bool IsSaving = false;
    private string SaveMessage = "";
    private bool SaveSuccess = false;

    private AttendanceRecordDto? SelectedEmployeeForHistory;
    private AttendanceRecordDto? SelectedAttendanceForEdit;

    // Edit modal fields
    private string SelectedShiftType = "";
    private DateTime EditScheduleStartTime = DateTime.Today.AddHours(5);
    private DateTime EditScheduleEndTime = DateTime.Today.AddHours(17);
    private DateTime? EditActualCheckInTime;
    private DateTime? EditActualCheckOutTime;
    private string EditAttendanceStatus = "Present";
    private bool EditIsLate = false;
    private string EditNotes = "";
    private string EditEmployeeName = "";
    private int EditEmployeeId = 0;
    private DateTime EditAttendanceDate = DateTime.Today;

    private List<AttendanceRecordDto> FilteredAttendance
    {
        get
        {
            var list = AttendanceRecords.ToList();

            if (!string.IsNullOrWhiteSpace(SearchText))
            {
                var search = SearchText.Trim();
                list = list.Where(a =>
                    (a.FirstName + " " + a.LastName).Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    a.EmployeeID.ToString().Contains(search) ||
                    (a.Department ?? "").Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    (a.Position ?? "").Contains(search, StringComparison.OrdinalIgnoreCase)).ToList();
            }

            if (!string.IsNullOrEmpty(SelectedDepartment))
            {
                list = list.Where(a => a.Department == SelectedDepartment).ToList();
            }

            if (!string.IsNullOrEmpty(SelectedStatus))
            {
                list = list.Where(a => a.AttendanceStatus == SelectedStatus).ToList();
            }

            return list.OrderBy(a => a.FirstName).ThenBy(a => a.LastName).ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDepartments();
        await LoadAttendanceRecords();
    }

    private async Task LoadDepartments()
    {
        try
        {
            var depts = await DbContext.Departments
                .AsNoTracking()
                .OrderBy(d => d.DepartmentName)
                .Select(d => d.DepartmentName)
                .ToListAsync();

            Departments = depts ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading departments: {ex.Message}");
            Departments = new();
        }
    }

    private async Task LoadAttendanceRecords()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            AttendanceRecords = await AttendanceService.GetAllEmployeesWithAttendanceAsync(SelectedDate);
            AttendanceSummary = await AttendanceService.GetAttendanceSummaryAsync(SelectedDate);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading attendance: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            SelectedDate = date;
            await LoadAttendanceRecords();
        }
    }

    private async Task RecordCheckIn(AttendanceRecordDto record)
    {
        var success = await AttendanceService.RecordCheckInAsync(record.EmployeeID, SelectedDate, record.ScheduleStart);
        if (success)
        {
            await LoadAttendanceRecords();
        }
    }

    private async Task RecordCheckOut(AttendanceRecordDto record)
    {
        var success = await AttendanceService.RecordCheckOutAsync(record.EmployeeID, SelectedDate);
        if (success)
        {
            await LoadAttendanceRecords();
        }
    }

    private async Task ViewAttendanceHistory(int employeeID)
    {
        SelectedEmployeeForHistory = AttendanceRecords.FirstOrDefault(r => r.EmployeeID == employeeID);

        if (SelectedEmployeeForHistory != null)
        {
            HistoryFromDate = DateTime.Now.AddDays(-30);
            HistoryToDate = DateTime.Now;
            await LoadAttendanceHistory();
            ShowHistoryModal = true;
        }
    }

    private async Task LoadAttendanceHistory()
    {
        if (SelectedEmployeeForHistory != null)
        {
            AttendanceHistory = await AttendanceService.GetEmployeeAttendanceHistoryAsync(
                SelectedEmployeeForHistory.EmployeeID,
                HistoryFromDate,
                HistoryToDate);
            StateHasChanged();
        }
    }

    private string GetShiftType(TimeSpan? scheduleStart)
    {
        if (!scheduleStart.HasValue)
            return "N/A";

        var hour = scheduleStart.Value.Hours;

        if (hour >= 5 && hour < 17)
            return "Day Shift";
        else
            return "Night Shift";
    }

    private string FormatSchedule(TimeSpan? start, TimeSpan? end)
    {
        if (!start.HasValue || !end.HasValue)
            return "--:-- - --:--";

        var startTime = DateTime.Today.Add(start.Value);
        var endTime = DateTime.Today.Add(end.Value);

        return $"{startTime:hh:mm tt} - {endTime:hh:mm tt}";
    }

    private void OpenAssignShiftModal(AttendanceRecordDto record)
    {
        IsNewAttendance = true;
        SelectedAttendanceForEdit = record;
        EditEmployeeName = $"{record.FirstName} {record.LastName}";
        EditEmployeeId = record.EmployeeID;
        EditAttendanceDate = SelectedDate;

        // Reset fields
        SelectedShiftType = "";
        EditScheduleStartTime = DateTime.Today.AddHours(5);
        EditScheduleEndTime = DateTime.Today.AddHours(17);
        EditAttendanceStatus = "Pending";
        EditIsLate = false;
        EditNotes = "";
        SaveMessage = "";

        ShowEditScheduleModal = true;
    }

    private void OpenEditShiftModal(AttendanceRecordDto record)
    {
        IsNewAttendance = false;
        SelectedAttendanceForEdit = record;
        EditEmployeeName = $"{record.FirstName} {record.LastName}";
        EditEmployeeId = record.EmployeeID;
        EditAttendanceDate = SelectedDate;

        // Determine shift type based on schedule
        if (record.ScheduleStart.HasValue)
        {
            var startHour = record.ScheduleStart.Value.Hours;
            var endHour = record.ScheduleEnd?.Hours ?? 0;

            if (startHour == 5 && endHour == 17)
                SelectedShiftType = "Day";
            else if (startHour == 17 && endHour == 5)
                SelectedShiftType = "Night";
            else
                SelectedShiftType = "Custom";
        }
        else
        {
            SelectedShiftType = "";
        }

        // Set schedule times
        EditScheduleStartTime = DateTime.Today.Add(record.ScheduleStart ?? new TimeSpan(5, 0, 0));
        EditScheduleEndTime = DateTime.Today.Add(record.ScheduleEnd ?? new TimeSpan(17, 0, 0));

        // Set actual check in/out times
        if (record.ActualCheckIn.HasValue)
            EditActualCheckInTime = DateTime.Today.Add(record.ActualCheckIn.Value.TimeOfDay);
        else
            EditActualCheckInTime = null;

        if (record.ActualCheckOut.HasValue)
            EditActualCheckOutTime = DateTime.Today.Add(record.ActualCheckOut.Value.TimeOfDay);
        else
            EditActualCheckOutTime = null;

        // Set other fields
        EditAttendanceStatus = record.AttendanceStatus;
        EditIsLate = record.IsLate;
        EditNotes = record.Notes ?? "";
        SaveMessage = "";

        ShowEditScheduleModal = true;
        ShowHistoryModal = false;
    }

    private void OnShiftTypeChanged()
    {
        switch (SelectedShiftType)
        {
            case "Day":
                // Day Shift: 5:00 AM - 5:00 PM
                EditScheduleStartTime = DateTime.Today.AddHours(5);
                EditScheduleEndTime = DateTime.Today.AddHours(17);
                break;
            case "Night":
                // Night Shift: 5:00 PM - 5:00 AM (next day)
                EditScheduleStartTime = DateTime.Today.AddHours(17);
                EditScheduleEndTime = DateTime.Today.AddHours(5);
                break;
            case "Custom":
                // Keep current values for custom
                break;
        }
        StateHasChanged();
    }

    private async Task SaveScheduleChanges()
    {
        Console.WriteLine("========================================");
        Console.WriteLine("=== SaveScheduleChanges START ===");
        Console.WriteLine($"Timestamp: {DateTime.Now}");

        // Validation checks
        if (SelectedAttendanceForEdit == null)
        {
            Console.WriteLine("ERROR: SelectedAttendanceForEdit is null!");
            SaveMessage = "Error: No employee selected";
            SaveSuccess = false;
            StateHasChanged();
            return;
        }

        Console.WriteLine($"EmployeeID: {SelectedAttendanceForEdit.EmployeeID}");
        Console.WriteLine($"AttendanceID: {SelectedAttendanceForEdit.AttendanceID}");
        Console.WriteLine($"IsNewAttendance: {IsNewAttendance}");

        if (string.IsNullOrEmpty(SelectedShiftType))
        {
            Console.WriteLine("ERROR: SelectedShiftType is empty!");
            SaveMessage = "Please select a shift type";
            SaveSuccess = false;
            StateHasChanged();
            return;
        }

        // Validate and map status
        var statusToSave = MapToValidStatus(EditAttendanceStatus);
        if (!IsValidStatus(statusToSave))
        {
            Console.WriteLine($"ERROR: Invalid status '{statusToSave}'");
            SaveMessage = "Invalid attendance status selected";
            SaveSuccess = false;
            StateHasChanged();
            return;
        }

        Console.WriteLine($"Status to save: {statusToSave}");

        // Set saving state
        IsSaving = true;
        SaveMessage = "";
        StateHasChanged();
        await Task.Delay(50); // Allow UI to update

        try
        {
            // Extract time spans
            var startTimeSpan = EditScheduleStartTime.TimeOfDay;
            var endTimeSpan = EditScheduleEndTime.TimeOfDay;

            Console.WriteLine($"Schedule Start: {startTimeSpan}");
            Console.WriteLine($"Schedule End: {endTimeSpan}");
            Console.WriteLine($"Attendance Date: {EditAttendanceDate:yyyy-MM-dd}");

            // Prepare actual check in/out times
            DateTime? actualCheckIn = null;
            DateTime? actualCheckOut = null;

            if (!IsNewAttendance)
            {
                if (EditActualCheckInTime.HasValue)
                {
                    actualCheckIn = EditAttendanceDate.Date.Add(EditActualCheckInTime.Value.TimeOfDay);
                    Console.WriteLine($"Actual Check In: {actualCheckIn}");
                }

                if (EditActualCheckOutTime.HasValue)
                {
                    actualCheckOut = EditAttendanceDate.Date.Add(EditActualCheckOutTime.Value.TimeOfDay);
                    Console.WriteLine($"Actual Check Out: {actualCheckOut}");
                }
            }

            bool success = false;

            // Determine if creating new or updating existing
            if (IsNewAttendance || SelectedAttendanceForEdit.AttendanceID == 0)
            {
                Console.WriteLine(">>> Creating NEW attendance record...");
                Console.WriteLine($"    EmployeeID: {SelectedAttendanceForEdit.EmployeeID}");
                Console.WriteLine($"    Date: {EditAttendanceDate:yyyy-MM-dd}");

                // Call service to create
                success = await AttendanceService.CreateAttendanceWithShiftAsync(
                    SelectedAttendanceForEdit.EmployeeID,
                    EditAttendanceDate,
                    startTimeSpan,
                    endTimeSpan,
                    string.IsNullOrWhiteSpace(EditNotes) ? null : EditNotes);

                Console.WriteLine($">>> CreateAttendanceWithShiftAsync returned: {success}");
            }
            else
            {
                Console.WriteLine($">>> Updating EXISTING attendance record ID: {SelectedAttendanceForEdit.AttendanceID}");

                // Call service to update
                success = await AttendanceService.UpdateAttendanceRecordAsync(
                    SelectedAttendanceForEdit.AttendanceID,
                    startTimeSpan,
                    endTimeSpan,
                    actualCheckIn,
                    actualCheckOut,
                    statusToSave,
                    EditIsLate,
                    string.IsNullOrWhiteSpace(EditNotes) ? null : EditNotes);

                Console.WriteLine($">>> UpdateAttendanceRecordAsync returned: {success}");
            }

            if (success)
            {
                Console.WriteLine("=== SUCCESS: Shift saved! ===");
                SaveMessage = "✓ Shift saved successfully!";
                SaveSuccess = true;
                StateHasChanged();

                // Brief delay to show success message
                await Task.Delay(1000);

                // Close modal and reload data
                var hadHistoryModal = SelectedEmployeeForHistory != null;
                var historyEmployeeId = SelectedEmployeeForHistory?.EmployeeID;

                CloseEditScheduleModal();

                if (hadHistoryModal && historyEmployeeId.HasValue)
                {
                    SelectedEmployeeForHistory = AttendanceRecords.FirstOrDefault(r => r.EmployeeID == historyEmployeeId);
                    if (SelectedEmployeeForHistory != null)
                    {
                        await LoadAttendanceHistory();
                        ShowHistoryModal = true;
                    }
                }

                // Always reload main records
                await LoadAttendanceRecords();
                Console.WriteLine("=== Data reloaded ===");
            }
            else
            {
                Console.WriteLine("=== FAILED: Service returned false ===");
                SaveMessage = "✗ Failed to save shift. Check console for details.";
                SaveSuccess = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"=== EXCEPTION in SaveScheduleChanges ===");
            Console.WriteLine($"Message: {ex.Message}");
            Console.WriteLine($"Type: {ex.GetType().Name}");
            Console.WriteLine($"Stack Trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"Inner Exception: {ex.InnerException.Message}");
            }

            SaveMessage = $"✗ Error: {ex.Message}";
            SaveSuccess = false;
        }
        finally
        {
            IsSaving = false;
            StateHasChanged();
            Console.WriteLine("=== SaveScheduleChanges END ===");
            Console.WriteLine("========================================");
        }
    }

    private string MapToValidStatus(string status)
    {
        if (string.IsNullOrEmpty(status))
            return "Pending";

        return status switch
        {
            "Not Checked In" => "Pending",
            "Checked In" => "Present",
            "Late" => "Present",
            _ => status
        };
    }

    private bool IsValidStatus(string status)
    {
        var validStatuses = new HashSet<string>
        {
            "Pending", "Present", "Absent", "On Leave", "Half Day", "Holiday"
        };
        return validStatuses.Contains(status);
    }

    private void CloseEditScheduleModal()
    {
        ShowEditScheduleModal = false;
        SelectedAttendanceForEdit = null;
        SaveMessage = "";
        StateHasChanged();
    }

    private void CloseHistoryModal()
    {
        ShowHistoryModal = false;
        SelectedEmployeeForHistory = null;
        StateHasChanged();
    }

    private void OpenEditScheduleModal(AttendanceRecordDto record)
    {
        IsNewAttendance = false;
        SelectedAttendanceForEdit = record;
        EditEmployeeName = SelectedEmployeeForHistory != null
            ? $"{SelectedEmployeeForHistory.FirstName} {SelectedEmployeeForHistory.LastName}"
            : $"{record.FirstName} {record.LastName}";
        EditEmployeeId = record.EmployeeID;
        EditAttendanceDate = record.AttendanceDate;

        // Determine shift type based on schedule
        if (record.ScheduleStart.HasValue)
        {
            var startHour = record.ScheduleStart.Value.Hours;
            var endHour = record.ScheduleEnd?.Hours ?? 0;

            if (startHour == 5 && endHour == 17)
                SelectedShiftType = "Day";
            else if (startHour == 17 && endHour == 5)
                SelectedShiftType = "Night";
            else
                SelectedShiftType = "Custom";
        }
        else
        {
            SelectedShiftType = "";
        }

        // Set schedule times
        EditScheduleStartTime = DateTime.Today.Add(record.ScheduleStart ?? new TimeSpan(5, 0, 0));
        EditScheduleEndTime = DateTime.Today.Add(record.ScheduleEnd ?? new TimeSpan(17, 0, 0));

        // Set actual check in/out times
        if (record.ActualCheckIn.HasValue)
            EditActualCheckInTime = DateTime.Today.Add(record.ActualCheckIn.Value.TimeOfDay);
        else
            EditActualCheckInTime = null;

        if (record.ActualCheckOut.HasValue)
            EditActualCheckOutTime = DateTime.Today.Add(record.ActualCheckOut.Value.TimeOfDay);
        else
            EditActualCheckOutTime = null;

        // Set other fields
        EditAttendanceStatus = record.AttendanceStatus;
        EditIsLate = record.IsLate;
        EditNotes = record.Notes ?? "";
        SaveMessage = "";

        ShowEditScheduleModal = true;
        ShowHistoryModal = false;
    }

    private async Task HandleSaveClick()
    {
        await SaveScheduleChanges();
    }
}