@page "/hr/department-setup"
@using HestiaLink.Components.Layout
@using HestiaLink.Models
@using HestiaLink.Data
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext Context
@inject IJSRuntime JSRuntime
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Department Setup</h1>
        <span class="page-topbar-subtitle">HR Administration</span>
    </header>

    <section class="page-content">

    <div class="user-toolbar">
        <div class="toolbar-left">
            <div class="toolbar-search">
                <input type="text" placeholder="Search departments..." @bind="SearchText" @oninput="OnSearchChanged" />
                <span class="search-icon">🔍</span>
            </div>
        </div>
        <div>
            <button class="btn-secondary" style="margin-right: 10px;" @onclick="OpenArchivedModal">
                📁 View Archived (@ArchivedDepartmentsCount)
            </button>
            <button class="btn-create" @onclick="OpenCreateModal">Add New Department</button>
        </div>
    </div>

    @if (!IsLoaded)
    {
        <div class="loading">
            <div>🔄 Loading departments from database...</div>
        </div>
    }
    else if (HasError)
    {
        <div class="error-message">
            <h4>❌ Database Connection Error</h4>
            <p>Error: @ErrorMessage</p>
            <button class="btn-create" @onclick="RetryLoad">Retry Connection</button>
        </div>
    }
    else if (!Departments.Any())
    {
        <div class="no-data">
            <p>📭 No departments found in database</p>
            <p style="font-size: 0.8rem; color: #64748b;">
                The database table is empty. Click 'Add New Department' to create one.
            </p>
        </div>
    }
    else
    {
        <div class="panel-card">
            <div class="panel-body user-list-container">
                @if (FilteredDepartments.Any())
                {
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Department Name</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th style="text-align:center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var dept in FilteredDepartments)
                            {
                                <tr>
                                    <td>@dept.DepartmentID</td>
                                    <td>
                                        <div style="font-weight: 700; color: #102f33;">@dept.DepartmentName</div>
                                    </td>
                                    <td style="color:#64748b; font-size:0.85rem; max-width: 300px;">
                                        @(string.IsNullOrEmpty(dept.Description) ? "No description" : dept.Description)
                                    </td>
                                    <td>
                                        <span class="badge-@(dept.Status == "Active" ? "active" : dept.Status == "Inactive" ? "inactive" : "archived")">
                                            @dept.Status
                                        </span>
                                    </td>
                                    <td style="text-align:center;">
                                        <div style="display: flex; gap: 8px; justify-content: center;">
                                            <button class="btn-icon btn-icon-edit" title="Edit" @onclick="() => OpenEditModal(dept)">✏️</button>
                                            <button class="btn-icon btn-icon-archive" title="Archive" @onclick="() => ArchiveDepartment(dept)">📁</button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="no-data">
                        <p>No departments match your search criteria</p>
                    </div>
                }
            </div>
        </div>
    }
    </section>
</div>

<!-- Add/Edit Department Modal -->
@if (ShowModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">@(IsEditMode ? "Edit Department" : "Create New Department")</h2>
            </div>

            <div class="form-group-container" style="padding: 20px;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">Department Name *</label>
                    <input type="text" class="form-input" @bind="CurrentDept.DepartmentName" placeholder="e.g. Front Office" />
                    @if (string.IsNullOrWhiteSpace(CurrentDept.DepartmentName))
                    {
                        <div style="color: #dc2626; font-size: 0.8rem; margin-top: 5px;">Department name is required</div>
                    }
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" rows="4" @bind="CurrentDept.Description" placeholder="Describe the department's responsibilities..."></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">Status</label>
                    <select class="form-input" @bind="CurrentDept.Status">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Archived">Archived</option>
                    </select>
                </div>
            </div>

            <div class="action-footer" style="border:none; padding-bottom:0; margin-top:20px;">
                <button class="btn-primary" @onclick="SaveDepartment" disabled="@(!CanSave)">
                    @(IsEditMode ? "Update Department" : "Add New Department")
                </button>
                <button class="btn-secondary" @onclick="CloseModal">Cancel</button>
            </div>
        </div>
    </div>
}

<!-- Archived Departments Modal -->
@if (ShowArchivedModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">📁 Archived Departments</h2>
                <div style="font-size: 0.9rem; color: #64748b;">
                    @ArchivedDepartments.Count archived departments
                </div>
            </div>

            <div class="panel-body" style="max-height: 60vh; overflow-y: auto;">
                @if (ArchivedDepartments.Any())
                {
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Department Name</th>
                                <th>Description</th>
                                <th>Archived Since</th>
                                <th style="text-align:center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var dept in ArchivedDepartments)
                            {
                                <tr>
                                    <td>@dept.DepartmentID</td>
                                    <td>
                                        <div style="font-weight: 700; color: #102f33;">@dept.DepartmentName</div>
                                    </td>
                                    <td style="color:#64748b; font-size:0.85rem; max-width: 300px;">
                                        @(string.IsNullOrEmpty(dept.Description) ? "No description" : dept.Description)
                                    </td>
                                    <td style="color:#64748b; font-size:0.8rem;">
                                        <!-- You can add archive date if you have that field -->
                                        Previously archived
                                    </td>
                                    <td style="text-align:center;">
                                        <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.8rem; background: #10b981;"
                                                @onclick="() => RestoreDepartmentFromModal(dept)"
                                                title="Restore this department">
                                            🔄 Restore
                                        </button>
                                        <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.8rem; margin-left: 5px; background: #dc2626;"
                                                @onclick="() => ConfirmDeleteFromModal(dept)"
                                                title="Permanently delete">
                                            🗑️ Delete
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="no-data" style="padding: 40px;">
                        <p>📭 No archived departments found</p>
                        <p style="font-size: 0.8rem; color: #64748b;">
                            There are no departments in the archive.
                        </p>
                    </div>
                }
            </div>

            <div class="action-footer" style="border:none; padding-bottom:0; margin-top:20px;">
                <button class="btn-secondary" @onclick="CloseArchivedModal">Close</button>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (ShowDeleteConfirm)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">Confirm Delete</h2>
            </div>
            <div style="padding: 20px;">
                <p>Are you sure you want to delete department <strong>@CurrentDept.DepartmentName</strong>?</p>
                <p style="color: #dc2626; font-size: 0.9rem;">This action cannot be undone.</p>
            </div>
            <div class="action-footer" style="border:none; padding-bottom:0;">
                <button class="btn-secondary" style="background:#dc2626;" @onclick="DeleteDepartment">Delete</button>
                <button class="btn-secondary" @onclick="CancelDelete">Cancel</button>
            </div>
        </div>
    </div>
}

<!-- Archive Confirmation Modal -->
@if (ShowArchiveConfirm)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">Confirm Archive</h2>
            </div>
            <div style="padding: 20px;">
                <p>Are you sure you want to archive department <strong>@ArchiveDept.DepartmentName</strong>?</p>
                <p style="color: #f59e0b; font-size: 0.9rem;">Archived departments will not appear in active lists but can be restored later.</p>
            </div>
            <div class="action-footer" style="border:none; padding-bottom:0;">
                <button class="btn-secondary" style="background:#f59e0b;" @onclick="ConfirmArchive">Archive</button>
                <button class="btn-secondary" @onclick="CancelArchive">Cancel</button>
            </div>
        </div>
    </div>
}

@code {
    private string SearchText { get; set; } = "";
    private bool ShowModal = false;
    private bool ShowDeleteConfirm = false;
    private bool ShowArchiveConfirm = false;
    private bool ShowArchivedModal = false; // New modal for archived departments
    private bool IsEditMode = false;
    private bool IsLoaded = false;
    private bool HasError = false;
    private string ErrorMessage = "";
    private Department CurrentDept = new();
    private Department ArchiveDept = new();
    private List<Department> Departments = new();

    // Computed properties
    private List<Department> ArchivedDepartments =>
        Departments.Where(d => d.Status == "Archived").OrderBy(d => d.DepartmentName).ToList();

    private int ArchivedDepartmentsCount => ArchivedDepartments.Count;

    protected override async Task OnInitializedAsync()
    {
        await LoadDepartments();
    }

    private async Task LoadDepartments()
    {
        try
        {
            HasError = false;
            ErrorMessage = "";

            Departments = await Context.Departments
                .AsNoTracking()
                .OrderBy(d => d.DepartmentName)
                .ToListAsync();

            IsLoaded = true;
            StateHasChanged();

        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = ex.Message;
            IsLoaded = true;
            await JSRuntime.InvokeVoidAsync("alert", $"Database Error: {ex.Message}");
        }
    }

    private async Task RetryLoad()
    {
        IsLoaded = false;
        HasError = false;
        StateHasChanged();
        await Task.Delay(1000);
        await LoadDepartments();
    }

    // FIXED: Renamed method to avoid naming conflict
    private void OpenArchivedModal()
    {
        ShowArchivedModal = true;
    }

    private void CloseArchivedModal()
    {
        ShowArchivedModal = false;
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        SearchText = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private List<Department> FilteredDepartments
    {
        get
        {
            var query = Departments.Where(d => d.Status != "Archived").AsQueryable();

            if (!string.IsNullOrEmpty(SearchText))
            {
                query = query.Where(d => d.DepartmentName.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                                        (d.Description != null && d.Description.Contains(SearchText, StringComparison.OrdinalIgnoreCase)));
            }

            return query.OrderBy(d => d.DepartmentName).ToList();
        }
    }

    private void OpenCreateModal()
    {
        CurrentDept = new Department { Status = "Active" };
        IsEditMode = false;
        ShowModal = true;
    }

    private void OpenEditModal(Department dept)
    {
        CurrentDept = new Department
        {
            DepartmentID = dept.DepartmentID,
            DepartmentName = dept.DepartmentName,
            Description = dept.Description,
            Status = dept.Status
        };
        IsEditMode = true;
        ShowModal = true;
    }

    private void CloseModal()
    {
        ShowModal = false;
        CurrentDept = new Department();
    }

    private void ConfirmDelete(Department dept)
    {
        CurrentDept = dept;
        ShowDeleteConfirm = true;
    }
    
    private void ArchiveDepartment(Department dept)
    {
        ArchiveDept = dept;
        ShowArchiveConfirm = true;
    }

    private void CancelDelete()
    {
        ShowDeleteConfirm = false;
        CurrentDept = new Department();
    }

    private async Task DeleteDepartment()
    {
        try
        {
            var department = await Context.Departments.FindAsync(CurrentDept.DepartmentID);
            if (department != null)
            {
                Context.Departments.Remove(department);
                await Context.SaveChangesAsync();

                // Remove from local list
                Departments.RemoveAll(d => d.DepartmentID == CurrentDept.DepartmentID);
                StateHasChanged();

                await JSRuntime.InvokeVoidAsync("alert", "Department deleted successfully!");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error deleting department: {ex.Message}");
        }
        finally
        {
            ShowDeleteConfirm = false;
            CurrentDept = new Department();
        }
    }

    // New method: Delete from archived modal
    private void ConfirmDeleteFromModal(Department dept)
    {
        CurrentDept = dept;
        ShowDeleteConfirm = true;
    }

    // New method: Restore from archived modal
    private async Task RestoreDepartmentFromModal(Department dept)
    {
        try
        {
            var department = await Context.Departments.FindAsync(dept.DepartmentID);
            if (department != null)
            {
                department.Status = "Active";
                Context.Departments.Update(department);
                await Context.SaveChangesAsync();

                // Update local list
                var localDept = Departments.FirstOrDefault(d => d.DepartmentID == dept.DepartmentID);
                if (localDept != null)
                {
                    localDept.Status = "Active";
                }
                StateHasChanged();

                await JSRuntime.InvokeVoidAsync("alert", "Department restored successfully!");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error restoring department: {ex.Message}");
        }
    }

    private void CancelArchive()
    {
        ShowArchiveConfirm = false;
        ArchiveDept = new Department();
    }

    private async Task ConfirmArchive()
    {
        try
        {
            var department = await Context.Departments.FindAsync(ArchiveDept.DepartmentID);
            if (department != null)
            {
                department.Status = "Archived";
                Context.Departments.Update(department);
                await Context.SaveChangesAsync();

                // Update local list
                var localDept = Departments.FirstOrDefault(d => d.DepartmentID == ArchiveDept.DepartmentID);
                if (localDept != null)
                {
                    localDept.Status = "Archived";
                }
                StateHasChanged();

                await JSRuntime.InvokeVoidAsync("alert", "Department archived successfully!");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error archiving department: {ex.Message}");
        }
        finally
        {
            ShowArchiveConfirm = false;
            ArchiveDept = new Department();
        }
    }

    private async Task SaveDepartment()
    {
        if (!CanSave) return;

        try
        {
            if (IsEditMode)
            {
                var existingDept = await Context.Departments.FindAsync(CurrentDept.DepartmentID);
                if (existingDept != null)
                {
                    existingDept.DepartmentName = CurrentDept.DepartmentName;
                    existingDept.Description = CurrentDept.Description;
                    existingDept.Status = CurrentDept.Status;
                    Context.Departments.Update(existingDept);
                    await Context.SaveChangesAsync();

                    // Update local list
                    var localDept = Departments.FirstOrDefault(d => d.DepartmentID == CurrentDept.DepartmentID);
                    if (localDept != null)
                    {
                        localDept.DepartmentName = CurrentDept.DepartmentName;
                        localDept.Description = CurrentDept.Description;
                        localDept.Status = CurrentDept.Status;
                    }
                    StateHasChanged();
                }
            }
            else
            {
                Context.Departments.Add(CurrentDept);
                await Context.SaveChangesAsync();

                // Reload to get the new department with ID
                await LoadDepartments();
            }

            CloseModal();
            await JSRuntime.InvokeVoidAsync("alert",
                $"Department {(IsEditMode ? "updated" : "created")} successfully!");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert",
                $"Error saving department: {ex.Message}");
        }
    }

    private bool CanSave => !string.IsNullOrWhiteSpace(CurrentDept.DepartmentName);
}