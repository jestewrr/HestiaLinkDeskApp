@page "/hr/payroll-processing"
@using HestiaLink.Data
@using HestiaLink.Models
@using HestiaLink.Models.Views
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext Context
@inject IJSRuntime JSRuntime
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Payroll Processing</h1>
        <span class="page-topbar-subtitle">Salary Management & Tax Processing</span>
    </header>

    <section class="page-content">
        <!-- 4 Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
            <!-- Card 1: Total Income -->
            <div class="stat-card" style="background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);">
                <div class="stat-title">Total Income</div>
                <div class="stat-value">₱@TotalIncome.ToString("N2")</div>
                <div style="font-size: 0.8rem; color: #64748b; margin-top: 4px;">From all completed payments</div>
            </div>

            <!-- Card 2: Number of Employees -->
            <div class="stat-card" style="background: linear-gradient(135deg, #dcfce7 0%, #86efac 100%);">
                <div class="stat-title">Active Employees</div>
                <div class="stat-value">@TotalEmployees</div>
                <div style="font-size: 0.8rem; color: #64748b; margin-top: 4px;">Currently employed</div>
            </div>

            <!-- Card 3: Total Employee Payments -->
            <div class="stat-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);">
                <div class="stat-title">Total Payments</div>
                <div class="stat-value">₱@TotalEmployeePayments.ToString("N2")</div>
                <div style="font-size: 0.8rem; color: #64748b; margin-top: 4px;">Gross payroll amount</div>
            </div>

            <!-- Card 4: Total Taxes Deducted -->
            <div class="stat-card" style="background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%);">
                <div class="stat-title">Total Taxes</div>
                <div class="stat-value">₱@TotalTaxesDeducted.ToString("N2")</div>
                <div style="font-size: 0.8rem; color: #64748b; margin-top: 4px;">Tax deductions</div>
            </div>
        </div>

        <!-- Toolbar with Create Tax Button -->
        <div style="background: var(--color-white); padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-weight: 700; color: var(--color-dark-teal); margin-bottom: 8px; display: block;">Payroll Period</label>
                    <select class="form-select" @bind="SelectedPeriod">
                        <option value="2025-01-01">January 1-15, 2025</option>
                        <option value="2024-12-16">December 16-31, 2024</option>
                        <option value="2024-12-01">December 1-15, 2024</option>
                        <option value="2024-11-16">November 16-30, 2024</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-weight: 700; color: var(--color-dark-teal); margin-bottom: 8px; display: block;">Filter by Department</label>
                    <select class="form-select" @bind="DepartmentFilter">
                        <option value="0">All Departments</option>
                        @foreach (var dept in Departments)
                        {
                            <option value="@dept.DepartmentID">@dept.DepartmentName</option>
                        }
                    </select>
                </div>
                <button class="btn-secondary" style="background: #f59e0b; color: white;" @onclick="OpenTaxModal">⚙️ Manage Taxes</button>
                <button class="btn-primary" @onclick="LoadPayrollData">🔄 Load Payroll</button>
            </div>
        </div>

        @if (!IsLoaded)
        {
            <div class="loading">Loading payroll data...</div>
        }
        else if (HasError)
        {
            <div class="error-message">
                <h4>⚠️ Database Error</h4>
                <p>@ErrorMessage</p>
                <button class="btn-primary" style="margin-top:15px;" @onclick="RetryLoad">Retry</button>
            </div>
        }
        else
        {
            <!-- Employee Payroll View -->
            <div class="panel-card">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <span>Employee Payroll Summary</span>
                    <span style="font-weight: 400; font-size: 0.9rem;">@FilteredPayrollSummary.Count employees</span>
                </div>
                <div class="panel-body user-list-container">
                    @if (FilteredPayrollSummary.Any())
                    {
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>Employee ID</th>
                                    <th>Employee Name</th>
                                    <th>Position</th>
                                    <th>Monthly Salary</th>
                                    <th>Total Hours</th>
                                    <th>Hourly Rate</th>
                                    <th>Total Salary</th>
                                    <th>Payment Status</th>
                                    <th style="text-align:center;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var employee in FilteredPayrollSummary)
                                {
                                    <tr style="cursor: pointer;" @onclick="@(() => OpenEmployeePaymentModal(employee))">
                                        <td style="font-family: monospace; font-weight: 700;">@employee.EmployeeID</td>
                                        <td style="font-weight: 700;">@employee.EmployeeName</td>
                                        <td>@employee.PositionTitle</td>
                                        <td>₱@employee.MonthlySalary.ToString("N2")</td>
                                        <td style="text-align: center; font-weight: 600;">@employee.TotalHours.ToString("N1")</td>
                                        <td>₱@employee.HourlyRate.ToString("N2")</td>
                                        <td style="font-weight: 900; color: var(--color-teal);">₱@employee.TotalSalary.ToString("N2")</td>
                                        <td>
                                            <span class="status-badge @GetPaymentStatusClass(employee.PaymentStatus)">
                                                @employee.PaymentStatus
                                            </span>
                                        </td>
                                        <td style="text-align:center;">
                                            <button class="btn-secondary" style="padding: 6px 12px;"
                                                    @onclick:stopPropagation="true"
                                                    @onclick="@(() => OpenEmployeePaymentModal(employee))">
                                                💰 Update
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="no-data" style="padding: 40px;">No payroll records found for the selected period</div>
                    }
                </div>
            </div>
        }
    </section>
</div>

<!-- Tax Management Modal -->
@if (ShowTaxModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">Tax Management</h2>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; padding: 20px;">
                <!-- Left Side: Add New Tax Form -->
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; height: fit-content;">
                    <h3 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900; font-size: 1.1rem; margin-bottom: 20px;">
                        <span style="background: var(--color-teal); color: white; padding: 4px 8px; border-radius: 6px; margin-right: 8px;">➕</span>
                        Add New Tax Rate
                    </h3>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Tax Name *</label>
                        <input type="text" class="form-input" @bind="NewTax.TaxName" placeholder="e.g., Withholding Tax"
                               style="width: 100%; padding: 10px 12px;" />
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Tax Percentage *</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" step="0.01" class="form-input" @bind="NewTax.TaxPercentage"
                                   placeholder="e.g., 15" style="flex: 1; padding: 10px 12px;" />
                            <span style="color: #64748b; font-weight: 600;">%</span>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" rows="3" @bind="NewTax.TaxDescription"
                                  placeholder="Describe the tax purpose..."
                                  style="width: 100%; padding: 10px 12px; resize: vertical;"></textarea>
                    </div>

                    <button class="btn-primary" style="width: 100%; padding: 12px; font-weight: 700;"
                            @onclick="AddNewTax">
                        <span style="margin-right: 8px;">✅</span> Add Tax Rate
                    </button>

                    <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                        <div style="font-size: 0.85rem; color: #0369a1; font-weight: 600;">💡 Tip</div>
                        <div style="font-size: 0.8rem; color: #64748b; margin-top: 4px;">
                            Add tax rates that will be automatically applied to payroll calculations.
                        </div>
                    </div>
                </div>

                <!-- Right Side: Tax Table View -->
                <div>
                    <div style="margin-bottom: 16px;">
                        <h3 style="margin: 0; color: var(--color-dark-teal); font-weight: 900; font-size: 1.1rem;">
                            <span style="background: var(--color-teal); color: white; padding: 4px 8px; border-radius: 6px; margin-right: 8px;">📊</span>
                            Current Tax Rates
                        </h3>
                        <div style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">
                            @TaxRates.Count active and archived tax rates
                        </div>
                    </div>

                    <div class="panel-body" style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                        @if (TaxRates.Any())
                        {
                            <table class="user-table" style="margin: 0;">
                                <thead>
                                    <tr style="background: #f8fafc;">
                                        <th style="padding: 12px 16px; font-weight: 700; color: #1e293b;">Tax Name</th>
                                        <th style="padding: 12px 16px; font-weight: 700; color: #1e293b;">Percentage</th>
                                        <th style="padding: 12px 16px; font-weight: 700, color: #1e293b;">Status</th>
                                        <th style="padding: 12px 16px; font-weight: 700; color: #1e293b; text-align:center;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var tax in TaxRates)
                                    {
                                        <tr style="border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 12px 16px;">
                                                <div style="font-weight: 700; color: var(--color-dark-teal);">@tax.TaxName</div>
                                                @if (!string.IsNullOrWhiteSpace(tax.TaxDescription))
                                                {
                                                    <div style="font-size: 0.85rem; color: #64748b; margin-top: 2px;">
                                                        @tax.TaxDescription
                                                    </div>
                                                }
                                            </td>
                                            <td style="padding: 12px 16px;">
                                                <span class="status-badge" style="background: #fee2e2; color: #991b1b; padding: 6px 12px; font-weight: 700;">
                                                    @tax.TaxPercentage.ToString("N1")%
                                                </span>
                                            </td>
                                            <td style="padding: 12px 16px;">
                                                <span class="status-badge @(tax.Status == "Active" ? "status-active" : "status-inactive")"
                                                      style="padding: 6px 12px;">
                                                    @if (tax.Status == "Active")
                                                    {
                                                        <span style="margin-right: 4px;">✅</span>
                                                    }
                                                    else
                                                    {
                                                        <span style="margin-right: 4px;">📁</span>
                                                    }
                                                    @tax.Status
                                                </span>
                                            </td>
                                            <td style="padding: 12px 16px; text-align:center;">
                                                <button class="btn-secondary"
                                                        style="padding: 6px 14px; background: @(tax.Status == "Active" ? "#f59e0b" : "#10b981"); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;"
                                                        @onclick="@(() => ToggleTaxStatus(tax))">
                                                    @if (tax.Status == "Active")
                                                    {
                                                        <span style="margin-right: 4px;">📁</span>
                                                        @:Archive
                                                    }
                                                    else
                                                    {
                                                        <span style="margin-right: 4px;">↩️</span>
                                                        @:Restore
                                                    }
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="no-data" style="padding: 40px 20px; text-align: center;">
                                <div style="font-size: 3rem; color: #e2e8f0; margin-bottom: 16px;">📊</div>
                                <div style="font-weight: 700; color: #64748b; margin-bottom: 8px;">No tax rates configured</div>
                                <div style="color: #94a3b8; font-size: 0.9rem;">Add your first tax rate using the form on the left</div>
                            </div>
                        }
                    </div>

                    <!-- Summary Stats -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px;">
                        <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; border: 1px solid #bbf7d0;">
                            <div style="font-size: 0.85rem; color: #166534; font-weight: 600;">Active Taxes</div>
                            <div style="font-size: 1.5rem; font-weight: 900, color: #166534;">
                                @TaxRates.Count(t => t.Status == "Active")
                            </div>
                        </div>
                        <div style="background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 0.85rem; color: #475569; font-weight: 600;">Archived Taxes</div>
                            <div style="font-size: 1.5rem; font-weight: 900, color: #475569;">
                                @TaxRates.Count(t => t.Status == "Archived")
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-footer" style="border-top: 1px solid #e2e8f0; padding: 16px 20px; margin-top: 0;">
                <button class="btn-secondary" @onclick="CloseModals"
                        style="padding: 10px 20px; background: #64748b; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    Close
                </button>
            </div>
        </div>
    </div>
}

<!-- Employee Payment Status Modal -->
@if (ShowEmployeePaymentModal && SelectedEmployee != null)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">Update Payment Status</h2>
            </div>

            <div style="padding: 20px;">
                <div style="margin-bottom: 20px; background: #f8fafc; padding: 16px; border-radius: 8px;">
                    <div style="font-weight: 700; color: var(--color-dark-teal); font-size: 0.9rem;">Employee</div>
                    <div style="font-size: 1.3rem; font-weight: 900, color: var(--color-teal);">@SelectedEmployee.EmployeeName</div>
                    <div style="font-size: 0.9rem; color: #64748b;">@SelectedEmployee.PositionTitle</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div style="background: #ecfdf5; padding: 16px; border-radius: 8px;">
                        <div style="font-weight: 700; color: #065f46; font-size: 0.85rem;">Total Hours</div>
                        <div style="font-size: 1.4rem; font-weight: 900, color: #047857;">@SelectedEmployee.TotalHours.ToString("N1")h</div>
                    </div>
                    <div style="background: #eff6ff; padding: 16px; border-radius: 8px;">
                        <div style="font-weight: 700; color: #1e40af; font-size: 0.85rem;">Total Salary</div>
                        <div style="font-size: 1.4rem; font-weight: 900, color: #1d4ed8;">₱@SelectedEmployee.TotalSalary.ToString("N2")</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Payment Status</label>
                    <select class="form-select" @bind="SelectedPaymentStatus">
                        <option value="Pending">⏳ Pending</option>
                        <option value="Processing">🔄 Processing</option>
                        <option value="Paid">✅ Paid</option>
                        <option value="On Hold">⏸️ On Hold</option>
                    </select>
                </div>

                <div class="action-footer" style="border:none; padding-bottom:0; margin-top: 20px;">
                    <button class="btn-primary" @onclick="UpdateEmployeePayment">Update Status</button>
                    <button class="btn-secondary" @onclick="CloseModals">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .stat-card {
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .stat-title {
        font-size: 0.85rem;
        color: #1e293b;
        text-transform: uppercase;
        font-weight: 700;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 900;
        color: #0f172a;
        margin-top: 8px;
    }

    .status-active {
        background-color: #d1fae5;
        color: #065f46;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-inactive {
        background-color: #f1f5f9;
        color: #64748b;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-processing {
        background-color: #dbeafe;
        color: #1e40af;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-paid {
        background-color: #d1fae5;
        color: #065f46;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-onhold {
        background-color: #fee2e2;
        color: #991b1b;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }
</style>

@code {
    // State
    private List<Tax> TaxRates = new();
    private List<EmployeePayrollSummaryView> EmployeePayrollSummary = new();
    private List<Department> Departments = new();
    private Tax NewTax = new();
    private EmployeePayrollSummaryView? SelectedEmployee;
    private string SelectedPaymentStatus = "Pending";
    private string SelectedPeriod = "2025-01-01";
    private int DepartmentFilter = 0;
    private bool ShowTaxModal = false;
    private bool ShowEmployeePaymentModal = false;
    private bool IsLoaded = false;
    private bool HasError = false;
    private string ErrorMessage = string.Empty;

    // Summary Calculations
    private decimal TotalIncome = 0m;
    private int TotalEmployees = 0;
    private decimal TotalEmployeePayments = 0m;
    private decimal TotalTaxesDeducted = 0m;

    private List<EmployeePayrollSummaryView> FilteredPayrollSummary =>
        DepartmentFilter == 0
            ? EmployeePayrollSummary
            : EmployeePayrollSummary.Where(e => e.DepartmentID == DepartmentFilter).ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            HasError = false;
            ErrorMessage = string.Empty;

            // Load departments for filter
            Departments = await Context.Departments
                .Where(d => d.Status == "Active")
                .AsNoTracking()
                .OrderBy(d => d.DepartmentName)
                .ToListAsync();

            // Load tax rates
            TaxRates = await Context.Taxes
                .Select(t => new Tax
                {
                    TaxID = t.TaxID,
                    TaxName = t.TaxName,
                    TaxPercentage = Convert.ToDecimal(t.TaxPercentage),
                    TaxDescription = t.TaxDescription,
                    Status = t.Status
                })
                .AsNoTracking()
                .OrderBy(t => t.TaxName)
                .ToListAsync();

            // CRITICAL FIX: Force refresh of the view with explicit query
            await RefreshPayrollViewData();

            // Calculate summary totals
            await CalculateSummaryTotals();

            IsLoaded = true;
        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = ex.Message;
            IsLoaded = true;
        }
    }

    private async Task CalculateSummaryTotals()
    {
        try
        {
            // Get current month's start and end dates
            var now = DateTime.Now;
            var monthStart = new DateTime(now.Year, now.Month, 1);
            var monthEnd = monthStart.AddMonths(1).AddDays(-1);

            // TOTAL INCOME: Get all income for current month
            TotalIncome = await Context.Incomes
                .Where(i => i.IncomeDate >= monthStart && i.IncomeDate <= monthEnd)
                .SumAsync(i => i.Amount);

            // Total Active Employees
            TotalEmployees = await Context.Employees
                .CountAsync(e => e.Status == "Active");

            // Total Employee Payments for current month
            TotalEmployeePayments = await Context.Payrolls
                .Where(p => p.PeriodStart >= monthStart && p.PeriodEnd <= monthEnd)
                .SumAsync(p => p.GrossPay);

            // Total Taxes Deducted for current month
            TotalTaxesDeducted = await Context.Payrolls
                .Where(p => p.PeriodStart >= monthStart && p.PeriodEnd <= monthEnd)
                .SumAsync(p => p.TaxAmount);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in CalculateSummaryTotals: {ex.Message}");
            TotalIncome = 0m;
            TotalEmployees = EmployeePayrollSummary.Count;
            TotalEmployeePayments = EmployeePayrollSummary.Sum(e => e.TotalSalary);
            TotalTaxesDeducted = 0m;
        }
    }

    private async Task LoadPayrollData()
    {
        IsLoaded = false;
        StateHasChanged();
        await Task.Delay(300);
        await LoadData();
    }

    private async Task RetryLoad()
    {
        IsLoaded = false;
        StateHasChanged();
        await Task.Delay(500);
        await LoadData();
    }

    private void OpenTaxModal()
    {
        NewTax = new Tax();
        ShowTaxModal = true;
    }

    private async Task AddNewTax()
    {
        if (string.IsNullOrWhiteSpace(NewTax.TaxName) || NewTax.TaxPercentage <= 0m)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please enter a valid tax name and percentage.");
            return;
        }

        try
        {
            var tax = new Tax
            {
                TaxName = NewTax.TaxName.Trim(),
                TaxPercentage = NewTax.TaxPercentage,
                TaxDescription = NewTax.TaxDescription?.Trim(),
                Status = "Active"
            };

            Context.Taxes.Add(tax);
            await Context.SaveChangesAsync();

            TaxRates = await Context.Taxes
                .Select(t => new Tax
                {
                    TaxID = t.TaxID,
                    TaxName = t.TaxName,
                    TaxPercentage = Convert.ToDecimal(t.TaxPercentage),
                    TaxDescription = t.TaxDescription,
                    Status = t.Status
                })
                .AsNoTracking()
                .OrderBy(t => t.TaxName)
                .ToListAsync();

            NewTax = new Tax();
            await CalculateSummaryTotals();
            await JSRuntime.InvokeVoidAsync("alert", "Tax added successfully!");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error adding tax: {ex.Message}");
        }
    }

    private async Task ToggleTaxStatus(Tax tax)
    {
        try
        {
            var existingTax = await Context.Taxes.FindAsync(tax.TaxID);
            if (existingTax != null)
            {
                existingTax.Status = existingTax.Status == "Active" ? "Archived" : "Active";
                await Context.SaveChangesAsync();

                TaxRates = await Context.Taxes
                    .Select(t => new Tax
                    {
                        TaxID = t.TaxID,
                        TaxName = t.TaxName,
                        TaxPercentage = Convert.ToDecimal(t.TaxPercentage),
                        TaxDescription = t.TaxDescription,
                        Status = t.Status
                    })
                    .AsNoTracking()
                    .OrderBy(t => t.TaxName)
                    .ToListAsync();

                await CalculateSummaryTotals();
                await JSRuntime.InvokeVoidAsync("alert", $"Tax status updated to {existingTax.Status}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error updating tax: {ex.Message}");
        }
    }

    private void OpenEmployeePaymentModal(EmployeePayrollSummaryView employee)
    {
        SelectedEmployee = employee;
        SelectedPaymentStatus = employee.PaymentStatus;
        ShowEmployeePaymentModal = true;
    }

    private async Task UpdateEmployeePayment()
    {
        if (SelectedEmployee == null) return;

        try
        {
            // Calculate pay values
            decimal regularPay = SelectedEmployee.TotalRegularHours * SelectedEmployee.HourlyRate;
            decimal overtimePay = SelectedEmployee.TotalOvertimeHours * (SelectedEmployee.HourlyRate * 1.5m);
            decimal grossPay = regularPay + overtimePay;

            // Calculate tax amount from active taxes
            decimal activeTaxPercentage = TaxRates
                .Where(t => t.Status == "Active")
                .Sum(t => t.TaxPercentage);
            decimal taxAmount = grossPay * (activeTaxPercentage / 100m);
            decimal netPay = grossPay - taxAmount;

            var periodStart = DateTime.Parse(SelectedPeriod);
            var periodEnd = periodStart.AddDays(14);

            // Get first active tax ID if available
            int? taxId = TaxRates.FirstOrDefault(t => t.Status == "Active")?.TaxID;

            // Find attendance
            var attendance = await Context.Attendances
                .Include(a => a.Schedule)
                .FirstOrDefaultAsync(a => a.Schedule != null && a.Schedule.EmployeeID == SelectedEmployee.EmployeeID);

            int? attendanceId = attendance?.AttendanceID;

            // CRITICAL FIX: Get or create IncomeID for this payroll
            var incomeStart = new DateTime(periodStart.Year, periodStart.Month, 1);
            var incomeEnd = incomeStart.AddMonths(1).AddDays(-1);

            var income = await Context.Incomes
                .Where(i => i.IncomeDate >= incomeStart && i.IncomeDate <= incomeEnd)
                .OrderByDescending(i => i.IncomeDate)
                .FirstOrDefaultAsync();

            int? incomeId = income?.IncomeID;

            // If no income record exists for this month, create one
            if (incomeId == null)
            {
                // Create a default income record for the month
                var newIncome = new Income
                {
                    IncomeDate = incomeStart,
                    Amount = 100000m, // Default starting amount
                    Description = $"Monthly income for {incomeStart:MMMM yyyy}",
                    CreatedDate = DateTime.Now
                };
                Context.Incomes.Add(newIncome);
                await Context.SaveChangesAsync();
                incomeId = newIncome.IncomeID;
            }

            // Check if payroll already exists for this period
            var existingPayroll = await Context.Payrolls
                .FirstOrDefaultAsync(p => p.PeriodStart == periodStart && p.PeriodEnd == periodEnd &&
                                        p.AttendanceID == attendanceId);

            if (existingPayroll != null)
            {
                // Store old status for comparison
                var oldStatus = existingPayroll.Status;

                // Update existing payroll
                existingPayroll.Status = SelectedPaymentStatus;
                existingPayroll.TotalHours = SelectedEmployee.TotalHours;
                existingPayroll.OvertimeHours = SelectedEmployee.TotalOvertimeHours;
                existingPayroll.HourlyRate = SelectedEmployee.HourlyRate;
                existingPayroll.RegularPay = regularPay;
                existingPayroll.OvertimePay = overtimePay;
                existingPayroll.GrossPay = grossPay;
                existingPayroll.TaxAmount = taxAmount;
                existingPayroll.NetPay = netPay;
                existingPayroll.TaxID = taxId;
                existingPayroll.IncomeID = incomeId; // Always set IncomeID

                // CRITICAL FIX: Handle income adjustment properly
                var incomeRecord = await Context.Incomes.FindAsync(incomeId);
                if (incomeRecord != null)
                {
                    // If changing from non-Paid to Paid, subtract
                    if (oldStatus != "Paid" && SelectedPaymentStatus == "Paid")
                    {
                        incomeRecord.Amount -= grossPay;
                        if (incomeRecord.Amount < 0) incomeRecord.Amount = 0;
                    }
                    // If changing from Paid to non-Paid, add back
                    else if (oldStatus == "Paid" && SelectedPaymentStatus != "Paid")
                    {
                        incomeRecord.Amount += grossPay;
                    }
                    // If staying as Paid and amount changed, adjust
                    else if (oldStatus == "Paid" && SelectedPaymentStatus == "Paid")
                    {
                        // Calculate the difference
                        decimal difference = grossPay - existingPayroll.GrossPay;
                        incomeRecord.Amount -= difference;
                        if (incomeRecord.Amount < 0) incomeRecord.Amount = 0;
                    }
                }

                await Context.SaveChangesAsync();
            }
            else
            {
                // Create new payroll
                var newPayroll = new Payroll
                {
                    AttendanceID = attendanceId,
                    IncomeID = incomeId, // Always set IncomeID
                    TaxID = taxId,
                    PeriodStart = periodStart,
                    PeriodEnd = periodEnd,
                    TotalHours = SelectedEmployee.TotalHours,
                    OvertimeHours = SelectedEmployee.TotalOvertimeHours,
                    HourlyRate = SelectedEmployee.HourlyRate,
                    RegularPay = regularPay,
                    OvertimePay = overtimePay,
                    GrossPay = grossPay,
                    TaxAmount = taxAmount,
                    NetPay = netPay,
                    Status = SelectedPaymentStatus,
                    CreatedDate = DateTime.Now
                };

                // CRITICAL FIX: Subtract from income only if status is Paid
                if (SelectedPaymentStatus == "Paid" && incomeId.HasValue)
                {
                    var incomeRecord = await Context.Incomes.FindAsync(incomeId.Value);
                    if (incomeRecord != null)
                    {
                        incomeRecord.Amount -= grossPay;
                        if (incomeRecord.Amount < 0) incomeRecord.Amount = 0;
                    }
                }

                Context.Payrolls.Add(newPayroll);
                await Context.SaveChangesAsync();
            }

            // CRITICAL FIX: Force refresh the view data
            await RefreshPayrollViewData();

            await JSRuntime.InvokeVoidAsync("alert", $"Payment status updated to {SelectedPaymentStatus}");
            CloseModals();

            // Force UI refresh
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in UpdateEmployeePayment: {ex.Message}");
            Console.WriteLine($"Inner Exception: {ex.InnerException?.Message}");

            await JSRuntime.InvokeVoidAsync("alert", $"Error updating payment: {ex.Message}\n{ex.InnerException?.Message}");
        }
    }

    private void CloseModals()
    {
        ShowTaxModal = false;
        ShowEmployeePaymentModal = false;
        SelectedEmployee = null;
        NewTax = new Tax();
    }

    private string GetPaymentStatusClass(string status)
    {
        return status switch
        {
            "Paid" => "status-paid",
            "Processing" => "status-processing",
            "On Hold" => "status-onhold",
            _ => "status-pending"
        };
    }

    private async Task RefreshIncomeData()
    {
        try
        {
            var now = DateTime.Now;
            var monthStart = new DateTime(now.Year, now.Month, 1);
            var monthEnd = monthStart.AddMonths(1).AddDays(-1);

            TotalIncome = await Context.Incomes
                .Where(i => i.IncomeDate >= monthStart && i.IncomeDate <= monthEnd)
                .SumAsync(i => i.Amount);

            await CalculateSummaryTotals();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing income data: {ex.Message}");
        }
    }

    // CRITICAL FIX: New method to properly refresh the view data
    private async Task RefreshPayrollViewData()
    {
        try
        {
            // Clear the current list
            EmployeePayrollSummary.Clear();

            // Force a fresh query from the database
            var freshData = await Context.EmployeePayrollSummaryView
                .AsNoTracking()
                .OrderBy(e => e.EmployeeName)
                .ToListAsync();

            // Update the list
            EmployeePayrollSummary = freshData;

            // Force UI update
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing payroll view: {ex.Message}");
        }
    }
}