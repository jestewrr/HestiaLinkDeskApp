@page "/finance/expense-tracking"
@layout MainLayout
@using HestiaLink.Data
@using HestiaLink.Models
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext _context

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Expense Tracking</h1>
        <span class="page-topbar-subtitle">Operational Expenses Management</span>
    </header>

    <section class="page-content">
        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-title">Total Expenses</div>
                <div class="stat-value">₱@TotalExpenses.ToString("N2")</div>
                <div class="stat-desc">All time total</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">This Month</div>
                <div class="stat-value">₱@MonthlyExpenses.ToString("N2")</div>
                <div class="stat-desc">Current month spend</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Pending Approval</div>
                <div class="stat-value">@PendingCount</div>
                <div class="stat-desc">Expenses awaiting review</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Categories</div>
                <div class="stat-value">@CategoryCount</div>
                <div class="stat-desc">Active expense types</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="user-toolbar">
            <div class="toolbar-left">
                <div class="toolbar-search" style="position: relative;">
                    <input type="text" placeholder="Search expenses..." @bind="SearchText" style="padding-left: 40px; width: 100%;" />
                    <span class="search-icon" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);">🔍</span>
                </div>
                <select class="filter-select" @bind="SelectedCategory">
                    <option value="All Categories">All Categories</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Supplies">Supplies</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Payroll">Payroll</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Others">Others</option>
                </select>
            </div>
            <button class="btn-create" @onclick="OpenAddModal">+ Add Expense</button>
        </div>

        <!-- Expenses Table -->
        <div class="panel-card">
            <div class="panel-body user-list-container">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Approved By</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var expense in FilteredExpenses)
                        {
                            <tr>
                                <td>@expense.ExpenseDate.ToString("MMM dd, yyyy")</td>
                                <td style="font-weight: 600;">@expense.Description</td>
                                <td>
                                    <span style="background: var(--color-light-gray); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">@expense.Category</span>
                                </td>
                                <td style="font-weight: 900; color: #991b1b;">₱@expense.Amount.ToString("N2")</td>
                                <td>
                                    <span class="status-badge @GetStatusColor(expense.Status)">@expense.Status</span>
                                </td>
                                <td>@(expense.ApprovedBy ?? "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<!-- Add Expense Modal -->
@if (ShowAddModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" style="max-width: 500px;" @onclick:stopPropagation="true">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">Add New Expense</h2>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" @bind="NewExpense.Description" placeholder="e.g. Office Supplies" />
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" @bind="NewExpense.Category">
                        <option value="">Select Category</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Supplies">Supplies</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Payroll">Payroll</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Others">Others</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <input type="number" class="form-input" @bind="NewExpense.Amount" placeholder="0.00" />
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Date Incurred</label>
                <input type="date" class="form-input" @bind="NewExpense.ExpenseDate" />
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn-primary" style="flex: 1;" @onclick="SaveExpense">Save Expense</button>
                <button class="btn-secondary" style="flex: 1;" @onclick="CloseModal">Cancel</button>
            </div>
        </div>
    </div>
}

<style>
    .stat-card {
        background: var(--color-white);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        gap: 8px;
        height: auto;
        min-height: 120px;
    }
    
    .stat-desc {
        font-size: 0.85rem;
        color: var(--color-dark-teal);
        opacity: 0.8;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
    }

    .status-approved {
        background-color: #d1fae5;
        color: #065f46;
    }

    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
    }

    .status-rejected {
        background-color: #fee2e2;
        color: #991b1b;
    }
</style>

@code {
    private List<OperationalExpense> ExpenseList = new List<OperationalExpense>();
    private OperationalExpense NewExpense = new OperationalExpense();
    private string SearchText = "";
    private string SelectedCategory = "All Categories";
    private bool ShowAddModal = false;

    // Computed Properties
    private decimal TotalExpenses => ExpenseList.Sum(e => e.Amount);
    private decimal MonthlyExpenses => ExpenseList.Where(e => e.ExpenseDate.Month == DateTime.Now.Month && e.ExpenseDate.Year == DateTime.Now.Year).Sum(e => e.Amount);
    private int PendingCount => ExpenseList.Count(e => e.Status == "Pending");
    private int CategoryCount => ExpenseList.Select(e => e.Category).Distinct().Count();

    private List<OperationalExpense> FilteredExpenses => ExpenseList
        .Where(e => (string.IsNullOrEmpty(SearchText) || 
                    e.Description?.Contains(SearchText, StringComparison.OrdinalIgnoreCase) == true ||
                    e.Category.Contains(SearchText, StringComparison.OrdinalIgnoreCase)) &&
                    (SelectedCategory == "All Categories" || e.Category == SelectedCategory))
        .OrderByDescending(e => e.ExpenseDate)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadExpenses();
    }

    private async Task LoadExpenses()
    {
        try
        {
            ExpenseList = await _context.OperationalExpenses.ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading expenses: {ex.Message}");
        }
    }

    private void OpenAddModal()
    {
        NewExpense = new OperationalExpense 
        { 
            ExpenseDate = DateTime.Now,
            Status = "Pending"
        };
        ShowAddModal = true;
    }

    private void CloseModal()
    {
        ShowAddModal = false;
    }

    private async Task SaveExpense()
    {
        if (string.IsNullOrWhiteSpace(NewExpense.Category) || NewExpense.Amount <= 0)
        {
            return; // Basic validation
        }

        try
        {
            // Default description if empty
            if (string.IsNullOrEmpty(NewExpense.Description)) 
            {
                NewExpense.Description = $"{NewExpense.Category} Expense";
            }

            _context.OperationalExpenses.Add(NewExpense);
            await _context.SaveChangesAsync();
            await LoadExpenses();
            CloseModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving expense: {ex.Message}");
        }
    }

    private string GetStatusColor(string status)
    {
        return status?.ToLower() switch
        {
            "approved" => "status-approved",
            "pending" => "status-pending",
            "rejected" => "status-rejected",
            _ => ""
        };
    }
}
