@page "/settings/user-management"
@using HestiaLink.Components.Layout
@layout MainLayout

<div class="user-mgmt-root">

    <header class="booking-history-header" style="margin-bottom: 0;">
        <h1>User Management</h1>
        <div style="font-weight: 600; color: #004f59;">System Administrator</div>
    </header>

    <div class="user-toolbar">
        <div class="toolbar-left">
            <div class="toolbar-search">
                <input type="text" placeholder="Search users..." @bind="SearchText" />
                <span class="search-icon">🔍</span>
            </div>
            <select class="filter-select" style="padding: 10px 16px; min-width: 150px;">
                <option>Sort by: Name</option>
                <option>Sort by: Role</option>
                <option>Sort by: Status</option>
            </select>
        </div>
        <button class="btn-primary" style="max-width: 160px;" @onclick="OpenCreateModal">+ New User</button>
    </div>

    <div class="checkin-layout">
        <div class="panel-card">
            <div class="panel-body user-list-container">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Emp ID</th>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in FilteredUsers)
                        {
                            <tr class="@(SelectedUser == user ? "selected-row" : "")" @onclick="() => SelectUser(user)">
                                <td>@user.UserId</td>
                                <td>@user.EmployeeId</td>
                                <td>
                                    <div style="font-weight: 700;">@user.Username</div>
                                </td>
                                <td><span class="user-role">@user.Role</span></td>
                                <td>
                                    <span class="@(user.IsActive ? "badge-active" : "badge-inactive")">
                                        @(user.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel-card">
            <div class="panel-header">
                <span>User's View</span>
                @if (SelectedUser != null)
                {
                    <span class="badge-active">@SelectedUser.UserId</span>
                }
            </div>
            <div class="panel-body">
                @if (SelectedUser != null)
                {
                    <div class="user-detail-view">
                        <div class="user-avatar-large">
                            @SelectedUser.Username.Substring(0, 1).ToUpper()
                        </div>
                        <h2 style="margin: 0 0 5px 0; color:#102f33;">@SelectedUser.Username</h2>
                        <span style="color:#64748b; margin-bottom: 30px;">@SelectedUser.Role</span>

                        <div class="detail-row">
                            <span class="detail-label">Employee ID</span>
                            <span class="detail-value">@SelectedUser.EmployeeId</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Contact</span>
                            <span class="detail-value">@SelectedUser.ContactNumber</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Job Desc</span>
                            <span class="detail-value" style="max-width: 50%; text-align:right;">@SelectedUser.JobDescription</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status</span>
                            <span class="detail-value" style="color: @(SelectedUser.IsActive ? "#166534" : "#64748b")">@(SelectedUser.IsActive ? "Active" : "Inactive")</span>
                        </div>
                    </div>

                    <div class="action-footer" style="justify-content: center;">
                        <button class="btn-primary" @onclick="OpenEditModal">Update</button>
                        <button class="btn-secondary" style="background:#b91c1c;" @onclick="DeleteUser">Delete</button>
                    </div>
                }
                else
                {
                    <div style="display:flex; height:100%; align-items:center; justify-content:center; color:#94a3b8;">
                        Select a user to view details
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@if (ShowCreateModal || ShowEditModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">@(ShowCreateModal ? "Create New User" : "Edit User")</h2>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">User ID</label>
                    <input type="text" class="form-input" @bind="CurrentUser.UserId" disabled="@ShowEditModal" />
                </div>
                <div class="form-group">
                    <label class="form-label">Username ID (Emp ID)</label>
                    <input type="text" class="form-input" @bind="CurrentUser.EmployeeId" />
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" @bind="CurrentUser.Username" />
                </div>

                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-select" @bind="CurrentUser.Role">
                        <option>Administrator</option>
                        <option>Manager</option>
                        <option>Cashier</option>
                        <option>Housekeeping</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Number</label>
                    <input type="text" class="form-input" @bind="CurrentUser.ContactNumber" />
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Job Description</label>
                    <textarea class="form-input" rows="4" @bind="CurrentUser.JobDescription"></textarea>
                </div>
            </div>

            <div class="action-footer" style="border:none; padding-bottom:0; margin-top:10px;">
                <button class="btn-primary" @onclick="SaveUser">@(ShowCreateModal ? "Create User" : "Save Changes")</button>
                <button class="btn-secondary" @onclick="CloseModals">Cancel</button>
            </div>
        </div>
    </div>
}

@code {
    private string SearchText { get; set; } = "";
    private bool ShowCreateModal = false;
    private bool ShowEditModal = false;

    private User? SelectedUser;
    private User CurrentUser = new(); // Holder for form data

    private List<User> Users = new()
    {
        new() { UserId = "192617", EmployeeId = "191231", Username = "Patrick", Role = "Cashier", ContactNumber = "0917-123-4567", JobDescription = "Handles front desk payments and guest inquiries.", IsActive = true },
        new() { UserId = "192618", EmployeeId = "191232", Username = "Sarah", Role = "Manager", ContactNumber = "0918-987-6543", JobDescription = "Oversees daily hotel operations.", IsActive = true },
        new() { UserId = "192619", EmployeeId = "191233", Username = "Mike", Role = "Housekeeping", ContactNumber = "0919-555-0000", JobDescription = "Ensures room cleanliness and maintenance.", IsActive = false },
    };

    private List<User> FilteredUsers => Users
        .Where(u => string.IsNullOrEmpty(SearchText) ||
                    u.Username.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                    u.Role.Contains(SearchText, StringComparison.OrdinalIgnoreCase))
        .ToList();

    private void SelectUser(User user)
    {
        SelectedUser = user;
    }

    private void OpenCreateModal()
    {
        CurrentUser = new User(); // Reset form
        ShowCreateModal = true;
    }

    private void OpenEditModal()
    {
        if (SelectedUser == null) return;
        // Clone data to avoid live editing before saving
        CurrentUser = new User
        {
            UserId = SelectedUser.UserId,
            EmployeeId = SelectedUser.EmployeeId,
            Username = SelectedUser.Username,
            Role = SelectedUser.Role,
            ContactNumber = SelectedUser.ContactNumber,
            JobDescription = SelectedUser.JobDescription,
            IsActive = SelectedUser.IsActive
        };
        ShowEditModal = true;
    }

    private void CloseModals()
    {
        ShowCreateModal = false;
        ShowEditModal = false;
    }

    private void SaveUser()
    {
        if (ShowCreateModal)
        {
            // Simulate Add
            CurrentUser.IsActive = true; // Default to active
            Users.Add(CurrentUser);
        }
        else if (ShowEditModal && SelectedUser != null)
        {
            // Simulate Update
            SelectedUser.EmployeeId = CurrentUser.EmployeeId;
            SelectedUser.Username = CurrentUser.Username;
            SelectedUser.Role = CurrentUser.Role;
            SelectedUser.ContactNumber = CurrentUser.ContactNumber;
            SelectedUser.JobDescription = CurrentUser.JobDescription;
        }

        CloseModals();
    }

    private void DeleteUser()
    {
        if (SelectedUser != null)
        {
            Users.Remove(SelectedUser);
            SelectedUser = null;
        }
    }

    public class User
    {
        public string UserId { get; set; } = "";
        public string EmployeeId { get; set; } = "";
        public string Username { get; set; } = "";
        public string Role { get; set; } = "";
        public string ContactNumber { get; set; } = "";
        public string JobDescription { get; set; } = "";
        public bool IsActive { get; set; } = true;
    }
}