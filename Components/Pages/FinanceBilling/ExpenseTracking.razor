@page "/finance/expense-tracking"
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Expense Tracking</h1>
        <span class="page-topbar-subtitle">Operational Expenses Management</span>
    </header>

    <section class="page-content">
        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-title">Total Expenses</div>
                <div class="stat-value">₱@TotalExpenses.ToString("N2")</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">This Month</div>
                <div class="stat-value">₱@MonthlyExpenses.ToString("N2")</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Pending Approval</div>
                <div class="stat-value">@PendingCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Categories</div>
                <div class="stat-value">@ExpenseCategories.Count</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="user-toolbar">
            <div class="toolbar-left">
                <div class="toolbar-search">
                    <input type="text" placeholder="Search expenses..." @bind="SearchText" />
                    <span class="search-icon">🔍</span>
                </div>
                <select class="filter-select" @bind="CategoryFilter">
                    <option value="">All Categories</option>
                    @foreach (var cat in ExpenseCategories)
                    {
                        <option value="@cat">@cat</option>
                    }
                </select>
            </div>
            <button class="btn-create" @onclick="OpenAddExpenseModal">Add Expense</button>
        </div>

        <!-- Expenses Table -->
        <div class="panel-card">
            <div class="panel-body user-list-container">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Supplier</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var expense in FilteredExpenses)
                        {
                            <tr>
                                <td>@expense.Date.ToString("MMM dd, yyyy")</td>
                                <td style="font-weight: 700;">@expense.Description</td>
                                <td>
                                    <span class="status-badge" style="background: var(--color-light-gray); color: var(--color-dark-teal);">
                                        @expense.Category
                                    </span>
                                </td>
                                <td>@expense.Supplier</td>
                                <td style="font-weight: 900; color: var(--color-teal);">₱@expense.Amount.ToString("N2")</td>
                                <td>@expense.PaymentMethod</td>
                                <td>
                                    <span class="status-badge status-@expense.Status.ToLower()">@expense.Status</span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 8px; justify-content: center;">
                                        <button class="btn-icon-action edit" title="Edit" @onclick="() => EditExpense(expense)">
                                            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                        </button>
                                        <button class="btn-icon-action archive" title="Delete" @onclick="() => DeleteExpense(expense)">
                                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<!-- Add Expense Modal -->
@if (ShowAddModal)
{
    <div class="modal-overlay" @onclick="CloseModals">
        <div class="modal-content" style="max-width: 600px;" @onclick:stopPropagation="true">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">Add New Expense</h2>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" @bind="NewExpense.Date" />
                </div>
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <input type="number" class="form-input" @bind="NewExpense.Amount" placeholder="0.00" />
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" @bind="NewExpense.Description" placeholder="Expense description" />
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" @bind="NewExpense.Category">
                        <option value="">Select Category</option>
                        @foreach (var cat in ExpenseCategories)
                        {
                            <option value="@cat">@cat</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <select class="form-select" @bind="NewExpense.PaymentMethod">
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Check">Check</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Supplier/Vendor</label>
                <input type="text" class="form-input" @bind="NewExpense.Supplier" placeholder="Supplier name" />
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn-primary" style="flex: 1;" @onclick="SaveExpense">Save Expense</button>
                <button class="btn-secondary" style="flex: 1;" @onclick="CloseModals">Cancel</button>
            </div>
        </div>
    </div>
}

<style>
    .status-approved { background-color: #d1fae5; color: #065f46; }
    .status-pending { background-color: #fef3c7; color: #92400e; }
    .status-rejected { background-color: #fee2e2; color: #991b1b; }
</style>

@code {
    private List<Expense> Expenses = new List<Expense>();
    private Expense NewExpense = new Expense();
    private string SearchText = "";
    private string CategoryFilter = "";
    private bool ShowAddModal = false;

    private List<string> ExpenseCategories = new List<string>
    {
        "Utilities", "Supplies", "Maintenance", "Payroll", "Food & Beverage",
        "Marketing", "Insurance", "Taxes", "Equipment", "Other"
    };

    private decimal TotalExpenses => Expenses.Sum(e => e.Amount);
    private decimal MonthlyExpenses => Expenses.Where(e => e.Date.Month == DateTime.Now.Month).Sum(e => e.Amount);
    private int PendingCount => Expenses.Count(e => e.Status == "Pending");

    private List<Expense> FilteredExpenses => Expenses
        .Where(e => (string.IsNullOrEmpty(SearchText) || 
                    e.Description.Contains(SearchText, StringComparison.OrdinalIgnoreCase)) &&
                    (string.IsNullOrEmpty(CategoryFilter) || e.Category == CategoryFilter))
        .OrderByDescending(e => e.Date)
        .ToList();

    protected override void OnInitialized()
    {
        Expenses.Add(new Expense 
        { 
            Date = DateTime.Now.AddDays(-2), 
            Description = "Electricity Bill - November", 
            Category = "Utilities",
            Amount = 25000,
            Supplier = "Manila Electric Company",
            PaymentMethod = "Bank Transfer",
            Status = "Approved"
        });
        Expenses.Add(new Expense 
        { 
            Date = DateTime.Now.AddDays(-1), 
            Description = "Cleaning Supplies", 
            Category = "Supplies",
            Amount = 8500,
            Supplier = "Metro Supply Co.",
            PaymentMethod = "Cash",
            Status = "Approved"
        });
    }

    private void OpenAddExpenseModal()
    {
        NewExpense = new Expense { Date = DateTime.Now, Status = "Pending" };
        ShowAddModal = true;
    }

    private void SaveExpense()
    {
        Expenses.Add(NewExpense);
        CloseModals();
    }

    private void EditExpense(Expense expense)
    {
        // Edit logic
    }

    private void DeleteExpense(Expense expense)
    {
        Expenses.Remove(expense);
    }

    private void CloseModals()
    {
        ShowAddModal = false;
    }

    public class Expense
    {
        public DateTime Date { get; set; }
        public string Description { get; set; } = "";
        public string Category { get; set; } = "";
        public decimal Amount { get; set; }
        public string Supplier { get; set; } = "";
        public string PaymentMethod { get; set; } = "Cash";
        public string Status { get; set; } = "Pending";
    }
}
