@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject HestiaLink.Services.UserSession UserSession

<link rel="stylesheet" href="app.css" />

<div class="dashboard-root">
    <aside class="dashboard-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo-circle">
                <img src="/images/hestialogo.png" alt="HestiaLink Logo" />
            </div>
            <div>
                <div class="sidebar-app-name">HestiaLink</div>
                <!-- DYNAMIC ROLE DISPLAY -->
                <div class="sidebar-role">@UserSession.Role</div>
            </div>
        </div>

        <nav class="sidebar-nav">

            <!-- ADMIN ONLY: Dashboard Overview -->
            @if (UserSession.Role == "Administrator")
            {
                <button class="sidebar-nav-item @(GetActiveClass("/dashboard"))" @onclick='() => NavigateTo("/dashboard")'>
                    <span class="sidebar-nav-icon">🏠</span>
                    <span>Dashboard</span>
                </button>
            }

            <!-- RESERVATION: Visible to Admin & Front Desk -->
            @if (UserSession.Role == "Administrator" || UserSession.Role == "FrontDesk")
            {
                <div class="sidebar-section">
                    <button class="sidebar-section-header @(ExpandedSection == "reservations" ? "open" : "")" @onclick='() => ToggleSection("reservations")'>
                        <div class="sidebar-nav-label">
                            <span class="sidebar-nav-icon">📅</span>
                            <span>Reservation &amp; Booking</span>
                        </div>
                        <span class="sidebar-section-chevron">@((ExpandedSection == "reservations") ? "▾" : "▸")</span>
                    </button>
                    <div class="sidebar-submenu @(ExpandedSection == "reservations" ? "open" : "")">
                        <button class="sidebar-subnav-item @(GetActiveClass("/reservations/booking-history"))" @onclick='() => NavigateTo("/reservations/booking-history")'>Booking History</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/reservations/check-in-check-out"))" @onclick='() => NavigateTo("/reservations/check-in-check-out")'>Check In / Check Out</button>
                    </div>
                </div>
            }

            <!-- HOUSEKEEPING: Visible to Admin & Front Desk -->
            @if (UserSession.Role == "Administrator" || UserSession.Role == "FrontDesk")
            {
                <div class="sidebar-section">
                    <button class="sidebar-section-header @(ExpandedSection == "housekeeping" ? "open" : "")" @onclick='() => ToggleSection("housekeeping")'>
                        <div class="sidebar-nav-label">
                            <span class="sidebar-nav-icon">🧹</span>
                            <span>Housekeeping</span>
                        </div>
                        <span class="sidebar-section-chevron">@((ExpandedSection == "housekeeping") ? "▾" : "▸")</span>
                    </button>
                    <div class="sidebar-submenu @(ExpandedSection == "housekeeping" ? "open" : "")">
                        <button class="sidebar-subnav-item @(GetActiveClass("/housekeeping/room-status"))" @onclick='() => NavigateTo("/housekeeping/room-status")'>Room Status</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/housekeeping/cleaning-schedule"))" @onclick='() => NavigateTo("/housekeeping/cleaning-schedule")'>Cleaning Schedule</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/housekeeping/maintenance-requests"))" @onclick='() => NavigateTo("/housekeeping/maintenance-requests")'>Maintenance Requests</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/housekeeping/inventory-check"))" @onclick='() => NavigateTo("/housekeeping/inventory-check")'>Inventory Check</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/housekeeping/staff-management"))" @onclick='() => NavigateTo("/housekeeping/staff-management")'>Staff Management</button>
                    </div>
                </div>
            }

            <!-- INVENTORY: Visible to Admin & Inventory -->
            @if (UserSession.Role == "Administrator" || UserSession.Role == "Inventory")
            {
                <div class="sidebar-section">
                    <button class="sidebar-section-header @(ExpandedSection == "inventory" ? "open" : "")" @onclick='() => ToggleSection("inventory")'>
                        <div class="sidebar-nav-label">
                            <span class="sidebar-nav-icon">📦</span>
                            <span>Inventory</span>
                        </div>
                        <span class="sidebar-section-chevron">@((ExpandedSection == "inventory") ? "▾" : "▸")</span>
                    </button>
                    <div class="sidebar-submenu @(ExpandedSection == "inventory" ? "open" : "")">
                        <button class="sidebar-subnav-item @(GetActiveClass("/inventory/stock-management"))" @onclick='() => NavigateTo("/inventory/stock-management")'>Stock Management</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/inventory/suppliers"))" @onclick='() => NavigateTo("/inventory/suppliers")'>Suppliers</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/inventory/purchase-orders"))" @onclick='() => NavigateTo("/inventory/purchase-orders")'>Purchase Orders</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/inventory/reports"))" @onclick='() => NavigateTo("/inventory/reports")'>Inventory Reports</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/inventory/service-categories"))" @onclick='() => NavigateTo("/inventory/service-categories")'>Service Categories</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/inventory/services"))" @onclick='() => NavigateTo("/inventory/services")'>Services</button>
                    </div>
                </div>
            }

            <!-- FINANCE: Visible to Admin Only -->
            @if (UserSession.Role == "Administrator")
            {
                <div class="sidebar-section">
                    <button class="sidebar-section-header @(ExpandedSection == "finance" ? "open" : "")" @onclick='() => ToggleSection("finance")'>
                        <div class="sidebar-nav-label">
                            <span class="sidebar-nav-icon">💰</span>
                            <span>Finance</span>
                        </div>
                        <span class="sidebar-section-chevron">@((ExpandedSection == "finance") ? "▾" : "▸")</span>
                    </button>
                    <div class="sidebar-submenu @(ExpandedSection == "finance" ? "open" : "")">
                        <button class="sidebar-subnav-item @(GetActiveClass("/finance/billing-invoices"))" @onclick='() => NavigateTo("/finance/billing-invoices")'>Billing Invoices</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/finance/expense-tracking"))" @onclick='() => NavigateTo("/finance/expense-tracking")'>Expense Tracking</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/finance/financial-reports"))" @onclick='() => NavigateTo("/finance/financial-reports")'>Financial Reports</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/finance/tax-management"))" @onclick='() => NavigateTo("/finance/tax-management")'>Tax Management</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/finance/payment-processing"))" @onclick='() => NavigateTo("/finance/payment-processing")'>Payment Processing</button>
                    </div>
                </div>
            }

            <!-- HR & PAYROLL: Visible to Admin & HR -->
            @if (UserSession.Role == "Administrator" || UserSession.Role == "HR")
            {
                <div class="sidebar-section">
                    <button class="sidebar-section-header @(ExpandedSection == "hr" ? "open" : "")" @onclick='() => ToggleSection("hr")'>
                        <div class="sidebar-nav-label">
                            <span class="sidebar-nav-icon">👥</span>
                            <span>HR &amp; Payroll</span>
                        </div>
                        <span class="sidebar-section-chevron">@((ExpandedSection == "hr") ? "▾" : "▸")</span>
                    </button>
                    <div class="sidebar-submenu @(ExpandedSection == "hr" ? "open" : "")">
                        <button class="sidebar-subnav-item @(GetActiveClass("/hr/employee-management"))" @onclick='() => NavigateTo("/hr/employee-management")'>Employee Management</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/hr/department-setup"))" @onclick='() => NavigateTo("/hr/department-setup")'>Department Setup</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/hr/position-setup"))" @onclick='() => NavigateTo("/hr/position-setup")'>Position Setup</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/hr/user-accounts"))" @onclick='() => NavigateTo("/hr/user-accounts")'>User Accounts</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/hr/attendance"))" @onclick='() => NavigateTo("/hr/attendance")'>Attendance</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/hr/payroll-processing"))" @onclick='() => NavigateTo("/hr/payroll-processing")'>Payroll Processing</button>
                    </div>
                </div>
            }

            <!-- SETTINGS: Visible to Admin Only -->
            @if (UserSession.Role == "Administrator")
            {
                <div class="sidebar-section">
                    <button class="sidebar-section-header @(ExpandedSection == "settings" ? "open" : "")" @onclick='() => ToggleSection("settings")'>
                        <div class="sidebar-nav-label">
                            <span class="sidebar-nav-icon">⚙️</span>
                            <span>System Settings</span>
                        </div>
                        <span class="sidebar-section-chevron">@((ExpandedSection == "settings") ? "▾" : "▸")</span>
                    </button>
                    <div class="sidebar-submenu @(ExpandedSection == "settings" ? "open" : "")">
                        <button class="sidebar-subnav-item @(GetActiveClass("/settings/user-management"))" @onclick='() => NavigateTo("/settings/user-management")'>User Management</button>
                        <button class="sidebar-subnav-item @(GetActiveClass("/settings/room-management"))" @onclick='() => NavigateTo("/settings/room-management")'>Room Management</button>
                    </div>
                </div>
            }
        </nav>

        <button class="sidebar-logout" @onclick='HandleLogout'>Logout (@UserSession.Username)</button>
    </aside>

    <main class="dashboard-main">
        @Body
    </main>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">×</a>
</div>

@code {
    private string? ExpandedSection;

    protected override void OnInitialized()
    {
        UpdateExpandedSection(Navigation.Uri);
    }

    private void ToggleSection(string key)
    {
        ExpandedSection = ExpandedSection == key ? null : key;
    }

    private void NavigateTo(string uri)
    {
        UpdateExpandedSection(uri);
        Navigation.NavigateTo(uri);
    }

    private void HandleLogout()
    {
        UserSession.Logout();
        Navigation.NavigateTo("/loginpage", forceLoad: true);
    }

    private void UpdateExpandedSection(string uri)
    {
        if (uri.Contains("reservations", StringComparison.OrdinalIgnoreCase)) ExpandedSection = "reservations";
        else if (uri.Contains("housekeeping", StringComparison.OrdinalIgnoreCase)) ExpandedSection = "housekeeping";
        else if (uri.Contains("inventory", StringComparison.OrdinalIgnoreCase)) ExpandedSection = "inventory";
        else if (uri.Contains("finance", StringComparison.OrdinalIgnoreCase)) ExpandedSection = "finance";
        else if (uri.Contains("hr", StringComparison.OrdinalIgnoreCase)) ExpandedSection = "hr";
        else if (uri.Contains("settings", StringComparison.OrdinalIgnoreCase)) ExpandedSection = "settings";
        else ExpandedSection = null;
    }

    private string GetActiveClass(string uri)
    {
        return Navigation.Uri.Contains(uri, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    }
}