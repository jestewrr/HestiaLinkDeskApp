@page "/login"
@layout LoginLayout
@inject NavigationManager Navigation
@inject UserSession UserSession
@inject AuthenticationService AuthService

<div class="login-card-modern">
    <div class="login-header">
        <div class="login-title-section">
            <h1 class="login-title">HestiaLink<br/>Hospitality<br/>ERP System</h1>
        </div>
        <div class="login-logo-section">
            <img src="/images/hestialogo.png" alt="HestiaLink Logo" class="login-logo" />
        </div>
    </div>

    <div class="login-form">
        <div class="input-group-modern">
            <label for="username" class="input-label">Username</label>
            <div class="input-wrapper">
                <span class="input-icon">✉️</span>
                <input id="username" 
                       type="text" 
                       class="input-field" 
                       placeholder="Enter your username" 
                       @bind="Username" 
                       @onkeydown="HandleKeyPress"
                       disabled="@IsLoading" />
            </div>
        </div>

        <div class="input-group-modern">
            <label for="password" class="input-label">Password</label>
            <div class="input-wrapper">
                <span class="input-icon">🔒</span>
                <input id="password" 
                       type="@(ShowPassword ? "text" : "password")" 
                       class="input-field" 
                       placeholder="Enter your password" 
                       @bind="Password"
                       @onkeydown="HandleKeyPress"
                       disabled="@IsLoading" />
                <span class="eye-icon-modern" @onclick="TogglePasswordVisibility" style="cursor: pointer;">
                    @(ShowPassword ? "👁️" : "👁️")
                </span>
            </div>
        </div>

        <button class="login-button-modern" @onclick="HandleLogin" disabled="@IsLoading">
            @if (IsLoading)
            {
                <span style="display: inline-flex; align-items: center; gap: 8px;">
                    <span class="spinner"></span>
                    Logging in...
                </span>
            }
            else
            {
                <span>Login</span>
            }
        </button>

        @if (!string.IsNullOrEmpty(Message))
        {
            <p class="error-message-modern">@Message</p>
        }
    </div>
</div>

@code {
    private string Username { get; set; } = "";
    private string Password { get; set; } = "";
    private string Message { get; set; } = "";
    private bool ShowPassword { get; set; } = false;
    private bool IsLoading { get; set; } = false;

    private void HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !IsLoading)
        {
            HandleLogin();
        }
    }

    private async Task HandleLogin()
    {
        if (IsLoading) return;

        try
        {
            IsLoading = true;
            Message = "";
            StateHasChanged();

            // Validate input
            if (string.IsNullOrWhiteSpace(Username) || string.IsNullOrWhiteSpace(Password))
            {
                Message = "Please enter both username and password.";
                return;
            }

            // Authenticate against database
            var (isValid, user, errorMessage) = await AuthService.AuthenticateAsync(Username, Password);

            if (!isValid || user == null)
            {
                Message = errorMessage;
                return;
            }

            // Set user session
            UserSession.Login(user.UserID, user.Username, user.Role);

            // Get landing page based on role
            var landingPage = AuthService.GetLandingPageForRole(user.Role);

            // Navigate to appropriate page
            Navigation.NavigateTo(landingPage);
        }
        catch (Exception ex)
        {
            Message = "An error occurred during login. Please try again.";
            Console.WriteLine($"Login error: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private void TogglePasswordVisibility()
    {
        ShowPassword = !ShowPassword;
    }
}