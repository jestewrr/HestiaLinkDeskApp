@page "/settings/user-management"
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext Context
@inject IJSRuntime JSRuntime
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>User Management</h1>
        <span class="page-topbar-subtitle">System Administrator</span>
    </header>

    <!-- Error Alert Banner -->
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="error-banner">
            <span class="error-icon"></span>
            <span class="error-message">@ErrorMessage</span>
            <button class="error-close" @onclick="ClearError">?</button>
        </div>
    }

    <!-- Loading Indicator -->
    @if (!IsLoaded)
    {
        <div class="loading-overlay">
            <div class="loading-spinner"></div>
            <p>Loading user data...</p>
        </div>
    }

    <section class="page-content">
        <div class="user-toolbar">
            <div class="toolbar-left">
                <div class="toolbar-search">
                    <input type="text" placeholder="Search users by name, ID, role, or employee ID..."
                           @bind="SearchText"
                           @oninput="OnSearchChanged"
                           @onkeydown="HandleKeyDown" />
                    <span class="search-icon"></span>
                    @if (!string.IsNullOrEmpty(SearchText))
                    {
                        <button class="clear-search" @onclick="ClearSearch" title="Clear search">
                            ?
                        </button>
                    }
                </div>
                <select class="filter-select" @bind="FilterRole">
                    <option value="All">All Roles</option>
                    <option value="Administrator">Administrator</option>
                    <option value="Manager">Manager</option>
                    <option value="FrontDesk">FrontDesk</option>
                    <option value="Housekeeping">Housekeeping</option>
                </select>
                <select class="filter-select" @bind="SortBy">
                    <option value="Username">Sort by Name</option>
                    <option value="Role">Sort by Role</option>
                    <option value="EmployeeId">Sort by Employee ID</option>
                    <option value="UserId">Sort by User ID</option>
                </select>
            </div>
            <div>
                <button class="btn-secondary" @onclick="OpenArchivedModal" disabled="@(!IsLoaded || IsProcessing)">
                     View Archived (@ArchivedUsersCount)
                </button>
                <button class="btn-create" @onclick="OpenCreateModal" disabled="@(!IsLoaded || IsProcessing)">
                    + New User
                </button>
            </div>
        </div>

        <!-- Search Results Info -->
        @if (IsLoaded && !string.IsNullOrEmpty(SearchText))
        {
            <div class="search-results-info">
                <span>
                    Found @FilteredUsers.Count users matching "<strong>@SearchText</strong>"
                    @if (FilterRole != "All")
                    {
                        <text> in role <strong>@FilterRole</strong></text>
                    }
                </span>
                <button class="btn-link" @onclick="ClearSearch">Clear search</button>
            </div>
        }

        <!-- Enhanced Card Layout -->
        <div class="user-grid-container">
            @if (FilteredUsers.Any())
            {
                <div class="user-grid">
                    @foreach (var user in FilteredUsers)
                    {
                        <div class="user-card @(SelectedUser?.UserId == user.UserId ? "selected-card" : "")">
                            <div class="user-card-header">
                                <div class="user-avatar">
                                    @GetInitials(user.Username)
                                </div>
                                <div class="user-info">
                                    <h3 class="username">@user.Username</h3>
                                    <span class="user-id">ID: @user.UserId</span>
                                </div>
                                <div class="user-status">
                                    <span class="@(user.Status == "Active" ? "badge-active" : "badge-inactive")">
                                        @(user.Status == "Active" ? "Active" : "Archived")
                                    </span>
                                </div>
                            </div>

                            <div class="user-details">
                                <div class="detail-item">
                                    <span class="detail-label">Employee ID:</span>
                                    <span class="detail-value">@user.EmployeeId</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Role:</span>
                                    <span class="user-role @(user.Role?.ToLower() ?? "")">@user.Role</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Created:</span>
                                    <span class="detail-value">@(user.CreatedAt.HasValue ? user.CreatedAt.Value.ToString("MMM dd, yyyy") : "--")</span>
                                </div>
                            </div>

                            @if (user.Status == "Active")
                            {
                                <div class="user-actions">
                                    <button class="btn-icon-action edit" @onclick="() => SelectAndEdit(user)" title="Edit User" disabled="@IsProcessing">
                                        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                    </button>
                                    <button class="btn-icon-action archive" @onclick="() => PromptArchive(user)" title="Archive User" disabled="@IsProcessing">
                                        <svg viewBox="0 0 24 24"><path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM6.24 5h11.52l.81.97H5.44l.8-.97zM5 19V8h14v11H5zm8.45-9h-2.9v3H8l4 4 4-4h-2.55z"/></svg>
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else if (IsLoaded)
            {
                <div class="no-users-message">
                    <div class="no-users-icon"></div>
                    <h3>No users found</h3>
                    <p>
                        @if (!string.IsNullOrEmpty(SearchText))
                        {
                            <text>No users found matching "<strong>@SearchText</strong>". Try adjusting your search terms.</text>
                        }
                        else if (FilterRole != "All")
                        {
                            <text>No active users found with role <strong>@FilterRole</strong>.</text>
                        }
                        else
                        {
                            <text>Create your first user to get started.</text>
                        }
                    </p>
                    @if (string.IsNullOrEmpty(SearchText) && FilterRole == "All")
                    {
                        <button class="btn-create" @onclick="OpenCreateModal" disabled="@IsProcessing">
                            + Create New User
                        </button>
                    }
                    else
                    {
                        <button class="btn-secondary" @onclick="ClearFilters">
                            Clear Filters
                        </button>
                    }
                </div>
            }
        </div>
    </section>
</div>

<!-- Rest of the modals remain the same as in the previous version -->
<!-- Create/Edit User Modal -->
@if (ShowCreateModal || ShowEditModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">@(ShowCreateModal ? "Create New User" : "Edit User")</h2>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Employee</label>
                    <select class="form-select" @bind="CurrentUser.EmployeeId" disabled="@IsProcessing">
                        <option value="">-- Select Employee --</option>
                        @foreach (var emp in AvailableEmployees)
                        {
                            <option value="@emp.EmployeeId">@emp.EmployeeId - @emp.FirstName @emp.LastName</option>
                        }
                        @if (ShowEditModal && SelectedUser != null && SelectedUser.EmployeeId != null && !AvailableEmployees.Any(e => e.EmployeeId == SelectedUser.EmployeeId))
                        {
                            var selEmp = Employees.FirstOrDefault(e => e.EmployeeId == SelectedUser.EmployeeId);
                            if (selEmp != null)
                            {
                                <option value="@selEmp.EmployeeId" selected>@selEmp.EmployeeId - @selEmp.FirstName @selEmp.LastName</option>
                            }
                        }
                    </select>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" @bind="CurrentUser.Username" disabled="@IsProcessing" />
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" @bind="CurrentUser.Password" 
                           placeholder="@(ShowEditModal ? "Leave blank to keep current password" : "")" 
                           disabled="@IsProcessing" />
                </div>

                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-select" @bind="CurrentUser.Role" disabled="@IsProcessing">
                        <option>Administrator</option>
                        <option>Manager</option>
                        <option>FrontDesk</option>
                        <option>Housekeeping</option>
                    </select>
                </div>
            </div>

            <div class="action-footer" style="border:none; padding-bottom:0; margin-top:10px;">
                <button class="btn-primary" @onclick="SaveUser" disabled="@IsProcessing">
                    @if (IsProcessing)
                    {
                        <span class="loading-spinner-small"></span>
                    }
                    @(ShowCreateModal ? "Create User" : "Save Changes")
                </button>
                <button class="btn-secondary" @onclick="CloseModals" disabled="@IsProcessing">Cancel</button>
            </div>
        </div>
    </div>
}

<!-- Archived Users Modal -->
@if (ShowArchivedModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;"> Archived Users</h2>
                <div style="font-size: 0.9rem; color: #64748b;">@ArchivedUsers.Count archived users</div>
            </div>

            <div class="panel-body" style="max-height:60vh; overflow-y:auto;">
                @if (ArchivedUsers.Any())
                {
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Employee</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th style="text-align:center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in ArchivedUsers)
                            {
                                <tr>
                                    <td>@user.UserId</td>
                                    <td>@user.EmployeeId</td>
                                    <td style="font-weight:700;">@user.Username</td>
                                    <td>@user.Role</td>
                                    <td style="text-align:center;">
                                        <button class="btn-secondary" style="background:#10b981;" 
                                                @onclick="() => RestoreUser(user)" disabled="@IsProcessing">
                                             Restore
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="no-data" style="padding:40px;">No archived users</div>
                }
            </div>

            <div class="action-footer" style="border:none; padding-bottom:0; margin-top:10px;">
                <button class="btn-secondary" @onclick="CloseArchivedModal" disabled="@IsProcessing">Close</button>
            </div>
        </div>
    </div>
}

<!-- Archive Confirmation Modal -->
@if (ShowArchiveConfirm)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width:420px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.2rem;">Confirm Archive</h2>
            </div>
            <div style="padding:20px;">
                <p>Are you sure you want to archive user <strong>@(ArchiveTarget?.Username)</strong>?</p>
                <p style="color:#f59e0b; font-size:0.9rem;">Archived users will not appear in active lists but can be restored later.</p>
            </div>
            <div class="action-footer" style="border:none; padding-bottom:0;">
                <button class="btn-secondary" style="background:#f59e0b;" @onclick="ConfirmArchive" disabled="@IsProcessing">
                    @if (IsProcessing)
                    {
                        <span class="loading-spinner-small"></span>
                    }
                    Archive
                </button>
                <button class="btn-secondary" @onclick="CancelArchive" disabled="@IsProcessing">Cancel</button>
            </div>
        </div>
    </div>
}

@code {
    private string SearchText { get; set; } = "";
    private string FilterRole { get; set; } = "All";
    private string SortBy { get; set; } = "Username";
    private bool ShowCreateModal = false;
    private bool ShowEditModal = false;
    private bool ShowArchivedModal = false;
    private bool IsLoaded = false;
    private bool IsProcessing = false;
    private string ErrorMessage = string.Empty;

    private SystemUser? SelectedUser;
    private SystemUser CurrentUser = new();

    private List<SystemUser> Users = new();
    private List<Employee> Employees = new();
    private List<Employee> AvailableEmployees = new();

    // Search debouncing
    private System.Threading.Timer? SearchTimer;
    private const int SearchDelay = 300; // milliseconds

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        IsLoaded = true;
    }

    private async Task LoadData()
    {
        try
        {
            IsProcessing = true;
            StateHasChanged();

            Users = await Context.SystemUsers.AsNoTracking().OrderBy(u => u.Username).ToListAsync();
            Employees = await Context.Employees.AsNoTracking().OrderBy(e => e.LastName).ToListAsync();
            await LoadAvailableEmployeesAsync();
            
            ClearError();
        }
        catch (Exception ex)
        {
            HandleError("Failed to load user data. Please refresh the page.", ex);
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    private async Task LoadAvailableEmployeesAsync()
    {
        try
        {
            AvailableEmployees = await Context.Employees
                .AsNoTracking()
                .Where(e => e.Status == "Active")
                .Where(e => !Context.SystemUsers.Any(s => s.EmployeeId == e.EmployeeId && s.Status == "Active"))
                .OrderBy(e => e.LastName)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            // Fallback to in-memory filtering if database query fails
            AvailableEmployees = Employees
                .Where(emp => emp.Status == "Active" && 
                             !Users.Any(u => u.EmployeeId == emp.EmployeeId && u.Status == "Active"))
                .OrderBy(e => e.LastName)
                .ToList();
            
            LogWarning("Using fallback method for available employees loading", ex);
        }
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        try
        {
            // Debounce UI updates to avoid excessive renders while typing.
            // SearchText is already updated by @bind, so we only need to delay StateHasChanged.
            SearchTimer?.Dispose();
            SearchTimer = new System.Threading.Timer(async _ =>
            {
                await InvokeAsync(() => StateHasChanged());
                // dispose timer after firing once
                SearchTimer?.Dispose();
            }, null, SearchDelay, System.Threading.Timeout.Infinite);
        }
        catch (Exception ex)
        {
            HandleError("Error processing search input", ex);
        }
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        try
        {
            if (e.Key == "Escape")
            {
                ClearSearch();
            }
            else if (e.Key == "Enter")
            {
                // Force immediate search on Enter: cancel debounce and render immediately
                SearchTimer?.Dispose();
                SearchTimer = null;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            HandleError("Error handling keyboard input", ex);
        }
    }

    private void ClearSearch()
    {
        try
        {
            SearchText = string.Empty;
            SearchTimer?.Dispose();
            SearchTimer = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            HandleError("Error clearing search", ex);
        }
    }

    private void OnFilterChanged(ChangeEventArgs e)
    {
        try
        {
            FilterRole = e.Value?.ToString() ?? "All";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            HandleError("Error changing filter", ex);
        }
    }

    private void OnSortChanged(ChangeEventArgs e)
    {
        try
        {
            SortBy = e.Value?.ToString() ?? "Username";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            HandleError("Error changing sort", ex);
        }
    }

    private void ClearFilters()
    {
        try
        {
            SearchText = string.Empty;
            FilterRole = "All";
            SortBy = "Username";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            HandleError("Error clearing filters", ex);
        }
    }

    private List<SystemUser> FilteredUsers
    {
        get
        {
            try
            {
                var query = Users.Where(u => u.Status == "Active");

                // Apply search filter
                if (!string.IsNullOrEmpty(SearchText))
                {
                    var searchTerm = SearchText.Trim().ToLower();
                    query = query.Where(u => 
                        u.Username.ToLower().Contains(searchTerm) ||
                        u.Role.ToLower().Contains(searchTerm) ||
                        (u.EmployeeId != null && u.EmployeeId.ToString().ToLower().Contains(searchTerm)) ||
                        (u.UserId.ToString().ToLower().Contains(searchTerm))
                    );
                }

                // Apply role filter
                if (FilterRole != "All")
                {
                    query = query.Where(u => u.Role == FilterRole);
                }

                // Apply sorting
                query = SortBy switch
                {
                    "Role" => query.OrderBy(u => u.Role).ThenBy(u => u.Username),
                    "EmployeeId" => query.OrderBy(u => u.EmployeeId),
                    "UserId" => query.OrderBy(u => u.UserId),
                    _ => query.OrderBy(u => u.Username) // Default sort by Username
                };

                return query.ToList();
            }
            catch (Exception ex)
            {
                HandleError("Error filtering users", ex);
                return new List<SystemUser>();
            }
        }
    }

    private List<SystemUser> ArchivedUsers 
    {
        get
        {
            try
            {
                return Users.Where(u => u.Status == "Archived").OrderBy(u => u.Username).ToList();
            }
            catch (Exception ex)
            {
                HandleError("Error loading archived users", ex);
                return new List<SystemUser>();
            }
        }
    }
    
    private int ArchivedUsersCount 
    {
        get
        {
            try
            {
                return ArchivedUsers.Count;
            }
            catch
            {
                return 0;
            }
        }
    }

    private string GetInitials(string username)
    {
        try
        {
            if (string.IsNullOrEmpty(username)) return "??";
            var parts = username.Split(' ', '.', '_');
            if (parts.Length >= 2)
                return $"{parts[0][0]}{parts[1][0]}".ToUpper();
            return username.Length >= 2 ? username.Substring(0, 2).ToUpper() : username.ToUpper();
        }
        catch
        {
            return "??";
        }
    }

    // The rest of the methods (SelectAndEdit, OpenCreateModal, CloseModals, SaveUser, etc.)
    // remain the same as in the previous version with error handling

    private void SelectAndEdit(SystemUser user)
    {
        try
        {
            SelectedUser = user;
            CurrentUser = new SystemUser
            {
                UserId = user.UserId,
                EmployeeId = user.EmployeeId,
                Username = user.Username,
                Password = "", // Don't pre-fill password for security
                Role = user.Role,
                CreatedAt = user.CreatedAt,
                UpdatedAt = user.UpdatedAt,
                Status = user.Status
            };
            ShowEditModal = true;
            ShowCreateModal = false;
        }
        catch (Exception ex)
        {
            HandleError("Error preparing user for editing", ex);
        }
    }

    private async Task OpenCreateModal()
    {
        try
        {
            CurrentUser = new SystemUser { Status = "Active", CreatedAt = DateTime.Now };
            await LoadAvailableEmployeesAsync();
            ShowCreateModal = true;
            ShowEditModal = false;
        }
        catch (Exception ex)
        {
            HandleError("Error opening create user modal", ex);
        }
    }

    private void CloseModals()
    {
        try
        {
            ShowCreateModal = false;
            ShowEditModal = false;
            ClearError();
        }
        catch (Exception ex)
        {
            HandleError("Error closing modal", ex);
        }
    }

    private async Task SaveUser()
    {
        try
        {
            IsProcessing = true;
            StateHasChanged();

            // Validation
            var validationError = ValidateUser(CurrentUser, ShowCreateModal);
            if (!string.IsNullOrEmpty(validationError))
            {
                await ShowAlert(validationError);
                return;
            }

            // Check for duplicates
            var duplicateError = await CheckForDuplicates(CurrentUser);
            if (!string.IsNullOrEmpty(duplicateError))
            {
                await ShowAlert(duplicateError);
                return;
            }

            if (ShowCreateModal)
            {
                await CreateUser();
            }
            else if (ShowEditModal)
            {
                await UpdateUser();
            }

            CloseModals();
        }
        catch (DbUpdateException dbEx)
        {
            HandleError("Database error while saving user. Please try again.", dbEx);
        }
        catch (Exception ex)
        {
            HandleError("Unexpected error while saving user", ex);
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    private string ValidateUser(SystemUser user, bool isCreate)
    {
        if (user.EmployeeId == null)
            return "Please select an Employee before saving.";
            
        if (string.IsNullOrWhiteSpace(user.Username))
            return "Username is required.";
            
        if (user.Username.Length < 3)
            return "Username must be at least 3 characters long.";
            
        if (isCreate && string.IsNullOrWhiteSpace(user.Password))
            return "Password is required for new users.";
            
        if (!string.IsNullOrWhiteSpace(user.Password) && user.Password.Length < 6)
            return "Password must be at least 6 characters long.";

        return string.Empty;
    }

    private async Task<string> CheckForDuplicates(SystemUser user)
    {
        try
        {
            var usernameTaken = await Context.SystemUsers
                .AsNoTracking()
                .AnyAsync(u => u.Username == user.Username && u.UserId != user.UserId);
            if (usernameTaken)
                return "Username already exists. Choose a different username.";

            var employeeAssigned = await Context.SystemUsers
                .AsNoTracking()
                .AnyAsync(u => u.EmployeeId == user.EmployeeId && u.UserId != user.UserId && u.Status == "Active");
            if (employeeAssigned)
                return "Selected employee already has an active user account.";

            return string.Empty;
        }
        catch (Exception ex)
        {
            LogWarning("Error checking for duplicates", ex);
            // Allow proceeding if duplicate check fails, but log the issue
            return string.Empty;
        }
    }

    private async Task CreateUser()
    {
        try
        {
            CurrentUser.CreatedAt = DateTime.Now;
            CurrentUser.Status = "Active";
            Context.SystemUsers.Add(CurrentUser);
            await Context.SaveChangesAsync();

            await LoadData();
            await ShowAlert("User created successfully");
        }
        catch (Exception ex)
        {
            throw new Exception("Failed to create user", ex);
        }
    }

    private async Task UpdateUser()
    {
        try
        {
            var existing = await Context.SystemUsers.FindAsync(CurrentUser.UserId);
            if (existing == null)
            {
                await ShowAlert("User not found. It may have been deleted.");
                return;
            }

            existing.EmployeeId = CurrentUser.EmployeeId;
            existing.Username = CurrentUser.Username;

            if (!string.IsNullOrWhiteSpace(CurrentUser.Password))
            {
                existing.Password = CurrentUser.Password;
            }

            existing.Role = CurrentUser.Role;
            existing.UpdatedAt = DateTime.Now;

            Context.SystemUsers.Update(existing);
            await Context.SaveChangesAsync();

            await LoadData();
            await ShowAlert("User updated successfully");
        }
        catch (Exception ex)
        {
            throw new Exception("Failed to update user", ex);
        }
    }

    // Archive flow
    private SystemUser? ArchiveTarget;
    private bool ShowArchiveConfirm = false;

    private void PromptArchive(SystemUser user)
    {
        try
        {
            ArchiveTarget = user;
            ShowArchiveConfirm = true;
        }
        catch (Exception ex)
        {
            HandleError("Error preparing archive confirmation", ex);
        }
    }

    private void CancelArchive()
    {
        try
        {
            ShowArchiveConfirm = false;
            ArchiveTarget = null;
        }
        catch (Exception ex)
        {
            HandleError("Error canceling archive", ex);
        }
    }

    private async Task ConfirmArchive()
    {
        try
        {
            IsProcessing = true;
            StateHasChanged();

            if (ArchiveTarget != null)
            {
                var user = await Context.SystemUsers.FindAsync(ArchiveTarget.UserId);
                if (user != null)
                {
                    user.Status = "Archived";
                    user.UpdatedAt = DateTime.Now;
                    Context.SystemUsers.Update(user);
                    await Context.SaveChangesAsync();

                    await LoadData();
                    await ShowAlert("User archived successfully");
                }
                else
                {
                    await ShowAlert("User not found. It may have been already deleted.");
                }
            }
        }
        catch (Exception ex)
        {
            HandleError("Error archiving user", ex);
        }
        finally
        {
            IsProcessing = false;
            ShowArchiveConfirm = false;
            ArchiveTarget = null;
            StateHasChanged();
        }
    }

    private void OpenArchivedModal()
    {
        try
        {
            ShowArchivedModal = true;
        }
        catch (Exception ex)
        {
            HandleError("Error opening archived users modal", ex);
        }
    }

    private void CloseArchivedModal()
    {
        try
        {
            ShowArchivedModal = false;
        }
        catch (Exception ex)
        {
            HandleError("Error closing archived users modal", ex);
        }
    }

    private async Task RestoreUser(SystemUser user)
    {
        try
        {
            IsProcessing = true;
            StateHasChanged();

            var existingUser = await Context.SystemUsers.FindAsync(user.UserId);
            if (existingUser != null)
            {
                // Check if employee is still available
                var employeeAvailable = await Context.Employees
                    .AnyAsync(e => e.EmployeeId == existingUser.EmployeeId && e.Status == "Active");
                    
                if (!employeeAvailable)
                {
                    await ShowAlert("Cannot restore user: Associated employee is no longer active.");
                    return;
                }

                existingUser.Status = "Active";
                existingUser.UpdatedAt = DateTime.Now;
                Context.SystemUsers.Update(existingUser);
                await Context.SaveChangesAsync();

                await LoadData();
                await ShowAlert("User restored successfully");
            }
            else
            {
                await ShowAlert("User not found. It may have been permanently deleted.");
            }
        }
        catch (Exception ex)
        {
            HandleError("Error restoring user", ex);
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    // Error handling methods
    private void HandleError(string userMessage, Exception ex = null)
    {
        ErrorMessage = userMessage;
        
        // Log the detailed error for debugging
        if (ex != null)
        {
            Console.WriteLine($"User Management Error: {ex.Message}");
            Console.WriteLine($"Stack Trace: {ex.StackTrace}");
        }
        
        StateHasChanged();
    }

    private void ClearError()
    {
        ErrorMessage = string.Empty;
        StateHasChanged();
    }

    private void LogWarning(string message, Exception ex = null)
    {
        Console.WriteLine($"User Management Warning: {message}");
        if (ex != null)
        {
            Console.WriteLine($"Warning Details: {ex.Message}");
        }
    }

    private async Task ShowAlert(string message)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("alert", message);
        }
        catch (Exception ex)
        {
            // If JS interop fails, show the message in the error banner
            HandleError(message, ex);
        }
    }

    public void Dispose()
    {
        SearchTimer?.Dispose();
    }
}

<style>
    .error-banner {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 12px 16px;
        border-radius: 6px;
        margin: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .error-icon {
        font-size: 1.2em;
    }

    .error-message {
        flex: 1;
    }

    .error-close {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: #dc2626;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    .loading-spinner-small {
        width: 16px;
        height: 16px;
        border: 2px solid #e2e8f0;
        border-top: 2px solid #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
    }

    .toolbar-search {
        position: relative;
        display: flex;
        align-items: center;
    }

    .clear-search {
        position: absolute;
        right: 35px;
        background: none;
        border: none;
        font-size: 1.2em;
        cursor: pointer;
        color: #64748b;
        padding: 4px;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .clear-search:hover {
        background: #f1f5f9;
        color: #475569;
    }

    .search-results-info {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 12px 16px;
        margin: 16px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9em;
        color: #475569;
    }

    .btn-link {
        background: none;
        border: none;
        color: #3b82f6;
        cursor: pointer;
        text-decoration: underline;
        font-size: 0.9em;
        padding: 4px 8px;
    }

    .btn-link:hover {
        color: #2563eb;
    }

    .user-role.administrator {
        color: #dc2626;
        font-weight: 600;
    }

    .user-role.manager {
        color: #ea580c;
        font-weight: 600;
    }

    .user-role.frontdesk {
        color: #16a34a;
        font-weight: 600;
    }

    .user-role.housekeeping {
        color: #9333ea;
        font-weight: 600;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    input:disabled, select:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background-color: #f8fafc;
    }
</style>
