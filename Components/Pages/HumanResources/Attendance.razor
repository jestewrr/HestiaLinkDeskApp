@page "/hr/attendance"
@using HestiaLink.Data
@using HestiaLink.Models
@using Microsoft.EntityFrameworkCore
@using AttendanceRecord = HestiaLink.Models.Attendance
@inject HestiaLinkContext Context
@inject IJSRuntime JSRuntime
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Attendance Management</h1>
        <span class="page-topbar-subtitle">@SelectedDate.ToString("dddd, MMMM dd, yyyy")</span>
    </header>

    <!-- Summary Cards - Moved above search -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0 30px 0;">
        <div class="stat-card @(SelectedFilter == "Present" ? "stat-card-active" : "")" @onclick="@(() => SetFilter("Present"))" style="cursor:pointer;">
            <div class="stat-title">Present</div>
            <div class="stat-value" style="color: #047857;">@PresentCount</div>
        </div>
        <div class="stat-card @(SelectedFilter == "Absent" ? "stat-card-active" : "")" @onclick="@(() => SetFilter("Absent"))" style="cursor:pointer;">
            <div class="stat-title">Absent</div>
            <div class="stat-value" style="color: #991b1b;">@AbsentCount</div>
        </div>
        <div class="stat-card @(SelectedFilter == "OnLeave" ? "stat-card-active" : "")" @onclick="@(() => SetFilter("OnLeave"))" style="cursor:pointer;">
            <div class="stat-title">On Leave</div>
            <div class="stat-value" style="color: #d97706;">@OnLeaveCount</div>
        </div>
        <div class="stat-card @(SelectedFilter == "Late" ? "stat-card-active" : "")" @onclick="@(() => SetFilter("Late"))" style="cursor:pointer;">
            <div class="stat-title">Late</div>
            <div class="stat-value" style="color: #b91c1c;">@LateCount</div>
        </div>
    </div>

    <div class="user-toolbar">
        <div class="toolbar-left">
            <div class="toolbar-search">
                <input type="text" placeholder="Search by name or ID..." @bind="SearchText" @oninput="OnSearchChanged" />
                <span class="search-icon"></span>
            </div>
            <input type="date" class="filter-select" value="@SelectedDate.ToString("yyyy-MM-dd")"
                   style="padding: 10px 16px;" @onchange="OnDateChanged" />
        </div>
        <div>
            <button class="btn-primary" @onclick="LoadToday">Today</button>
        </div>
    </div>

    <!-- Filter indicator -->
    @if (!string.IsNullOrEmpty(SelectedFilter))
    {
        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #64748b;">Filtering by: <strong>@SelectedFilter</strong></span>
            <button class="btn-secondary" style="padding: 4px 10px; font-size: 0.8rem;" @onclick="ClearFilter">Clear Filter</button>
        </div>
    }

    @if (!IsLoaded)
    {
        <div class="loading">Loading attendance records...</div>
    }
    else if (HasError)
    {
        <div class="error-message">
            <h4>⚠️ Database Error</h4>
            <p>@ErrorMessage</p>
            <button class="btn-primary" style="margin-top:15px;" @onclick="RetryLoad">Retry</button>
        </div>
    }
    else
    {
        <div class="panel-card">
            <div class="panel-body user-list-container">
                @if (FilteredEmployees.Any())
                {
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Full Name</th>
                                <th>Department</th>
                                <th>Shift Schedule</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Hours</th>
                                <th>Status</th>
                                <th style="text-align:center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var emp in FilteredEmployees)
                            {
                                var schedule = Schedules.FirstOrDefault(s => s.EmployeeID == emp.EmployeeID);
                                var attendance = schedule != null
                                ? Attendances.FirstOrDefault(a => a.ScheduleID == schedule.ScheduleID)
                                : null;

                                <tr>
                                    <td style="font-family:monospace; font-weight:700;">@emp.EmployeeID</td>
                                    <td style="font-weight:600;">@emp.FirstName @emp.LastName</td>
                                    <td>@(emp.Position?.Department?.DepartmentName ?? "-")</td>
                                    <td>
                                        @if (schedule != null)
                                        {
                                            <span style="font-weight:600; color:#0f766e;">
                                                @FormatTime(schedule.ScheduledStart) - @FormatTime(schedule.ScheduledEnd)
                                            </span>
                                        }
                                        else
                                        {
                                            <button class="btn-secondary" style="padding:4px 10px; font-size:0.8rem;"
                                                    @onclick="() => OpenShiftModal(emp, null)">
                                                + Assign Shift
                                            </button>
                                        }
                                    </td>
                                    <td>
                                        @if (attendance?.ActualCheckIn != null)
                                        {
                                            <span style="color:#10b981; font-weight:700;">
                                                @attendance.ActualCheckIn.Value.ToString("hh:mm tt")
                                            </span>
                                        }
                                        else if (schedule != null)
                                        {
                                            <button class="btn-secondary" style="background:#10b981; color:white;"
                                                    @onclick="() => CheckIn(emp, schedule)">
                                                Check In
                                            </button>
                                        }
                                        else
                                        {
                                            <span style="color:#94a3b8;">--:--</span>
                                        }
                                    </td>
                                    <td>
                                        @if (attendance?.ActualCheckOut != null)
                                        {
                                            <span style="color:#f59e0b; font-weight:700;">
                                                @attendance.ActualCheckOut.Value.ToString("hh:mm tt")
                                            </span>
                                        }
                                        else if (attendance?.ActualCheckIn != null)
                                        {
                                            <button class="btn-secondary" style="background:#f59e0b; color:white;"
                                                    @onclick="() => CheckOut(attendance)">
                                                Check Out
                                            </button>
                                        }
                                        else
                                        {
                                            <span style="color:#94a3b8;">--:--</span>
                                        }
                                    </td>
                                    <td style="font-weight:700; color:#10b981;">
                                        @if (attendance != null)
                                        {
                                            @((attendance.RegularHours + attendance.OvertimeHours).ToString("F1"))
                            
                                            <span style="font-weight:400;">h</span>
                                        }
                                        else
                                        {
                                            <span style="color:#94a3b8;">0.0h</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge-@GetStatusClass(attendance, schedule)">@GetStatusText(attendance, schedule)</span>
                                    </td>
                                    <td style="text-align:center;">
                                        <div style="display:flex; justify-content:center; gap:8px;">
                                            <button class="btn-secondary" style="padding:6px 10px; background:#10b981; color:white;"
                                                    @onclick="() => OpenShiftModal(emp, schedule)">
                                                @(schedule != null ? "Edit" : "➕")
                                            </button>
                                            <button class="btn-secondary" style="padding:6px 10px; background:#64748b; color:white;"
                                                    @onclick="() => ViewHistory(emp.EmployeeID)">
                                                History
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="no-data">No employees found</div>
                }
            </div>
        </div>
    }
</div>

@if (ShowShiftModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">@(IsEditingShift ? "Edit Shift" : "Create New Shift")</h2>
            </div>
            <div class="form-grid" style="padding:20px;">
                <div class="form-group full-width">
                    <label class="form-label">Employee</label>
                    <input type="text" class="form-input" value="@ModalEmployeeName" disabled />
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" @bind="ShiftDate" />
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Shift Type</label>
                    <select class="form-input" @bind="SelectedShiftType" @bind:after="OnShiftTypeChanged">
                        <option value="">-- Select Shift Type --</option>
                        <option value="Day">🌅 Day Shift (5:00 AM - 5:00 PM)</option>
                        <option value="Night">🌙 Night Shift (5:00 PM - 5:00 AM)</option>
                        <option value="Custom">⚙️ Custom Schedule</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Start Time</label>
                    <input type="time" class="form-input" @bind="ShiftStart" disabled="@(!IsCustomShift)" />
                </div>
                <div class="form-group">
                    <label class="form-label">End Time</label>
                    <input type="time" class="form-input" @bind="ShiftEnd" disabled="@(!IsCustomShift)" />
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" rows="2" @bind="ShiftNotes" placeholder="Optional notes..."></textarea>
                </div>
            </div>
            <div class="action-footer" style="border:none; padding-bottom:0; margin-top:10px;">
                <button class="btn-primary" @onclick="SaveShift" disabled="@(string.IsNullOrEmpty(SelectedShiftType))">
                    @(IsEditingShift ? "Update Shift" : "Create Shift")
                </button>
                <button class="btn-secondary" @onclick="CloseShiftModal">Cancel</button>
            </div>
        </div>
    </div>
}

@if (ShowHistoryModal)
{
    <div class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">Attendance History - @HistoryEmployeeName</h2>
            </div>
            <div class="panel-body" style="max-height:60vh; overflow-y:auto; padding:20px;">
                @if (HistoryRecords.Any())
                {
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Shift</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Hours</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var record in HistoryRecords)
                            {
                                <tr>
                                    <td style="font-weight:600;">@record.AttendanceDate.ToString("MMM dd, yyyy")</td>
                                    <td>
                                        @if (record.Schedule != null)
                                        {
                                            @($"{FormatTime(record.Schedule.ScheduledStart)} - {FormatTime(record.Schedule.ScheduledEnd)}")
                                        }
                                        else
                                        {
                                            <span style="color:#94a3b8;">N/A</span>
                                        }
                                    </td>
                                    <td>@(record.ActualCheckIn?.ToString("hh:mm tt") ?? "--:--")</td>
                                    <td>@(record.ActualCheckOut?.ToString("hh:mm tt") ?? "--:--")</td>
                                    <td style="font-weight:700; color:#10b981;">@((record.RegularHours + record.OvertimeHours).ToString("F1"))h</td>
                                    <td>
                                        <span class="badge-@record.AttendanceStatus.ToLower().Replace(" ", "-")">@record.AttendanceStatus</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="no-data" style="padding:40px;">No attendance history found</div>
                }
            </div>
            <div class="action-footer" style="border:none; padding-bottom:0; margin-top:10px;">
                <button class="btn-secondary" @onclick="CloseHistoryModal">Close</button>
            </div>
        </div>
    </div>
}

<style>
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

    .stat-card-active {
        border: 2px solid #0f766e;
        background: #f0fdfa;
    }

    .stat-title {
        font-size: 0.85rem;
        color: #64748b;
        text-transform: uppercase;
        font-weight: 600;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 900;
        margin-top: 8px;
    }

    .badge-present {
        background-color: #d1fae5;
        color: #065f46;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-absent, .badge-no-shift {
        background-color: #fee2e2;
        color: #991b1b;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-on-leave {
        background-color: #fef3c7;
        color: #92400e;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-pending {
        background-color: #f1f5f9;
        color: #64748b;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }
</style>

@code {
    private string SearchText = "";
    private DateTime SelectedDate = DateTime.Today;
    private bool ShowShiftModal = false;
    private bool ShowHistoryModal = false;
    private bool IsEditingShift = false;
    private bool IsLoaded = false;
    private bool HasError = false;
    private string ErrorMessage = string.Empty;
    private string SelectedFilter = "";

    private List<Employee> Employees = new();
    private List<Schedule> Schedules = new();
    private List<AttendanceRecord> Attendances = new();
    private List<AttendanceRecord> HistoryRecords = new();

    private Employee? SelectedEmployee;
    private Schedule? SelectedSchedule;
    private string ModalEmployeeName = "";
    private string HistoryEmployeeName = "";
    private DateTime ShiftDate = DateTime.Today;
    private DateTime ShiftStart = DateTime.Today.AddHours(5);
    private DateTime ShiftEnd = DateTime.Today.AddHours(17);
    private string ShiftNotes = "";
    private string SelectedShiftType = "";
    private bool IsCustomShift => SelectedShiftType == "Custom";

    private int PresentCount = 0;
    private int AbsentCount = 0;
    private int OnLeaveCount = 0;
    private int LateCount = 0;

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        try
        {
            HasError = false;
            ErrorMessage = string.Empty;

            Employees = await Context.Employees
                .Include(e => e.Position).ThenInclude(p => p!.Department)
                .Where(e => e.Status == "Active")
                .AsNoTracking().OrderBy(e => e.FirstName).ToListAsync();

            Schedules = await Context.Schedules
                .Where(s => s.ScheduleDate.Date == SelectedDate.Date && s.IsActive)
                .AsNoTracking().ToListAsync();

            var scheduleIds = Schedules.Select(s => s.ScheduleID).ToList();

            Attendances = await Context.Attendances
                .Where(a => a.AttendanceDate.Date == SelectedDate.Date && scheduleIds.Contains(a.ScheduleID))
                .Include(a => a.Schedule).AsNoTracking().ToListAsync();

            CalculateSummary();
            IsLoaded = true;
        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = ex.Message;
            IsLoaded = true;
        }
    }

    private void CalculateSummary()
    {
        PresentCount = Attendances.Count(a => a.AttendanceStatus == "Present");
        AbsentCount = Attendances.Count(a => a.AttendanceStatus == "Absent");
        OnLeaveCount = Attendances.Count(a => a.AttendanceStatus == "On Leave");

        // Calculate late count dynamically
        LateCount = Attendances.Count(a =>
            a.ActualCheckIn != null &&
            a.Schedule != null &&
            a.ActualCheckIn.Value.TimeOfDay > a.Schedule.ScheduledStart.Add(TimeSpan.FromMinutes(15)));
    }

    private void SetFilter(string filter)
    {
        SelectedFilter = SelectedFilter == filter ? "" : filter;
    }

    private void ClearFilter()
    {
        SelectedFilter = "";
    }

    private async Task RetryLoad() { IsLoaded = false; StateHasChanged(); await Task.Delay(500); await LoadData(); }
    private void OnSearchChanged(ChangeEventArgs e) => SearchText = e.Value?.ToString() ?? string.Empty;
    private async Task OnDateChanged(ChangeEventArgs e) { if (DateTime.TryParse(e.Value?.ToString(), out var date)) { SelectedDate = date; await LoadData(); } }
    private async Task LoadToday() { SelectedDate = DateTime.Today; await LoadData(); }

    private List<Employee> FilteredEmployees
    {
        get
        {
            var list = Employees.ToList();

            // Apply search filter
            if (!string.IsNullOrWhiteSpace(SearchText))
            {
                var search = SearchText.Trim();
                list = list.Where(e =>
                    (e.FirstName + " " + e.LastName).Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    e.EmployeeID.ToString().Contains(search) ||
                    (e.Position?.Department?.DepartmentName ?? "").Contains(search, StringComparison.OrdinalIgnoreCase))
                    .ToList();
            }

            // Apply card filter
            if (!string.IsNullOrEmpty(SelectedFilter))
            {
                list = list.Where(emp =>
                {
                    var schedule = Schedules.FirstOrDefault(s => s.EmployeeID == emp.EmployeeID);
                    var attendance = schedule != null
                        ? Attendances.FirstOrDefault(a => a.ScheduleID == schedule.ScheduleID)
                        : null;

                    return SelectedFilter switch
                    {
                        "Present" => attendance?.AttendanceStatus == "Present",
                        "Absent" => attendance?.AttendanceStatus == "Absent",
                        "OnLeave" => attendance?.AttendanceStatus == "On Leave",
                        "Late" => attendance?.ActualCheckIn != null && schedule != null &&
                                  attendance.ActualCheckIn.Value.TimeOfDay > schedule.ScheduledStart.Add(TimeSpan.FromMinutes(15)),
                        _ => true
                    };
                }).ToList();
            }

            return list.OrderBy(e => e.FirstName).ToList();
        }
    }

    private void OpenShiftModal(Employee emp, Schedule? schedule)
    {
        SelectedEmployee = emp;
        SelectedSchedule = schedule;
        IsEditingShift = schedule != null;
        ModalEmployeeName = $"{emp.FirstName} {emp.LastName}";
        ShiftDate = SelectedDate;

        if (schedule != null)
        {
            // Determine shift type based on existing schedule
            var startHour = schedule.ScheduledStart.Hours;
            var endHour = schedule.ScheduledEnd.Hours;

            if (startHour == 5 && endHour == 17)
                SelectedShiftType = "Day";
            else if (startHour == 17 && endHour == 5)
                SelectedShiftType = "Night";
            else
                SelectedShiftType = "Custom";

            ShiftStart = DateTime.Today.Add(schedule.ScheduledStart);
            ShiftEnd = DateTime.Today.Add(schedule.ScheduledEnd);
            ShiftNotes = schedule.Notes ?? "";
        }
        else
        {
            SelectedShiftType = "";
            ShiftStart = DateTime.Today.AddHours(5);
            ShiftEnd = DateTime.Today.AddHours(17);
            ShiftNotes = "";
        }
        ShowShiftModal = true;
    }

    private void OnShiftTypeChanged()
    {
        switch (SelectedShiftType)
        {
            case "Day":
                ShiftStart = DateTime.Today.AddHours(5);  // 5:00 AM
                ShiftEnd = DateTime.Today.AddHours(17);   // 5:00 PM
                break;
            case "Night":
                ShiftStart = DateTime.Today.AddHours(17); // 5:00 PM
                ShiftEnd = DateTime.Today.AddHours(5);    // 5:00 AM (next day)
                break;
            case "Custom":
                // Keep current values, user will set them
                break;
        }
    }

    private void CloseShiftModal() { ShowShiftModal = false; SelectedEmployee = null; SelectedSchedule = null; SelectedShiftType = ""; }

    private async Task SaveShift()
    {
        if (SelectedEmployee == null || string.IsNullOrEmpty(SelectedShiftType)) return;
        try
        {
            var existingSchedule = await Context.Schedules
                .FirstOrDefaultAsync(s => s.EmployeeID == SelectedEmployee.EmployeeID && s.ScheduleDate.Date == ShiftDate.Date && s.IsActive);

            if (existingSchedule != null)
            {
                existingSchedule.IsActive = false;
                existingSchedule.UpdatedAt = DateTime.Now;
                Context.Schedules.Update(existingSchedule);
            }

            var newSchedule = new Schedule
            {
                EmployeeID = SelectedEmployee.EmployeeID,
                ScheduleDate = ShiftDate,
                ScheduledStart = ShiftStart.TimeOfDay,
                ScheduledEnd = ShiftEnd.TimeOfDay,
                Notes = $"[{SelectedShiftType} Shift] {ShiftNotes}".Trim(),
                IsActive = true,
                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now
            };
            Context.Schedules.Add(newSchedule);
            await Context.SaveChangesAsync();

            if (existingSchedule != null)
            {
                var attendancesToUpdate = await Context.Attendances.Where(a => a.ScheduleID == existingSchedule.ScheduleID).ToListAsync();
                foreach (var att in attendancesToUpdate) { att.ScheduleID = newSchedule.ScheduleID; att.UpdatedAt = DateTime.Now; }
                await Context.SaveChangesAsync();
            }

            await LoadData();
            CloseShiftModal();
            await JSRuntime.InvokeVoidAsync("alert", "Shift saved successfully");
        }
        catch (Exception ex) { await JSRuntime.InvokeVoidAsync("alert", $"Error saving shift: {ex.Message}"); }
    }

    private async Task CheckIn(Employee emp, Schedule schedule)
    {
        try
        {
            var existingAttendance = await Context.Attendances.FirstOrDefaultAsync(a => a.ScheduleID == schedule.ScheduleID);

            if (existingAttendance != null)
            {
                existingAttendance.ActualCheckIn = DateTime.Now;
                existingAttendance.AttendanceStatus = "Present";
                existingAttendance.UpdatedAt = DateTime.Now;
                Context.Attendances.Update(existingAttendance);
            }
            else
            {
                var newAttendance = new AttendanceRecord
                {
                    ScheduleID = schedule.ScheduleID,
                    AttendanceDate = SelectedDate,
                    ActualCheckIn = DateTime.Now,
                    AttendanceStatus = "Present",
                    CreatedAt = DateTime.Now,
                    UpdatedAt = DateTime.Now
                };
                Context.Attendances.Add(newAttendance);
            }
            await Context.SaveChangesAsync();
            await LoadData();
            await JSRuntime.InvokeVoidAsync("alert", $"{emp.FirstName} checked in successfully");
        }
        catch (Exception ex) { await JSRuntime.InvokeVoidAsync("alert", $"Error checking in: {ex.Message}"); }
    }

    private async Task CheckOut(AttendanceRecord attendance)
    {
        try
        {
            var existing = await Context.Attendances.FindAsync(attendance.AttendanceID);
            if (existing != null)
            {
                existing.ActualCheckOut = DateTime.Now;
                if (existing.ActualCheckIn.HasValue)
                {
                    var hours = (DateTime.Now - existing.ActualCheckIn.Value).TotalHours;
                    existing.RegularHours = (decimal)Math.Min(hours, 8);
                    existing.OvertimeHours = (decimal)Math.Max(hours - 8, 0);
                }
                existing.UpdatedAt = DateTime.Now;
                Context.Attendances.Update(existing);
                await Context.SaveChangesAsync();
                await LoadData();
                await JSRuntime.InvokeVoidAsync("alert", "Check-out recorded");
            }
        }
        catch (Exception ex) { await JSRuntime.InvokeVoidAsync("alert", $"Error checking out: {ex.Message}"); }
    }

    private async Task ViewHistory(int employeeId)
    {
        try
        {
            var emp = Employees.FirstOrDefault(e => e.EmployeeID == employeeId);
            if (emp == null) return;
            HistoryEmployeeName = $"{emp.FirstName} {emp.LastName}";
            var scheduleIds = await Context.Schedules.Where(s => s.EmployeeID == employeeId).Select(s => s.ScheduleID).ToListAsync();
            HistoryRecords = await Context.Attendances
                .Where(a => scheduleIds.Contains(a.ScheduleID))
                .Include(a => a.Schedule)
                .OrderByDescending(a => a.AttendanceDate).Take(30).AsNoTracking().ToListAsync();
            ShowHistoryModal = true;
        }
        catch (Exception ex) { await JSRuntime.InvokeVoidAsync("alert", $"Error loading history: {ex.Message}"); }
    }

    private void CloseHistoryModal() { ShowHistoryModal = false; HistoryRecords = new(); }
    private string FormatTime(TimeSpan time) => DateTime.Today.Add(time).ToString("hh:mm tt");
    private string GetStatusText(AttendanceRecord? attendance, Schedule? schedule) => attendance != null ? attendance.AttendanceStatus : (schedule != null ? "Pending" : "No Shift");
    private string GetStatusClass(AttendanceRecord? attendance, Schedule? schedule) => attendance != null ? attendance.AttendanceStatus.ToLower().Replace(" ", "-") : (schedule != null ? "pending" : "no-shift");
}