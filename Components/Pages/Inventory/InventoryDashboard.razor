@page "/inventory/dashboard"
@using Microsoft.EntityFrameworkCore
@using System.Globalization
@inject IJSRuntime JSRuntime
@inject HestiaLinkContext DbContext
@layout MainLayout

<div class="page-wrapper">
    <div class="page-topbar">
        <div>
            <h1>Inventory Dashboard</h1>
            <div class="page-topbar-subtitle">Real-time Inventory Overview</div>
        </div>
        <div class="page-topbar-date">@DateTime.Now.ToString("MMMM dd, yyyy")</div>
    </div>

    <div class="page-content">
        @if (!IsLoaded)
    {
        <div class="loading">Loading inventory data...</div>
    }
    else if (HasError)
    {
        <div class="error-message">
            <h4>‚ö†Ô∏è Database Error</h4>
            <p>@ErrorMessage</p>
            <button class="btn-primary" @onclick="RetryLoad">Retry</button>
        </div>
    }
    else
    {
        @* ===== SUMMARY CARDS ===== *@
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-label">TOTAL ITEMS</div>
                <div class="summary-value">@TotalItems</div>
                <div class="summary-desc">Total inventory count</div>
            </div>

            <div class="summary-card danger">
                <div class="summary-label">LOW STOCK ALERTS</div>
                <div class="summary-value">@LowStockCount</div>
                <div class="summary-desc">Items below threshold</div>
            </div>

            <div class="summary-card">
                <div class="summary-label">CATEGORIES</div>
                <div class="summary-value">@CategoryCount</div>
                <div class="summary-desc">Active item categories</div>
            </div>

            <div class="summary-card">
                <div class="summary-label">TOTAL VALUE</div>
                <div class="summary-value">‚Ç±@TotalStockValue.ToString("N0")</div>
                <div class="summary-desc">Total inventory worth</div>
            </div>
        </div>

        @* ===== QUICK ACTION BUTTONS ===== *@
        <div class="quick-actions">
            <a href="/inventory/items" class="action-btn">
                <span class="action-icon">üì¶</span>
                <span>Manage Items</span>
            </a>
            <a href="/inventory/service-links" class="action-btn">
                <span class="action-icon">üîó</span>
                <span>Service Links</span>
            </a>
            <a href="/inventory/reports" class="action-btn">
                <span class="action-icon">üìä</span>
                <span>Reports</span>
            </a>
            <a href="/inventory/alerts" class="action-btn">
                <span class="action-icon">‚ö†Ô∏è</span>
                <span>Alerts (@LowStockCount)</span>
            </a>
        </div>

        <div class="dashboard-grid">
            @* ===== LOW STOCK ALERTS PANEL ===== *@
            <div class="panel-card">
                <div class="panel-header">
                    <h3>‚ö†Ô∏è Low Stock Alerts</h3>
                    <a href="/inventory/alerts" class="view-all-link">View All</a>
                </div>
                <div class="panel-body">
                    @if (LowStockItems.Any())
                    {
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Current Stock</th>
                                    <th>Reorder Point</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in LowStockItems.Take(5))
                                {
                                    <tr>
                                        <td style="font-weight:600;">@item.ItemName</td>
                                        <td>
                                            <span class="stock-badge critical">@(item.CurrentStock ?? 0) @item.UnitOfMeasure</span>
                                        </td>
                                        <td>@(item.ReorderPoint ?? 0)</td>
                                        <td>
                                            @if ((item.CurrentStock ?? 0) == 0)
                                            {
                                                <span class="status-badge status-cancelled">Out of Stock</span>
                                            }
                                            else
                                            {
                                                <span class="status-badge status-pending">Low Stock</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                         <div class="no-data" style="color: #059669;">‚úÖ All items are well stocked!</div>
                    }
                </div>
            </div>

            @* ===== RECENT CONSUMPTION PANEL ===== *@
            <div class="panel-card">
                <div class="panel-header">
                    <h3>üìã Recent Consumption</h3>
                    <a href="/inventory/reports" class="view-all-link">View All</a>
                </div>
                <div class="panel-body">
                    @if (RecentConsumptions.Any())
                    {
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Qty Consumed</th>
                                    <th>Room</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var consumption in RecentConsumptions.Take(5))
                                {
                                    <tr>
                                        <td style="font-weight:600;">@(consumption.InventoryItem?.ItemName ?? "N/A")</td>
                                        <td>@consumption.QuantityConsumed @(consumption.InventoryItem?.UnitOfMeasure ?? "")</td>
                                        <td>@(consumption.RoomNumber ?? "-")</td>
                                        <td>@consumption.ConsumptionDate.ToString("MMM dd, HH:mm")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="no-data">No recent consumption records</div>
                    }
                </div>
            </div>

            @* ===== INVENTORY BY CATEGORY ===== *@
            <div class="panel-card">
                <div class="panel-header">
                    <h3>üìÅ Inventory by Category</h3>
                </div>
                <div class="panel-body">
                    @if (CategoryBreakdown.Any())
                    {
                        <div class="category-list">
                            @foreach (var cat in CategoryBreakdown)
                            {
                                <div class="category-item">
                                    <div class="category-info">
                                        <span class="category-name">@cat.Category</span>
                                        <span class="category-count">@cat.ItemCount items</span>
                                    </div>
                                    <div class="category-bar">
                                        <div class="category-bar-fill" style="width: @(cat.ItemCount * 100 / Math.Max(CategoryBreakdown.Max(c => c.ItemCount), 1))%"></div>
                                    </div>
                                    <span class="category-value">‚Ç±@cat.TotalValue.ToString("N0")</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="no-data">No inventory items found</div>
                    }
                </div>
            </div>

            @* ===== SERVICES USING INVENTORY ===== *@
            <div class="panel-card">
                <div class="panel-header">
                    <h3>üîó Services Using Inventory</h3>
                    <a href="/inventory/service-links" class="view-all-link">Manage Links</a>
                </div>
                <div class="panel-body">
                    @if (ServicesWithInventory.Any())
                    {
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Items Linked</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var service in ServicesWithInventory.Take(5))
                                {
                                    <tr>
                                        <td style="font-weight:600;">@service.ServiceName</td>
                                        <td>@service.LinkedItemsCount items</td>
                                        <td>
                                            <span class="status-badge status-confirmed">Active</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="no-data">No services linked to inventory yet</div>
                    }
                </div>
            </div>
        </div>
    }
    </div>
</div>

@code {
    private bool IsLoaded = false;
    private bool HasError = false;
    private string ErrorMessage = string.Empty;

    // Summary data
    private int TotalItems = 0;
    private int LowStockCount = 0;
    private int CategoryCount = 0;
    private decimal TotalStockValue = 0;

    // Lists
    private List<InventoryItem> LowStockItems = new();
    private List<InventoryConsumption> RecentConsumptions = new();
    private List<CategorySummary> CategoryBreakdown = new();
    private List<ServiceWithInventory> ServicesWithInventory = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            HasError = false;
            ErrorMessage = string.Empty;

            // Get all active inventory items with proper null handling
            var inventoryItems = await DbContext.InventoryItems
                .Where(i => i.IsActive != null && i.IsActive.Value)
                .ToListAsync();

            TotalItems = inventoryItems.Count;
            TotalStockValue = inventoryItems.Sum(i => (i.CurrentStock ?? 0) * i.UnitCost);
            CategoryCount = inventoryItems.Select(i => i.Category).Distinct().Count();

            // Low stock items (at or below reorder point) with null-safe comparison
            LowStockItems = inventoryItems
                .Where(i => (i.CurrentStock ?? 0) <= (i.ReorderPoint ?? 0))
                .OrderBy(i => i.CurrentStock ?? 0)
                .ToList();
            LowStockCount = LowStockItems.Count;

            // Category breakdown with null-safe calculations
            CategoryBreakdown = inventoryItems
                .GroupBy(i => i.Category)
                .Select(g => new CategorySummary
                {
                    Category = g.Key,
                    ItemCount = g.Count(),
                    TotalValue = g.Sum(i => (i.CurrentStock ?? 0) * i.UnitCost)
                })
                .OrderByDescending(c => c.TotalValue)
                .ToList();

            // Recent consumptions
            RecentConsumptions = await DbContext.InventoryConsumptions
                .Include(c => c.InventoryItem)
                .OrderByDescending(c => c.ConsumptionDate)
                .Take(10)
                .ToListAsync();

            // Services with inventory links - handle nullable IsActive
            var serviceLinks = await DbContext.ServiceInventories
                .Include(si => si.Service)
                .Where(si => si.Service != null && si.Service.IsActive != null && si.Service.IsActive.Value)
                .ToListAsync();

            ServicesWithInventory = serviceLinks
                .GroupBy(si => si.ServiceId)
                .Select(g => new ServiceWithInventory
                {
                    ServiceId = g.Key,
                    ServiceName = g.First().Service?.ServiceName ?? "Unknown",
                    LinkedItemsCount = g.Count()
                })
                .OrderByDescending(s => s.LinkedItemsCount)
                .ToList();

            IsLoaded = true;
        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = ex.Message;
            IsLoaded = true;
        }
    }

    private async Task RetryLoad()
    {
        IsLoaded = false;
        StateHasChanged();
        await Task.Delay(500);
        await LoadDashboardData();
    }

    // Helper classes
    private class CategorySummary
    {
        public string Category { get; set; } = string.Empty;
        public int ItemCount { get; set; }
        public decimal TotalValue { get; set; }
    }

    private class ServiceWithInventory
    {
        public int ServiceId { get; set; }
        public string ServiceName { get; set; } = string.Empty;
        public int LinkedItemsCount { get; set; }
    }
}

<style>
    /* Summary Cards */
    /* Summary Cards (Premium Design) */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 24px;
        margin-bottom: 32px;
    }

    .summary-card {
        background: #e0f2f1; /* Light Cyan/Teal */
        border-radius: 16px;
        padding: 24px;
        border: none;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 160px;
        position: relative;
        transition: transform 0.2s;
    }

    .summary-card:hover {
        transform: translateY(-2px);
    }

    .summary-card .summary-label {
        color: #0e7490; /* Cyan-700 */
        font-size: 0.8rem;
        font-weight: 800;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }

    .summary-card .summary-value {
        color: #0f172a; /* Slate-900 */
        font-size: 3.5rem;
        font-weight: 800;
        line-height: 1;
        text-align: right;
        margin: 0;
    }

    .summary-card .summary-desc {
        color: #64748b; /* Slate-500 */
        font-size: 0.85rem;
        font-weight: 500;
        margin-top: auto;
    }

    /* Danger/Alert Variant */
    .summary-card.danger {
        background: #fee2e2; /* Red-100 */
    }

    .summary-card.danger .summary-label {
        color: #b91c1c; /* Red-700 */
    }

    .summary-card.danger .summary-value {
        color: #b91c1c; /* Red-700 */
    }

    .summary-card.danger .summary-desc {
        color: #ef4444; /* Red-500 */
    }

    /* Quick Actions */
    .quick-actions {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #ffffff;
        padding: 14px 22px;
        border-radius: 12px;
        text-decoration: none;
        color: #0f766e;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
        transition: all 0.2s ease;
    }

    .action-btn:hover {
        background: #0f766e;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(15, 118, 110, 0.2);
    }

    .action-icon {
        font-size: 1.2rem;
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    /* Panel Cards */
    .panel-card {
        background: #ffffff;
        border-radius: 14px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.04);
        overflow: hidden;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #f1f5f9;
        background: linear-gradient(90deg, #064e49, #0f766e);
        color: white;
    }

    .panel-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
    }

    .view-all-link {
        color: #d1fae5;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .view-all-link:hover {
        color: white;
        text-decoration: underline;
    }

    .panel-body {
        padding: 16px 20px;
        max-height: 320px;
        overflow-y: auto;
    }

    /* Inventory Table */
    .inventory-table {
        width: 100%;
        border-collapse: collapse;
    }

    .inventory-table th,
    .inventory-table td {
        padding: 12px 10px;
        text-align: left;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.9rem;
    }

    .inventory-table th {
        color: #6b7280;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
    }

    /* Stock Badge */
    .stock-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .stock-badge.critical {
        background: #fef2f2;
        color: #991b1b;
    }

    .stock-badge.warning {
        background: #fef9c3;
        color: #92400e;
    }

    /* Status Badge */
    .status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.8rem;
    }

    .status-badge.status-confirmed {
        background: #d1fae5;
        color: #065f46;
    }

    .status-badge.status-pending {
        background: #fef9c3;
        color: #92400e;
    }

    .status-badge.status-cancelled {
        background: #fee2e2;
        color: #991b1b;
    }

    /* Category List */
    .category-list {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .category-item {
        display: grid;
        grid-template-columns: 1fr 2fr auto;
        align-items: center;
        gap: 12px;
    }

    .category-info {
        display: flex;
        flex-direction: column;
    }

    .category-name {
        font-weight: 700;
        color: #0f172a;
        font-size: 0.9rem;
    }

    .category-count {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .category-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
    }

    .category-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #0f766e, #14b8a6);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .category-value {
        font-weight: 700;
        color: #065f46;
        font-size: 0.9rem;
    }

    /* No Data */
    .no-data {
        padding: 20px;
        text-align: center;
        color: #6b7280;
        font-size: 0.9rem;
    }

    /* Loading */
    .loading {
        padding: 40px;
        text-align: center;
        color: #0f766e;
        font-weight: 600;
    }

    /* Error */
    .error-message {
        background: #fef2f2;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        color: #991b1b;
    }

    .btn-primary {
        background: #0f766e;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 10px;
    }

    @@media (max-width: 1200px) {
        .summary-cards {
            grid-template-columns: repeat(2, 1fr);
        }
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
