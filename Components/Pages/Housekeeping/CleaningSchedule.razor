@page "/housekeeping/cleaning-schedule"
@using HestiaLink.Data
@using HestiaLink.Models
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext DbContext
@inject NavigationManager Navigation

<div class="page-wrapper">
    <div class="page-topbar">
        <div>
            <h1>Cleaning Schedule</h1>
            <div class="page-topbar-subtitle">Assign and track room cleaning tasks</div>
        </div>
        <div class="page-topbar-date">@DateTime.Now.ToString("MMMM dd, yyyy")</div>
    </div>

    <div class="page-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; height: 100%;">
            
            <!-- Left Column: Rooms Needing Cleaning -->
            <div class="panel-card" style="padding: 24px; height: 100%;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h3 style="margin:0; color: var(--color-dark-teal); font-weight:800;">Needs Cleaning</h3>
                    <span class="status-badge badge-dirty" style="font-size:0.8rem;">DIRTY</span>
                </div>
                
                @if (DirtyRooms == null)
                {
                    <div class="spinner"></div>
                }
                else if (!DirtyRooms.Any())
                {
                    <div style="text-align: center; padding: 40px; color: #94a3b8; font-style: italic;">
                        All rooms are clean!
                    </div>
                }
                else
                {
                    <div style="overflow-y: auto; flex: 1; padding-right: 4px;">
                        @foreach (var room in DirtyRooms)
                        {
                            <div style="background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 800; font-size: 1.1rem; color: #0f172a;">Room @room.RoomNumber</div>
                                    <div style="font-size: 0.9rem; color: #64748b;">Floor @room.Floor</div>
                                </div>
                                <button class="btn-primary" style="padding: 8px 20px; font-size: 0.85rem; flex: none; width: auto;" @onclick="() => OpenAssignModal(room)">
                                    Assign
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Right Column: Active Cleaning Tasks -->
            <div class="panel-card" style="padding: 24px; height: 100%;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h3 style="margin:0; color: var(--color-dark-teal); font-weight:800;">Active Tasks</h3>
                    <span class="status-badge" style="background:#e0f2fe; color:#0369a1;">IN PROGRESS</span>
                </div>

                @if (ActiveTasks == null)
                {
                    <div class="spinner"></div>
                }
                else if (!ActiveTasks.Any())
                {
                    <div style="text-align: center; padding: 40px; color: #94a3b8; font-style: italic;">
                        No active tasks.
                    </div>
                }
                else
                {
                    <div style="overflow-y: auto; flex: 1; padding-right: 4px;">
                        @foreach (var task in ActiveTasks)
                        {
                            <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.03);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 800; color: #0f172a;">Room @(task.Room?.RoomNumber ?? "???")</span>
                                    <span class="status-badge" style="background:#fff7ed; color:#c2410c; border:1px solid #ffedd5;">ASSIGNED</span>
                                </div>
                                <div style="font-size: 0.9rem; margin-bottom: 6px; color: #334155;">
                                    Assigned to: <strong style="color: var(--color-dark-teal);">@(task.User?.Username ?? "Unknown")</strong>
                                </div>
                                <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 12px; line-height: 1.4;">
                                    Standard Cleaning Task<br/>
                                </div>
                                <div style="text-align: right;">
                                    <button class="btn-secondary" style="font-size: 0.85rem; padding: 6px 16px; flex: none; width: auto;" @onclick="() => MarkTaskComplete(task)">
                                        Mark Completed
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Assign Modal -->
@if (ShowAssignModal)
{
    <div class="modal-overlay" @onclick="CloseAssignModal">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h2>Assign Cleaning Task</h2>
            </div>
            <div class="login-form">
                <p style="margin-bottom: 15px;">Assigning cleaning for <strong>Room @SelectedDirtyRoom?.RoomNumber</strong></p>

                <div class="input-group-modern">
                    <label class="input-label">Assign To (Staff)</label>
                    <select class="form-select" @bind="NewTask.UserId">
                        <option value="">Select Staff...</option>
                        @foreach (var user in StaffUsers)
                        {
                            <option value="@user.UserId">@user.Username</option>
                        }
                    </select>
                </div>
                
                <!-- Notes field removed as not supported by Task schema -->

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" @onclick="SaveAssignment">Assign Task</button>
                    <button class="btn-secondary" @onclick="CloseAssignModal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<HestiaLink.Models.VwRoomsNeedingCleaning> DirtyRooms = new();
    private List<CleaningTask> ActiveTasks = new();
    private List<SystemUser> StaffUsers = new();
    
    private bool ShowAssignModal = false;
    private CleaningTask NewTask = new();
    private HestiaLink.Models.VwRoomsNeedingCleaning? SelectedDirtyRoom;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        DirtyRooms = await DbContext.VwRoomsNeedingCleanings
            .OrderBy(r => r.RoomNumber)
            .ToListAsync();

        ActiveTasks = await DbContext.Tasks
            .Include(t => t.Room)
            .Include(t => t.User)
            .ToListAsync();

        StaffUsers = await DbContext.SystemUsers
            .Where(u => u.Status == "Active") 
            .ToListAsync();
    }

    private void OpenAssignModal(HestiaLink.Models.VwRoomsNeedingCleaning room)
    {
        SelectedDirtyRoom = room;
        NewTask = new CleaningTask 
        { 
            RoomId = room.RoomId
        };
        ShowAssignModal = true;
    }

    private void CloseAssignModal()
    {
        ShowAssignModal = false;
        SelectedDirtyRoom = null;
    }

    private async Task SaveAssignment()
    {
        if (SelectedDirtyRoom == null) return;

        DbContext.Tasks.Add(NewTask);
        await DbContext.SaveChangesAsync();
        
        await LoadData();
        CloseAssignModal();
    }

    private async Task MarkTaskComplete(CleaningTask task)
    {
        // Logic limited by schema: Removing task to signify completion
        DbContext.Tasks.Remove(task);

        // Update Room Status to Available
        var room = await DbContext.Rooms.FindAsync(task.RoomId);
        if (room != null)
        {
            room.Status = "Available";
            DbContext.Rooms.Update(room);
        }

        await DbContext.SaveChangesAsync();
        await LoadData();
    }
}
