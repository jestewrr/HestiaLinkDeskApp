@page "/settings/room-management"
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext Context
@inject IJSRuntime JSRuntime
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Room Management</h1>
        <span class="page-topbar-subtitle">Configure Rooms & Floors</span>
    </header>

    <section class="page-content">
        <!-- Action Buttons -->
        <div style="display: flex; gap: 12px; margin-bottom: 24px; justify-content: flex-end;">
            <button class="btn-action-secondary" @onclick="ShowRoomStatusView">Room Status</button>
            <button class="btn-create" @onclick="OpenAddRoomModal">Add Room</button>
            <button class="btn-create" @onclick="OpenAddRoomTypeModal">Add RoomType</button>
        </div>

        <!-- Room Status Grid View -->
        @if (CurrentView == "status")
        {
            <div class="room-grid-container">
                @foreach (var floor in Floors.OrderBy(f => f.FloorNumber))
                {
                    <div class="floor-section">
                        <h3 class="floor-title">Floor @floor.FloorNumber</h3>
                        <div class="room-grid">
                            @foreach (var room in Rooms.Where(r => r.Floor == floor.FloorNumber).OrderBy(r => r.RoomNumber))
                            {
                                <button class="room-status-card @GetRoomStatusClass(room.Status)"
                                        @onclick="() => OpenEditRoomModal(room)">
                                    <span class="room-label">ROOM @room.RoomNumber</span>
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </section>
</div>

<!-- Add Room Modal -->
@if (ShowAddRoomModal)
{
    <div class="modal-overlay" @onclick="CloseModals">
        <div class="modal-content modal-room-create" @onclick:stopPropagation="true">
            <h2 style="margin-top: 0; margin-bottom: 24px;">Create Room</h2>

            <div class="room-modal-layout">
                <!-- Left Side - Form -->
                <div class="room-form-section">
                    <h3 style="margin-top: 0; font-size: 1.1rem; margin-bottom: 16px;">Room Information</h3>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Room Number</label>
                        <input type="text" class="form-input" @bind="NewRoom.RoomNumber" placeholder="e.g., 101" />
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Floor</label>
                        <input type="number" class="form-input" @bind="NewRoom.Floor" placeholder="e.g., 1" />
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Room Type</label>
                        <select class="form-select" @bind="NewRoom.RoomTypeID">
                            <option value="">Select Type</option>
                            @foreach (var rt in RoomTypes.Where(rt => rt.Status == "Active"))
                            {
                                <option value="@rt.RoomTypeID">@rt.TypeName</option>
                            }
                        </select>
                    </div>

                    <div class="room-action-buttons">
                        <button class="btn-modal-primary" @onclick="AddRoom">Add Room</button>
                    </div>
                </div>

                <!-- Right Side - List -->
                <div class="room-list-section">
                    <h3 style="margin-top: 0; font-size: 1.1rem; margin-bottom: 16px;">List of Room</h3>

                    <div class="room-list-table-container">
                        <table class="room-list-table">
                            <thead>
                                <tr>
                                    <th>Room Number</th>
                                    <th>Floor</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var room in Rooms.OrderBy(r => r.Floor).ThenBy(r => r.RoomNumber))
                                {
                                    <tr @onclick="() => SelectRoomFromList(room)" style="cursor: pointer;">
                                        <td>@room.RoomNumber</td>
                                        <td>@room.Floor</td>
                                        <td>@room.Status</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Edit Room Modal -->
@if (ShowEditRoomModal)
{
    <div class="modal-overlay" @onclick="CloseModals">
        <div class="modal-content modal-room-edit" @onclick:stopPropagation="true">
            <h2 style="margin-top: 0; margin-bottom: 24px;">Edit Room</h2>

            <div class="room-form-section">
                <h3 style="margin-top: 0; font-size: 1.1rem; margin-bottom: 16px;">Room Information</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label class="form-label">Room Number</label>
                        <input type="text" class="form-input" @bind="SelectedRoom.RoomNumber" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" @bind="SelectedRoom.Status">
                            <option value="Available">Available</option>
                            <option value="Occupied">Occupied</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Cleaning">Cleaning</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label class="form-label">Room Type</label>
                        <select class="form-select" @bind="SelectedRoom.RoomTypeID">
                            @foreach (var rt in RoomTypes.Where(rt => rt.Status == "Active"))
                            {
                                <option value="@rt.RoomTypeID">@rt.TypeName</option>
                            }
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Floor Number</label>
                        <input type="number" class="form-input" @bind="SelectedRoom.Floor" />
                    </div>
                </div>

                <button class="btn-modal-primary" style="width: 100%;" @onclick="SaveRoomEdit">Update</button>
            </div>
        </div>
    </div>
}

<!-- Add Room Type Modal -->
@if (ShowAddRoomTypeModal)
{
    <div class="modal-overlay" @onclick="CloseModals">
        <div class="modal-content modal-room-type" @onclick:stopPropagation="true">
            <h2 style="margin-top: 0; margin-bottom: 24px;">Create Room Type</h2>

            <div class="room-modal-layout">
                <!-- Left Side - Form -->
                <div class="room-form-section">
                    <h3 style="margin-top: 0; font-size: 1.1rem; margin-bottom: 16px;">Room Type Information</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div class="form-group">
                            <label class="form-label">Room Type</label>
                            <input type="text" class="form-input" @bind="NewRoomType.TypeName" placeholder="e.g., Deluxe" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Max Occupancy</label>
                            <input type="number" class="form-input" @bind="NewRoomType.MaxOccupancy" />
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Base Price</label>
                        <input type="number" class="form-input" @bind="NewRoomType.BasePrice" />
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Status</label>
                        <select class="form-select" @bind="NewRoomType.Status">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" rows="3" @bind="NewRoomType.Description" placeholder="Describe the room type..."></textarea>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="btn-modal-primary" @onclick="ConfirmRoomType">Confirm</button>
                        <button class="btn-modal-secondary" @onclick="CloseModals">Cancel</button>
                    </div>
                </div>

                <!-- Right Side - Room Type List -->
                <div class="room-list-section">
                    <h3 style="margin-top: 0; font-size: 1.1rem; margin-bottom: 16px;">Room Types</h3>

                    <div class="room-list-table-container">
                        <table class="room-list-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Max Occupancy</th>
                                    <th>Base Price</th>
                                    <th>Status</th>
                                    <th style="text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var roomType in RoomTypes.OrderBy(rt => rt.TypeName))
                                {
                                    <tr>
                                        <td style="font-weight: 600;">@roomType.TypeName</td>
                                        <td>@roomType.MaxOccupancy</td>
                                        <td>@roomType.BasePrice.ToString("C")</td>
                                        <td>
                                            <span class="@(roomType.Status == "Active" ? "badge-active" : "badge-inactive")">
                                                @roomType.Status
                                            </span>
                                        </td>
                                        <td style="text-align: center;">
                                            <div style="display: flex; gap: 8px; justify-content: center;">
                                                <button class="btn-icon-action edit" @onclick="() => EditRoomType(roomType)" title="Edit">
                                                    <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                                </button>
                                                <button class="btn-icon-action archive" @onclick="() => ArchiveRoomType(roomType)" title="Archive">
                                                    <svg viewBox="0 0 24 24"><path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM6.24 5h11.52l.81.97H5.44l.8-.97zM5 19V8h14v11H5zm8.45-9h-2.9v3H8l4 4 4-4h-2.55z"/></svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .room-grid-container {
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .floor-section {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .floor-title {
        margin: 0 0 20px 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        padding: 8px 16px;
        background-color: #e2e8f0;
        border-radius: 8px;
        display: inline-block;
    }

    .room-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 16px;
    }

    .room-status-card {
        background: #10b981;
        border: none;
        border-radius: 12px;
        padding: 24px 16px;
        font-weight: 700;
        font-size: 0.9rem;
        color: black;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .room-status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .room-status-card.available {
            background: #10b981;
        }

        .room-status-card.occupied {
            background: #ef4444;
        }

        .room-status-card.maintenance {
            background: #eab308;
        }

        .room-status-card.cleaning {
            background: #3b82f6;
        }

    .room-label {
        display: block;
        text-align: center;
    }

    .btn-action-secondary {
        background-color: #94a3b8;
        color: white;
        padding: 11px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }

        .btn-action-secondary:hover {
            background-color: #64748b;
        }

    .modal-room-create {
        max-width: 1000px;
        width: 90%;
    }

    .modal-room-edit {
        max-width: 900px;
        width: 90%;
    }

    .modal-room-type {
        max-width: 1250px;
        width: 90%;
    }

    .room-modal-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
    }

    .room-form-section {
        background: #f3f5f7;
        padding: 20px;
        border-radius: 12px;
    }

    .room-list-section {
        display: flex;
        flex-direction: column;
    }

    .room-list-table-container {
        flex: 1;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: auto;
        max-height: 400px;
    }

    .room-list-table {
        width: 100%;
        border-collapse: collapse;
    }

        .room-list-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }

        .room-list-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .room-list-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }

        .room-list-table tbody tr:hover {
            background: #f8fafc;
        }

    .room-action-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
    }

    .btn-modal-primary {
        background: black;
        color: white;
        padding: 14px 24px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
    }

        .btn-modal-primary:hover {
            background: #333;
        }

    .btn-modal-secondary {
        background: #64748b;
        color: white;
        padding: 14px 24px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
    }

        .btn-modal-secondary:hover {
            background: #475569;
        }

    .btn-small {
        background: #3b82f6;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        font-weight: 500;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
    }

        .btn-small:hover {
            background: #2563eb;
        }

        .btn-small.btn-warning {
            background: #ef4444;
        }

            .btn-small.btn-warning:hover {
                background: #dc2626;
            }

    .badge-active {
        background: #10b981;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-inactive {
        background: #ef4444;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background-color: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease-out;
    }

    @@keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>

@code {
    private string CurrentView = "status";
    private bool ShowAddRoomModal = false;
    private bool ShowEditRoomModal = false;
    private bool ShowAddRoomTypeModal = false;

    private List<Room> Rooms = new();
    private List<Floor> Floors = new();
    private List<RoomType> RoomTypes = new();

    private Room NewRoom = new();
    private Room SelectedRoom = new();
    private RoomType NewRoomType = new();
    private RoomType SelectedRoomType = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            if (Context != null)
            {
                RoomTypes = await Context.RoomTypes.AsNoTracking().OrderBy(rt => rt.TypeName).ToListAsync();
                Rooms = await Context.Rooms.AsNoTracking().OrderBy(r => r.Floor).ThenBy(r => r.RoomNumber).ToListAsync();

                Floors = Rooms.Select(r => r.Floor).Distinct().OrderBy(f => f).Select(f => new Floor { FloorNumber = f }).ToList();
                if (!Floors.Any()) Floors = new List<Floor> { new Floor { FloorNumber = 1 }, new Floor { FloorNumber = 2 } };
                return;
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", ex.Message);
        }

        // Fallback sample data
        Floors = new List<Floor> { new Floor { FloorNumber = 1 }, new Floor { FloorNumber = 2 }, new Floor { FloorNumber = 3 } };
        RoomTypes = new List<RoomType>
        {
            new() { RoomTypeID = 1, TypeName = "Standard", MaxOccupancy = 2, BasePrice = 100m, Description = "Standard", Status = "Active" },
            new() { RoomTypeID = 2, TypeName = "Deluxe", MaxOccupancy = 3, BasePrice = 150m, Description = "Deluxe", Status = "Active" }
        };
        Rooms = new List<Room>
        {
            new() { RoomID = 1, RoomNumber = "101", Floor = 1, Status = "Available", RoomTypeID = 1 },
            new() { RoomID = 2, RoomNumber = "102", Floor = 1, Status = "Occupied", RoomTypeID = 2 }
        };
    }

    private string GetRoomStatusClass(string status) => status?.ToLower() switch
    {
        "available" => "available",
        "occupied" => "occupied",
        "maintenance" => "maintenance",
        "cleaning" => "cleaning",
        _ => "available"
    };

    private void ShowRoomStatusView() => CurrentView = "status";
    private void OpenAddRoomModal() { NewRoom = new Room(); ShowAddRoomModal = true; ShowAddRoomTypeModal = false; ShowEditRoomModal = false; }
    private void OpenAddRoomTypeModal() { NewRoomType = new RoomType(); ShowAddRoomTypeModal = true; ShowAddRoomModal = false; ShowEditRoomModal = false; }

    private void OpenEditRoomModal(Room room)
    {
        SelectedRoom = new Room
        {
            RoomID = room.RoomID,
            RoomNumber = room.RoomNumber,
            Floor = room.Floor,
            Status = room.Status,
            RoomTypeID = room.RoomTypeID
        };
        ShowEditRoomModal = true;
        ShowAddRoomModal = false;
        ShowAddRoomTypeModal = false;
    }

    private void CloseModals()
    {
        ShowAddRoomModal = false;
        ShowEditRoomModal = false;
        ShowAddRoomTypeModal = false;
    }

    private async Task AddRoom()
    {
        if (string.IsNullOrWhiteSpace(NewRoom.RoomNumber)) return;

        try
        {
            if (Context != null)
            {
                NewRoom.Status = "Available";
                Context.Rooms.Add(NewRoom);
                await Context.SaveChangesAsync();
                await LoadDataAsync();
                CloseModals();
                return;
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", ex.Message);
        }

        var nextId = Rooms.Any() ? Rooms.Max(r => r.RoomID) + 1 : 1;
        NewRoom.RoomID = nextId;
        NewRoom.Status = "Available";
        Rooms.Add(NewRoom);
        NewRoom = new Room();
        CloseModals();
    }

    private void SelectRoomFromList(Room room)
    {
        NewRoom = new Room { RoomID = room.RoomID, RoomNumber = room.RoomNumber, Floor = room.Floor, Status = room.Status, RoomTypeID = room.RoomTypeID };
    }

    private async Task SaveRoomEdit()
    {
        try
        {
            if (Context != null)
            {
                var existing = await Context.Rooms.FindAsync(SelectedRoom.RoomID);
                if (existing != null)
                {
                    existing.RoomNumber = SelectedRoom.RoomNumber;
                    existing.Floor = SelectedRoom.Floor;
                    existing.Status = SelectedRoom.Status;
                    existing.RoomTypeID = SelectedRoom.RoomTypeID;
                    Context.Rooms.Update(existing);
                    await Context.SaveChangesAsync();
                    await LoadDataAsync();
                }
                CloseModals();
                return;
            }
        }
        catch (Exception ex) { await JSRuntime.InvokeVoidAsync("console.error", ex.Message); }

        var local = Rooms.FirstOrDefault(r => r.RoomID == SelectedRoom.RoomID);
        if (local != null)
        {
            local.RoomNumber = SelectedRoom.RoomNumber;
            local.Floor = SelectedRoom.Floor;
            local.Status = SelectedRoom.Status;
            local.RoomTypeID = SelectedRoom.RoomTypeID;
        }
        CloseModals();
    }

    private async Task ConfirmRoomType()
    {
        if (string.IsNullOrWhiteSpace(NewRoomType.TypeName)) return;
        try
        {
            if (Context != null)
            {
                if (NewRoomType.RoomTypeID == 0)
                {
                    Context.RoomTypes.Add(NewRoomType);
                }
                else
                {
                    var existing = await Context.RoomTypes.FindAsync(NewRoomType.RoomTypeID);
                    if (existing != null)
                    {
                        existing.TypeName = NewRoomType.TypeName;
                        existing.MaxOccupancy = NewRoomType.MaxOccupancy;
                        existing.BasePrice = NewRoomType.BasePrice;
                        existing.Description = NewRoomType.Description;
                        existing.Status = NewRoomType.Status;
                        Context.RoomTypes.Update(existing);
                    }
                }
                await Context.SaveChangesAsync();
                await LoadDataAsync();
                CloseModals();
                return;
            }
        }
        catch (Exception ex) { await JSRuntime.InvokeVoidAsync("console.error", ex.Message); }

        if (NewRoomType.RoomTypeID == 0)
        {
            var nextId = RoomTypes.Any() ? RoomTypes.Max(rt => rt.RoomTypeID) + 1 : 1;
            NewRoomType.RoomTypeID = nextId;
            RoomTypes.Add(NewRoomType);
        }
        else
        {
            var existing = RoomTypes.FirstOrDefault(rt => rt.RoomTypeID == NewRoomType.RoomTypeID);
            if (existing != null)
            {
                existing.TypeName = NewRoomType.TypeName;
                existing.MaxOccupancy = NewRoomType.MaxOccupancy;
                existing.BasePrice = NewRoomType.BasePrice;
                existing.Description = NewRoomType.Description;
                existing.Status = NewRoomType.Status;
            }
        }
        NewRoomType = new RoomType();
        CloseModals();
    }

    private void EditRoomType(RoomType roomType)
    {
        NewRoomType = new RoomType
        {
            RoomTypeID = roomType.RoomTypeID,
            TypeName = roomType.TypeName,
            MaxOccupancy = roomType.MaxOccupancy,
            BasePrice = roomType.BasePrice,
            Description = roomType.Description,
            Status = roomType.Status
        };
        ShowAddRoomTypeModal = true;
        ShowAddRoomModal = false;
        ShowEditRoomModal = false;
    }

    private async Task ArchiveRoomType(RoomType roomType)
    {
        try
        {
            if (Context != null)
            {
                var entity = await Context.RoomTypes.FindAsync(roomType.RoomTypeID);
                if (entity != null)
                {
                    entity.Status = "Inactive";
                    Context.RoomTypes.Update(entity);
                    await Context.SaveChangesAsync();
                    await LoadDataAsync();
                    return;
                }
            }
        }
        catch (Exception ex) { await JSRuntime.InvokeVoidAsync("console.error", ex.Message); }

        roomType.Status = "Inactive";
        StateHasChanged();
    }

    public class Floor
    {
        public int FloorNumber { get; set; }
        public string Status { get; set; } = "Active";
        public string Description { get; set; } = string.Empty;
    }
}