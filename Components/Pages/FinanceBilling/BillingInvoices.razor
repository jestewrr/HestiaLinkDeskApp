@page "/finance/billing-invoices"
@using HestiaLink.Components.Layout
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Billing & Invoices</h1>
        <span class="page-topbar-subtitle">Guest Bills & Tax Management</span>
    </header>

    <section class="page-content">
        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-title">Total Invoices</div>
                <div class="stat-value">@Invoices.Count</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total Revenue</div>
                <div class="stat-value">‚Ç±@TotalRevenue.ToString("N2")</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">VAT Collected</div>
                <div class="stat-value">‚Ç±@TotalVAT.ToString("N2")</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Service Charge</div>
                <div class="stat-value">‚Ç±@TotalServiceCharge.ToString("N2")</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="user-toolbar">
            <div class="toolbar-left">
                <div class="toolbar-search">
                    <input type="text" placeholder="Search by guest or invoice ID..." @bind="SearchText" />
                    <span class="search-icon">üîç</span>
                </div>
                <select class="filter-select" @bind="StatusFilter">
                    <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="Paid">Paid</option>
                    <option value="Overdue">Overdue</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            <button class="btn-create" @onclick="OpenCreateInvoiceModal">Create Invoice</button>
        </div>

        <!-- Invoices Table -->
        <div class="panel-card">
            <div class="panel-body user-list-container">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Invoice ID</th>
                            <th>Guest Name</th>
                            <th>Room</th>
                            <th>Check-In</th>
                            <th>Check-Out</th>
                            <th>Subtotal</th>
                            <th>VAT (12%)</th>
                            <th>Service Charge (10%)</th>
                            <th>Total Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var invoice in FilteredInvoices)
                        {
                            <tr>
                                <td style="font-weight: 700; color: var(--color-teal);">INV-@invoice.Id.ToString("D5")</td>
                                <td>@invoice.GuestName</td>
                                <td>Room @invoice.RoomNumber</td>
                                <td>@invoice.CheckInDate.ToString("MMM dd, yyyy")</td>
                                <td>@invoice.CheckOutDate.ToString("MMM dd, yyyy")</td>
                                <td>‚Ç±@invoice.Subtotal.ToString("N2")</td>
                                <td>‚Ç±@invoice.VAT.ToString("N2")</td>
                                <td>‚Ç±@invoice.ServiceCharge.ToString("N2")</td>
                                <td style="font-weight: 900; color: var(--color-dark-teal);">‚Ç±@invoice.TotalAmount.ToString("N2")</td>
                                <td>
                                    <span class="status-badge status-@invoice.Status.ToLower()">@invoice.Status</span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 8px; justify-content: center;">
                                        <button class="btn-icon btn-icon-edit" title="View Details" @onclick="() => ViewInvoiceDetails(invoice)">üëÅ</button>
                                        <button class="btn-icon btn-icon-edit" title="Print" @onclick="() => PrintInvoice(invoice)">üñ®</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<!-- Create Invoice Modal -->
@if (ShowCreateModal)
{
    <div class="modal-overlay" @onclick="CloseModals">
        <div class="modal-content" style="max-width: 700px;" @onclick:stopPropagation="true">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">Create New Invoice</h2>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label">Guest Name</label>
                    <input type="text" class="form-input" @bind="NewInvoice.GuestName" placeholder="Enter guest name" />
                </div>
                <div class="form-group">
                    <label class="form-label">Room Number</label>
                    <input type="text" class="form-input" @bind="NewInvoice.RoomNumber" placeholder="e.g., 101" />
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label">Check-In Date</label>
                    <input type="date" class="form-input" @bind="NewInvoice.CheckInDate" />
                </div>
                <div class="form-group">
                    <label class="form-label">Check-Out Date</label>
                    <input type="date" class="form-input" @bind="NewInvoice.CheckOutDate" />
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Room Rate per Night</label>
                <input type="number" class="form-input" @bind="NewInvoice.RoomRate" placeholder="0.00" />
            </div>

            <!-- Bill Computation Preview -->
            <div style="background-color: var(--color-cream); padding: 20px; border-radius: 12px; border: 2px solid var(--color-light-gray); margin-bottom: 20px;">
                <h3 style="margin-top:0; color: var(--color-dark-teal); font-size:1.1rem; font-weight: 900;">Bill Computation</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600;">Number of Nights:</span>
                    <span style="font-weight: 700;">@CalculateNights() night(s)</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600;">Room Charges:</span>
                    <span style="font-weight: 700;">‚Ç±@(NewInvoice.RoomRate * CalculateNights()).ToString("N2")</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600;">Additional Charges:</span>
                    <span style="font-weight: 700;">‚Ç±@NewInvoice.AdditionalCharges.ToString("N2")</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-top: 8px; border-top: 1px solid var(--color-light-gray);">
                    <span style="font-weight: 700;">Subtotal:</span>
                    <span style="font-weight: 900; color: var(--color-teal);">‚Ç±@CalculateSubtotal().ToString("N2")</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--color-dark-teal);">
                    <span style="font-weight: 600;">VAT (12%):</span>
                    <span style="font-weight: 700;">‚Ç±@CalculateVAT().ToString("N2")</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; color: var(--color-dark-teal);">
                    <span style="font-weight: 600;">Service Charge (10%):</span>
                    <span style="font-weight: 700;">‚Ç±@CalculateServiceCharge().ToString("N2")</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 2px solid var(--color-dark-teal);">
                    <span style="font-weight: 900; font-size: 1.2rem; color: var(--color-dark-teal);">Total Amount:</span>
                    <span style="font-weight: 900; font-size: 1.3rem; color: var(--color-teal);">‚Ç±@CalculateTotal().ToString("N2")</span>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Additional Charges (Optional)</label>
                <input type="number" class="form-input" @bind="NewInvoice.AdditionalCharges" placeholder="Extra services, minibar, etc." />
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn-primary" style="flex: 1;" @onclick="SaveInvoice">Create Invoice</button>
                <button class="btn-secondary" style="flex: 1;" @onclick="CloseModals">Cancel</button>
            </div>
        </div>
    </div>
}

<!-- Invoice Details Modal -->
@if (ShowDetailsModal && SelectedInvoice != null)
{
    <div class="modal-overlay" @onclick="CloseModals">
        <div class="modal-content" style="max-width: 600px;" @onclick:stopPropagation="true">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">Invoice Details - INV-@SelectedInvoice.Id.ToString("D5")</h2>
            </div>

            <div style="background: var(--color-cream); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <div style="font-weight: 600; color: var(--color-dark-teal); margin-bottom: 4px;">Guest Name:</div>
                        <div style="font-weight: 700;">@SelectedInvoice.GuestName</div>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: var(--color-dark-teal); margin-bottom: 4px;">Room Number:</div>
                        <div style="font-weight: 700;">Room @SelectedInvoice.RoomNumber</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <div style="font-weight: 600; color: var(--color-dark-teal); margin-bottom: 4px;">Check-In:</div>
                        <div style="font-weight: 700;">@SelectedInvoice.CheckInDate.ToString("MMM dd, yyyy")</div>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: var(--color-dark-teal); margin-bottom: 4px;">Check-Out:</div>
                        <div style="font-weight: 700;">@SelectedInvoice.CheckOutDate.ToString("MMM dd, yyyy")</div>
                    </div>
                </div>
            </div>

            <div style="background: var(--color-white); padding: 20px; border-radius: 8px; border: 1px solid var(--color-light-gray);">
                <h3 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900;">Billing Summary</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Subtotal:</span>
                    <span style="font-weight: 700;">‚Ç±@SelectedInvoice.Subtotal.ToString("N2")</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>VAT (12%):</span>
                    <span style="font-weight: 700;">‚Ç±@SelectedInvoice.VAT.ToString("N2")</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--color-light-gray);">
                    <span>Service Charge (10%):</span>
                    <span style="font-weight: 700;">‚Ç±@SelectedInvoice.ServiceCharge.ToString("N2")</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 1.2rem;">
                    <span style="font-weight: 900; color: var(--color-dark-teal);">Total Amount:</span>
                    <span style="font-weight: 900; color: var(--color-teal);">‚Ç±@SelectedInvoice.TotalAmount.ToString("N2")</span>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn-primary" style="flex: 1;" @onclick="() => PrintInvoice(SelectedInvoice)">Print Invoice</button>
                <button class="btn-secondary" style="flex: 1;" @onclick="CloseModals">Close</button>
            </div>
        </div>
    </div>
}

<style>
    .stat-card {
        background: var(--color-white);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
    }

    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
    }

    .status-paid {
        background-color: #d1fae5;
        color: #065f46;
    }

    .status-overdue {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .status-cancelled {
        background-color: var(--color-light-gray);
        color: var(--color-dark-teal);
    }
</style>

@code {
    private List<Invoice> Invoices = new List<Invoice>();
    private Invoice NewInvoice = new Invoice();
    private Invoice? SelectedInvoice = null;
    private string SearchText = "";
    private string StatusFilter = "";
    private bool ShowCreateModal = false;
    private bool ShowDetailsModal = false;

    private decimal TotalRevenue => Invoices.Where(i => i.Status == "Paid").Sum(i => i.TotalAmount);
    private decimal TotalVAT => Invoices.Where(i => i.Status == "Paid").Sum(i => i.VAT);
    private decimal TotalServiceCharge => Invoices.Where(i => i.Status == "Paid").Sum(i => i.ServiceCharge);

    private List<Invoice> FilteredInvoices => Invoices
        .Where(i => (string.IsNullOrEmpty(SearchText) || 
                    i.GuestName.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                    i.Id.ToString().Contains(SearchText)) &&
                    (string.IsNullOrEmpty(StatusFilter) || i.Status == StatusFilter))
        .OrderByDescending(i => i.Id)
        .ToList();

    protected override void OnInitialized()
    {
        // Sample data
        Invoices.Add(new Invoice 
        { 
            Id = 1, 
            GuestName = "John Doe", 
            RoomNumber = "101",
            CheckInDate = DateTime.Now.AddDays(-3),
            CheckOutDate = DateTime.Now,
            Subtotal = 9000,
            Status = "Paid"
        });
        Invoices.Add(new Invoice 
        { 
            Id = 2, 
            GuestName = "Jane Smith", 
            RoomNumber = "205",
            CheckInDate = DateTime.Now.AddDays(-2),
            CheckOutDate = DateTime.Now.AddDays(1),
            Subtotal = 12000,
            Status = "Pending"
        });

        foreach (var invoice in Invoices)
        {
            invoice.VAT = invoice.Subtotal * 0.12m;
            invoice.ServiceCharge = invoice.Subtotal * 0.10m;
            invoice.TotalAmount = invoice.Subtotal + invoice.VAT + invoice.ServiceCharge;
        }
    }

    private void OpenCreateInvoiceModal()
    {
        NewInvoice = new Invoice 
        { 
            CheckInDate = DateTime.Now,
            CheckOutDate = DateTime.Now.AddDays(1),
            RoomRate = 2500,
            AdditionalCharges = 0
        };
        ShowCreateModal = true;
    }

    private void ViewInvoiceDetails(Invoice invoice)
    {
        SelectedInvoice = invoice;
        ShowDetailsModal = true;
    }

    private void CloseModals()
    {
        ShowCreateModal = false;
        ShowDetailsModal = false;
    }

    private int CalculateNights()
    {
        var nights = (NewInvoice.CheckOutDate - NewInvoice.CheckInDate).Days;
        return nights > 0 ? nights : 1;
    }

    private decimal CalculateSubtotal()
    {
        return (NewInvoice.RoomRate * CalculateNights()) + NewInvoice.AdditionalCharges;
    }

    private decimal CalculateVAT()
    {
        return CalculateSubtotal() * 0.12m;
    }

    private decimal CalculateServiceCharge()
    {
        return CalculateSubtotal() * 0.10m;
    }

    private decimal CalculateTotal()
    {
        return CalculateSubtotal() + CalculateVAT() + CalculateServiceCharge();
    }

    private void SaveInvoice()
    {
        NewInvoice.Id = Invoices.Count + 1;
        NewInvoice.Subtotal = CalculateSubtotal();
        NewInvoice.VAT = CalculateVAT();
        NewInvoice.ServiceCharge = CalculateServiceCharge();
        NewInvoice.TotalAmount = CalculateTotal();
        NewInvoice.Status = "Pending";
        
        Invoices.Add(NewInvoice);
        CloseModals();
    }

    private void PrintInvoice(Invoice invoice)
    {
        // Print logic here
    }

    public class Invoice
    {
        public int Id { get; set; }
        public string GuestName { get; set; } = "";
        public string RoomNumber { get; set; } = "";
        public DateTime CheckInDate { get; set; }
        public DateTime CheckOutDate { get; set; }
        public decimal RoomRate { get; set; }
        public decimal AdditionalCharges { get; set; }
        public decimal Subtotal { get; set; }
        public decimal VAT { get; set; }
        public decimal ServiceCharge { get; set; }
        public decimal TotalAmount { get; set; }
        public string Status { get; set; } = "Pending";
    }
}
