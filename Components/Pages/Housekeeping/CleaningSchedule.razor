@page "/housekeeping/cleaning-schedule"
@using HestiaLink.Data
@using HestiaLink.Models
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext DbContext
@inject NavigationManager Navigation

<div class="page-wrapper">
    <div class="page-topbar">
        <div>
            <h1>Cleaning Schedule</h1>
            <div class="page-topbar-subtitle">Assign and track room cleaning tasks</div>
        </div>
        <div class="page-topbar-date">@DateTime.Now.ToString("MMMM dd, yyyy")</div>
    </div>

    <div class="page-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 100%;">
            
            <!-- Left Column: Rooms Needing Cleaning -->
            <div class="card-modern" style="display: flex; flex-direction: column;">
                <h3 style="margin-bottom: 15px; color: var(--color-dark-teal);">Needs Cleaning (Dirty)</h3>
                
                @if (DirtyRooms == null)
                {
                    <p>Loading...</p>
                }
                else if (!DirtyRooms.Any())
                {
                    <div style="text-align: center; padding: 20px; color: #64748b;">
                        <p>No rooms currently marked as Dirty.</p>
                    </div>
                }
                else
                {
                    <div style="overflow-y: auto; flex: 1;">
                        @foreach (var room in DirtyRooms)
                        {
                            <div class="list-item-card" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e2e8f0;">
                                <div>
                                    <div style="font-weight: bold; font-size: 1.1rem;">Room @room.RoomNumber</div>
                                    <div style="font-size: 0.9rem; color: #64748b;">@room.RoomType?.TypeName - Floor @room.Floor</div>
                                </div>
                                <button class="btn-primary" style="padding: 8px 16px;" @onclick="() => OpenAssignModal(room)">
                                    Assign
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Right Column: Active Cleaning Tasks -->
            <div class="card-modern" style="display: flex; flex-direction: column;">
                <h3 style="margin-bottom: 15px; color: var(--color-dark-teal);">Active Tasks</h3>

                @if (ActiveTasks == null)
                {
                    <p>Loading...</p>
                }
                else if (!ActiveTasks.Any())
                {
                    <div style="text-align: center; padding: 20px; color: #64748b;">
                        <p>No active cleaning tasks.</p>
                    </div>
                }
                else
                {
                    <div style="overflow-y: auto; flex: 1;">
                        @foreach (var task in ActiveTasks)
                        {
                            <div class="list-item-card" style="padding: 15px; border-bottom: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-weight: bold;">Room @task.Room?.RoomNumber</span>
                                    <span class="status-badge status-pending">@task.Status</span>
                                </div>
                                <div style="font-size: 0.9rem; margin-bottom: 5px;">
                                    Assigned to: <strong>@(task.AssignedUser?.Username ?? "Unassigned")</strong>
                                </div>
                                <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 10px;">
                                    @task.Description <br/>
                                    Created: @task.CreatedDate.ToString("g")
                                </div>
                                <div style="text-align: right;">
                                    <button class="btn-secondary" style="font-size: 0.8rem;" @onclick="() => MarkTaskComplete(task)">
                                        Mark Completed
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Assign Modal -->
@if (ShowAssignModal)
{
    <div class="modal-overlay" @onclick="CloseAssignModal">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h2>Assign Cleaning Task</h2>
            </div>
            <div class="login-form">
                <p style="margin-bottom: 15px;">Assigning cleaning for <strong>Room @SelectedRoom?.RoomNumber</strong></p>

                <div class="input-group-modern">
                    <label class="input-label">Assign To (Staff)</label>
                    <select class="form-select" @bind="NewTask.UserID">
                        <option value="">Select Staff...</option>
                        @foreach (var user in StaffUsers)
                        {
                            <option value="@user.UserID">@user.Username</option>
                        }
                    </select>
                </div>

                <div class="input-group-modern">
                    <label class="input-label">Notes</label>
                    <textarea class="form-input" @bind="NewTask.Description" rows="3"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" @onclick="SaveAssignment">Assign Task</button>
                    <button class="btn-secondary" @onclick="CloseAssignModal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Room> DirtyRooms = new();
    private List<HestiaLink.Models.CleaningTask> ActiveTasks = new();
    private List<SystemUser> StaffUsers = new();
    
    private bool ShowAssignModal = false;
    private Room? SelectedRoom;
    private HestiaLink.Models.CleaningTask NewTask = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        // Load Dirty Rooms that don't have an active task? 
        // Or just all Dirty rooms. Let's load all Dirty rooms.
        DirtyRooms = await DbContext.Rooms
            .Include(r => r.RoomType)
            .Where(r => r.Status == "Dirty")
            .OrderBy(r => r.RoomNumber)
            .ToListAsync();

        // Load Active Tasks (Pending or In Progress)
        ActiveTasks = await DbContext.CleaningTasks
            .Include(t => t.Room)
            .Include(t => t.AssignedUser)
            .Where(t => t.Status != "Completed")
            .OrderByDescending(t => t.CreatedDate)
            .ToListAsync();

        // Load Staff (Users) - In a real app filter by Role
        StaffUsers = await DbContext.SystemUsers
            .Where(u => u.Status == "Active") 
            .ToListAsync();
    }

    private void OpenAssignModal(Room room)
    {
        SelectedRoom = room;
        NewTask = new HestiaLink.Models.CleaningTask 
        { 
            RoomID = room.RoomID,
            Description = "Standard Cleaning",
            Status = "Pending",
            CreatedDate = DateTime.Now
        };
        ShowAssignModal = true;
    }

    private void CloseAssignModal()
    {
        ShowAssignModal = false;
        SelectedRoom = null;
    }

    private async Task SaveAssignment()
    {
        if (SelectedRoom == null) return;

        DbContext.CleaningTasks.Add(NewTask);
        await DbContext.SaveChangesAsync();
        
        await LoadData();
        CloseAssignModal();
    }

    private async Task MarkTaskComplete(HestiaLink.Models.CleaningTask task)
    {
        // Update Task
        task.Status = "Completed";
        task.CompletedDate = DateTime.Now;
        DbContext.CleaningTasks.Update(task);

        // Update Room Status to Available
        var room = await DbContext.Rooms.FindAsync(task.RoomID);
        if (room != null)
        {
            room.Status = "Available";
            DbContext.Rooms.Update(room);
        }

        await DbContext.SaveChangesAsync();
        await LoadData();
    }
}
