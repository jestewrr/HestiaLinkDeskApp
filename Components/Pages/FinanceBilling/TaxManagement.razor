@page "/finance/tax-management"
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Tax Management</h1>
        <span class="page-topbar-subtitle">Philippine Tax System Compliance</span>
    </header>

    <section class="page-content">
        <!-- Tax Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-title">Total VAT Collected</div>
                <div class="stat-value">₱@TotalVATCollected.ToString("N2")</div>
                <div style="font-size: 0.85rem; color: var(--color-dark-teal); margin-top: 4px;">12% of Guest Bills</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Service Charge Pool</div>
                <div class="stat-value">₱@TotalServiceChargeCollected.ToString("N2")</div>
                <div style="font-size: 0.85rem; color: var(--color-dark-teal); margin-top: 4px;">10% for Distribution</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Income Tax Deductions</div>
                <div class="stat-value">₱@TotalIncomeTaxDeducted.ToString("N2")</div>
                <div style="font-size: 0.85rem; color: var(--color-dark-teal); margin-top: 4px;">From Employee Payroll</div>
            </div>
        </div>

        <!-- Tax Breakdown Tabs -->
        <div style="display: flex; gap: 12px; margin-bottom: 24px;">
            <button class="@(ActiveTab == "guest" ? "btn-create" : "btn-outlined")" @onclick='() => ActiveTab = "guest"'>
                Guest Tax (VAT & SC)
            </button>
            <button class="@(ActiveTab == "employee" ? "btn-create" : "btn-outlined")" @onclick='() => ActiveTab = "employee"'>
                Employee Income Tax
            </button>
            <button class="@(ActiveTab == "distribution" ? "btn-create" : "btn-outlined")" @onclick='() => ActiveTab = "distribution"'>
                Service Charge Distribution
            </button>
        </div>

        <!-- Guest Tax Tab -->
        @if (ActiveTab == "guest")
        {
            <div class="panel-card" style="margin-bottom: 30px;">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Guest Bill Tax Breakdown (VAT 12% + Service Charge 10%)
                </div>
                <div class="panel-body">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Invoice ID</th>
                                <th>Guest Name</th>
                                <th>Bill Date</th>
                                <th>Subtotal</th>
                                <th>VAT (12%)</th>
                                <th>Service Charge (10%)</th>
                                <th>Total Tax</th>
                                <th>Grand Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var bill in GuestBills)
                            {
                                <tr>
                                    <td style="font-weight: 700; color: var(--color-teal);">INV-@bill.Id.ToString("D5")</td>
                                    <td>@bill.GuestName</td>
                                    <td>@bill.BillDate.ToString("MMM dd, yyyy")</td>
                                    <td>₱@bill.Subtotal.ToString("N2")</td>
                                    <td style="color: var(--color-teal);">₱@bill.VAT.ToString("N2")</td>
                                    <td style="color: var(--color-teal);">₱@bill.ServiceCharge.ToString("N2")</td>
                                    <td style="font-weight: 700;">₱@(bill.VAT + bill.ServiceCharge).ToString("N2")</td>
                                    <td style="font-weight: 900; color: var(--color-dark-teal);">₱@bill.GrandTotal.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    
                    <div style="background: var(--color-cream); padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900;">Tax Computation Logic</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <div style="font-weight: 700; margin-bottom: 8px;">VAT Calculation:</div>
                                <div style="font-family: monospace; background: var(--color-white); padding: 12px; border-radius: 6px;">
                                    VAT = Subtotal × 0.12
                                </div>
                            </div>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 8px;">Service Charge Calculation:</div>
                                <div style="font-family: monospace; background: var(--color-white); padding: 12px; border-radius: 6px;">
                                    SC = Subtotal × 0.10
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 12px; background: var(--color-white); border-radius: 6px; font-weight: 700;">
                            Grand Total = Subtotal + VAT + Service Charge
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Employee Income Tax Tab -->
        @if (ActiveTab == "employee")
        {
            <div class="panel-card" style="margin-bottom: 30px;">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Employee Income Tax (2025 Graduated Tax Table)
                </div>
                <div class="panel-body">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Position</th>
                                <th>Monthly Salary</th>
                                <th>Annual Income</th>
                                <th>Tax Bracket</th>
                                <th>Monthly Tax</th>
                                <th>Tax Rate</th>
                                <th>SC Eligible</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var emp in EmployeeTaxRecords)
                            {
                                <tr>
                                    <td style="font-weight: 700;">@emp.Name</td>
                                    <td>@emp.Position</td>
                                    <td>₱@emp.MonthlySalary.ToString("N2")</td>
                                    <td style="color: var(--color-teal);">₱@emp.AnnualIncome.ToString("N2")</td>
                                    <td style="font-weight: 700;">@emp.TaxBracket</td>
                                    <td style="font-weight: 900; color: var(--color-dark-teal);">₱@emp.MonthlyTax.ToString("N2")</td>
                                    <td>@emp.EffectiveTaxRate%</td>
                                    <td>
                                        @if (emp.ServiceChargeEligible)
                                        {
                                            <span style="color: #047857; font-weight: 700;">✓ YES</span>
                                        }
                                        else
                                        {
                                            <span style="color: #991b1b; font-weight: 700;">✗ NO</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div style="background: var(--color-cream); padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900;">2025 Philippine Income Tax Table</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--color-dark-teal); color: var(--color-white);">
                                    <th style="padding: 12px; text-align: left; font-weight: 900;">Annual Taxable Income</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 900;">Tax Rate</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 900;">Tax Computation</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: var(--color-white);">
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray);">₱250,000 and below</td>
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray); font-weight: 700;">0%</td>
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray); font-family: monospace;">₱0</td>
                                </tr>
                                <tr style="background: var(--color-cream);">
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray);">Over ₱250,000 to ₱400,000</td>
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray); font-weight: 700;">15%</td>
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray); font-family: monospace;">₱0 + 15% of excess over ₱250,000</td>
                                </tr>
                                <tr style="background: var(--color-white);">
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray);">Over ₱400,000 to ₱800,000</td>
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray); font-weight: 700;">20%</td>
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray); font-family: monospace;">₱22,500 + 20% of excess over ₱400,000</td>
                                </tr>
                                <tr style="background: var(--color-cream);">
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray);">Over ₱800,000 to ₱2,000,000</td>
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray); font-weight: 700;">25%</td>
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray); font-family: monospace;">₱102,500 + 25% of excess over ₱800,000</td>
                                </tr>
                                <tr style="background: var(--color-white);">
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray);">Over ₱2,000,000</td>
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray); font-weight: 700;">30%</td>
                                    <td style="padding: 10px; border: 1px solid var(--color-light-gray); font-family: monospace;">₱402,500 + 30% of excess over ₱2,000,000</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Service Charge Distribution Tab -->
        @if (ActiveTab == "distribution")
        {
            <div class="panel-card">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Service Charge Distribution (Rank-and-File Only)
                </div>
                <div class="panel-body">
                    <div style="background: var(--color-cream); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                            <div>
                                <div style="font-weight: 600; color: var(--color-dark-teal); margin-bottom: 4px;">Total SC Pool</div>
                                <div style="font-size: 1.8rem; font-weight: 900; color: var(--color-teal);">₱@TotalServiceChargeCollected.ToString("N2")</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--color-dark-teal); margin-bottom: 4px;">Eligible Employees</div>
                                <div style="font-size: 1.8rem; font-weight: 900; color: var(--color-teal);">@EligibleEmployeesCount</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--color-dark-teal); margin-bottom: 4px;">Per Employee Share</div>
                                <div style="font-size: 1.8rem; font-weight: 900; color: var(--color-teal);">₱@PerEmployeeShare.ToString("N2")</div>
                            </div>
                        </div>
                    </div>

                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Employee Name</th>
                                <th>Position</th>
                                <th>Role Type</th>
                                <th>Basic Salary</th>
                                <th>SC Share</th>
                                <th>Total Earnings</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var emp in ServiceChargeDistribution)
                            {
                                <tr>
                                    <td style="font-weight: 700;">@emp.Name</td>
                                    <td>@emp.Position</td>
                                    <td>
                                        <span class="status-badge" style="background: @(emp.IsRankAndFile ? "#d1fae5" : "#fee2e2"); color: @(emp.IsRankAndFile ? "#065f46" : "#991b1b");">
                                            @(emp.IsRankAndFile ? "Rank & File" : "Managerial")
                                        </span>
                                    </td>
                                    <td>₱@emp.BasicSalary.ToString("N2")</td>
                                    <td style="font-weight: 900; color: var(--color-teal);">
                                        @if (emp.IsRankAndFile)
                                        {
                                            <span>₱@emp.ServiceChargeShare.ToString("N2")</span>
                                        }
                                        else
                                        {
                                            <span style="color: #991b1b;">Not Eligible</span>
                                        }
                                    </td>
                                    <td style="font-weight: 900; color: var(--color-dark-teal);">₱@emp.TotalEarnings.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div style="background: var(--color-cream); padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin-top: 0; color: var(--color-dark-teal); font-weight: 900;">Service Charge Distribution Rules</h4>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Eligible Employees:</strong> Rank-and-File staff only (Room Attendants, Housekeepers, Front Desk Staff, etc.)</li>
                            <li><strong>Excluded Employees:</strong> Managerial and supervisory positions are not eligible per Philippine Labor Law</li>
                            <li><strong>Distribution Method:</strong> Equal share among all eligible employees</li>
                            <li><strong>Payment Frequency:</strong> Distributed monthly along with regular salary</li>
                            <li><strong>Taxable Income:</strong> Service charge share is added to taxable income for BIR reporting</li>
                        </ul>
                    </div>
                </div>
            </div>
        }
    </section>
</div>

@code {
    private string ActiveTab = "guest";
    private List<GuestBill> GuestBills = new List<GuestBill>();
    private List<EmployeeTaxRecord> EmployeeTaxRecords = new List<EmployeeTaxRecord>();
    private List<ServiceChargeEmployee> ServiceChargeDistribution = new List<ServiceChargeEmployee>();

    private decimal TotalVATCollected => GuestBills.Sum(b => b.VAT);
    private decimal TotalServiceChargeCollected => GuestBills.Sum(b => b.ServiceCharge);
    private decimal TotalIncomeTaxDeducted => EmployeeTaxRecords.Sum(e => e.MonthlyTax);
    private int EligibleEmployeesCount => ServiceChargeDistribution.Count(e => e.IsRankAndFile);
    private decimal PerEmployeeShare => EligibleEmployeesCount > 0 ? TotalServiceChargeCollected / EligibleEmployeesCount : 0;

    protected override void OnInitialized()
    {
        // Sample Guest Bills
        GuestBills.Add(new GuestBill { Id = 1, GuestName = "John Doe", BillDate = DateTime.Now.AddDays(-2), Subtotal = 9000 });
        GuestBills.Add(new GuestBill { Id = 2, GuestName = "Jane Smith", BillDate = DateTime.Now.AddDays(-1), Subtotal = 12000 });
        GuestBills.Add(new GuestBill { Id = 3, GuestName = "Bob Johnson", BillDate = DateTime.Now, Subtotal = 7500 });

        foreach (var bill in GuestBills)
        {
            bill.VAT = bill.Subtotal * 0.12m;
            bill.ServiceCharge = bill.Subtotal * 0.10m;
            bill.GrandTotal = bill.Subtotal + bill.VAT + bill.ServiceCharge;
        }

        // Sample Employee Tax Records
        EmployeeTaxRecords.Add(new EmployeeTaxRecord 
        { 
            Name = "Maria Santos", 
            Position = "Room Attendant", 
            MonthlySalary = 18000,
            ServiceChargeEligible = true
        });
        EmployeeTaxRecords.Add(new EmployeeTaxRecord 
        { 
            Name = "Pedro Cruz", 
            Position = "Front Desk Staff", 
            MonthlySalary = 20000,
            ServiceChargeEligible = true
        });
        EmployeeTaxRecords.Add(new EmployeeTaxRecord 
        { 
            Name = "Ana Reyes", 
            Position = "Front Desk Manager", 
            MonthlySalary = 45000,
            ServiceChargeEligible = false
        });

        foreach (var emp in EmployeeTaxRecords)
        {
            emp.AnnualIncome = emp.MonthlySalary * 13; // Including 13th month
            emp.MonthlyTax = CalculateMonthlyIncomeTax(emp.AnnualIncome);
            emp.TaxBracket = GetTaxBracket(emp.AnnualIncome);
            emp.EffectiveTaxRate = emp.AnnualIncome > 0 ? Math.Round((emp.MonthlyTax * 12 / emp.AnnualIncome) * 100, 2) : 0;
        }

        // Service Charge Distribution
        ServiceChargeDistribution.Add(new ServiceChargeEmployee 
        { 
            Name = "Maria Santos", 
            Position = "Room Attendant", 
            BasicSalary = 18000, 
            IsRankAndFile = true 
        });
        ServiceChargeDistribution.Add(new ServiceChargeEmployee 
        { 
            Name = "Pedro Cruz", 
            Position = "Front Desk Staff", 
            BasicSalary = 20000, 
            IsRankAndFile = true 
        });
        ServiceChargeDistribution.Add(new ServiceChargeEmployee 
        { 
            Name = "Ana Reyes", 
            Position = "Front Desk Manager", 
            BasicSalary = 45000, 
            IsRankAndFile = false 
        });

        foreach (var emp in ServiceChargeDistribution)
        {
            emp.ServiceChargeShare = emp.IsRankAndFile ? PerEmployeeShare : 0;
            emp.TotalEarnings = emp.BasicSalary + emp.ServiceChargeShare;
        }
    }

    private decimal CalculateMonthlyIncomeTax(decimal annualIncome)
    {
        decimal annualTax = 0;

        if (annualIncome <= 250000)
        {
            annualTax = 0;
        }
        else if (annualIncome <= 400000)
        {
            annualTax = (annualIncome - 250000) * 0.15m;
        }
        else if (annualIncome <= 800000)
        {
            annualTax = 22500 + (annualIncome - 400000) * 0.20m;
        }
        else if (annualIncome <= 2000000)
        {
            annualTax = 102500 + (annualIncome - 800000) * 0.25m;
        }
        else
        {
            annualTax = 402500 + (annualIncome - 2000000) * 0.30m;
        }

        return annualTax / 12;
    }

    private string GetTaxBracket(decimal annualIncome)
    {
        if (annualIncome <= 250000) return "₱0 - ₱250K (0%)";
        if (annualIncome <= 400000) return "₱250K - ₱400K (15%)";
        if (annualIncome <= 800000) return "₱400K - ₱800K (20%)";
        if (annualIncome <= 2000000) return "₱800K - ₱2M (25%)";
        return "Over ₱2M (30%)";
    }

    public class GuestBill
    {
        public int Id { get; set; }
        public string GuestName { get; set; } = "";
        public DateTime BillDate { get; set; }
        public decimal Subtotal { get; set; }
        public decimal VAT { get; set; }
        public decimal ServiceCharge { get; set; }
        public decimal GrandTotal { get; set; }
    }

    public class EmployeeTaxRecord
    {
        public string Name { get; set; } = "";
        public string Position { get; set; } = "";
        public decimal MonthlySalary { get; set; }
        public decimal AnnualIncome { get; set; }
        public decimal MonthlyTax { get; set; }
        public string TaxBracket { get; set; } = "";
        public decimal EffectiveTaxRate { get; set; }
        public bool ServiceChargeEligible { get; set; }
    }

    public class ServiceChargeEmployee
    {
        public string Name { get; set; } = "";
        public string Position { get; set; } = "";
        public decimal BasicSalary { get; set; }
        public bool IsRankAndFile { get; set; }
        public decimal ServiceChargeShare { get; set; }
        public decimal TotalEarnings { get; set; }
    }
}
