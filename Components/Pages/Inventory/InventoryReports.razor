@page "/inventory/reports"
@using Microsoft.EntityFrameworkCore
@using System.Globalization
@inject IJSRuntime JSRuntime
@inject HestiaLinkContext DbContext
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Inventory Reports</h1>
        <span class="page-topbar-subtitle">Consumption Analytics & Stock Movement</span>
    </header>

    @* ===== DATE FILTER ===== *@
    <div class="report-filters">
        <div class="filter-group">
            <label>From:</label>
            <input type="date" @bind="StartDate" class="date-input" />
        </div>
        <div class="filter-group">
            <label>To:</label>
            <input type="date" @bind="EndDate" class="date-input" />
        </div>
        <div class="filter-group">
            <label>Category:</label>
            <select @bind="FilterCategory" class="filter-select">
                <option value="">All Categories</option>
                @foreach (var category in Categories)
                {
                    <option value="@category">@category</option>
                }
            </select>
        </div>
        <button class="btn-primary" @onclick="LoadReportData">Generate Report</button>
    </div>

    @if (!IsLoaded)
    {
        <div class="loading">Loading report data...</div>
    }
    else if (HasError)
    {
        <div class="error-message">
            <h4>?? Error</h4>
            <p>@ErrorMessage</p>
            <button class="btn-primary" @onclick="RetryLoad">Retry</button>
        </div>
    }
    else
    {
        @* ===== SUMMARY CARDS ===== *@
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-label">TOTAL CONSUMPTION</div>
                <div class="summary-value">@TotalConsumptionCount items</div>
            </div>

            <div class="summary-card">
                <div class="summary-label">TOTAL COST</div>
                <div class="summary-value">?@TotalConsumptionCost.ToString("N2")</div>
            </div>

            <div class="summary-card">
                <div class="summary-label">SERVICES USED</div>
                <div class="summary-value">@UniqueServicesCount</div>
            </div>

            <div class="summary-card">
                <div class="summary-label">ROOMS SERVED</div>
                <div class="summary-value">@UniqueRoomsCount</div>
            </div>
        </div>

        <div class="reports-grid">
            @* ===== TOP CONSUMED ITEMS ===== *@
            <div class="report-card">
                <div class="report-header">
                    <h3>?? Top Consumed Items</h3>
                </div>
                <div class="report-body">
                    @if (TopConsumedItems.Any())
                    {
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Total Qty</th>
                                    <th>Total Cost</th>
                                    <th>Usage</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in TopConsumedItems.Take(10))
                                {
                                    var maxQty = TopConsumedItems.Max(i => i.TotalQuantity);
                                    <tr>
                                        <td>
                                            <span class="item-code">@item.ItemCode</span>
                                            <span style="font-weight:600;">@item.ItemName</span>
                                        </td>
                                        <td>@item.TotalQuantity.ToString("N2") @item.Unit</td>
                                        <td>?@item.TotalCost.ToString("N2")</td>
                                        <td>
                                            <div class="usage-bar">
                                                <div class="usage-fill" style="width: @((item.TotalQuantity / (maxQty > 0 ? maxQty : 1m) * 100).ToString("F0"))%"></div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="no-data">No consumption data for selected period</div>
                    }
                </div>
            </div>

            @* ===== CONSUMPTION BY SERVICE ===== *@
            <div class="report-card">
                <div class="report-header">
                    <h3>?? Consumption by Service</h3>
                </div>
                <div class="report-body">
                    @if (ConsumptionByService.Any())
                    {
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Transactions</th>
                                    <th>Items Consumed</th>
                                    <th>Total Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var service in ConsumptionByService.Take(10))
                                {
                                    <tr>
                                        <td style="font-weight:600;">@service.ServiceName</td>
                                        <td>@service.TransactionCount</td>
                                        <td>@service.ItemsConsumed</td>
                                        <td>?@service.TotalCost.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="no-data">No service consumption data</div>
                    }
                </div>
            </div>

            @* ===== DAILY CONSUMPTION TREND ===== *@
            <div class="report-card full-width">
                <div class="report-header">
                    <h3>?? Daily Consumption Trend</h3>
                </div>
                <div class="report-body">
                    @if (DailyConsumption.Any())
                    {
                        <div class="trend-chart">
                            @{ var maxDailyCost = DailyConsumption.Max(d => d.TotalCost); }
                            @foreach (var day in DailyConsumption)
                            {
                                <div class="trend-bar-container">
                                    <div class="trend-bar" style="height: @((day.TotalCost / (maxDailyCost > 0 ? maxDailyCost : 1m) * 100).ToString("F0"))%">
                                        <span class="trend-value">?@day.TotalCost.ToString("N0")</span>
                                    </div>
                                    <span class="trend-label">@day.Date.ToString("MMM dd")</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="no-data">No daily trend data available</div>
                    }
                </div>
            </div>

            @* ===== CONSUMPTION LOG ===== *@
            <div class="report-card full-width">
                <div class="report-header">
                    <h3>?? Consumption Log</h3>
                    <span class="record-count">@ConsumptionLog.Count records</span>
                </div>
                <div class="report-body" style="max-height: 400px; overflow-y: auto;">
                    @if (ConsumptionLog.Any())
                    {
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Item</th>
                                    <th>Qty</th>
                                    <th>Unit Cost</th>
                                    <th>Service</th>
                                    <th>Room</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var log in ConsumptionLog)
                                {
                                    <tr>
                                        <td>@log.ConsumptionDate.ToString("MMM dd, HH:mm")</td>
                                        <td style="font-weight:600;">@(log.InventoryItem?.ItemName ?? "N/A")</td>
                                        <td>@log.QuantityConsumed @(log.InventoryItem?.UnitOfMeasure ?? "")</td>
                                        <td>?@((log.InventoryItem?.UnitCost ?? 0).ToString("N2"))</td>
                                        <td>@(log.ServiceTransaction?.Service?.ServiceName ?? "-")</td>
                                        <td>@(log.RoomNumber ?? "-")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="no-data">No consumption records for selected period</div>
                    }
                </div>
            </div>

            @* ===== STOCK LEVELS ===== *@
            <div class="report-card">
                <div class="report-header">
                    <h3>?? Current Stock Levels</h3>
                </div>
                <div class="report-body">
                    @if (StockLevels.Any())
                    {
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Stock</th>
                                    <th>Reorder</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in StockLevels)
                                {
                                    var currentStock = item.CurrentStock ?? 0;
                                    var reorderPoint = item.ReorderPoint ?? 0;
                                    <tr>
                                        <td style="font-weight:600;">@item.ItemName</td>
                                        <td>@currentStock @item.UnitOfMeasure</td>
                                        <td>@reorderPoint</td>
                                        <td>
                                            @if (currentStock == 0)
                                            {
                                                <span class="status-out">Out of Stock</span>
                                            }
                                            else if (currentStock <= reorderPoint)
                                            {
                                                <span class="status-low">Low</span>
                                            }
                                            else
                                            {
                                                <span class="status-ok">OK</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="no-data">No inventory items</div>
                    }
                </div>
            </div>

            @* ===== CATEGORY BREAKDOWN ===== *@
            <div class="report-card">
                <div class="report-header">
                    <h3>?? Consumption by Category</h3>
                </div>
                <div class="report-body">
                    @if (CategoryConsumption.Any())
                    {
                        <div class="category-breakdown">
                            @{ var totalCategoryCost = CategoryConsumption.Sum(c => c.TotalCost); }
                            @foreach (var cat in CategoryConsumption)
                            {
                                var percentage = totalCategoryCost > 0 ? (cat.TotalCost / totalCategoryCost * 100) : 0;
                                <div class="category-row">
                                    <div class="category-info">
                                        <span class="category-name">@cat.Category</span>
                                        <span class="category-percentage">@percentage.ToString("F1")%</span>
                                    </div>
                                    <div class="category-bar">
                                        <div class="category-fill" style="width: @percentage.ToString("F0")%"></div>
                                    </div>
                                    <span class="category-cost">?@cat.TotalCost.ToString("N0")</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="no-data">No category data</div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    // State
    private DateTime StartDate = DateTime.Today.AddMonths(-1);
    private DateTime EndDate = DateTime.Today;
    private string FilterCategory = "";
    private bool IsLoaded = false;
    private bool HasError = false;
    private string ErrorMessage = string.Empty;

    // Summary
    private int TotalConsumptionCount = 0;
    private decimal TotalConsumptionCost = 0;
    private int UniqueServicesCount = 0;
    private int UniqueRoomsCount = 0;

    // Data
    private List<string> Categories = new();
    private List<ConsumedItemSummary> TopConsumedItems = new();
    private List<ServiceConsumptionSummary> ConsumptionByService = new();
    private List<DailyConsumptionSummary> DailyConsumption = new();
    private List<InventoryConsumption> ConsumptionLog = new();
    private List<InventoryItem> StockLevels = new();
    private List<CategoryConsumptionSummary> CategoryConsumption = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadReportData();
    }

    private async Task LoadReportData()
    {
        try
        {
            IsLoaded = false;
            HasError = false;
            ErrorMessage = string.Empty;
            StateHasChanged();

            var endDateAdjusted = EndDate.AddDays(1);

            // Get categories
            Categories = await DbContext.InventoryItems
                .Where(i => i.IsActive == true)
                .Select(i => i.Category)
                .Distinct()
                .OrderBy(c => c)
                .ToListAsync();

            // Get consumption data
            var consumptionQuery = DbContext.InventoryConsumptions
                .Include(c => c.InventoryItem)
                .Include(c => c.ServiceTransaction)
                    .ThenInclude(st => st!.Service)
                .Where(c => c.ConsumptionDate >= StartDate && c.ConsumptionDate < endDateAdjusted);

            if (!string.IsNullOrEmpty(FilterCategory))
            {
                consumptionQuery = consumptionQuery.Where(c => c.InventoryItem != null && c.InventoryItem.Category == FilterCategory);
            }

            var consumptions = await consumptionQuery.ToListAsync();

            // Summary - use InventoryItem.UnitCost instead of UnitCostAtTime
            TotalConsumptionCount = consumptions.Count;
            TotalConsumptionCost = consumptions.Sum(c => (c.InventoryItem?.UnitCost ?? 0) * c.QuantityConsumed);
            UniqueServicesCount = consumptions.Select(c => c.ServiceTransaction?.ServiceID).Distinct().Count();
            UniqueRoomsCount = consumptions.Where(c => !string.IsNullOrEmpty(c.RoomNumber)).Select(c => c.RoomNumber).Distinct().Count();

            // Top consumed items
            TopConsumedItems = consumptions
                .Where(c => c.InventoryItem != null)
                .GroupBy(c => c.InventoryItemID)
                .Select(g => new ConsumedItemSummary
                {
                    ItemCode = g.First().InventoryItem!.ItemCode,
                    ItemName = g.First().InventoryItem!.ItemName,
                    Unit = g.First().InventoryItem!.UnitOfMeasure,
                    TotalQuantity = g.Sum(c => c.QuantityConsumed),
                    TotalCost = g.Sum(c => (g.First().InventoryItem?.UnitCost ?? 0) * c.QuantityConsumed)
                })
                .OrderByDescending(i => i.TotalQuantity)
                .ToList();

            // Consumption by service
            ConsumptionByService = consumptions
                .Where(c => c.ServiceTransaction?.Service != null)
                .GroupBy(c => c.ServiceTransaction!.ServiceID)
                .Select(g => new ServiceConsumptionSummary
                {
                    ServiceName = g.First().ServiceTransaction!.Service!.ServiceName,
                    TransactionCount = g.Select(c => c.ServiceTransactionID).Distinct().Count(),
                    ItemsConsumed = g.Count(),
                    TotalCost = g.Sum(c => (c.InventoryItem?.UnitCost ?? 0) * c.QuantityConsumed)
                })
                .OrderByDescending(s => s.TotalCost)
                .ToList();

            // Daily consumption trend
            DailyConsumption = consumptions
                .GroupBy(c => c.ConsumptionDate.Date)
                .Select(g => new DailyConsumptionSummary
                {
                    Date = g.Key,
                    ItemCount = g.Count(),
                    TotalCost = g.Sum(c => (c.InventoryItem?.UnitCost ?? 0) * c.QuantityConsumed)
                })
                .OrderBy(d => d.Date)
                .TakeLast(14)
                .ToList();

            // Consumption log
            ConsumptionLog = consumptions
                .OrderByDescending(c => c.ConsumptionDate)
                .Take(100)
                .ToList();

            // Stock levels
            var stockQuery = DbContext.InventoryItems.Where(i => i.IsActive == true);
            if (!string.IsNullOrEmpty(FilterCategory))
            {
                stockQuery = stockQuery.Where(i => i.Category == FilterCategory);
            }
            StockLevels = await stockQuery
                .OrderBy(i => (i.CurrentStock ?? 0) - (i.ReorderPoint ?? 0))
                .Take(15)
                .ToListAsync();

            // Category consumption
            CategoryConsumption = consumptions
                .Where(c => c.InventoryItem != null)
                .GroupBy(c => c.InventoryItem!.Category)
                .Select(g => new CategoryConsumptionSummary
                {
                    Category = g.Key,
                    ItemCount = g.Count(),
                    TotalCost = g.Sum(c => (c.InventoryItem?.UnitCost ?? 0) * c.QuantityConsumed)
                })
                .OrderByDescending(c => c.TotalCost)
                .ToList();

            IsLoaded = true;
        }
        catch (Exception ex)
        {
            HasError = true;
            ErrorMessage = ex.Message;
            IsLoaded = true;
        }
    }

    private async Task RetryLoad()
    {
        await LoadReportData();
    }

    // Helper classes
    private class ConsumedItemSummary
    {
        public string ItemCode { get; set; } = "";
        public string ItemName { get; set; } = "";
        public string Unit { get; set; } = "";
        public decimal TotalQuantity { get; set; }
        public decimal TotalCost { get; set; }
    }

    private class ServiceConsumptionSummary
    {
        public string ServiceName { get; set; } = "";
        public int TransactionCount { get; set; }
        public int ItemsConsumed { get; set; }
        public decimal TotalCost { get; set; }
    }

    private class DailyConsumptionSummary
    {
        public DateTime Date { get; set; }
        public int ItemCount { get; set; }
        public decimal TotalCost { get; set; }
    }

    private class CategoryConsumptionSummary
    {
        public string Category { get; set; } = "";
        public int ItemCount { get; set; }
        public decimal TotalCost { get; set; }
    }
}

<style>
    /* Filters */
    .report-filters {
        display: flex;
        align-items: flex-end;
        gap: 16px;
        margin-bottom: 24px;
        background: #ffffff;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .filter-group label {
        font-size: 0.8rem;
        font-weight: 700;
        color: #6b7280;
        text-transform: uppercase;
    }

    .date-input,
    .filter-select {
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        font-size: 0.95rem;
    }

    .btn-primary {
        background: #0f766e;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }

    /* Summary Cards */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 24px;
    }

    .summary-card {
        background: #ffffff;
        padding: 18px 22px;
        border-radius: 14px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.04);
        border-left: 6px solid #0f766e;
    }

    .summary-label {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: .5px;
        font-weight: 700;
    }

    .summary-value {
        font-size: 1.4rem;
        font-weight: 800;
        margin-top: 6px;
        color: #065f46;
    }

    /* Reports Grid */
    .reports-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    /* Report Card */
    .report-card {
        background: #ffffff;
        border-radius: 14px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.04);
        overflow: hidden;
    }

    .report-card.full-width {
        grid-column: span 2;
    }

    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 20px;
        background: linear-gradient(90deg, #064e49, #0f766e);
        color: white;
    }

    .report-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
    }

    .record-count {
        font-size: 0.8rem;
        opacity: 0.85;
    }

    .report-body {
        padding: 16px 20px;
    }

    /* Report Table */
    .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .report-table th,
    .report-table td {
        padding: 10px 8px;
        text-align: left;
        border-bottom: 1px solid #f1f5f9;
    }

    .report-table th {
        font-size: 0.7rem;
        font-weight: 700;
        color: #9ca3af;
        text-transform: uppercase;
    }

    .item-code {
        font-family: monospace;
        color: #9ca3af;
        font-size: 0.75rem;
        display: block;
    }

    /* Usage Bar */
    .usage-bar {
        width: 80px;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
    }

    .usage-fill {
        height: 100%;
        background: linear-gradient(90deg, #0f766e, #14b8a6);
        border-radius: 4px;
    }

    /* Trend Chart */
    .trend-chart {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        height: 200px;
        padding: 20px 0;
    }

    .trend-bar-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
    }

    .trend-bar {
        width: 100%;
        max-width: 40px;
        background: linear-gradient(180deg, #0f766e, #14b8a6);
        border-radius: 4px 4px 0 0;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        margin-top: auto;
        position: relative;
    }

    .trend-value {
        position: absolute;
        top: -20px;
        font-size: 0.7rem;
        font-weight: 700;
        color: #0f766e;
        white-space: nowrap;
    }

    .trend-label {
        font-size: 0.7rem;
        color: #6b7280;
        margin-top: 8px;
    }

    /* Status badges */
    .status-ok {
        background: #d1fae5;
        color: #065f46;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .status-low {
        background: #fef9c3;
        color: #92400e;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .status-out {
        background: #fee2e2;
        color: #991b1b;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    /* Category breakdown */
    .category-breakdown {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .category-row {
        display: grid;
        grid-template-columns: 100px 1fr 80px;
        align-items: center;
        gap: 12px;
    }

    .category-info {
        display: flex;
        flex-direction: column;
    }

    .category-name {
        font-weight: 700;
        color: #0f172a;
        font-size: 0.85rem;
    }

    .category-percentage {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .category-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
    }

    .category-fill {
        height: 100%;
        background: linear-gradient(90deg, #0f766e, #14b8a6);
        border-radius: 4px;
    }

    .category-cost {
        font-weight: 700;
        color: #065f46;
        font-size: 0.9rem;
        text-align: right;
    }

    /* Other */
    .no-data {
        padding: 30px;
        text-align: center;
        color: #9ca3af;
    }

    .loading {
        padding: 40px;
        text-align: center;
        color: #0f766e;
        font-weight: 600;
    }

    .error-message {
        background: #fef2f2;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        color: #991b1b;
    }

    @@media (max-width: 1200px) {
        .summary-cards {
            grid-template-columns: repeat(2, 1fr);
        }
        .reports-grid {
            grid-template-columns: 1fr;
        }
        .report-card.full-width {
            grid-column: span 1;
        }
    }
</style>
