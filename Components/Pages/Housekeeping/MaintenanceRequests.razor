@page "/housekeeping/maintenance-requests"
@using HestiaLink.Data
@using HestiaLink.Models
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext DbContext
@inject NavigationManager Navigation

<div class="page-wrapper">
    <div class="page-topbar">
        <div>
            <h1>Maintenance Requests</h1>
            <div class="page-topbar-subtitle">Track and resolve maintenance issues</div>
        </div>
        <div class="page-topbar-date">@DateTime.Now.ToString("MMMM dd, yyyy")</div>
    </div>

    <div class="page-content">
        <!-- Actions -->
        <div class="user-toolbar">
            <div class="toolbar-left">
                <div class="toolbar-search">
                    <input type="text" placeholder="Search Requests..." @bind="SearchTerm" @bind:event="oninput" />
                    <span class="search-icon">🔍</span>
                </div>
                <select class="form-select" @bind="FilterStatus" style="width: 200px;">
                    <option value="">All Statuses</option>
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>
            <button class="btn-add-new" @onclick="OpenCreateModal">
                <span>+ New Request</span>
            </button>
        </div>

        <!-- Requests Table -->
        <div class="booking-history-main" style="padding: 0; overflow: hidden;">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Room</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Reported Date</th>
                        <th>Resolved Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (FilteredRequests == null)
                    {
                        <tr><td colspan="7" style="text-align:center; padding: 20px;">Loading...</td></tr>
                    }
                    else if (!FilteredRequests.Any())
                    {
                        <tr><td colspan="7" style="text-align:center; padding: 20px;">No maintenance requests found.</td></tr>
                    }
                    else
                    {
                        @foreach (var req in FilteredRequests)
                        {
                            <tr>
                                <td>#@req.RequestID</td>
                                <td style="font-weight: 700; color: var(--color-dark-teal);">@req.Room?.RoomNumber</td>
                                <td>@req.Description</td>
                                <td>
                                    <span class="status-badge @GetStatusBadgeClass(req.Status)">@req.Status</span>
                                </td>
                                <td>@req.ReportedDate.ToString("MMM dd, yyyy")</td>
                                <td>@(req.ResolvedDate?.ToString("MMM dd, yyyy") ?? "-")</td>
                                <td>
                                    <div style="display: flex; gap: 8px;">
                                        @if (req.Status != "Completed")
                                        {
                                            <button class="btn-icon-action edit" title="Mark Complete" @onclick="() => MarkComplete(req)">
                                                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                            </button>
                                        }
                                        <button class="btn-icon-action archive" title="Delete" @onclick="() => DeleteRequest(req)">
                                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Modal -->
@if (ShowCreateModal)
{
    <div class="modal-overlay" @onclick="CloseCreateModal">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h2>New Maintenance Request</h2>
            </div>
            <div class="login-form">
                <div class="input-group-modern">
                    <label class="input-label">Room</label>
                    <select class="form-select" @bind="NewRequest.RoomID">
                        <option value="0">Select Room...</option>
                        @foreach (var room in Rooms)
                        {
                            <option value="@room.RoomID">@room.RoomNumber</option>
                        }
                    </select>
                </div>
                <div class="input-group-modern">
                    <label class="input-label">Description</label>
                    <textarea class="form-input" @bind="NewRequest.Description" rows="4" placeholder="Describe the issue..."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" @onclick="SaveRequest">Submit Request</button>
                    <button class="btn-secondary" @onclick="CloseCreateModal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<MaintenanceRequest> Requests = new();
    private List<Room> Rooms = new();
    private string SearchTerm = "";
    private string FilterStatus = "";
    private bool ShowCreateModal = false;
    private MaintenanceRequest NewRequest = new();

    private IEnumerable<MaintenanceRequest> FilteredRequests => Requests
        .Where(r => string.IsNullOrEmpty(SearchTerm) || 
                    r.Description.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) || 
                    (r.Room?.RoomNumber.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
        .Where(r => string.IsNullOrEmpty(FilterStatus) || r.Status == FilterStatus)
        .OrderByDescending(r => r.ReportedDate);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        Requests =   await DbContext.MaintenanceRequests.Include(r => r.Room).ToListAsync();
        Rooms = await DbContext.Rooms.OrderBy(r => r.RoomNumber).ToListAsync();
    }

    private void OpenCreateModal()
    {
        NewRequest = new MaintenanceRequest { ReportedDate = DateTime.Now, Status = "Pending" };
        ShowCreateModal = true;
    }

    private void CloseCreateModal()
    {
        ShowCreateModal = false;
    }

    private async Task SaveRequest()
    {
        if (NewRequest.RoomID == 0 || string.IsNullOrWhiteSpace(NewRequest.Description)) return;

        DbContext.MaintenanceRequests.Add(NewRequest);
        
        // Also update room status to Maintenance?
        var room = Rooms.FirstOrDefault(r => r.RoomID == NewRequest.RoomID);
        if (room != null)
        {
            room.Status = "Maintenance";
            DbContext.Rooms.Update(room);
        }

        await DbContext.SaveChangesAsync();
        await LoadData();
        CloseCreateModal();
    }

    private async Task MarkComplete(MaintenanceRequest req)
    {
        req.Status = "Completed";
        req.ResolvedDate = DateTime.Now;
        DbContext.MaintenanceRequests.Update(req);

        // Ask user if they want to mark room as Available? 
        // For simplicity, let's assume if maintenance is done, room is Dirty (needs cleaning) or Available.
        // Let's set it to Dirty so housekeeping checks it.
        var room = await DbContext.Rooms.FindAsync(req.RoomID);
        if (room != null && room.Status == "Maintenance")
        {
            room.Status = "Dirty"; // Needs cleaning after maintenance
            DbContext.Rooms.Update(room);
        }

        await DbContext.SaveChangesAsync();
        await LoadData();
    }

    private async Task DeleteRequest(MaintenanceRequest req)
    {
        DbContext.MaintenanceRequests.Remove(req);
        await DbContext.SaveChangesAsync();
        await LoadData();
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "status-cancelled", // Red-ish
            "In Progress" => "status-checked-in", // Blue
            "Completed" => "status-confirmed", // Green
            _ => ""
        };
    }
}
