@page "/finance/payment-processing"
@layout MainLayout
@using HestiaLink.Data
@using HestiaLink.Models
@using Microsoft.EntityFrameworkCore
@inject HestiaLinkContext _context
@inject NavigationManager NavigationManager

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Payment Processing</h1>
        <span class="page-topbar-subtitle">Guest Payment Management</span>
    </header>

    <section class="page-content">
        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-title">Today's Payments</div>
                <div class="stat-value">₱@TodayPayments.ToString("N2")</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Pending Payments</div>
                <div class="stat-value">@PendingCount</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total Collected</div>
                <div class="stat-value">₱@TotalCollected.ToString("N2")</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Outstanding</div>
                <div class="stat-value" style="color: #991b1b;">₱@OutstandingBalance.ToString("N2")</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="user-toolbar">
            <div class="toolbar-left">
                <div class="toolbar-search">
                    <input type="text" placeholder="Search by guest or invoice..." @bind="SearchText" />
                    <span class="search-icon">🔍</span>
                </div>
                <select class="filter-select" @bind="PaymentStatusFilter">
                    <option value="">All Status</option>
                    <option value="Paid">Paid</option>
                    <option value="Partial">Partial</option>
                    <option value="Pending">Pending</option>
                    <option value="Refunded">Refunded</option>
                </select>
                <select class="filter-select" @bind="PaymentMethodFilter">
                    <option value="">All Methods</option>
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="GCash">GCash</option>
                    <option value="Maya">Maya</option>
                </select>
            </div>
            <button class="btn-create" @onclick="OpenProcessPaymentModal">Process Payment</button>
        </div>

        <!-- Payments Table -->
        <div class="panel-card">
            <div class="panel-body user-list-container">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Payment Date</th>
                            <th>Invoice ID</th>
                            <th>Guest Name</th>
                            <th>Room</th>
                            <th>Total Bill</th>
                            <th>Amount Paid</th>
                            <th>Balance</th>
                            <th>Payment Method</th>
                            <th>Reference No.</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var payment in FilteredPayments)
                        {
                            <tr>
                                <td>@payment.PaymentDate.ToString("MMM dd, yyyy HH:mm")</td>
                                <td style="font-weight: 700; color: var(--color-teal);">INV-@payment.InvoiceId.ToString("D5")</td>
                                <td style="font-weight: 700;">@payment.GuestName</td>
                                <td>@payment.RoomNumber</td>
                                <td>₱@payment.TotalBill.ToString("N2")</td>
                                <td style="font-weight: 900; color: var(--color-teal);">₱@payment.AmountPaid.ToString("N2")</td>
                                <td style="font-weight: 700; color: @(payment.Balance > 0 ? "#991b1b" : "#065f46");">₱@payment.Balance.ToString("N2")</td>
                                <td>
                                    <span class="status-badge" style="background: var(--color-light-gray); color: var(--color-dark-teal);">
                                        @payment.PaymentMethod
                                    </span>
                                </td>
                                <td style="font-family: monospace; font-size: 0.85rem;">@payment.ReferenceNumber</td>
                                <td>
                                    <span class="status-badge status-@payment.Status.ToLower()">@payment.Status</span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 8px; justify-content: center;">
                                        <button class="btn-icon-action edit" title="View Receipt" @onclick="() => ViewReceipt(payment)">
                                            <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                                        </button>
                                        <button class="btn-icon-action edit" title="Print" @onclick="() => PrintReceipt(payment)">
                                            <svg viewBox="0 0 24 24"><path d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v5H8v-5h8zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z"/><circle cx="18" cy="11.5" r="1"/></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payment Method Breakdown -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px;">
            <div class="panel-card">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Cash Payments
                </div>
                <div class="panel-body" style="text-align: center; padding: 30px;">
                    <div style="font-size: 2rem; font-weight: 900; color: var(--color-teal);">₱@CashPayments.ToString("N2")</div>
                    <div style="font-size: 0.9rem; color: var(--color-dark-teal); margin-top: 8px;">@CashPaymentCount transactions</div>
                </div>
            </div>

            <div class="panel-card">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Card Payments
                </div>
                <div class="panel-body" style="text-align: center; padding: 30px;">
                    <div style="font-size: 2rem; font-weight: 900; color: var(--color-teal);">₱@CardPayments.ToString("N2")</div>
                    <div style="font-size: 0.9rem; color: var(--color-dark-teal); margin-top: 8px;">@CardPaymentCount transactions</div>
                </div>
            </div>

            <div class="panel-card">
                <div style="background: var(--color-dark-teal); color: var(--color-white); padding: 16px 24px; font-weight: 900; border-radius: 12px 12px 0 0;">
                    Digital Wallets
                </div>
                <div class="panel-body" style="text-align: center; padding: 30px;">
                    <div style="font-size: 2rem; font-weight: 900; color: var(--color-teal);">₱@DigitalPayments.ToString("N2")</div>
                    <div style="font-size: 0.9rem; color: var(--color-dark-teal); margin-top: 8px;">@DigitalPaymentCount transactions</div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Process Payment Modal -->
@if (ShowProcessModal)
{
    <div class="modal-overlay" @onclick="CloseModals">
        <div class="modal-content" style="max-width: 600px;" @onclick:stopPropagation="true">
            <div class="modal-header-teal">
                <h2 style="margin:0; font-size:1.4rem;">Process Payment</h2>
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
                <label class="form-label">Invoice ID</label>
                <div style="display:flex; gap: 8px;">
                    <input type="number" class="form-input" @bind="NewPayment.InvoiceId" placeholder="Enter Invoice ID to fetch" />
                    <button class="btn-primary" style="padding: 8px 16px;" @onclick="FetchBillDetails">Fetch</button>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
                 <label class="form-label">Guest Name</label>
                 <input type="text" class="form-input" @bind="NewPayment.GuestName" readonly style="background-color: #f3f4f6;" />
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group">
                    <label class="form-label">Room Number</label>
                    <input type="text" class="form-input" @bind="NewPayment.RoomNumber" readonly style="background-color: #f3f4f6;" />
                </div>
                <div class="form-group">
                    <label class="form-label">Current Balance</label>
                     <!-- Display ONLY the unpaid balance, not full bill, to avoid confusion -->
                    <input type="text" class="form-input" value="₱@CurrentBillBalance.ToString("N2")" readonly style="background-color: #f3f4f6; font-weight: bold; color: #991b1b;" />
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
                <label class="form-label">Amount Paying</label>
                <input type="number" class="form-input" @bind="NewPayment.AmountPaid" placeholder="0.00" />
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
                <label class="form-label">Payment Method</label>
                <select class="form-select" @bind="NewPayment.PaymentMethod">
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="GCash">GCash</option>
                    <option value="Maya">Maya</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Reference Number (Optional)</label>
                <input type="text" class="form-input" @bind="NewPayment.ReferenceNumber" placeholder="Transaction reference" />
            </div>

            <div style="background: var(--color-cream); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600;">Balance After Payment:</span>
                    <span style="font-weight: 900; color: var(--color-teal); font-size: 1.2rem;">₱@(CurrentBillBalance - NewPayment.AmountPaid).ToString("N2")</span>
                </div>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn-primary" style="flex: 1;" @onclick="ProcessPayment">Process Payment</button>
                <button class="btn-secondary" style="flex: 1;" @onclick="CloseModals">Cancel</button>
            </div>
        </div>
    </div>
}

<style>
    .status-paid { background-color: #d1fae5; color: #065f46; }
    .status-partial { background-color: #fef3c7; color: #92400e; }
    .status-pending { background-color: #fee2e2; color: #991b1b; }
    .status-refunded { background-color: var(--color-light-gray); color: var(--color-dark-teal); }
</style>

@code {
    public class PaymentViewModel
    {
        public int PaymentId { get; set; } // DB ID
        public DateTime PaymentDate { get; set; }
        public int InvoiceId { get; set; }
        public string GuestName { get; set; } = "";
        public string RoomNumber { get; set; } = "";
        public decimal TotalBill { get; set; }
        public decimal AmountPaid { get; set; }
        public decimal Balance { get; set; } // Bill Balance, not just payment balance
        public string PaymentMethod { get; set; } = "Cash";
        public string ReferenceNumber { get; set; } = "";
        public string Status { get; set; } = "Pending";
    }

    private List<PaymentViewModel> Payments = new List<PaymentViewModel>();
    private PaymentViewModel NewPayment = new PaymentViewModel();
    private string SearchText = "";
    private string PaymentStatusFilter = "";
    private string PaymentMethodFilter = "";
    private bool ShowProcessModal = false;
    private decimal CurrentBillBalance = 0; // Helper for modal

    private decimal TodayPayments => Payments.Where(p => p.PaymentDate.Date == DateTime.Now.Date).Sum(p => p.AmountPaid);
    private int PendingCount => Payments.Count(p => p.Status == "Pending" || p.Status == "Partial"); // Logic adjustment
    private decimal TotalCollected => Payments.Sum(p => p.AmountPaid);
    
    // Outstanding is tricky, it's really the sum of Balances of UNIQUE bills, not payments. 
    // But for simple view, let's sum remaining balances of latest payments? 
    // Better: We should probably fetch Bills separately for the "Outstanding" card. 
    // For now, I'll stick to a simple sum but aware it might double count if multiple payments exist for same bill.
    // Fixed: OutstandingBalance should query Bills directly ideally. 
    // Let's approximate: Distinct Invoices sum of balances.
    private decimal OutstandingBalance => Payments.Select(p => new { p.InvoiceId, p.Balance }).Distinct().Sum(x => x.Balance);

    // Breakdowns
    private decimal CashPayments => Payments.Where(p => p.PaymentMethod == "Cash").Sum(p => p.AmountPaid);
    private int CashPaymentCount => Payments.Count(p => p.PaymentMethod == "Cash");
    
    private decimal CardPayments => Payments.Where(p => p.PaymentMethod == "Credit Card" || p.PaymentMethod == "Debit Card").Sum(p => p.AmountPaid);
    private int CardPaymentCount => Payments.Count(p => p.PaymentMethod == "Credit Card" || p.PaymentMethod == "Debit Card");
    
    private decimal DigitalPayments => Payments.Where(p => p.PaymentMethod == "GCash" || p.PaymentMethod == "Maya").Sum(p => p.AmountPaid);
    private int DigitalPaymentCount => Payments.Count(p => p.PaymentMethod == "GCash" || p.PaymentMethod == "Maya");

    private List<PaymentViewModel> FilteredPayments => Payments
        .Where(p => (string.IsNullOrEmpty(SearchText) || 
                    p.GuestName.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                    p.InvoiceId.ToString().Contains(SearchText)) &&
                    (string.IsNullOrEmpty(PaymentStatusFilter) || p.Status == PaymentStatusFilter) &&
                    (string.IsNullOrEmpty(PaymentMethodFilter) || p.PaymentMethod == PaymentMethodFilter))
        .OrderByDescending(p => p.PaymentDate)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadPayments();
    }

    private async Task LoadPayments()
    {
        try 
        {
            var payments = await _context.Payments
                .Include(p => p.Bill)
                .ThenInclude(b => b.Reservation)
                .ThenInclude(r => r.Guest)
                .Include(p => p.Bill)
                .ThenInclude(b => b.Reservation)
                .ThenInclude(r => r.ReservedRooms)
                .ThenInclude(rr => rr.Room)
                .ToListAsync();

            Payments = payments.Select(p => new PaymentViewModel
            {
                PaymentId = p.PaymentId,
                PaymentDate = p.PaymentDate ?? DateTime.Now,
                InvoiceId = p.BillId ?? 0,
                GuestName = p.Bill?.Reservation?.Guest != null ? $"{p.Bill.Reservation.Guest.FirstName} {p.Bill.Reservation.Guest.LastName}" : "Unknown",
                RoomNumber = p.Bill?.Reservation?.ReservedRooms.FirstOrDefault()?.Room?.RoomNumber ?? "N/A",
                TotalBill = p.Bill?.GrandTotal ?? 0,
                AmountPaid = p.Amount ?? 0,
                Balance = (p.Bill?.GrandTotal ?? 0) - (p.Bill?.AmountPaid ?? 0), // Calc real balance from Bill
                PaymentMethod = p.PaymentMethod ?? "Cash",
                ReferenceNumber = p.ReferenceNumber ?? "",
                Status = p.PaymentStatus ?? "Completed"
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading payments: {ex.Message}");
        }
    }

    private void OpenProcessPaymentModal()
    {
        NewPayment = new PaymentViewModel { PaymentDate = DateTime.Now, PaymentMethod = "Cash" };
        CurrentBillBalance = 0;
        ShowProcessModal = true;
    }

    private async Task FetchBillDetails()
    {
        if (NewPayment.InvoiceId == 0) return;

        var bill = await _context.Bills
            .Include(b => b.Reservation)
            .ThenInclude(r => r.Guest)
            .Include(b => b.Reservation)
            .ThenInclude(r => r.ReservedRooms)
            .ThenInclude(rr => rr.Room)
            .FirstOrDefaultAsync(b => b.BillId == NewPayment.InvoiceId);

        if (bill != null)
        {
            NewPayment.GuestName = bill.Reservation?.Guest != null ? $"{bill.Reservation.Guest.FirstName} {bill.Reservation.Guest.LastName}" : "Unknown";
            NewPayment.RoomNumber = bill.Reservation?.ReservedRooms.FirstOrDefault()?.Room?.RoomNumber ?? "N/A";
            NewPayment.TotalBill = bill.GrandTotal ?? 0;
            
            // Calculate what has been paid so far
            decimal alreadyPaid = await _context.Payments.Where(p => p.BillId == bill.BillId).SumAsync(p => p.Amount ?? 0);
            CurrentBillBalance = (bill.GrandTotal ?? 0) - alreadyPaid;
            
            // Default amount to pay = balance
            NewPayment.AmountPaid = CurrentBillBalance;
        }
    }

    private async Task ProcessPayment()
    {
        if (NewPayment.InvoiceId == 0 || NewPayment.AmountPaid <= 0) return;

        using var transaction = _context.Database.BeginTransaction();
        try
        {
            // 1. Record Payment
            var dbPayment = new HestiaLink.Models.Payment
            {
                BillId = NewPayment.InvoiceId,
                Amount = NewPayment.AmountPaid,
                PaymentDate = DateTime.Now,
                PaymentMethod = NewPayment.PaymentMethod,
                ReferenceNumber = NewPayment.ReferenceNumber,
                PaymentStatus = "Completed"
            };
            _context.Payments.Add(dbPayment);
            await _context.SaveChangesAsync();

            // 2. Update Bill Balance/Status
            var bill = await _context.Bills.FindAsync(NewPayment.InvoiceId);
            if (bill != null)
            {
                var existingPaid = bill.AmountPaid ?? 0;
                bill.AmountPaid = existingPaid + NewPayment.AmountPaid;

                // Simple check: if Paid >= GrandTotal, mark as Paid
                if (bill.AmountPaid >= bill.GrandTotal)
                {
                    bill.BillStatus = "Paid";
                    bill.BalanceDue = 0;
                }
                else
                {
                    bill.BillStatus = "Partial";
                    bill.BalanceDue = bill.GrandTotal - bill.AmountPaid;
                }
                _context.Bills.Update(bill);
                await _context.SaveChangesAsync();
            }

            await transaction.CommitAsync();
            await LoadPayments();
            CloseModals();
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync();
            Console.WriteLine($"Error processing payment: {ex.Message}");
        }
    }

    private void ViewReceipt(PaymentViewModel payment)
    {
        // View receipt logic
    }

    private void PrintReceipt(PaymentViewModel payment)
    {
        // Print receipt logic
    }

    private void CloseModals()
    {
        ShowProcessModal = false;
    }
}
