@page "/reservations/booking-history"
@using HestiaLink.Data
@using HestiaLink.Models
@using Microsoft.EntityFrameworkCore
@using System.Data
@inject NavigationManager Navigation
@inject HestiaLinkContext DbContext
@layout MainLayout

<div class="page-wrapper">
    <header class="page-topbar">
        <h1>Booking History</h1>
        <span class="page-topbar-date">@DateTime.Now.ToString("dddd, MMMM dd, yyyy")</span>
    </header>

    <section class="page-content">
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-row">
                <!-- Date Filters - Left side -->
                <div class="left-filters">
                    <div class="date-input-group">
                        <label>From:</label>
                        <input type="date" class="date-input" value="@StartDateString" @onchange="HandleStartDateChanged" />
                    </div>
                    <span class="date-separator">to</span>
                    <div class="date-input-group">
                        <label>To:</label>
                        <input type="date" class="date-input" value="@EndDateString" @onchange="HandleEndDateChanged" />
                    </div>
                </div>

                <!-- Middle - Status Filters -->
                <div class="middle-filters">
                    <select class="filter-select" @bind="SelectedStatus" @bind:event="onchange">
                        <option value="">All Status</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Checked In">Checked In</option>
                        <option value="Checked Out">Checked Out</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>

                    <select class="filter-select" @bind="SelectedPaymentStatus" @bind:event="onchange">
                        <option value="">All Payments</option>
                        <option value="Paid">Paid</option>
                        <option value="Pending">Pending</option>
                        <option value="Partial">Partial</option>
                    </select>
                </div>

                <!-- Right - Search Bar -->
                <div class="right-filters">
                    <div class="search-box">
                        <span class="search-icon">🔍</span>
                        <input type="text" placeholder="Search by guest name or booking ID..."
                               @bind="SearchText"
                               @bind:event="oninput" />
                    </div>
                </div>
            </div>
        </div>

        <div class="panel-card">
            <div class="panel-body">
                @if (IsLoading)
                {
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>Loading booking history...</p>
                    </div>
                }
                else if (!Bookings.Any())
                {
                    <div class="empty-state">
                        <div class="empty-icon">📋</div>
                        <p>No bookings found</p>
                        <small>Try adjusting your search or date filters</small>
                    </div>
                }
                else
                {
                    <div class="booking-table-wrapper">
                        <table class="booking-table">
                            <thead>
                                <tr>
                                    <th>BOOKING ID</th>
                                    <th>GUEST NAME</th>
                                    <th>ROOM</th>
                                    <th>CHECK-IN</th>
                                    <th>CHECK-OUT</th>
                                    <th>NIGHTS</th>
                                    <th>STATUS</th>
                                    <th>PAYMENT</th>
                                    <th>TOTAL</th>
                                    <!-- REMOVED ACTIONS COLUMN -->
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var booking in Bookings)
                                {
                                    <tr>
                                        <td class="booking-id" style="font-weight: 700; color: #0f766e;">@booking.BookingId</td>
                                        <td>
                                            <div class="guest-info">
                                                <strong>@booking.GuestName</strong>
                                                <small style="color: #64748b;">@booking.Email</small>
                                            </div>
                                        </td>
                                        <td style="font-weight: 600;">@booking.Room</td>
                                        <td>@booking.CheckIn.ToString("MMM dd, yyyy")</td>
                                        <td>@booking.CheckOut.ToString("MMM dd, yyyy")</td>
                                        <td style="text-align: center; font-weight: 600;">@booking.Nights</td>
                                        <td>
                                            <span class="status-badge @booking.StatusClass">@booking.BookingStatus</span>
                                        </td>
                                        <td>
                                            <span class="payment-badge @booking.PaymentStatusClass">@booking.PaymentStatus</span>
                                        </td>
                                        <td class="amount" style="font-weight: 900; color: #0f766e;">@booking.Total.ToString("C")</td>
                                        <!-- REMOVED ACTIONS CELL -->
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-section">
                        <div class="pagination-info">
                            Showing <strong>@((CurrentPage - 1) * PageSize + 1)</strong> to <strong>@Math.Min(CurrentPage * PageSize, TotalCount)</strong> of <strong>@TotalCount</strong> bookings
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" disabled="@(CurrentPage == 1)" @onclick="PreviousPage">← Previous</button>
                            <span class="page-indicator">Page @CurrentPage of @TotalPages</span>
                            <button class="pagination-btn" disabled="@(CurrentPage == TotalPages)" @onclick="NextPage">Next →</button>

                            <select class="page-size-select" @onchange="OnPageSizeChanged" value="@PageSize">
                                <option value="10">10 per page</option>
                                <option value="25">25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>
                }
            </div>
        </div>
    </section>
</div>

<style>
    /* Filter Section */
    .filter-section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e5e7eb;
    }

    /* Filter Row Layout */
    .filter-row {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
    }

    /* Left Filters - Date Range */
    .left-filters {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        flex: 1;
    }

    .date-input-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 120px;
    }

        .date-input-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
        }

    .date-input {
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        background: white;
        transition: all 0.2s ease;
        height: 42px;
        width: 100%;
    }

        .date-input:focus {
            outline: none;
            border-color: #0f766e;
            box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
        }

    .date-separator {
        font-size: 0.9rem;
        font-weight: 600;
        color: #64748b;
        padding-bottom: 12px;
        white-space: nowrap;
    }

    /* Middle Filters - Status Dropdowns */
    .middle-filters {
        display: flex;
        gap: 8px;
    }

    .filter-select {
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        background: white;
        font-size: 0.9rem;
        cursor: pointer;
        height: 42px;
        min-width: 140px;
        transition: all 0.2s ease;
    }

        .filter-select:focus {
            outline: none;
            border-color: #0f766e;
            box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
        }

    /* Right Filters - Search Box */
    .right-filters {
        display: flex;
        justify-content: flex-end;
        min-width: 250px;
    }

    /* Search Box - Smaller version */
    .search-box {
        position: relative;
        width: 100%;
        max-width: 350px;
    }

        .search-box input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            height: 42px;
        }

            .search-box input:focus {
                outline: none;
                border-color: #0f766e;
                box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
            }

    .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        font-size: 1rem;
        z-index: 1;
    }

    /* Table Styles */
    .booking-table-wrapper {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .booking-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

        /* WHITE TABLE HEADER */
        .booking-table thead {
            background: #ffffff;
            border-bottom: 2px solid #0f766e;
        }

        .booking-table th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: #0f766e;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

    /* Rest of your existing CSS styles remain exactly the same */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        gap: 16px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #0f766e;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        text-align: center;
        color: #64748b;
    }

    .empty-icon {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.6;
    }

    .empty-state p {
        font-size: 1.2rem;
        font-weight: 600;
        color: #374151;
        margin: 0;
    }

    .empty-state small {
        color: #64748b;
        margin-top: 8px;
    }

    .booking-table tbody tr {
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s ease;
    }

        .booking-table tbody tr:hover {
            background-color: #f8fafc;
        }

    .booking-table td {
        padding: 16px;
        font-size: 0.95rem;
        color: #334155;
    }

    .guest-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

        .guest-info strong {
            color: #1e293b;
            font-weight: 700;
        }

    .status-badge,
    .payment-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
    }

    .status-confirmed {
        background: #dbeafe;
        color: #0369a1;
    }

    .status-checked-in {
        background: #fef3c7;
        color: #92400e;
    }

    .status-checked-out {
        background: #d1fae5;
        color: #065f46;
    }

    .status-cancelled {
        background: #fee2e2;
        color: #991b1b;
    }

    .payment-paid {
        background: #d1fae5;
        color: #065f46;
    }

    .payment-pending {
        background: #fef3c7;
        color: #92400e;
    }

    .payment-partial {
        background: #fed7aa;
        color: #9a3412;
    }

    .pagination-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
    }

    .pagination-info {
        font-size: 0.95rem;
        color: #64748b;
    }

    .pagination-controls {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .pagination-btn {
        padding: 8px 16px;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        color: #475569;
        transition: all 0.2s ease;
    }

        .pagination-btn:hover:not(:disabled) {
            background: #f1f5f9;
            border-color: #0f766e;
            color: #0f766e;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    .page-indicator {
        font-size: 0.95rem;
        font-weight: 600;
        color: #475569;
        min-width: 120px;
        text-align: center;
    }

    .page-size-select {
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .panel-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .panel-body {
        padding: 20px;
    }

    /* Responsive adjustments */
    @@media (max-width: 1024px) {
        .filter-row {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }

        .left-filters,
        .middle-filters,
        .right-filters {
            width: 100%;
        }

        .right-filters {
            justify-content: flex-start;
        }

        .search-box {
            max-width: 100%;
        }
    }

    @@media (max-width: 768px) {
        .left-filters {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }

        .date-separator {
            text-align: center;
            padding: 4px 0;
        }

        .middle-filters {
            flex-direction: column;
        }

        .filter-select {
            width: 100%;
        }
    }
</style>



@code {
    private string _searchText = "";
    private string SearchText
    {
        get => _searchText;
        set
        {
            if (_searchText != value)
            {
                _searchText = value;
                _ = OnFilterChanged();
            }
        }
    }

    private string _selectedStatus = "";
    private string SelectedStatus
    {
        get => _selectedStatus;
        set
        {
            if (_selectedStatus != value)
            {
                _selectedStatus = value;
                _ = OnFilterChanged();
            }
        }
    }

    private string _selectedPaymentStatus = "";
    private string SelectedPaymentStatus
    {
        get => _selectedPaymentStatus;
        set
        {
            if (_selectedPaymentStatus != value)
            {
                _selectedPaymentStatus = value;
                _ = OnFilterChanged();
            }
        }
    }

    private string _startDateString = "";
    private string StartDateString
    {
        get => _startDateString;
        set
        {
            if (_startDateString != value)
            {
                _startDateString = value;
                _ = OnFilterChanged();
            }
        }
    }

    private string _endDateString = "";
    private string EndDateString
    {
        get => _endDateString;
        set
        {
            if (_endDateString != value)
            {
                _endDateString = value;
                _ = OnFilterChanged();
            }
        }
    }

    private int CurrentPage = 1;
    private int PageSize = 10;
    private int TotalPages = 1;
    private int TotalCount = 0;
    private bool IsLoading = false;

    private List<Booking> Bookings = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadBookings();
    }

    private async Task OnFilterChanged()
    {
        CurrentPage = 1;
        await LoadBookings();
    }

    private async Task HandleStartDateChanged(ChangeEventArgs e)
    {
        StartDateString = e.Value?.ToString() ?? "";
        CurrentPage = 1;
        await LoadBookings();
    }

    private async Task HandleEndDateChanged(ChangeEventArgs e)
    {
        EndDateString = e.Value?.ToString() ?? "";
        CurrentPage = 1;
        await LoadBookings();
    }

    private async Task LoadBookings()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            await LoadBookingsFromView();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading bookings: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadBookingsFromView()
    {
        Bookings.Clear();

        try
        {
            // Load from the view
            await LoadFromBookingHistoryView();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading booking history: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            Bookings = new List<Booking>();
            StateHasChanged();
        }
    }

    private async Task LoadFromBookingHistoryView()
    {
        try
        {
            var conn = DbContext.Database.GetDbConnection();
            using var cmd = conn.CreateCommand();

            // Base query with filters - simplified view reference like CheckInCheckOut
            cmd.CommandText = @"
                SELECT
                    BookingId,
                    GuestName,
                    Room,
                    CheckIn,
                    CheckOut,
                    BookingStatus,
                    PaymentStatus,
                    Total,
                    BookingDate,
                    Nights,
                    Email,
                    ContactNumber
                FROM vw_BookingHistory
                WHERE 1=1";

            // Add filters
            var whereClauses = new List<string>();

            if (!string.IsNullOrWhiteSpace(SearchText))
            {
                whereClauses.Add("(GuestName LIKE @SearchText OR BookingId LIKE @SearchText)");
                AddParameter(cmd, "@SearchText", "%" + SearchText + "%");
            }

            if (!string.IsNullOrWhiteSpace(SelectedStatus))
            {
                whereClauses.Add("BookingStatus = @Status");
                AddParameter(cmd, "@Status", SelectedStatus);
            }

            if (!string.IsNullOrWhiteSpace(SelectedPaymentStatus))
            {
                whereClauses.Add("PaymentStatus = @PaymentStatus");
                AddParameter(cmd, "@PaymentStatus", SelectedPaymentStatus);
            }

            if (!string.IsNullOrWhiteSpace(StartDateString) && DateTime.TryParse(StartDateString, out var startDate))
            {
                whereClauses.Add("CAST(CheckIn AS DATE) >= @StartDate");
                AddParameter(cmd, "@StartDate", startDate);
            }

            if (!string.IsNullOrWhiteSpace(EndDateString) && DateTime.TryParse(EndDateString, out var endDate))
            {
                whereClauses.Add("CAST(CheckIn AS DATE) <= @EndDate");
                AddParameter(cmd, "@EndDate", endDate);
            }

            // Add all where clauses
            if (whereClauses.Any())
            {
                cmd.CommandText += " AND " + string.Join(" AND ", whereClauses);
            }

            cmd.CommandText += " ORDER BY BookingDate DESC";

            if (conn.State != ConnectionState.Open)
                await conn.OpenAsync();

            Console.WriteLine($"Executing SQL: {cmd.CommandText}");

            // Get total count for pagination (before adding OFFSET/FETCH)
            var countCmd = conn.CreateCommand();
            countCmd.CommandText = cmd.CommandText.Replace("ORDER BY BookingDate DESC", "");
            countCmd.CommandText = $"SELECT COUNT(*) FROM ({countCmd.CommandText}) AS subquery";

            // Copy parameters to count command
            foreach (System.Data.Common.DbParameter param in cmd.Parameters)
            {
                var newParam = countCmd.CreateParameter();
                newParam.ParameterName = param.ParameterName;
                newParam.Value = param.Value;
                countCmd.Parameters.Add(newParam);
            }

            var countResult = await countCmd.ExecuteScalarAsync();
            TotalCount = countResult != null ? Convert.ToInt32(countResult) : 0;
            TotalPages = TotalCount > 0 ? (int)Math.Ceiling((double)TotalCount / PageSize) : 1;

            // Ensure current page is valid
            if (CurrentPage > TotalPages && TotalPages > 0)
                CurrentPage = TotalPages;

            // Apply pagination to main query
            int skipRows = (CurrentPage - 1) * PageSize;
            cmd.CommandText += $" OFFSET {skipRows} ROWS FETCH NEXT {PageSize} ROWS ONLY";

            using var reader = await cmd.ExecuteReaderAsync();
            var loadedBookings = new List<Booking>();

            while (await reader.ReadAsync())
            {
                var booking = new Booking
                {
                    BookingId = reader["BookingId"]?.ToString()?.Trim() ?? "",
                    GuestName = reader["GuestName"]?.ToString()?.Trim() ?? "",
                    Email = reader["Email"]?.ToString()?.Trim() ?? "",
                    Room = reader["Room"]?.ToString()?.Trim() ?? "",
                    CheckIn = reader["CheckIn"] != DBNull.Value ? Convert.ToDateTime(reader["CheckIn"]) : DateTime.Today,
                    CheckOut = reader["CheckOut"] != DBNull.Value ? Convert.ToDateTime(reader["CheckOut"]) : DateTime.Today,
                    BookingStatus = reader["BookingStatus"]?.ToString()?.Trim() ?? "",
                    PaymentStatus = reader["PaymentStatus"]?.ToString()?.Trim() ?? "",
                    Total = reader["Total"] != DBNull.Value ? Convert.ToDecimal(reader["Total"]) : 0m,
                    Nights = reader["Nights"] != DBNull.Value ? Convert.ToInt32(reader["Nights"]) : 0
                };

                loadedBookings.Add(booking);
            }

            Bookings = loadedBookings;
            Console.WriteLine($"Loaded {Bookings.Count} bookings from vw_BookingHistory (Total: {TotalCount})");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading from vw_BookingHistory: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            throw;
        }
    }

    private void AddParameter(System.Data.Common.DbCommand cmd, string name, object value)
    {
        var parameter = cmd.CreateParameter();
        parameter.ParameterName = name;
        parameter.Value = value ?? DBNull.Value;
        cmd.Parameters.Add(parameter);
    }

    private async Task PreviousPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            await LoadBookings();
        }
    }

    private async Task NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
            await LoadBookings();
        }
    }

    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            PageSize = newSize;
            CurrentPage = 1;
            await LoadBookings();
        }
    }

    // Sample data generator (for testing)
    private List<Booking> GenerateSampleBookings()
    {
        // This method is kept for fallback only
        // The view should provide the data
        var sampleBookings = new List<Booking>();

        var sampleData = new (string BookingId, string GuestName, string Room, DateTime CheckIn, DateTime CheckOut, string BookingStatus, string PaymentStatus, decimal Total, int Nights, string Email)[]
        {
            ("BK001", "John Doe", "101", DateTime.Today.AddDays(-5), DateTime.Today.AddDays(-3), "Checked Out", "Paid", 2400.00m, 2, "john.doe@email.com"),
            ("BK002", "Jane Smith", "102", DateTime.Today.AddDays(-2), DateTime.Today.AddDays(1), "Checked In", "Paid", 3600.00m, 3, "jane.smith@email.com"),
            ("BK003", "Robert Johnson", "103", DateTime.Today.AddDays(1), DateTime.Today.AddDays(3), "Confirmed", "Pending", 2400.00m, 2, "robert.j@email.com"),
            ("BK004", "Mary Williams", "201", DateTime.Today.AddDays(-7), DateTime.Today.AddDays(-6), "Checked Out", "Paid", 1200.00m, 1, "mary.w@email.com"),
            ("BK005", "James Brown", "202", DateTime.Today.AddDays(-1), DateTime.Today, "Cancelled", "Partial", 1200.00m, 1, "james.b@email.com"),
        };

        foreach (var data in sampleData)
        {
            sampleBookings.Add(new Booking
            {
                BookingId = data.BookingId,
                GuestName = data.GuestName,
                Room = data.Room,
                CheckIn = data.CheckIn,
                CheckOut = data.CheckOut,
                BookingStatus = data.BookingStatus,
                PaymentStatus = data.PaymentStatus,
                Total = data.Total,
                Nights = data.Nights,
                Email = data.Email
            });
        }

        TotalCount = sampleBookings.Count;
        TotalPages = (int)Math.Ceiling((double)TotalCount / PageSize);

        // Apply pagination to sample data
        return sampleBookings
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .ToList();
    }

    public class Booking
    {
        public string BookingId { get; set; } = "";
        public string GuestName { get; set; } = "";
        public string Email { get; set; } = "";
        public string Room { get; set; } = "";
        public DateTime CheckIn { get; set; }
        public DateTime CheckOut { get; set; }
        public string BookingStatus { get; set; } = "";
        public string PaymentStatus { get; set; } = "";
        public decimal Total { get; set; }
        public int Nights { get; set; }

        public string StatusClass => BookingStatus switch
        {
            "Confirmed" => "status-confirmed",
            "Checked In" => "status-checked-in",
            "Checked Out" => "status-checked-out",
            "Cancelled" => "status-cancelled",
            _ => ""
        };

        public string PaymentStatusClass => PaymentStatus switch
        {
            "Paid" => "payment-paid",
            "Pending" => "payment-pending",
            "Partial" => "payment-partial",
            _ => ""
        };
    }
}}